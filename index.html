<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Cabang - Sistem Pengendalian Operasional Multi Outlet</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Portal Cabang - Pengendalian Operasional&quot;,
        &quot;short_name&quot;: &quot;Portal Cabang&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;%231e3a8a&quot;,
        &quot;theme_color&quot;: &quot;%231e3a8a&quot;
    }">
    <meta name="theme-color" content="#1e3a8a">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: 16px; }
        html { font-size: 16px; }
        body { font-size: 1rem; }
        .text-sm { font-size: 0.95rem; }
        .text-xs { font-size: 0.85rem; }
        .sidebar-link.active { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .module-section { display: none; }
        .module-section.active { display: block; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-only { pointer-events: none; opacity: 0.7; }
        .btn-disabled { pointer-events: none; opacity: 0.5; }

        /* Remove all borders inside module sections */
        .module-section .border,
        .module-section .border-b,
        .module-section .border-t,
        .module-section .border-l,
        .module-section .border-r,
        .module-section .border-x,
        .module-section .border-y,
        .module-section .border-white\/10,
        .module-section .border-gray-100,
        .module-section .border-gray-200,
        .module-section .border-gray-300,
        .module-section .border-red-200,
        .module-section .border-yellow-200,
        .module-section .border-green-200,
        .module-section .border-blue-200 { border-width: 0 !important; }

        .module-section .border-b { border-bottom-width: 0 !important; }
        .module-section .border-t { border-top-width: 0 !important; }
        .module-section .border-l { border-left-width: 0 !important; }
        .module-section .border-r { border-right-width: 0 !important; }

        /* Remove divide lines in lists/tables */
        .module-section .divide-y > :not([hidden]) ~ :not([hidden]) { border-top-width: 0 !important; }
        .module-section .divide-x > :not([hidden]) ~ :not([hidden]) { border-left-width: 0 !important; }

        /* Tables: remove borders */
        .module-section table,
        .module-section th,
        .module-section td { border: none !important; }
    </style>
    <style>
        /* Remove borders on Outlet Selector Bar */
        #outletSelectorBar { border-width: 0 !important; border: none !important; }
        #outletSelectorBar .border,
        #outletSelectorBar .border-b,
        #outletSelectorBar .border-t,
        #outletSelectorBar .border-l,
        #outletSelectorBar .border-r,
        #outletSelectorBar .border-x,
        #outletSelectorBar .border-y { border-width: 0 !important; }
        #outletSelectorBar select { border: none !important; box-shadow: none !important; }

        /* Hide access badge (top-right) */
        #accessBadge { display: none !important; }
        /* Hide access mode label under Portal Cabang (sidebar) */
        #accessModeLabel { display: none !important; }
        /* Hide subtitle under Portal Cabang in login modal */
        #loginModal .text-center > p { display: none !important; }

        /* Narrow outlet filter and improve mobile fit */
        #outletSelectorBar .flex.items-center.gap-3 { gap: 0.5rem; }
        #outletSelectorBar span { font-size: 0.85rem; }
        #activeOutletSelect {
            max-width: 60vw;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            font-size: 0.9rem;
            padding: 0.35rem 0.6rem;
        }
        @media (max-width: 640px) {
            #activeOutletSelect { max-width: 56vw; font-size: 0.85rem; }
            #outletSelectorBar span { font-size: 0.8rem; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-indigo-900 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-store text-white text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Portal Cabang</h1>
                <p class="text-gray-500">Sistem Pengendalian Operasional</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Role <span class="text-red-500">*</span></label>
                    <select id="loginRole" onchange="onRoleChange()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- Pilih Role --</option>
                        <option value="admin">Admin</option>
                        <option value="head-office">Head Office</option>
                        <option value="area-manager">Area Manager</option>
                        <option value="kepala-cabang">Kepala Cabang</option>
                        <option value="outlet">Staff Outlet</option>
                    </select>
                </div>
                <div id="roleDescription" class="hidden p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-700" id="roleDescText"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kode Akses <span class="text-red-500">*</span></label>
                    <input type="password" id="loginCode" placeholder="Masukkan kode akses Anda" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1" id="codeHint"></p>
                </div>
                <div id="loginError" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600"><i class="fas fa-exclamation-circle mr-1"></i><span id="errorText"></span></p>
                </div>
                <button onclick="login()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-indigo-700 transition-all">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                </button>
            </div>
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <p class="text-xs text-gray-600"><i class="fas fa-info-circle mr-1"></i> Hubungi Admin jika Anda belum memiliki kode akses.</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Mobile Header -->
        <div class="lg:hidden bg-gradient-to-r from-blue-800 to-indigo-900 text-white p-4 flex items-center justify-between sticky top-0 z-40">
            <button onclick="toggleSidebar()" class="p-2"><i class="fas fa-bars text-xl"></i></button>
            <h1 class="font-bold">Portal Cabang</h1>
            <button onclick="logout()" class="p-2"><i class="fas fa-sign-out-alt text-xl"></i></button>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-gradient-to-b from-blue-900 to-indigo-900 text-white z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center">
                        <i class="fas fa-store text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">Portal Cabang</h1>
                        <p class="text-xs text-blue-200" id="accessModeLabel">Mode Akses</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <p class="font-medium text-sm" id="userName">User</p>
                        <p class="text-xs text-blue-200" id="userRole">Role</p>
                    </div>
                </div>
            </div>
            <nav class="p-4 space-y-1">
                <a href="#" onclick="showModule('dashboard')" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-chart-pie w-5"></i><span>Dashboard</span>
                </a>
                <a href="#" onclick="showModule('jadwal-kerja')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-calendar-alt w-5"></i><span>Jadwal Kerja</span>
                </a>
                <a href="#" onclick="showModule('tugas-harian')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-tasks w-5"></i><span>Tugas Harian</span>
                </a>
                <a href="#" onclick="showModule('preparation')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-utensils w-5"></i><span>Preparation Bahan Baku</span>
                </a>
                <a href="#" onclick="showModule('checklist')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-clipboard-check w-5"></i><span>Checklist Operasional</span>
                </a>
                <a href="#" onclick="showModule('reject')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-times-circle w-5"></i><span>Catatan Barang Reject</span>
                </a>
                <a href="#" onclick="showModule('inventori')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-boxes w-5"></i><span>Inventori (FIFO/FEFO)</span>
                </a>
                <a href="#" onclick="showModule('logbook')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-book w-5"></i><span>Log Book</span>
                </a>
                <a href="#" onclick="showModule('feedback')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-comments w-5"></i><span>Customer Feedback</span>
                </a>
                <div class="pt-4 mt-4 border-t border-white/10" id="settingsMenu">
                    <p class="px-4 text-xs text-blue-300 uppercase tracking-wider mb-2">Pengaturan</p>
                    <a href="#" onclick="showModule('settings-checklist')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                        <i class="fas fa-cog w-5"></i><span>Pengaturan Checklist</span>
                    </a>
                    <a href="#" onclick="showModule('settings-outlet')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                        <i class="fas fa-store-alt w-5"></i><span>Pengaturan Outlet</span>
                    </a>
                    <a href="#" onclick="showModule('settings-users')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                        <i class="fas fa-users-cog w-5"></i><span>Manajemen User</span>
                    </a>
                    <a href="#" onclick="showModule('spreadsheet')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                        <i class="fas fa-database w-5"></i><span>Koneksi Spreadsheet</span>
                    </a>
                    <a href="#" onclick="showModule('guidelines')" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-all">
                        <i class="fas fa-book-reader w-5"></i><span>Panduan Akses</span>
                    </a>
                </div>
            </nav>
            <div class="p-4 mt-auto hidden lg:block">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-all">
                    <i class="fas fa-sign-out-alt"></i><span>Keluar</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="lg:ml-72 min-h-screen">
            <!-- Outlet Selector Bar -->
            <div id="outletSelectorBar" class="bg-white border-b px-4 lg:px-8 py-3 sticky top-0 lg:top-0 z-30">
                <div class="flex items-center justify-between relative">
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-500">Outlet:</span>
                        <!-- Single select (for non Admin/HO/AM) -->
                        <select id="activeOutletSelect" onchange="changeActiveOutlet()" class="px-3 py-2 border rounded-lg text-sm font-medium"></select>
                        <!-- Multi select (for Admin/HO/AM) -->
                        <div id="multiOutletSelector" class="hidden">
                            <button id="multiOutletBtn" type="button" onclick="toggleMultiOutletPanel()" class="px-3 py-2 rounded-lg text-sm font-medium bg-gray-100 hover:bg-gray-200 truncate max-w-[60vw]">
                                Pilih Outlet
                            </button>
                            <div id="multiOutletPanel" class="absolute left-0 top-full mt-2 w-[90vw] sm:w-[32rem] bg-white rounded-xl shadow-xl p-4 hidden z-40">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm font-semibold text-gray-700">Pilih Outlet</span>
                                    <button class="text-sm text-gray-500 hover:text-gray-700" onclick="toggleMultiOutletPanel()"><i class="fas fa-times"></i></button>
                                </div>
                                <!-- Search box -->
                                <div class="mb-3">
                                    <div class="relative">
                                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                        <input id="multiOutletSearch" type="text" oninput="filterMultiOutletOptions()" placeholder="Cari outlet..." class="w-full pl-9 pr-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-300" />
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 mb-3">
                                    <button onclick="selectAllOutlets()" class="px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs"><i class="fas fa-check-double mr-1"></i>Pilih Semua</button>
                                    <button onclick="deselectAllOutlets()" class="px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-xs"><i class="fas fa-times mr-1"></i>Hapus Semua</button>
                                </div>
                                <div id="multiOutletOptions" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-64 overflow-y-auto pr-1"></div>
                                <div class="mt-4 flex items-center justify-end gap-2">
                                    <button onclick="applySelectedOutlets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"><i class="fas fa-check mr-1"></i>Terapkan</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="accessBadge" class="px-3 py-1 rounded-full text-xs font-medium"></div>
                </div>
            </div>

            <!-- Dashboard -->
            <section id="module-dashboard" class="module-section active p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <p class="text-gray-500" id="dashboardDate"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tugas Selesai</p>
                                <p class="text-3xl font-bold text-gray-800" id="statTugas">0/0</p>
                            </div>
                            <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-tasks text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 rounded-full" id="progressTugas" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Checklist Hari Ini</p>
                                <p class="text-3xl font-bold text-gray-800" id="statChecklist">0%</p>
                            </div>
                            <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clipboard-check text-green-600 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-green-500 rounded-full" id="progressChecklist" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Barang Reject</p>
                                <p class="text-3xl font-bold text-red-600" id="statReject">0</p>
                            </div>
                            <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                            </div>
                        </div>
                        <p class="mt-4 text-sm text-gray-500">Hari ini</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Rating Feedback</p>
                                <p class="text-3xl font-bold text-yellow-600" id="statRating">0.0</p>
                            </div>
                            <div class="w-14 h-14 bg-yellow-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-star text-yellow-600 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex text-yellow-400" id="starsRating">
                            <i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-clock text-blue-500 mr-2"></i>Aktivitas Terkini</h3>
                        <div class="space-y-4" id="recentActivities">
                            <p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>Item Mendekati Expired</h3>
                        <div class="space-y-3" id="expiringItems">
                            <p class="text-gray-500 text-center py-4">Tidak ada item mendekati expired</p>
                        </div>
                    </div>
                </div>

                <!-- Head Office / Area Manager Dashboard Extensions -->
                <div id="hoDashboard" class="mt-8 hidden">
                    <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
                        <h3 class="font-bold text-gray-800 flex items-center"><i class="fas fa-globe-asia text-indigo-500 mr-2"></i><span id="hoTitle">Ringkasan Multi-Outlet</span></h3>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span id="hoOutletScope" class="px-2 py-1 rounded bg-gray-100"></span>
                            <button onclick="window.exportHoSummaryPDF && window.exportHoSummaryPDF()" class="px-3 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"><i class="fas fa-file-pdf mr-2"></i>Export Ringkasan PDF</button>
                        </div>
                    </div>

                    <!-- KPI Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <!-- Tugas Selesai -->
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Tugas Selesai (hari ini)</p>
                                    <p class="text-3xl font-extrabold text-gray-800" id="hoStatTugas">0/0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-tasks text-blue-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-3 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 rounded-full" id="hoProgressTugas" style="width:0%"></div>
                            </div>
                        </div>
                        <!-- Checklist Hari Ini -->
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Checklist Hari Ini</p>
                                    <p class="text-3xl font-extrabold text-gray-800" id="hoStatChecklist">0%</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-clipboard-check text-green-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="mt-3 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-green-500 rounded-full" id="hoProgressChecklist" style="width:0%"></div>
                            </div>
                        </div>
                        <!-- Outlets Melapor -->
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Outlets Melapor</p>
                                    <p class="text-3xl font-extrabold text-gray-800"><span id="hoOutletsReporting">0</span>/<span id="hoOutletsTotal">0</span></p>
                                </div>
                                <div class="relative w-12 h-12">
                                    <div id="hoCoverageRing" class="absolute inset-0 rounded-full" style="background:conic-gradient(#10b981 0%, #e5e7eb 0%);"></div>
                                    <div class="absolute inset-1 rounded-full bg-white"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Pending CAPA -->
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Pending CAPA</p>
                                    <p class="text-3xl font-extrabold text-amber-600" id="hoCapaPending">0</p>
                                </div>
                                <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-exclamation-circle text-amber-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Alert Negatif -->
                        <div class="bg-white rounded-xl p-5 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Feedback Negatif (hari ini)</p>
                                    <p class="text-3xl font-extrabold text-red-600" id="hoNegFeedback">0</p>
                                </div>
                                <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-comment-dots text-red-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary Row: Ranking + Alerts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Ranking Outlet</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Outlet</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Checklist</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Reject (Hari ini)</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hoRankingBody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-bell text-red-500 mr-2"></i>Panel Alert</h3>
                            <div id="hoAlertsList" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Tidak ada alert</p>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage Table -->
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-gray-800"><i class="fas fa-table text-indigo-500 mr-2"></i>Cakupan & Status Outlet</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Outlet</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Checklist</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tugas (Selesai)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Reject (Hari ini)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="hoCoverageBody" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Aktivitas Lintas Outlet (HO/AM) -->
                    <div class="bg-white rounded-xl p-6 shadow-sm mt-6">
                        <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-stream text-blue-500 mr-2"></i>Aktivitas Lintas Outlet</h3>
                        <div id="hoActivitiesList" class="space-y-3">
                            <p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Jadwal Kerja -->
            <section id="module-jadwal-kerja" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Jadwal Kerja</h2>
                    <div class="flex gap-2">
                        <button id="btnExportJadwal" onclick="exportJadwalPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                        <button id="btnAddJadwal" onclick="openModal('modalJadwal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Jadwal
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex items-center justify-between gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-2 border rounded-lg" onclick="changeSchedulePeriod(-1)"><i class="fas fa-chevron-left"></i></button>
                            <div class="text-sm">
                                <div class="font-semibold text-gray-700">Periode</div>
                                <div id="labelSchedulePeriod" class="text-gray-500">21 ... 20 ...</div>
                            </div>
                            <button class="px-3 py-2 border rounded-lg" onclick="changeSchedulePeriod(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Pilih Periode:</label>
                                <select id="periodSelect" class="px-4 py-2 border rounded-lg" onchange="onPeriodSelectChange()"></select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Filter Shift:</label>
                                <select id="shiftFilter" class="px-4 py-2 border rounded-lg" onchange="loadJadwal()">
                                    <option value="">Semua Shift</option>
                                    <option value="pagi">Pagi (06:00-14:00)</option>
                                    <option value="siang">Siang (14:00-22:00)</option>
                                    <option value="malam">Malam (22:00-06:00)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Staff</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shift</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="jadwalTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Tugas Harian -->
            <section id="module-tugas-harian" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Tugas Harian</h2>
                    <div class="flex gap-2">
                        <button id="btnExportTugas" onclick="exportTugasPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddTugas" onclick="openModal('modalTugas')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Tugas
                        </button>
                    </div>
                </div>
                <div class="grid gap-4" id="tugasContainer"></div>
            </section>

            <!-- Preparation Bahan Baku -->
            <section id="module-preparation" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Preparation Bahan Baku</h2>
                    <div class="flex gap-2">
                        <button id="btnExportPreparation" onclick="exportPreparationPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddPrep" onclick="openModal('modalPreparation')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Preparation
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bahan Baku</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Petugas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="preparationTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Checklist Operasional -->
            <section id="module-checklist" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Checklist Operasional</h2>
                    </div>
                    <div class="flex gap-2 items-center">
                        <button id="btnExportChecklist" onclick="exportChecklistPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <select id="checklistShift" class="px-4 py-2 border rounded-lg" onchange="loadChecklist()">
                            <option value="pra">Pra Opening</option>
                            <option value="during">During</option>
                            <option value="after">After Closing</option>
                        </select>
                    </div>
                </div>

                <!-- Info Panel: Waktu + Progress + Stats -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <span class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold" id="clsShiftTime">Pra Opening</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <span id="clsProgressLabel">0%</span>
                                <span>Progress</span>
                            </div>
                            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div id="clsProgressBar" class="h-full bg-green-500 rounded-full" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            <span class="px-2 py-1 rounded bg-gray-100 text-gray-700">Total: <b id="clsStatTotal">0</b></span>
                            <span class="px-2 py-1 rounded bg-green-100 text-green-700">OK: <b id="clsStatOk">0</b></span>
                            <span class="px-2 py-1 rounded bg-red-100 text-red-700">Tidak OK: <b id="clsStatNotOk">0</b></span>
                            <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700">Pending CAPA: <b id="clsStatPending">0</b></span>
                        </div>
                    </div>
                </div>

                <!-- Daftar Checklist -->
                <div class="grid gap-4" id="checklistContainer"></div>
            </section>

            <!-- Catatan Barang Reject -->
            <section id="module-reject" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Catatan Barang Reject</h2>
                    <div class="flex gap-2">
                        <button id="btnExportReject" onclick="exportRejectPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddReject" onclick="openModal('modalReject')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Catat Reject
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex gap-4 flex-wrap">
                        <input type="date" id="rejectDateFilter" class="px-4 py-2 border rounded-lg" onchange="loadReject()">
                        <select id="rejectCategoryFilter" class="px-4 py-2 border rounded-lg" onchange="loadReject()">
                            <option value="">Semua Kategori</option>
                            <option value="expired">Expired</option>
                            <option value="rusak">Rusak/Cacat</option>
                            <option value="kontaminasi">Kontaminasi</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Alasan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">PIC</th>
                                </tr>
                            </thead>
                            <tbody id="rejectTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventori FIFO/FEFO -->
            <section id="module-inventori" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Inventori (FIFO/FEFO)</h2>
                    <div class="flex gap-2">
                        <button id="btnAddInv" onclick="openModal('modalInventori')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-sign-in-alt mr-2"></i>In Stock
                        </button>
                        <button id="btnOutStock" onclick="openModal('modalOutStock')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all">
                            <i class="fas fa-sign-out-alt mr-2"></i>Out Stock
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 w-full max-w-full min-w-0">
                        <p class="text-green-600 text-sm font-medium">Stock Aman</p>
                        <p class="text-2xl font-bold text-green-700" id="stockAman">0</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 w-full max-w-full min-w-0">
                        <p class="text-yellow-600 text-sm font-medium">Mendekati Expired</p>
                        <p class="text-2xl font-bold text-yellow-700" id="stockWarning">0</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 w-full max-w-full min-w-0">
                        <p class="text-red-600 text-sm font-medium">Expired</p>
                        <p class="text-2xl font-bold text-red-700" id="stockExpired">0</p>
                    </div>
                </div>
                <!-- Rekap Saldo & Jumlah -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="font-bold text-gray-800"><i class="fas fa-layer-group text-blue-500 mr-2"></i>Rekap Saldo per Tgl Produksi</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Produksi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="invSaldoBody" class="divide-y divide-gray-200">
                                    <tr><td colspan="3" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="font-bold text-gray-800"><i class="fas fa-box-open text-emerald-500 mr-2"></i>Rekap Jumlah per Nama Barang</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="invJumlahBody" class="divide-y divide-gray-200">
                                    <tr><td colspan="2" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b">
                        <div class="flex items-center gap-4 flex-wrap">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Filter Nama Barang:</label>
                                <select id="invFilterNama" class="px-4 py-2 border rounded-lg" onchange="loadInventori()">
                                    <option value="">Semua Barang</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Satuan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Batch</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Produksi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Masuk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Expired</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="inventoriTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Riwayat Out Stock -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden mt-6">
                    <div class="p-4 border-b">
                        <h3 class="font-bold text-gray-800"><i class="fas fa-history text-red-500 mr-2"></i>Riwayat Out Stock</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Satuan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">PIC</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="outStockTable" class="divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Log Book -->
            <section id="module-logbook" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Log Book (Komunikasi Antar Shift)</h2>
                    <button id="btnAddLog" onclick="openModal('modalLogbook')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                        <i class="fas fa-plus mr-2"></i>Tulis Log
                    </button>
                </div>
                <div class="space-y-4" id="logbookContainer"></div>
            </section>

            <!-- Customer Feedback -->
            <section id="module-feedback" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Customer Feedback</h2>
                    <div class="flex gap-2">
                        <button id="btnExportFeedback" onclick="exportFeedbackPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddFeedback" onclick="openModal('modalFeedback')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Feedback
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-yellow-500" id="avgRating">0.0</p>
                        <p class="text-gray-500 text-sm">Rating Rata-rata</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-green-500" id="totalPositive">0</p>
                        <p class="text-gray-500 text-sm">Feedback Positif (4-5/Puas)</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-red-500" id="totalNegative">0</p>
                        <p class="text-gray-500 text-sm">Feedback Negatif (1-3/Tidak Puas)</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-blue-500" id="totalFeedback">0</p>
                        <p class="text-gray-500 text-sm">Total Feedback</p>
                    </div>
                </div>
                <!-- Filter Feedback -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-500">Tanggal:</label>
                            <input type="date" id="fbFilterTanggal" class="px-3 py-2 border rounded-lg text-sm" onchange="loadFeedback()">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sumber</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Komentar</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CAPA</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Pengaturan Checklist -->
            <section id="module-settings-checklist" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Pengaturan Checklist Operasional</h2>
                    <div class="flex gap-2">
                        <button id="btnResetChecklist" onclick="resetChecklistMaster()" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition-all">
                            <i class="fas fa-undo mr-2"></i>Reset Master (Pra+During)
                        </button>
                        <button id="btnAddChecklist" onclick="openModal('modalChecklistSetting')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Item
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item Checklist</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="checklistSettingTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Pengaturan Outlet -->
            <section id="module-settings-outlet" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Pengaturan Outlet</h2>
                    <button id="btnAddOutlet" onclick="openModal('modalOutlet')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                        <i class="fas fa-plus mr-2"></i>Tambah Outlet
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="outletContainer"></div>
            </section>

            <!-- Manajemen User -->
            <section id="module-settings-users" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Manajemen User</h2>
                    <button id="btnAddUser" onclick="openModal('modalUser')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                        <i class="fas fa-plus mr-2"></i>Tambah User
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kode Akses</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Outlet</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Koneksi Spreadsheet -->
            <section id="module-spreadsheet" class="module-section p-4 lg:p-8 fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Koneksi Google Spreadsheet</h2>
                    <p class="text-gray-500">Konfigurasi koneksi ke database Spreadsheet</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Web App URL (Google Apps Script) <span class="text-red-500">*</span></label>
                            <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/xxxxx/exec" class="w-full px-4 py-3 border rounded-lg font-mono text-sm">
                            <p class="text-xs text-gray-500 mt-1">URL dari Google Apps Script yang sudah di-deploy</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Spreadsheet ID <span class="text-gray-400">(opsional)</span></label>
                                <input type="text" id="spreadsheetId" placeholder="ID dari URL Spreadsheet" class="w-full px-4 py-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">API Key <span class="text-gray-400">(opsional)</span></label>
                                <input type="password" id="apiKey" placeholder="Tidak diperlukan untuk Web App" class="w-full px-4 py-3 border rounded-lg">
                            </div>
                        </div>
                        
                        <!-- Status Koneksi -->
                        <div id="connectionStatus" class="p-4 bg-gray-50 rounded-lg hidden">
                            <div class="flex items-center gap-3">
                                <div id="connStatusIcon" class="w-4 h-4 rounded-full bg-gray-300"></div>
                                <span id="connStatusText" class="text-sm text-gray-600">Belum terhubung</span>
                            </div>
                        </div>
                        
                        <!-- Tombol Aksi -->
                        <div class="flex flex-wrap gap-3">
                            <button onclick="saveSpreadsheetConfig()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg hover:bg-blue-700 transition-all">
                                <i class="fas fa-save mr-2"></i>Simpan
                            </button>
                            <button onclick="testConnection()" class="bg-green-600 text-white px-5 py-2.5 rounded-lg hover:bg-green-700 transition-all">
                                <i class="fas fa-plug mr-2"></i>Test & Sync ke Cloud
                            </button>
                            <button onclick="pullDataFromCloud()" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg hover:bg-purple-700 transition-all">
                                <i class="fas fa-cloud-download-alt mr-2"></i>Unduh dari Cloud
                            </button>
                            <button onclick="diagnoseCloud()" class="bg-orange-600 text-white px-5 py-2.5 rounded-lg hover:bg-orange-700 transition-all">
                                <i class="fas fa-stethoscope mr-2"></i>Diagnosa Cloud
                            </button>
                        </div>
                    </div>
                    
                    <!-- Panduan -->
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Panduan Setup</h4>
                        <ol class="text-sm text-blue-700 space-y-2 list-decimal ml-4">
                            <li>Buat Google Spreadsheet baru</li>
                            <li>Buka <strong>Extensions > Apps Script</strong></li>
                            <li>Paste kode Google Apps Script (lihat dokumentasi)</li>
                            <li>Jalankan fungsi <code class="bg-blue-100 px-1 rounded">testSetup</code> untuk membuat sheet otomatis</li>
                            <li>Deploy: <strong>Deploy > New deployment > Web app</strong></li>
                            <li>Set "Who has access" ke <strong>Anyone</strong></li>
                            <li>Copy URL dan paste di form di atas</li>
                            <li>Klik <strong>Test & Sync ke Cloud</strong></li>
                        </ol>
                    </div>
                    
                    <!-- Info Sheets -->
                    <div class="mt-4 p-4 bg-green-50 rounded-lg">
                        <h4 class="font-medium text-green-800 mb-2"><i class="fas fa-table mr-2"></i>Sheet yang Akan Dibuat Otomatis</h4>
                        <div class="flex flex-wrap gap-2 text-xs">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">users</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">outlets</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">jadwal</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">tugas</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">preparation</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">checklistItems</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">reject</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">inventori</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">outStockLogs</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">logbook</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">feedback</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded">activities</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Panduan Akses -->
            <section id="module-guidelines" class="module-section p-4 lg:p-8 fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panduan Akses Head Office</h2>
                    <p class="text-gray-500">Rekomendasi cakupan akses agar efektif memantau seluruh outlet</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 space-y-6">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Tujuan Peran</h3>
                        <p class="text-sm text-gray-600">Head Office berfokus pada pemantauan, analitik, dan audit mutu. Tidak melakukan input operasional harian.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Akses yang Disarankan</h3>
                        <ul class="list-disc ml-5 text-sm text-gray-700 space-y-1">
                            <li>Dashboard: akses penuh untuk melihat metrik seluruh outlet dan per outlet.</li>
                            <li>Jadwal Kerja: lihat saja, termasuk filter periode dan outlet.</li>
                            <li>Tugas Harian: lihat saja, progres dan detail tugas per outlet.</li>
                            <li>Preparation Bahan Baku: lihat saja, untuk audit kepatuhan.</li>
                            <li>Checklist Operasional: lihat saja status OK/Tidak OK beserta CAPA.</li>
                            <li>Catatan Barang Reject: lihat saja, ekspor laporan untuk audit.</li>
                            <li>Inventori (FIFO/FEFO): lihat saja, termasuk stok, rekap saldo/jumlah, riwayat out stock.</li>
                            <li>Log Book: lihat saja, arsip komunikasi antar shift.</li>
                            <li>Customer Feedback: lihat saja seluruh catatan dan statistik.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Fitur Analitik Tambahan (Opsional)</h3>
                        <ul class="list-disc ml-5 text-sm text-gray-700 space-y-1">
                            <li>Filter lintas outlet dan periode untuk membandingkan performa.</li>
                            <li>Ekspor PDF/Spreadsheet untuk seluruh modul.</li>
                            <li>Notifikasi atau highlight outlier (mis. reject tinggi, checklist pending CAPA).</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Batasan</h3>
                        <ul class="list-disc ml-5 text-sm text-gray-700 space-y-1">
                            <li>Tidak dapat menambah/mengubah/menghapus data operasional.</li>
                            <li>Tidak dapat mengubah pengaturan master (Checklist, Outlet, User).</li>
                        </ul>
                    </div>
                </div>
            </section>        </main>
    </div>

    <!-- Modals -->
    <!-- Modal Jadwal -->
    <div id="modalJadwal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Jadwal Kerja</h3>
                <button onclick="closeModal('modalJadwal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Staff</label>
                    <input type="text" id="jadwalNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="jadwalTanggal" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                    <select id="jadwalShift" class="w-full px-4 py-2 border rounded-lg">
                        <option value="pagi">Pagi (06:00-14:00)</option>
                        <option value="siang">Siang (14:00-22:00)</option>
                        <option value="malam">Malam (22:00-06:00)</option>
                    </select>
                </div>
                <button onclick="saveJadwal()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Tugas -->
    <div id="modalTugas" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Tugas</h3>
                <button onclick="closeModal('modalTugas')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tugas</label>
                    <select id="tugasJudul" class="w-full px-4 py-2 border rounded-lg">
                        <option>Buang Sampah</option>
                        <option>Greastrap</option>
                        <option>Dishwasher</option>
                        <option>Stock Opname</option>
                        <option>Room Service/Penanganan TO</option>
                        <option>Checker</option>
                        <option>Order Barang</option>
                        <option>Terima Barang</option>
                        <option>Masakan "A"</option>
                        <option>Masakan "B"</option>
                        <option>Masakan "C"</option>
                        <option>Kasir</option>
                        <option>Juicer</option>
                        <option>Greeter</option>
                        <option>Runner</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <textarea id="tugasDeskripsi" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prioritas</label>
                    <select id="tugasPrioritas" class="w-full px-4 py-2 border rounded-lg">
                        <option value="tinggi">Tinggi</option>
                        <option value="sedang">Sedang</option>
                        <option value="rendah">Rendah</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ditugaskan kepada</label>
                    <select id="tugasAssign" class="w-full px-4 py-2 border rounded-lg"></select>
                    <p class="text-xs text-gray-500 mt-1">Nama diambil dari Jadwal Kerja periode aktif (21 s.d. 20).</p>
                </div>
                <button onclick="saveTugas()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Preparation -->
    <div id="modalPreparation" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Preparation</h3>
                <button onclick="closeModal('modalPreparation')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Bahan Baku</label>
                    <select id="prepNama" class="w-full px-4 py-2 border rounded-lg">
                        <option>Siomay</option>
                        <option>SMU</option>
                        <option>SKT</option>
                        <option>Telur</option>
                        <option>Kentang</option>
                        <option>Kol</option>
                        <option>Pare</option>
                        <option>Tahu</option>
                        <option>Bumbu Siomay</option>
                        <option>Bumbu Otak-otak</option>
                        <option>Nasi pera</option>
                        <option>nasi putih</option>
                        <option>sambal terasi</option>
                        <option>sambal mercon</option>
                        <option>telur ceplok</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label>
                    <input type="text" id="prepJumlah" class="w-full px-4 py-2 border rounded-lg" placeholder="contoh: 5 kg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Petugas</label>
                    <select id="prepPetugas" class="w-full px-4 py-2 border rounded-lg"></select>
                    <p class="text-xs text-gray-500 mt-1">Nama diambil dari Jadwal Kerja periode aktif (21 s.d. 20).</p>
                </div>
                <button onclick="savePreparation()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Reject -->
    <div id="modalReject" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Catat Barang Reject</h3>
                <button onclick="closeModal('modalReject')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <select id="rejectNama" class="w-full px-4 py-2 border rounded-lg">
                        <option>Ayam marinade</option>
                        <option>Boneless marinade</option>
                        <option>Daun bawang</option>
                        <option>Seldri</option>
                        <option>Wortel</option>
                        <option>CMB</option>
                        <option>CRH</option>
                        <option>Telur</option>
                        <option>Kentang</option>
                        <option>Kol</option>
                        <option>Pare</option>
                        <option>Bokcoy</option>
                        <option>Apple</option>
                        <option>Alpukat</option>
                        <option>Nanas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label>
                    <input type="text" id="rejectJumlah" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="rejectKategori" class="w-full px-4 py-2 border rounded-lg">
                        <option value="expired">Expired</option>
                        <option value="rusak">Rusak/Cacat</option>
                        <option value="kontaminasi">Kontaminasi</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Alasan</label>
                    <textarea id="rejectAlasan" rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <button onclick="saveReject()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Inventori (In Stock) -->
    <div id="modalInventori" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">In Stock</h3>
                <button onclick="closeModal('modalInventori')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Masuk</label>
                    <input type="date" id="invTglMasuk" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <select id="invNama" class="w-full px-4 py-2 border rounded-lg" onchange="onInvNamaChange()"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Batch Number</label>
                    <input type="text" id="invBatch" class="w-full px-4 py-2 border rounded-lg" placeholder="Contoh: PRD-202601-01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Produksi</label>
                    <input type="date" id="invTglProduksi" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Expired</label>
                    <input type="date" id="invTglExpired" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah <span id="invSatuanLabel" class="text-gray-400"></span></label>
                    <input type="number" id="invJumlah" class="w-full px-4 py-2 border rounded-lg" placeholder="0">
                </div>
                <button onclick="saveInventori()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Out Stock -->
    <div id="modalOutStock" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Out Stock (FEFO)</h3>
                <button onclick="closeModal('modalOutStock')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <select id="outNama" class="w-full px-4 py-2 border rounded-lg" onchange="onOutNamaChange()"></select>
                </div>
                <!-- Info Batch Tersedia -->
                <div id="outBatchInfo" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-layer-group text-blue-500 mr-1"></i>Batch Tersedia (Urutan FEFO)
                    </label>
                    <div class="bg-gray-50 rounded-lg border max-h-40 overflow-y-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 py-1 text-left">Urutan</th>
                                    <th class="px-2 py-1 text-left">Tgl Produksi</th>
                                    <th class="px-2 py-1 text-left">Tgl Expired</th>
                                    <th class="px-2 py-1 text-right">Stok</th>
                                </tr>
                            </thead>
                            <tbody id="outBatchTable"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-blue-600 mt-1"><i class="fas fa-info-circle mr-1"></i>Batch dengan tanggal expired paling awal akan dikeluarkan terlebih dahulu.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah yang Dikeluarkan <span id="outSatuanLabel" class="text-gray-400"></span></label>
                    <input type="number" id="outJumlah" class="w-full px-4 py-2 border rounded-lg" placeholder="0" oninput="previewOutStock()">
                    <p class="text-xs text-gray-500 mt-1">Total tersedia: <span id="outTotalTersedia" class="font-semibold">0</span></p>
                </div>
                <!-- Preview Penggunaan Batch -->
                <div id="outPreview" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-eye text-green-500 mr-1"></i>Preview Batch yang Akan Terpakai
                    </label>
                    <div id="outPreviewContent" class="bg-green-50 border border-green-200 rounded-lg p-3 text-sm"></div>
                </div>
                <button onclick="saveOutStock()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700">
                    <i class="fas fa-sign-out-alt mr-2"></i>Keluarkan Stock
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Logbook -->
    <div id="modalLogbook" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tulis Log Book</h3>
                <button onclick="closeModal('modalLogbook')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                    <select id="logShift" class="w-full px-4 py-2 border rounded-lg">
                        <option value="pagi">Pagi</option>
                        <option value="siang">Siang</option>
                        <option value="malam">Malam</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="logKategori" class="w-full px-4 py-2 border rounded-lg">
                        <option value="info">Informasi</option>
                        <option value="penting">Penting</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                    <textarea id="logCatatan" rows="4" class="w-full px-4 py-2 border rounded-lg" placeholder="Tulis catatan untuk shift berikutnya..."></textarea>
                </div>
                <button onclick="saveLogbook()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Feedback -->
    <div id="modalFeedback" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Feedback</h3>
                <button onclick="closeModal('modalFeedback')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Customer</label>
                    <input type="text" id="fbNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sumber Feedback</label>
                    <select id="fbSumber" class="w-full px-4 py-2 border rounded-lg" onchange="onFbSumberChange()">
                        <option value="google">Google Review</option>
                        <option value="wa">WA Customer Care</option>
                        <option value="instagram">Instagram</option>
                        <option value="onsite">On Site</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="fbKategori" class="w-full px-4 py-2 border rounded-lg">
                        <option value="pelayanan">Pelayanan</option>
                        <option value="produk">Produk</option>
                        <option value="sikap">Sikap Karyawan</option>
                        <option value="lingkungan">Lingkungan</option>
                    </select>
                </div>
                <!-- Rating Bintang (Google Review) -->
                <div id="ratingStarsContainer">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating Bintang</label>
                    <div class="flex gap-2" id="ratingStars">
                        <button type="button" onclick="setRating(1)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(2)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(3)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(4)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(5)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                    </div>
                    <input type="hidden" id="fbRating" value="0">
                </div>
                <!-- Rating Puas/Tidak Puas (selain Google Review) -->
                <div id="ratingPuasContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tingkat Kepuasan</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="fbPuas" value="puas" onchange="onPuasChange()" class="w-5 h-5 text-green-600">
                            <span class="text-green-600 font-medium"><i class="fas fa-smile mr-1"></i>Puas</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="fbPuas" value="tidak_puas" onchange="onPuasChange()" class="w-5 h-5 text-red-600">
                            <span class="text-red-600 font-medium"><i class="fas fa-frown mr-1"></i>Tidak Puas</span>
                        </label>
                    </div>
                </div>
                <!-- Kolom CAPA (muncul jika rating negatif) -->
                <div id="fbCapaContainer" class="hidden">
                    <label class="block text-sm font-medium text-red-700 mb-1">CAPA (Corrective and Preventive Action) <span class="text-red-500">*</span></label>
                    <textarea id="fbCapa" rows="3" class="w-full px-4 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-300" placeholder="Jelaskan tindakan perbaikan dan pencegahan..."></textarea>
                    <p class="text-xs text-red-500 mt-1" id="fbCapaHint">Wajib diisi untuk rating negatif</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Komentar</label>
                    <textarea id="fbKomentar" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <button onclick="saveFeedback()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Checklist Setting -->
    <div id="modalChecklistSetting" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Item Checklist</h3>
                <button onclick="closeModal('modalChecklistSetting')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="clsKategori" class="w-full px-4 py-2 border rounded-lg">
                        <option value="kebersihan">Kebersihan</option>
                        <option value="peralatan">Peralatan</option>
                        <option value="keamanan">Keamanan</option>
                        <option value="operasional">Operasional</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Item</label>
                    <input type="text" id="clsNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Berlaku untuk Waktu</label>
                    <select id="clsWaktu" class="w-full px-4 py-2 border rounded-lg">
                        <option value="pra">Pra Opening (03.00 - 10.00)</option>
                        <option value="during">During (16.00 - 18.00)</option>
                        <option value="after">After Closing (21.00 - 00.00)</option>
                    </select>
                </div>
                <button onclick="saveChecklistSetting()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Outlet -->
    <div id="modalOutlet" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Outlet</h3>
                <button onclick="closeModal('modalOutlet')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kode Outlet</label>
                    <input type="text" id="outletKode" class="w-full px-4 py-2 border rounded-lg" placeholder="contoh: OT001">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Outlet</label>
                    <input type="text" id="outletNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                    <textarea id="outletAlamat" rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telepon</label>
                    <input type="text" id="outletTelp" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Area</label>
                    <input type="text" id="outletArea" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <button onclick="saveOutlet()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal User -->
    <div id="modalUser" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah User</h3>
                <button onclick="closeModal('modalUser')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kode Akses</label>
                    <input type="text" id="userKode" class="w-full px-4 py-2 border rounded-lg" placeholder="Kode unik untuk login">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="userNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="userRoleSelect" class="w-full px-4 py-2 border rounded-lg" onchange="onUserRoleChange()">
                        <option value="admin">Admin</option>
                        <option value="head-office">Head Office</option>
                        <option value="area-manager">Area Manager</option>
                        <option value="kepala-cabang">Kepala Cabang</option>
                        <option value="outlet">Staff Outlet</option>
                    </select>
                </div>
                <div id="outletAssignmentDiv">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Outlet yang Ditangani</label>
                    <div id="outletCheckboxes" class="max-h-40 overflow-y-auto border rounded-lg p-3 space-y-2"></div>
                </div>
                <button onclick="saveUser()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 fade-in">
        <i class="fas fa-check-circle mr-2"></i><span id="toastMessage">Berhasil disimpan!</span>
    </div>
    
    <!-- Cloud Config Alert -->
    <div id="cloudAlert" class="fixed bottom-4 left-4 bg-yellow-500 text-white px-4 py-3 rounded-lg shadow-lg hidden z-50 fade-in">
        <div class="flex items-center gap-3">
            <i class="fas fa-plug"></i>
            <span class="text-sm">Belum terhubung ke Cloud. Masukkan Web App URL pada Koneksi Spreadsheet.</span>
            <button onclick="showModule('spreadsheet')" class="bg-white/20 hover:bg-white/30 text-white text-xs px-3 py-1 rounded">Buka Pengaturan</button>
        </div>
    </div>

    <script>
        // ==================== USER DATABASE ====================
        const userDatabase = {
            'admin': [
                { kode: '2015115650mr', nama: 'Marianto', outlets: 'all' }
            ],
            'head-office': [
                { kode: '1998090117', nama: 'Puguh Setyo Wicasono', outlets: 'all' },
                { kode: '1994050021', nama: 'Wiwin Wiyono', outlets: 'all' },
                { kode: '1988110003', nama: 'Suyono', outlets: 'all' },
                { kode: '1988100004', nama: 'Grace Santoso', outlets: 'all' },
                { kode: '1988100005', nama: 'Stephanus Robion Pranatio', outlets: 'all' },
                { kode: '1988100006', nama: 'Rosalia Pranatio', outlets: 'all' }
            ],
            'area-manager': [
                { kode: '2015115657', nama: 'Afifur Rahman', outlets: ['outlet-1', 'outlet-2', 'outlet-3'] },
                { kode: '2015115662', nama: 'Sunarto', outlets: ['outlet-4', 'outlet-5', 'outlet-6'] },
                { kode: '2018037573', nama: 'I Made Swastika', outlets: ['outlet-7', 'outlet-8'] },
                { kode: '2018127754', nama: 'Moh. Imam Ma\'ruf Nahi Mungkar', outlets: ['outlet-9', 'outlet-10'] },
                { kode: '1997080076', nama: 'Ferdiyanto', outlets: ['outlet-11', 'outlet-12'] }
            ],
            'kepala-cabang': [],
            'outlet': []
        };

        // Role descriptions
        const roleDescriptions = {
            'admin': 'Semua outlet - Akses penuh ke seluruh sistem',
            'head-office': 'View Only semua outlet - Dapat melihat data tanpa mengubah',
            'area-manager': 'Outlet yang dibawahi - Mengelola beberapa outlet',
            'kepala-cabang': 'Outlet yang dibawahi - Mengelola satu outlet',
            'outlet': 'View + Input terbatas - Hanya outlet tempat bertugas'
        };

        // ==================== STATE MANAGEMENT ====================
        let currentUser = null;
        let currentOutlet = null; // legacy single outlet
        let selectedOutlets = null; // array of selected outlet ids for Admin/HO/AM
        let allowedOutlets = [];
        let isViewOnly = false;
        let currentModule = 'dashboard';
        let selectedRating = 0;
        let schedulePeriodOffset = 0; // 0 = periode berjalan, -1 periode sebelumnya, 1 periode berikutnya


        // Role Permissions
        const rolePermissions = {
            'admin': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'checklist', 'reject', 'inventori', 'logbook', 'feedback', 'settings-checklist', 'settings-outlet', 'settings-users', 'spreadsheet', 'guidelines'],
            'head-office': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'checklist', 'reject', 'inventori', 'logbook', 'feedback'],
            'area-manager': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'checklist', 'reject', 'inventori', 'logbook', 'feedback'],
            'kepala-cabang': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'checklist', 'reject', 'inventori', 'logbook', 'feedback'],
            'outlet': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'checklist', 'reject', 'inventori', 'logbook', 'feedback']
        };

        // ==================== INITIALIZATION ====================
        const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxeMBKwWm4PIK1suf8FGtwJ3IsTD-dowfn-158_qTKrTRyVZs7Lt8tnqfarKYWkXfY/exec';
        const DEFAULT_SPREADSHEET_ID = '1h7VCFxncf--Ksv-I79sk9N1gUCNn7p_Kz6NByyiyrpk';
        function ensureCloudConfigDefaults() {
            try {
                // Paksa gunakan URL default terbaru agar tidak terjebak URL lama di localStorage
                const cfg = JSON.parse(localStorage.getItem('spreadsheetConfig') || '{}');
                cfg.webAppUrl = DEFAULT_WEB_APP_URL;
                if (!cfg.spreadsheetId) cfg.spreadsheetId = DEFAULT_SPREADSHEET_ID;
                localStorage.setItem('spreadsheetConfig', JSON.stringify(cfg));
            } catch (e) {/* ignore */}
        }
        function cleanupDefaultOutlets() {
            try {
                let outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
                const before = outlets.length;
                const norm = (s) => (s || '').toString().toLowerCase().trim();
                const toRemoveSet = new Set([
                    'outlet sudirman',
                    'outlet kemang',
                    'outlet depok',
                    'outlet bali kuta',
                    'outlet bali seminyak',
                    'outlet kelapa gading',
                    'outlet surabaya tunjungan',
                    'outlet surabaya gubeng',
                    'outlet bandung dago',
                    'outlet bandung raya',
                    'outlet thamrin',
                    'outlet bekasi'
                ]);
                outlets = outlets.filter(o => {
                    const name = norm(o.nama);
                    if (toRemoveSet.has(name)) return false;
                    // Tangani kemungkinan salah ketik: "Bandung Raya" yang dimaksud "Bandung Braga"
                    if (name.startsWith('outlet bandung ') && (name.includes('braga') || name.includes('raya'))) return false;
                    return true;
                });
                if (outlets.length !== before) {
                    localStorage.setItem('outlets', JSON.stringify(outlets));
                }
            } catch (e) { /* ignore */ }
        }
        function ensureChecklistSchemaV2() {
            // Jika sudah pernah migrate, skip (tetap izinkan overwrite bila belum ada properti waktu)
            const migrated = localStorage.getItem('checklistV2');
            let items = JSON.parse(localStorage.getItem('checklistItems') || '[]');
            if (migrated === '1' && items.some(i => i.waktu)) return;

            // Dataset baru: Pra Opening, During, dan After Closing sesuai permintaan
            const praList = [
                "Muka bersih tidak berminyak dan merias wajah sesuai standar",
                "Kulit tidak kering dan tidak bersisik memakai body lotion",
                "Kuku pendek dan tidak menggunakan cat kuku",
                "Bulu atau rambut hidung tidak menjorok keluar lubang hidung",
                "Tidak ada bau yang tidak sedap dari badan, mulut, telinga atau bagian tubuh lainnya termasuk parfume yang aromanya menyengat",
                "Mengenakan baju dan celana sesuai standar bentuk, warna bahan yang ditetapkan dalam kondisi bersih dan rapi",
                "Memakai sepatu pantofel warna hitam dengan maksimal tinggi 3 cm dalam kondisi bersih dan mengkilap (bersemir)",
                "Memakai ikat pinggang warna hitam polos terbuat dari kulit bukan kain atau sintetis dengan kepala gesper yang sederhana",
                "Memakai kaos singlet warna putih",
                "Tidak memakai gelang, anting, kalung, jam tangan atau aksesoris lainnya",
                "Tidak ada tato di bagian tubuh yang terbuka",
                "Pakai name tag sesuai standar yang ditetapkan",
                "Memakai masker hitam dan kelengkapan kerja sesuai jabatannya",
                "Rambut rapi dengan maksimal panjang 5 cm, tidak kusam/kering, rapi menggunakan minyak rambut yang tidak berbau menyengat",
                "Tidak memelihara kumis, jenggot dan jambang dipotong sejajar ekor mata",
                "Hijab dalam keadaan rapi, terutama pada bagian leher harus kelihatan bentuk leher dengan bantuan jepit/bros tanpa manik dan warna sesuai warna hijab",
                "Dilarang menggunakan jarum pentul",
                "Memakai dalaman hijab berwarna hitam polos",
                "Rambut panjang harus memakai hairnet dan poni tidak menjuntai ke depan menutupi dahi",
                "Order Barang sudah dicek kacab, diinput dan dikirim ke bagian gudang",
                "Labeling pada pada barang datang, hasil prepare dan atau hasil produksi sudah dilakukan",
                "Rekap pemakaian sudah dikerjakan dan dikirim ke bagian akuntansi",
                "Pencatatan produksi cabang, produksi pusat sudah dikerjakan dan diverifikasi",
                "Laporan Piutang (Bagi cabang yang ada transaksi piutang) sudah dikerjakan dan atau dikirim ke bagian akuntansi",
                "Kesiapan kelengkapan, kebersihan, serta kecukupan sumberdaya (Area Dinning, Juicer, Kasir, Dapur)",
                "Sendok, garpu, pisau roti dan sumpit tersedia dalam kondisi cukup",
                "Tissue meja, saos, kecap, sambal dalam kondisi terisi cukup dan tidak belepotan",
                "Nampan, buku menu, slip order dan alat tulis tersedia dalam kondisi bersih dan cukup",
                "Kain lap meja (waiter, juicer, kasir dan dapur) dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Kain lap sendok, gelas dan piring dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Hand sanitizer pada posisi pintu masuk & kasir",
                "Disinfektan tersedia dalam kondisi cukup",
                "Semua meja, kursi, sofa, kursi anak  dalam kondisi bersih dan tertata rapi",
                "Semua pegangan pintu, pegangan anak tangga, pembatas antrian dalam kondisi bersih",
                "Wastafel dalam kondisi bersih, tersedia hand soap, tissue, tempat sampah, cermin",
                "Tempat Sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Pad counter dalam kondisi bersih dan barang-barang tertata rapi",
                "Semua Dinding (dining, juicer, kasir, dapur, gudang) dalam kondisi bersih",
                "Semua lantai (dining, kasir, juicer, dapur, gudang) dan gotter dalam kondisi bersih",
                "Kaca (jendela, interior) dalam kondisi bersih tidak buram",
                "Diffuser AC / AC dalam kondisi bersih dan dingin",
                "TV display, Audio player dalam kondisi normal dan bersih",
                "Interior (gambar dinding, lampu gantung, furniture) dalam kondisi bersih",
                "Service Extension dalam kondisi rapi dan bersih",
                "Lampu (dining, box menu, Logo) dalam kondisi menyala normal dan bersih",
                "Tanaman Hias tidak ada yang layu daunnya",
                "Sarana Promosi (x banner, tripod banner, standing menu, baliho) dalam kondisi layak dan bersih",
                "Peralatan proses juicer (Blender, Juicer, extractor, sendok ukur, pisau, talenan, saringan juice, teh, scoop es krim, tea maker, mesin serut es, mesin cup sealer, es maker, timbangan) dalam kondisi berfungsi normal dan bersih",
                "Alat saji (Plate coupe 7.5, 8, 9, 10,5. Saucer 4,25. Bowl 4.5, 6, Bowl omega 7, square plate besar, kecil, piring snack, piring lauk, mangkok kuring/ramen, saucer, sendok, gelas juice, gelas teh, cangkir kopi, lunch box, box gurame, paper bowl set 650, 800, 1000, cup oval, cup 400, 500, sedotan) dalam kondisi cukup dan bersih",
                "Meja kerja di semua area dalam kondisi bersih dan penataan barang-barang rapi",
                "Alegro dalam kondisi berfungsi normal, bersih dan penataan buah rapi",
                "Freezer, under freezer, chiller, under chiller, salad case (gasket, kaca, rak, kipas, handle, body) juicer dan dapur dalam kondisi berfungsi normal, bersih, bunga es tidak tebal dan penataan bahan baku rapi",
                "Chiller, salad case juicer dan dapur dalam kondisi normal dan bersih",
                "Tempat prepare di area juicer dan dapur (food pan, kitchen set, termos nasi, keranjang, toples, box risol, box thawing) dalam kondisi tertutup dan dalam kondisi bersih",
                "Tempat penyimpanan bahan baku & produk (rak susun, rak tempel dan lemari penyimpanan termasuk laci-laci) dalam kondisi bersih dan barang-barang tersusun rapi",
                "Sink, grease trap, grease induk dan gutter dalam kondisi bersih",
                "Langit-langit semua area dalam kondisi baik dan bersih",
                "Tempat sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Dinding semua area dalam kondisi bersih",
                "Mesin POS, alat pembayaran (EDC BCA, Mandiri, BRI, Gobiz, Grabfood, Handphone, HT dalam kondisi normal dan bersih",
                "Setor omset maksimal jam 14.00 dan laporan setor omzet ke bagian keuangan",
                "Kelengkapan peralatan kasir (kalkulator, money detector, stepless, isolatif) dalam kondisi cukup",
                "Uang receh tersedia cukup (20rb, 10rb, 5rb, 2rb, 1rb, 500, 200, 100)",
                "Peralatan proses cook (steamer nasi, rice cooker, gas cooker, steamer, magic com, microwave, toaster, panci, wajan, sodet, saringan mie, saringan minyak, jepitan makanan, deep fryer, teflon, cetakan nasi, kompor high, kompor low, pisau, talenan, parutan keju, timbangan) dalam kondisi layak pakai, bersih dan bebas dari kontaminasi antar alat, maupun dari  dari hal-hal lainnya",
                "Hood dan exhaust dalam kondisi bersih dan berfungsi normal",
                "Mesin cuci piring dan mesin pembuat es dalam kondisi bersih dan berfungsi normal",
                "Semua area bebas dari hama(tikus, kecoa, lalat, semut)",
                "Fasilitas toilet di dalam cabang",
                "Handle pintu dan kunci pintu berfungsi normal dan bersih",
                "Aroma toilet harum atau tidak berbau tidak sedap",
                "Lantai dan dinding dalam kondisi bersih dan kering",
                "Lampu penerangan tidak ada yang mati dan fan exhaust dengan kondisi bersih dan berfungsi normal",
                "Kloset dalam kondisi baik,bersih dan kering",
                "Shower kloset berfungsi normal dan bersih",
                "Wastafel dalam kondisi normal dan bersih serta tersedia hand soap dan tissue",
                "Urinoir dalam kondisi bersih, berfungsi normal dan tidak beraroma tidak sedap",
                "Tempat Sampah dalam kondisi bersih tidak ada bau tidak sedap"
            ];

            const duringList = [
                "Muka bersih tidak berminyak dan merias wajah sesuai standar",
                "Kulit tidak kering dan tidak bersisik memakai body lotion",
                "Kuku pendek dan tidak menggunakan cat kuku",
                "Bulu atau rambut hidung tidak menjorok keluar lubang hidung",
                "Tidak ada bau yang tidak sedap dari badan, mulut, telinga atau bagian tubuh lainnya termasuk parfume yang aromanya menyengat",
                "Mengenakan baju dan celana sesuai standar bentuk, warna bahan yang ditetapkan dalam kondisi bersih dan rapi",
                "Memakai sepatu pantofel warna hitam dengan maksimal tinggi 3 cm dalam kondisi bersih dan mengkilap (bersemir)",
                "Memakai ikat pinggang warna hitam polos terbuat dari kulit bukan kain atau sintetis dengan kepala gesper yang sederhana",
                "Memakai kaos singlet warna putih",
                "Tidak memakai gelang, anting, kalung, jam tangan atau aksesoris lainnya",
                "Tidak ada tato di bagian tubuh yang terbuka",
                "Pakai name tag sesuai standar yang ditetapkan",
                "Memakai masker hitam dan kelengkapan kerja sesuai jabatannya",
                "Rambut rapi dengan maksimal panjang 5 cm, tidak kusam/kering, rapi menggunakan minyak rambut yang tidak berbau menyengat",
                "Tidak memelihara kumis, jenggot dan jambang dipotong sejajar ekor mata",
                "Hijab dalam keadaan rapi, terutama pada bagian leher harus kelihatan bentuk leher dengan bantuan jepit/bros tanpa manik dan warna sesuai warna hijab",
                "Dilarang menggunakan jarum pentul",
                "Memakai dalaman hijab berwarna hitam polos",
                "Rambut panjang harus memakai hairnet dan poni tidak menjuntai ke depan menutupi dahi",
                "Order Barang sudah dicek kacab, diinput dan dikirim ke bagian gudang",
                "Labeling pada pada barang datang, hasil prepare dan atau hasil produksi sudah dilakukan",
                "Rekap pemakaian sudah dikerjakan dan dikirim ke bagian akuntansi",
                "Pencatatan produksi cabang, produksi pusat sudah dikerjakan dan diverifikasi",
                "Laporan Piutang (Bagi cabang yang ada transaksi piutang) sudah dikerjakan dan atau dikirim ke bagian akuntansi",
                "Kesiapan kelengkapan, kebersihan, serta kecukupan sumberdaya (Area Dinning, Juicer, Kasir, Dapur)",
                "Sendok, garpu, pisau roti dan sumpit tersedia dalam kondisi cukup",
                "Tissue meja, saos, kecap, sambal dalam kondisi terisi cukup dan tidak belepotan",
                "Nampan, buku menu, slip order dan alat tulis tersedia dalam kondisi bersih dan cukup",
                "Kain lap meja (waiter, juicer, kasir dan dapur) dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Kain lap sendok, gelas dan piring dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Hand sanitizer pada posisi pintu masuk & kasir",
                "Disinfektan tersedia dalam kondisi cukup",
                "Semua meja, kursi, sofa, kursi anak  dalam kondisi bersih dan tertata rapi",
                "Semua pegangan pintu, pegangan anak tangga, pembatas antrian dalam kondisi bersih",
                "Wastafel dalam kondisi bersih, tersedia hand soap, tissue, tempat sampah, cermin",
                "Tempat Sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Pad counter dalam kondisi bersih dan barang-barang tertata rapi",
                "Semua Dinding (dining, juicer, kasir, dapur, gudang) dalam kondisi bersih",
                "Semua lantai (dining, kasir, juicer, dapur, gudang) dan gotter dalam kondisi bersih",
                "Kaca (jendela, interior) dalam kondisi bersih tidak buram",
                "Diffuser AC / AC dalam kondisi bersih dan dingin",
                "TV display, Audio player dalam kondisi normal dan bersih",
                "Interior (gambar dinding, lampu gantung, furniture) dalam kondisi bersih",
                "Service Extension dalam kondisi rapi dan bersih",
                "Lampu (dining, box menu, Logo) dalam kondisi menyala normal dan bersih",
                "Tanaman Hias tidak ada yang layu daunnya",
                "Sarana Promosi (x banner, tripod banner, standing menu, baliho) dalam kondisi layak dan bersih",
                "Peralatan proses juicer (Blender, Juicer, extractor, sendok ukur, pisau, talenan, saringan juice, teh, scoop es krim, tea maker, mesin serut es, mesin cup sealer, es maker, timbangan) dalam kondisi berfungsi normal dan bersih",
                "Alat saji (Plate coupe 7.5, 8, 9, 10,5. Saucer 4,25. Bowl 4.5, 6, Bowl omega 7, square plate besar, kecil, piring snack, piring lauk, mangkok kuring/ramen, saucer, sendok, gelas juice, gelas teh, cangkir kopi, lunch box, box gurame, paper bowl set 650, 800, 1000, cup oval, cup 400, 500, sedotan) dalam kondisi cukup dan bersih",
                "Meja kerja di semua area dalam kondisi bersih dan penataan barang-barang rapi",
                "Alegro dalam kondisi berfungsi normal, bersih dan penataan buah rapi",
                "Freezer, under freezer, chiller, under chiller, salad case (gasket, kaca, rak, kipas, handle, body) juicer dan dapur dalam kondisi berfungsi normal, bersih, bunga es tidak tebal dan penataan bahan baku rapi",
                "Chiller, salad case juicer dan dapur dalam kondisi normal dan bersih",
                "Tempat prepare di area juicer dan dapur (food pan, kitchen set, termos nasi, keranjang, toples, box risol, box thawing) dalam kondisi tertutup dan dalam kondisi bersih",
                "Tempat penyimpanan bahan baku & produk (rak susun, rak tempel dan lemari penyimpanan termasuk laci-laci) dalam kondisi bersih dan barang-barang tersusun rapi",
                "Sink, grease trap, grease induk dan gutter dalam kondisi bersih",
                "Langit-langit semua area dalam kondisi baik dan bersih",
                "Tempat sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Dinding semua area dalam kondisi bersih",
                "Mesin POS, alat pembayaran (EDC BCA, Mandiri, BRI, Gobiz, Grabfood, Handphone, HT dalam kondisi normal dan bersih",
                "Setor omset maksimal jam 14.00 dan laporan setor omzet ke bagian keuangan",
                "Kelengkapan peralatan kasir (kalkulator, money detector, stepless, isolatif) dalam kondisi cukup",
                "Uang receh tersedia cukup (20rb, 10rb, 5rb, 2rb, 1rb, 500, 200, 100)",
                "Peralatan proses cook (steamer nasi, rice cooker, gas cooker, steamer, magic com, microwave, toaster, panci, wajan, sodet, saringan mie, saringan minyak, jepitan makanan, deep fryer, teflon, cetakan nasi, kompor high, kompor low, pisau, talenan, parutan keju, timbangan) dalam kondisi layak pakai, bersih dan bebas dari kontaminasi antar alat, maupun dari  dari hal-hal lainnya",
                "Hood dan exhaust dalam kondisi bersih dan berfungsi normal",
                "Mesin cuci piring dan mesin pembuat es dalam kondisi bersih dan berfungsi normal",
                "Semua area bebas dari hama(tikus, kecoa, lalat, semut)",
                "Fasilitas toilet di dalam cabang",
                "Handle pintu dan kunci pintu berfungsi normal dan bersih",
                "Aroma toilet harum atau tidak berbau tidak sedap",
                "Lantai dan dinding dalam kondisi bersih dan kering",
                "Lampu penerangan tidak ada yang mati dan fan exhaust dengan kondisi bersih dan berfungsi normal",
                "Kloset dalam kondisi baik,bersih dan kering",
                "Shower kloset berfungsi normal dan bersih",
                "Wastafel dalam kondisi normal dan bersih serta tersedia hand soap dan tissue",
                "Urinoir dalam kondisi bersih, berfungsi normal dan tidak beraroma tidak sedap",
                "Tempat Sampah dalam kondisi bersih tidak ada bau tidak sedap"
            ];

            const afterList = [
                "Permintaan barang ke gudang sudah di lakukan dan diverifikasi oleh kacab atau staff penggantinya",
                "Labeling pada pada barang datang sudah dilakukan",
                "Stock Opname sudah dilakukan dan diinput kedalam form rekapan pemakaian",
                "Bahan baku sisa sudah masuk pendingin (bahan baku food & juice)",
                "Semua peralatan saji dan kerja dalam kondisi bersih (dapur, juicer, kasir, dinning)",
                "Grase Trap dan Gotter dalam kondisi bersih (dapur & juicer)",
                "Semua area dalam kondisi bersih meliputi semua dinding, semua kolong meja kerja, pendingin, meja makan dan bangku dan atau sofa dalam kondisi bersih",
                "Semua area bebas hama (tikus, kecoa, semut, lalat)",
                "Tea maker, Microwave, Toaster, Magic com, Mesin cup sealer, Mesin ice cube, Mesin cuci piring dalam kondisi off",
                "Exaust Pan, Kompor gas, kompor listrik  dalam kondisi off",
                "Valve Gas central, Valve kran air dalam kondisi off",
                "Lampu penerangan dan lampu  hias area dinning, dapur, juicer, kasir serta lampu logo dalam kondisi off",
                "Komputer admin, POS, Semua printer, Monitor checker, UPS dalam kondisi off",
                "Uang Omzet, Kas Kecil, Modal sudah masuk ke brangkas dan kodenya diputar acak",
                "Kipas Angin / AC, TV display, Audio player dalam kondisi off",
                "Tidak ada sampah yang tertinggal di dalam cabang",
                "Semua pintu dan jendela dalam kondisi terkunci"
            ];

            // Bangun items baru
            const baseItems = [];
            let idCounter = 1000;
            praList.forEach(n => baseItems.push({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'pra', status: 'aktif' }));
            duringList.forEach(n => baseItems.push({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'during', status: 'aktif' }));
            afterList.forEach(n => baseItems.push({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'after', status: 'aktif' }));

            // Gabungkan dengan item kustom (tanpa properti waktu)
            const custom = items.filter(i => !i.waktu);
            const merged = [...baseItems, ...custom];
            localStorage.setItem('checklistItems', JSON.stringify(merged));
            localStorage.setItem('checklistV2', '1');
        }
        function init() {
            // Pastikan data dasar terbuat lalu lakukan merge & cleanup sebelum menampilkan app
            ensureCloudConfigDefaults();
            initDefaultData();
            mergeUserDatabase();
            cleanupDefaultOutlets();
            ensureChecklistSchemaV2();
            // Remove duplicate outlets early
            try { dedupeOutlets(); } catch(e) {}

            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                setupUserSession();
                showMainApp();
            }
        }

        function initDefaultData() {
            if (!localStorage.getItem('outlets')) {
                localStorage.setItem('outlets', JSON.stringify([
                    { id: 'outlet-1', kode: 'OT001', nama: 'Outlet Sudirman', alamat: 'Jl. Sudirman No. 123', telp: '021-1234567', area: 'Jakarta Pusat', status: 'aktif' },
                    { id: 'outlet-2', kode: 'OT002', nama: 'Outlet Thamrin', alamat: 'Jl. Thamrin No. 456', telp: '021-2345678', area: 'Jakarta Pusat', status: 'aktif' },
                    { id: 'outlet-3', kode: 'OT003', nama: 'Outlet Kemang', alamat: 'Jl. Kemang Raya No. 789', telp: '021-3456789', area: 'Jakarta Selatan', status: 'aktif' },
                    { id: 'outlet-4', kode: 'OT004', nama: 'Outlet Kelapa Gading', alamat: 'Jl. Kelapa Gading No. 101', telp: '021-4567890', area: 'Jakarta Utara', status: 'aktif' },
                    { id: 'outlet-5', kode: 'OT005', nama: 'Outlet Bekasi', alamat: 'Jl. Ahmad Yani No. 202', telp: '021-5678901', area: 'Bekasi', status: 'aktif' },
                    { id: 'outlet-6', kode: 'OT006', nama: 'Outlet Depok', alamat: 'Jl. Margonda No. 303', telp: '021-6789012', area: 'Depok', status: 'aktif' },
                    { id: 'outlet-7', kode: 'OT007', nama: 'Outlet Bali Kuta', alamat: 'Jl. Kuta Beach No. 1', telp: '0361-123456', area: 'Bali', status: 'aktif' },
                    { id: 'outlet-8', kode: 'OT008', nama: 'Outlet Bali Seminyak', alamat: 'Jl. Seminyak No. 2', telp: '0361-234567', area: 'Bali', status: 'aktif' },
                    { id: 'outlet-9', kode: 'OT009', nama: 'Outlet Surabaya Tunjungan', alamat: 'Jl. Tunjungan No. 10', telp: '031-123456', area: 'Surabaya', status: 'aktif' },
                    { id: 'outlet-10', kode: 'OT010', nama: 'Outlet Surabaya Gubeng', alamat: 'Jl. Gubeng No. 20', telp: '031-234567', area: 'Surabaya', status: 'aktif' },
                    { id: 'outlet-11', kode: 'OT011', nama: 'Outlet Bandung Dago', alamat: 'Jl. Dago No. 100', telp: '022-123456', area: 'Bandung', status: 'aktif' },
                    { id: 'outlet-12', kode: 'OT012', nama: 'Outlet Bandung Braga', alamat: 'Jl. Braga No. 50', telp: '022-234567', area: 'Bandung', status: 'aktif' }
                ]));
            }
            if (!localStorage.getItem('checklistItems')) {
                localStorage.setItem('checklistItems', JSON.stringify([]));
            }
            // Migrasi/penjamin skema checklist (V2 - waktu: pra/during/after)
            ensureChecklistSchemaV2();
        }

        function mergeUserDatabase() {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            let outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            let needsUserSave = false;
            let needsOutletSave = false;

            // 1) Merge predefined users (Admin, Head Office, Area Manager, dll)
            Object.keys(userDatabase).forEach(role => {
                userDatabase[role].forEach(u => {
                    const existing = users.find(existing => existing.kode === u.kode);
                    if (!existing) {
                        users.push({
                            kode: u.kode,
                            nama: u.nama,
                            role: role,
                            outlets: u.outlets,
                            status: 'aktif'
                        });
                        needsUserSave = true;
                    } else {
                        // Update nama, role, dan outlets jika berubah agar sinkron dengan data terbaru
                        let updated = false;
                        if (existing.nama !== u.nama) { existing.nama = u.nama; updated = true; }
                        if (existing.role !== role) { existing.role = role; updated = true; }
                        if (existing.outlets !== u.outlets) { existing.outlets = u.outlets; updated = true; }
                        if (updated) needsUserSave = true;
                    }
                });
            });

            // 2) Tambah daftar Staff Outlet dari data yang diberikan
            const staffOutletList = [
                { nama: 'MM RS Mayapada Tangerang', kode: '065' },
                { nama: 'MM RS JEC Kedoya', kode: '024' },
                { nama: 'MM RS Carolus Sumarecon', kode: '046' },
                { nama: 'MM RS EMC Alam Sutera', kode: '033' },
                { nama: 'MM Bandara Soetta T 1B Keberangkatan', kode: '035' },
                { nama: 'MM Bandara Soetta T 2E Keberangkatan', kode: '073' },
                { nama: 'MM Bandara Soetta T 2F Keberangkatan', kode: '059' },
                { nama: 'MM Bandara Soetta T 3Int Kedatangan', kode: '044' },
                { nama: 'MM Villagio Sumarecon karawang', kode: '028' },
                { nama: 'MM RS Siloam Cikarang', kode: '038' },
                { nama: 'MM Green Terrace Taman Mini', kode: '022' },
                { nama: 'MM RS EMC Sentul', kode: 'sentul' },
                { nama: 'MM RS Mayapada Nusantara', kode: '055' },
                { nama: 'MM HO Fatmawati', kode: '201' },
                { nama: 'MM Plaza Bintaro', kode: '015' },
                { nama: 'MM RS Mayapada Kuningan', kode: '071' },
                { nama: 'MM RS Premier Bintaro', kode: '013' },
                { nama: 'MM Cikajang', kode: '062' },
                { nama: 'MM Hypesquare Taman Yasmin', kode: 'yasmin' },
                { nama: 'MM RSUPFatmawati', kode: '040' },
                { nama: 'MM RS Mayapada Cakung', kode: 'cakung' },
                { nama: 'MM Bandara Soetta T 1A Keberangkatan', kode: '069' },
                { nama: 'MM Bandara Soetta T 1C Keberangkatan', kode: 'mm1c' },
                { nama: 'PK Bandara Soetta T 1C Keberangkatan', kode: 'pk1c' },
                { nama: 'MM Bandara Soetta T 3 G 14 Keberangkatan', kode: 't3g14' },
                { nama: 'MM Bandara Soetta T 3 G 3 Kedatangan', kode: '074' },
                { nama: 'MM Melawai', kode: '001' },
                { nama: 'MM RS Hermina Kemayoran', kode: '031' },
                { nama: 'MM RS Pusat Pertamina', kode: '054' },
                { nama: 'MM EKA Hospital MT. Haryono', kode: 'eka' },
                { nama: 'MM Mal Puri Indah', kode: '014' },
                { nama: 'MM RS Pantai Indah Kapuk', kode: '008' },
                { nama: 'MM RSPAD Gatot Subroto', kode: '068' },
                { nama: 'MM RS EMC Pekayon', kode: 'pekayon' },
                { nama: 'MM PandanSari', kode: '018' },
                { nama: 'MM RS Mayapada Jaksel', kode: '010' },
                { nama: 'PK RS Mayapada Jaksel', kode: '007' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Kedatangan', kode: '009' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Keberangkatan', kode: 'hasanudin' },
                { nama: 'MM Bandara Juanda Surabaya', kode: '034' },
                { nama: 'MM Grand City Surabaya', kode: '003' },
                { nama: 'MM RS Husada Utama Surabaya', kode: '026' },
                { nama: 'MM RS Mayapada Surabaya', kode: '067' },
                { nama: 'MM RS Mitra Keluarga Waru', kode: '004' },
                { nama: 'MM RS Mitra Keluarga Sidoarjo', kode: 'sidoarjo' },
                { nama: 'MM RS Mitra Keluarga Darmo Satelit', kode: 'darmo' },
                { nama: 'MM Mal Sumarecon Bandung', kode: '025' },
                { nama: 'MM Paris Van Java', kode: '043' },
                { nama: 'MM Paskal 23 Square', kode: '056' },
                { nama: 'MM RS Mayapada Bandung', kode: '072' },
                { nama: 'MM RSUP dr.Hasan Sadikin Bandung', kode: '052' },
                { nama: 'MM Manado Town Square', kode: '048' },
                { nama: 'MM Mega Mas Manado', kode: '051' },
                { nama: 'MM Living World Bali', kode: '042' },
                { nama: 'PK Living World Bali', kode: '057' },
                { nama: 'MM Gatot Subroto Bali', kode: '053' },
                { nama: 'MM RSUP Prof. dr. I.G.N.G. Ngoerah', kode: '064' },
                { nama: 'MM RS Kasih Ibu', kode: '005' },
                { nama: 'MM Lippo Sunset Plaza', kode: '017' },
                { nama: 'MM Icon Bali', kode: '037' },
                { nama: 'PK Icon Bali', kode: '049' },
                { nama: 'MM Lippo Mal Kuta', kode: '047' },
                { nama: 'MM Plaza Renon Bali', kode: '061' },
                { nama: 'MM Mal Bali Galeria', kode: '029' },
                { nama: 'PK Mal Bali Galeria', kode: '020' },
                { nama: 'MM Beachwalk', kode: '063' },
                { nama: 'PK Beachwalk', kode: '070' },
                { nama: 'MM Teuku Umar', kode: '058' },
                { nama: 'MM Pepito Jimbaran Bali', kode: '041' }
            ];

            // Helper untuk membuat ID outlet konsisten & unik
            const slugify = (str) => str
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const codeSlug = (str) => (str || '').toLowerCase().replace(/[^a-z0-9]+/g, '');

            staffOutletList.forEach(entry => {
                const name = entry.nama.trim();
                const code = entry.kode.trim();

                // Cari outlet berdasarkan nama (case-insensitive)
                let outletObj = outlets.find(o => (o.nama || '').toLowerCase() === name.toLowerCase());
                if (!outletObj) {
                    const id = `outlet-${slugify(name)}-${codeSlug(code)}`.slice(0, 64);
                    outletObj = {
                        id,
                        kode: code.toUpperCase(),
                        nama: name,
                        alamat: '-',
                        telp: '-',
                        area: '-',
                        status: 'aktif'
                    };
                    outlets.push(outletObj);
                    needsOutletSave = true;
                }

                // Sinkronisasi user Staff Outlet berdasarkan nama (update kode/outlet bila perlu)
                const existingByName = users.find(u => u.role === 'outlet' && (u.nama || '').toLowerCase() === name.toLowerCase());
                if (existingByName) {
                    // Perbarui kode akses dan outlet assignment jika berbeda
                    if (existingByName.kode !== code) { existingByName.kode = code; needsUserSave = true; }
                    if (existingByName.outlets !== outletObj.id) { existingByName.outlets = outletObj.id; needsUserSave = true; }
                }

                // Tambah user Staff Outlet jika belum ada (berdasarkan kode)
                if (!users.find(u => u.kode === code)) {
                    users.push({
                        kode: code,
                        nama: name,
                        role: 'outlet',
                        outlets: outletObj.id,
                        status: 'aktif'
                    });
                    needsUserSave = true;
                }
            });

            // 2b) Tambah daftar Kepala Cabang dari data yang diberikan
            const kepalaCabangList = [
                { nama: 'MM RS Mayapada Tangerang', kode: '065a' },
                { nama: 'MM RS JEC Kedoya', kode: '024a' },
                { nama: 'MM RS Carolus Sumarecon', kode: '046a' },
                { nama: 'MM RS EMC Alam Sutera', kode: '033a' },
                { nama: 'MM Bandara Soetta T 1B Keberangkatan', kode: '035a' },
                { nama: 'MM Bandara Soetta T 2E Keberangkatan', kode: '073a' },
                { nama: 'MM Bandara Soetta T 2F Keberangkatan', kode: '059a' },
                { nama: 'MM Bandara Soetta T 3Int Kedatangan', kode: '044a' },
                { nama: 'MM Villagio Sumarecon karawang', kode: '028a' },
                { nama: 'MM RS Siloam Cikarang', kode: '038a' },
                { nama: 'MM Green Terrace Taman Mini', kode: '022a' },
                { nama: 'MM RS EMC Sentul', kode: '@sentul' },
                { nama: 'MM RS Mayapada Nusantara', kode: '055a' },
                { nama: 'MM HO Fatmawati', kode: '201a' },
                { nama: 'MM Plaza Bintaro', kode: '015a' },
                { nama: 'MM RS Mayapada Kuningan', kode: '071a' },
                { nama: 'MM RS Premier Bintaro', kode: '013a' },
                { nama: 'MM Cikajang', kode: '062a' },
                { nama: 'MM Hypesquare Taman Yasmin', kode: '@yasmin' },
                { nama: 'MM RSUPFatmawati', kode: '040a' },
                { nama: 'MM RS Mayapada Cakung', kode: '@cakung' },
                { nama: 'MM Bandara Soetta T 1A Keberangkatan', kode: '069a' },
                { nama: 'MM Bandara Soetta T 1C Keberangkatan', kode: '@mm1c' },
                { nama: 'PK Bandara Soetta T 1C Keberangkatan', kode: '@pk1c' },
                { nama: 'MM Bandara Soetta T 3 G 14 Keberangkatan', kode: '@t3g14' },
                { nama: 'MM Bandara Soetta T 3 G 3 Kedatangan', kode: '074a' },
                { nama: 'MM Melawai', kode: '001a' },
                { nama: 'MM RS Hermina Kemayoran', kode: '031a' },
                { nama: 'MM RS Pusat Pertamina', kode: '054a' },
                { nama: 'MM EKA Hospital MT. Haryono', kode: '@eka' },
                { nama: 'MM Mal Puri Indah', kode: '014a' },
                { nama: 'MM RS Pantai Indah Kapuk', kode: '008a' },
                { nama: 'MM RSPAD Gatot Subroto', kode: '068a' },
                { nama: 'MM RS EMC Pekayon', kode: '@pekayon' },
                { nama: 'MM PandanSari', kode: '018a' },
                { nama: 'MM RS Mayapada Jaksel', kode: '010a' },
                { nama: 'PK RS Mayapada Jaksel', kode: '007a' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Kedatangan', kode: '009a' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Keberangkatan', kode: '@hasanudin' },
                { nama: 'MM Bandara Juanda Surabaya', kode: '034a' },
                { nama: 'MM Grand City Surabaya', kode: '003a' },
                { nama: 'MM RS Husada Utama Surabaya', kode: '026a' },
                { nama: 'MM RS Mayapada Surabaya', kode: '067a' },
                { nama: 'MM RS Mitra Keluarga Waru', kode: '004a' },
                { nama: 'MM RS Mitra Keluarga Sidoarjo', kode: '@sidoarjo' },
                { nama: 'MM RS Mitra Keluarga Darmo Satelit', kode: '@darmo' },
                { nama: 'MM Mal Sumarecon Bandung', kode: '025a' },
                { nama: 'MM Paris Van Java', kode: '043a' },
                { nama: 'MM Paskal 23 Square', kode: '056a' },
                { nama: 'MM RS Mayapada Bandung', kode: '072a' },
                { nama: 'MM RSUP dr.Hasan Sadikin Bandung', kode: '052a' },
                { nama: 'MM Manado Town Square', kode: '048a' },
                { nama: 'MM Mega Mas Manado', kode: '051a' },
                { nama: 'MM Living World Bali', kode: '042a' },
                { nama: 'PK Living World Bali', kode: '057a' },
                { nama: 'MM Gatot Subroto Bali', kode: '053a' },
                { nama: 'MM RSUP Prof. dr. I.G.N.G. Ngoerah', kode: '064a' },
                { nama: 'MM RS Kasih Ibu', kode: '005a' },
                { nama: 'MM Lippo Sunset Plaza', kode: '017a' },
                { nama: 'MM Icon Bali', kode: '037a' },
                { nama: 'PK Icon Bali', kode: '049a' },
                { nama: 'MM Lippo Mal Kuta', kode: '047a' },
                { nama: 'MM Plaza Renon Bali', kode: '061a' },
                { nama: 'MM Mal Bali Galeria', kode: '029a' },
                { nama: 'PK Mal Bali Galeria', kode: '020a' },
                { nama: 'MM Beachwalk', kode: '063a' },
                { nama: 'PK Beachwalk', kode: '070a' },
                { nama: 'MM Teuku Umar', kode: '058a' },
                { nama: 'MM Pepito Jimbaran Bali', kode: '041a' }
            ];

            kepalaCabangList.forEach(entry => {
                const name = entry.nama.trim();
                const code = entry.kode.trim();

                // Cari outlet berdasarkan nama (case-insensitive)
                let outletObj = outlets.find(o => (o.nama || '').toLowerCase() === name.toLowerCase());
                if (!outletObj) {
                    // Buat outlet baru jika belum ada
                    const id = `outlet-${slugify(name)}-${codeSlug(code)}`.slice(0, 64);
                    outletObj = {
                        id,
                        kode: code.toUpperCase(),
                        nama: name,
                        alamat: '-',
                        telp: '-',
                        area: '-',
                        status: 'aktif'
                    };
                    outlets.push(outletObj);
                    needsOutletSave = true;
                }

                // Sinkronisasi user Kepala Cabang berdasarkan kode
                const existingByCode = users.find(u => u.kode === code);
                if (existingByCode) {
                    // Update role dan outlet jika diperlukan
                    if (existingByCode.role !== 'kepala-cabang') { existingByCode.role = 'kepala-cabang'; needsUserSave = true; }
                    if (existingByCode.outlets !== outletObj.id) { existingByCode.outlets = outletObj.id; needsUserSave = true; }
                    if (existingByCode.nama !== name) { existingByCode.nama = name; needsUserSave = true; }
                } else {
                    // Tambah user Kepala Cabang baru
                    users.push({
                        kode: code,
                        nama: name,
                        role: 'kepala-cabang',
                        outlets: outletObj.id,
                        status: 'aktif'
                    });
                    needsUserSave = true;
                }
            });

            // 3) Tambah/Update Area Manager berdasarkan mapping nama outlet -> kode AM dan nama AM
            const normalizeName = (s) => (s || '').toString().toLowerCase().replace(/\s+/g, ' ').trim();
            const outletNameIndex = {};
            outlets.forEach(o => { outletNameIndex[normalizeName(o.nama)] = o.id; });

            function findOutletIdByNameFuzzy(name) {
                if (!name) return null;
                let n = normalizeName(name);
                // perbaiki variasi umum
                n = n.replace(/^mm mm\s+/, 'mm ');
                let id = outletNameIndex[n];
                if (!id) {
                    // coba tambahkan/hilangkan prefix 'mm '
                    const withMM = n.startsWith('mm ') ? n : ('mm ' + n);
                    const withoutMM = n.replace(/^mm\s+/, '');
                    id = outletNameIndex[withMM] || outletNameIndex[withoutMM];
                }
                if (!id) {
                    // coba cocokkan dengan includes dua arah
                    const hit = outlets.find(o => {
                        const on = normalizeName(o.nama);
                        return on.includes(n) || n.includes(on);
                    });
                    if (hit) id = hit.id;
                }
                if (!id) {
                    // jika tetap tidak ditemukan, buat outlet baru agar assignment tidak gagal
                    const newId = `outlet-${slugify(name)}-${Math.random().toString(36).slice(2,8)}`.slice(0,64);
                    const outletObj = { id: newId, kode: '-', nama: name.trim(), alamat: '-', telp: '-', area: '-', status: 'aktif' };
                    outlets.push(outletObj);
                    outletNameIndex[normalizeName(name)] = newId;
                    needsOutletSave = true;
                    id = newId;
                }
                return id;
            }

            const areaManagerAssignments = [
                { kode: '1995120041', nama: 'Hartadi', outletsByName: [
                    'MM RS Mayapada Tangerang','MM RS JEC Kedoya','MM RS Carolus Sumarecon','MM RS EMC Alam Sutera','MM Bandara Soetta T 1B Keberangkatan','MM Bandara Soetta T 2E Keberangkatan','MM Bandara Soetta T 2F Keberangkatan','MM Bandara Soetta T 3Int Kedatangan','MM Villagio Sumarecon Karawang','MM RS Siloam Cikarang','MM Green Terrace Taman Mini','MM RS EMC Sentul','MM RS Mayapada Nusantara','MM HO Fatmawati','MM Plaza Bintaro','MM RS Mayapada Kuningan','MM RS Premier Bintaro','MM Cikajang','MM Hypesquare Taman Yasmin','MM RSUPFatmawati','MM RS Mayapada Cakung','MM Bandara Soetta T 1A Keberangkatan','MM Bandara Soetta T 1C Keberangkatan','PK Bandara Soetta T 1C Keberangkatan','MM Bandara Soetta T 3 G 14 Keberangkatan','MM Bandara Soetta T 3 G 3 Kedatangan','MM Melawai','MM RS Hermina Kemayoran','MM RS Pusat Pertamina','MM EKA Hospital MT. Haryono','MM Mal Puri Indah','MM RS Pantai Indah Kapuk','MM RSPAD Gatot Subroto','MM RS EMC Pekayon','MM Pandansari','MM RS Mayapada Jaksel','PK RS Mayapada Jaksel','MM Bandar Udara Sultan Hasanudin Kedatangan','MM Bandar Udara Sultan Hasanudin Keberangkatan','MM Bandara Juanda Surabaya','MM Grand City Surabaya','MM RS Husada Utama Surabaya','MM RS Mayapada Surabaya','MM RS Mitra Keluarga Waru','MM RS Mitra Keluarga Sidoarjo','MM RS Mitra Keluarga Darmo Satelit','MM Mal Sumarecon Bandung','MM Paris Van Java','MM Paskal 23 Square','MM RS Mayapada Bandung','MM RSUP dr.Hasan Sadikin Bandung','MM Living World Bali','PK Living World Bali','MM Gatot Subroto Bali','MM RSUP Prof. dr. I.G.N.G. Ngoerah','MM RS Kasih Ibu','MM Lippo Sunset Plaza','MM Icon Bali','PK Icon Bali','MM Lippo Mal Kuta','MM Plaza Renon Bali','MM Mal Bali Galeria','PK Mal Bali Galeria','MM Beachwalk','PK Beachwalk','MM Teuku Umar','MM Pepito Jimbaran Bali','MM Mega Mas Manado','Manado Town Square'
                ]},
                { kode: '1992080011', nama: 'Darwanto', outletsByName: [
                    'MM Bandara Soetta T 1B Keberangkatan','MM Bandara Soetta T 2E Keberangkatan','MM Bandara Soetta T 2F Keberangkatan','MM Bandara Soetta T 3Int Kedatangan'
                ]},
                { kode: '2009081950', nama: 'Suprianto', outletsByName: [
                    'MM Villagio Sumarecon Karawang','MM RS Siloam Cikarang','MM Green Terrace Taman Mini','MM RS EMC Sentul','MM RS Mayapada Nusantara'
                ]},
                { kode: '2016126353', nama: 'Deni Hormansyah', outletsByName: [
                    'MM HO Fatmawati','MM Plaza Bintaro','MM RS Mayapada Kuningan','MM RS Premier Bintaro'
                ]},
                { kode: '2015115648', nama: 'Budi Hari Santoso', outletsByName: [
                    'MM Cikajang','MM Hypesquare Taman Yasmin','MM RSUPFatmawati','MM RS Mayapada Cakung'
                ]},
                { kode: '2022050099', nama: 'Pujianto', outletsByName: [
                    'MM Bandara Soetta T 1A Keberangkatan','MM Bandara Soetta T 1C Keberangkatan','PK Bandara Soetta T 1C Keberangkatan','MM Bandara Soetta T 3 G 14 Keberangkatan','MM Bandara Soetta T 3 G 3 Kedatangan'
                ]},
                { kode: '2000110212', nama: 'Badrudin', outletsByName: [
                    'MM Melawai','MM RS Hermina Kemayoran','MM RS Pusat Pertamina','MM EKA Hospital MT. Haryono'
                ]},
                { kode: '2017036469', nama: 'Tri Prasetio', outletsByName: [
                    'MM Mal Puri Indah','MM RS Pantai Indah Kapuk','MM RSPAD Gatot Subroto','MM RS EMC Pekayon'
                ]},
                { kode: '2017126957', nama: 'Ahmad Fauzi', outletsByName: [
                    'MM Pandansari','MM RS Mayapada Jaksel','PK RS Mayapada Jaksel','MM Bandar Udara Sultan Hasanudin Kedatangan','MM Bandar Udara Sultan Hasanudin Keberangkatan'
                ]},
                { kode: '2016086072', nama: 'Khoirrudin', outletsByName: [
                    'MM Bandara Juanda Surabaya','MM Grand City Surabaya','MM RS Husada Utama Surabaya','MM RS Mayapada Surabaya','MM RS Mitra Keluarga Waru','MM RS Mitra Keluarga Sidoarjo','MM RS Mitra Keluarga Darmo Satelit'
                ]},
                { kode: '1999080142', nama: 'Dadan Dani', outletsByName: [
                    'MM Mal Sumarecon Bandung','MM Paris Van Java','MM Paskal 23 Square','MM RS Mayapada Bandung','MM RSUP dr.Hasan Sadikin Bandung'
                ]},
                { kode: '1997080076', nama: 'Ferdiyanto', outletsByName: [
                    'MM Living World Bali','PK Living World Bali','MM Gatot Subroto Bali','MM RSUP Prof. dr. I.G.N.G. Ngoerah','MM RS Kasih Ibu','MM Lippo Sunset Plaza','MM Icon Bali','PK Icon Bali','MM Lippo Mal Kuta','MM Plaza Renon Bali','MM Mal Bali Galeria','PK Mal Bali Galeria','MM Beachwalk','PK Beachwalk','MM Teuku Umar','MM Pepito Jimbaran Bali','MM Mega Mas Manado','Manado Town Square'
                ]},
                { kode: '2015115657', nama: 'Afifur Rahman', outletsByName: [
                    'MM Living World Bali','PK Living World Bali','MM Gatot Subroto Bali','MM RSUP Prof. dr. I.G.N.G. Ngoerah'
                ]},
                { kode: '2015115662', nama: 'Sunarto', outletsByName: [
                    'MM RS Kasih Ibu','MM Lippo Sunset Plaza','MM Icon Bali','PK Icon Bali'
                ]},
                { kode: '2018127754', nama: "Moh. Imam Ma'ruf Nahi Mungkar", outletsByName: [
                    'MM Lippo Mal Kuta','MM Plaza Renon Bali','MM Mal Bali Galeria','PK Mal Bali Galeria'
                ]},
                { kode: '2018037573', nama: 'I Made Swastika', outletsByName: [
                    'MM Beachwalk','PK Beachwalk','MM Teuku Umar','MM Pepito Jimbaran Bali'
                ]}
            ];

            areaManagerAssignments.forEach(am => {
                const ids = Array.from(new Set(am.outletsByName.map(findOutletIdByNameFuzzy).filter(Boolean)));
                const existing = users.find(u => u.kode === am.kode);
                if (existing) {
                    if (existing.role !== 'area-manager') { existing.role = 'area-manager'; }
                    if (existing.nama !== am.nama) { existing.nama = am.nama; }
                    existing.outlets = ids;
                    needsUserSave = true;
                } else {
                    users.push({ kode: am.kode, nama: am.nama, role: 'area-manager', outlets: ids, status: 'aktif' });
                    needsUserSave = true;
                }
            });

            if (needsOutletSave) {
                localStorage.setItem('outlets', JSON.stringify(outlets));
            }
            if (needsUserSave) {
                localStorage.setItem('users', JSON.stringify(users));
                // Sinkronkan currentUser jika ada perubahan pada data user
                try {
                    const cu = JSON.parse(localStorage.getItem('currentUser') || 'null');
                    if (cu) {
                        const upd = users.find(u => u.kode === cu.kode);
                        if (upd) {
                            const newCurrent = { kode: upd.kode, nama: upd.nama, role: upd.role, outlets: upd.outlets };
                            localStorage.setItem('currentUser', JSON.stringify(newCurrent));
                            currentUser = newCurrent;
                        }
                    }
                } catch (e) { /* ignore */ }
            }
        }

        // Deduplicate outlets by normalized name and fix user references
        function dedupeOutlets() {
            try {
                let outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
                if (!Array.isArray(outlets) || outlets.length === 0) return false;
                const normalize = (s) => (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
                const nameToKeepIdx = new Map();
                const idMap = {};
                outlets.forEach((o, idx) => {
                    const key = normalize(o.nama);
                    if (!key) return;
                    if (!nameToKeepIdx.has(key)) {
                        nameToKeepIdx.set(key, idx);
                    } else {
                        const keepIdx = nameToKeepIdx.get(key);
                        const keep = outlets[keepIdx];
                        const drop = o;
                        if (keep && drop && drop.id && keep.id && drop.id !== keep.id) {
                            idMap[drop.id] = keep.id;
                        }
                    }
                });
                const dupIds = Object.keys(idMap);
                if (!dupIds.length) return false;

                // Update users references
                let users = [];
                try { users = JSON.parse(localStorage.getItem('users') || '[]'); } catch(e) { users = []; }
                if (Array.isArray(users)) {
                    users.forEach(u => {
                        if (!u) return;
                        if (u.outlets === 'all') return;
                        if (Array.isArray(u.outlets)) {
                            u.outlets = Array.from(new Set(u.outlets.map(id => idMap[id] || id)));
                        } else if (u.outlets) {
                            u.outlets = idMap[u.outlets] || u.outlets;
                        }
                    });
                    localStorage.setItem('users', JSON.stringify(users));
                }

                // Also fix selectedOutlets/currentOutlet/allowedOutlets in current session
                if (currentUser) {
                    if (Array.isArray(selectedOutlets)) {
                        selectedOutlets = Array.from(new Set(selectedOutlets.map(id => idMap[id] || id)));
                    }
                    if (currentOutlet) currentOutlet = idMap[currentOutlet] || currentOutlet;
                    if (Array.isArray(allowedOutlets)) {
                        allowedOutlets = Array.from(new Set(allowedOutlets.map(id => idMap[id] || id)));
                    }
                }

                // Remove duplicate outlets
                const filtered = outlets.filter(o => !idMap[o.id]);
                localStorage.setItem('outlets', JSON.stringify(filtered));
                console.log(` Dedupe outlets: removed ${outlets.length - filtered.length} duplicates`);
                return true;
            } catch (e) {
                console.warn('Dedupe outlets failed:', e);
                return false;
            }
        }

        // ==================== LOGIN FUNCTIONS ====================
        function onRoleChange() {
            const role = document.getElementById('loginRole').value;
            const descDiv = document.getElementById('roleDescription');
            const descText = document.getElementById('roleDescText');
            const codeHint = document.getElementById('codeHint');
            
            if (role) {
                descDiv.classList.remove('hidden');
                descText.textContent = roleDescriptions[role];
                codeHint.textContent = 'Masukkan kode akses untuk role ' + getRoleName(role);
            } else {
                descDiv.classList.add('hidden');
                codeHint.textContent = '';
            }
            
            document.getElementById('loginError').classList.add('hidden');
        }

        function login() {
            const role = (document.getElementById('loginRole').value || '').trim();
            const code = (document.getElementById('loginCode').value || '').trim();
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');

            function showErr(msg){
                errorDiv.classList.remove('hidden');
                errorText.textContent = msg;
            }

            if (!role) return showErr('Silakan pilih role terlebih dahulu');
            if (!code) return showErr('Silakan masukkan kode akses');

            const roleNorm = role; // nilai di <select> sudah format mesin (admin, head-office, area-manager, kepala-cabang, outlet)

            function findUserByRoleAndCode(list){
                try {
                    return (list || []).find(u => u && String(u.kode).trim() === code && String(u.role).trim() === roleNorm);
                } catch(e){ return null; }
            }

            // 1) Cari di localStorage saat ini
            let users = [];
            try { users = JSON.parse(localStorage.getItem('users') || '[]'); } catch(e){ users = []; }
            let user = findUserByRoleAndCode(users);

            // 2) Jika tidak ada, merge user master bawaan lalu coba lagi
            if (!user) {
                try { mergeUserDatabase && mergeUserDatabase(); } catch(e) {}
                try { users = JSON.parse(localStorage.getItem('users') || '[]'); } catch(e){ users = []; }
                user = findUserByRoleAndCode(users);
            }

            // 3) Jika masih tidak ada, fallback ke daftar bawaan di userDatabase sesuai role
            if (!user) {
                try {
                    const fallbackList = (userDatabase && userDatabase[roleNorm]) ? userDatabase[roleNorm] : [];
                    const fb = (fallbackList || []).find(u => u && String(u.kode).trim() === code);
                    if (fb) {
                        user = { kode: fb.kode, nama: fb.nama, role: roleNorm, outlets: fb.outlets || (roleNorm==='head-office' || roleNorm==='admin' ? 'all' : []) , status: 'aktif' };
                        // Simpan ke local agar sesi berikutnya langsung ada
                        users.push(user);
                        try { localStorage.setItem('users', JSON.stringify(users)); } catch(e) {}
                    }
                } catch(e) {}
            }

            if (!user) {
                return showErr('Kode akses tidak valid untuk role ' + getRoleName(roleNorm));
            }

            // Set current user & lanjutkan
            currentUser = { kode: user.kode, nama: user.nama, role: user.role, outlets: user.outlets };
            try { localStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch(e){}

            // Pastikan sesi disiapkan dan app ditampilkan
            try { setupUserSession && setupUserSession(); } catch(e){}
            showMainApp();
        }

        function setupUserSession() {
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');

            // Determine allowed outlets based on role
            if (currentUser.role === 'admin' || currentUser.role === 'head-office' || currentUser.outlets === 'all') {
                allowedOutlets = outlets.map(o => o.id);
            } else if (Array.isArray(currentUser.outlets)) {
                allowedOutlets = currentUser.outlets;
            } else {
                allowedOutlets = [currentUser.outlets];
            }

            // Set view only mode for head-office
            isViewOnly = (currentUser.role === 'head-office');

            // Legacy single outlet fallback
            currentOutlet = allowedOutlets[0];

            // Restore multi-selection for Admin/HO/AM from localStorage (persist per user)
            const isMultiRole = ['admin','head-office','area-manager'].includes(currentUser.role);
            if (isMultiRole) {
                const key = `selectedOutlets.${currentUser.role}.${currentUser.kode}`;
                const saved = JSON.parse(localStorage.getItem(key) || 'null');
                // Use intersection of saved with allowedOutlets, fallback to all allowed
                if (Array.isArray(saved) && saved.length) {
                    const setAllowed = new Set(allowedOutlets);
                    const filtered = saved.filter(id => setAllowed.has(id));
                    selectedOutlets = filtered.length ? filtered : [...allowedOutlets];
                } else {
                    selectedOutlets = [...allowedOutlets];
                }
                // Ensure currentOutlet is within selectedOutlets
                if (!selectedOutlets.includes(currentOutlet)) currentOutlet = selectedOutlets[0] || currentOutlet;
            } else {
                selectedOutlets = null;
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            allowedOutlets = [];
            isViewOnly = false;
            location.reload();
        }

        // ==================== MAIN APP ====================
        function showMainApp() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.nama;
            document.getElementById('userRole').textContent = getRoleName(currentUser.role);
            
            // Set access mode label (use roleDescriptions for detailed text)
            const accessLabel = document.getElementById('accessModeLabel');
            accessLabel.textContent = roleDescriptions[currentUser.role] || 'Mode Akses';
            
            // Set access badge (disembunyikan via CSS, tetap set untuk konsistensi state)
            const accessBadge = document.getElementById('accessBadge');
            if (isViewOnly) {
                accessBadge.textContent = 'VIEW ONLY';
                accessBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700';
            } else {
                accessBadge.textContent = 'DAPAT MENGUBAH';
                accessBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
            }
            
            populateOutletSelector();
            applyRolePermissions();
            applyViewOnlyMode();
            updateDashboardDate();

            // Tarik dari cloud terlebih dahulu agar lintas-perangkat konsisten, baru render dashboard
            if (isCloudConfigured()) {
                hideCloudAlert();
                pullDataFromCloud().then(() => {
                    loadDashboard();
                    autoCloudStart();
                }).catch(() => {
                    loadDashboard();
                    autoCloudStart();
                });
            } else {
                showCloudAlert();
                loadDashboard();
            }
        }

        function populateOutletSelector() {
            const select = document.getElementById('activeOutletSelect');
            const multiWrap = document.getElementById('multiOutletSelector');
            const multiBtn = document.getElementById('multiOutletBtn');
            const optionsBox = document.getElementById('multiOutletOptions');
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');

            const isMultiRole = ['admin','head-office','area-manager'].includes(currentUser.role);
            if (isMultiRole) {
                // Show multi selector, hide single select
                if (multiWrap) multiWrap.classList.remove('hidden');
                if (select) select.classList.add('hidden');

                // Build options (checkboxes)
                if (optionsBox) {
                    const list = outlets.filter(o => allowedOutlets.includes(o.id));
                    optionsBox.innerHTML = list.map(o => {
                        const checked = !selectedOutlets || selectedOutlets.includes(o.id) ? 'checked' : '';
                        const dataName = (o.nama || '').toLowerCase();
                        return `<label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50" data-name="${dataName}">
                            <input type="checkbox" class="outlet-check" value="${o.id}" ${checked}>
                            <span class="text-sm text-gray-700 truncate">${o.nama}</span>
                        </label>`;
                    }).join('');
                }

                // Update button label summary
                if (multiBtn) {
                    const list = outlets.filter(o => allowedOutlets.includes(o.id));
                    const mapName = (id)=> (list.find(x=>x.id===id)||{}).nama || id;
                    const sel = (selectedOutlets && selectedOutlets.length) ? selectedOutlets : allowedOutlets;
                    let label = 'Semua Outlet';
                    if (sel.length === 1) label = mapName(sel[0]);
                    else if (sel.length > 1 && sel.length < list.length) label = `${sel.length} Outlet dipilih`;
                    else if (sel.length === list.length) label = 'Semua Outlet';
                    multiBtn.textContent = label;
                }
            } else {
                // Show single select
                if (multiWrap) multiWrap.classList.add('hidden');
                if (select) {
                    select.classList.remove('hidden');
                    select.innerHTML = '';
                    outlets.filter(o => allowedOutlets.includes(o.id)).forEach(o => {
                        const option = document.createElement('option');
                        option.value = o.id;
                        option.textContent = o.nama;
                        if (o.id === currentOutlet) option.selected = true;
                        select.appendChild(option);
                    });
                }
            }
        }

        function changeActiveOutlet() {
            currentOutlet = document.getElementById('activeOutletSelect').value;
            // Reload current module
            const activeModule = document.querySelector('.module-section.active');
            if (activeModule) {
                const moduleId = activeModule.id.replace('module-', '');
                loadModuleData(moduleId);
            }
        }

        function toggleMultiOutletPanel() {
            const panel = document.getElementById('multiOutletPanel');
            if (!panel) return;
            panel.classList.toggle('hidden');

            // Attach/detach outside click to close
            const handler = (e) => {
                if (!panel.classList.contains('hidden')) {
                    const btn = document.getElementById('multiOutletBtn');
                    if (!panel.contains(e.target) && !btn.contains(e.target)) {
                        panel.classList.add('hidden');
                        document.removeEventListener('click', handler);
                    }
                }
            };
            if (!panel.classList.contains('hidden')) {
                setTimeout(() => document.addEventListener('click', handler), 0);
            }
        }

        function selectAllOutlets() {
            const checks = document.querySelectorAll('#multiOutletOptions .outlet-check');
            checks.forEach(c => c.checked = true);
        }

        function deselectAllOutlets() {
            const checks = document.querySelectorAll('#multiOutletOptions .outlet-check');
            checks.forEach(c => c.checked = false);
        }

        function applySelectedOutlets() {
            const checks = document.querySelectorAll('#multiOutletOptions .outlet-check');
            const sel = Array.from(checks).filter(c => c.checked).map(c => c.value);
            selectedOutlets = sel.length ? sel : [...allowedOutlets];

            // Persist selection per user
            try {
                const key = `selectedOutlets.${currentUser.role}.${currentUser.kode}`;
                localStorage.setItem(key, JSON.stringify(selectedOutlets));
            } catch (e) {}

            // Ensure legacy currentOutlet stays within selection for single-outlet modules
            if (selectedOutlets && selectedOutlets.length) {
                if (!selectedOutlets.includes(currentOutlet)) {
                    currentOutlet = selectedOutlets[0];
                }
            }
            // Update summary label
            populateOutletSelector();
            toggleMultiOutletPanel();
            // Reload current module
            const activeModule = document.querySelector('.module-section.active');
            if (activeModule) {
                const moduleId = activeModule.id.replace('module-', '');
                loadModuleData(moduleId);
            }
        }

        function filterMultiOutletOptions() {
            const q = (document.getElementById('multiOutletSearch')?.value || '').toLowerCase().trim();
            const items = document.querySelectorAll('#multiOutletOptions > label');
            items.forEach(el => {
                const n = el.getAttribute('data-name') || '';
                el.style.display = !q || n.includes(q) ? '' : 'none';
            });
        }

        function getRoleName(role) {
            const names = {
                'admin': 'Administrator',
                'head-office': 'Head Office',
                'area-manager': 'Area Manager',
                'kepala-cabang': 'Kepala Cabang',
                'outlet': 'Staff Outlet'
            };
            return names[role] || role;
        }

        function applyRolePermissions() {
            const permissions = rolePermissions[currentUser.role] || [];
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const onclick = link.getAttribute('onclick');
                if (onclick) {
                    const match = onclick.match(/'([^']+)'/);
                    if (match) {
                        const module = match[1];
                        if (!permissions.includes(module)) {
                            link.style.display = 'none';
                        }
                    }
                }
            });
            
            // Sembunyikan seluruh menu Pengaturan untuk role non-admin
            if (currentUser.role !== 'admin') {
                document.getElementById('settingsMenu').style.display = 'none';
            }
        }

        function applyViewOnlyMode() {
            const addButtons = [
                'btnAddJadwal', 'btnAddTugas', 'btnAddPrep', 'btnAddReject',
                'btnAddInv', 'btnOutStock', 'btnAddLog', 'btnAddFeedback', 'btnAddChecklist',
                'btnAddOutlet', 'btnAddUser'
            ];
            
            addButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    if (isViewOnly) {
                        btn.classList.add('btn-disabled');
                        btn.onclick = null;
                    }
                }
            });

            // Head Office: pastikan tombol Export PDF tetap terlihat (monitoring butuh export)
            if (currentUser && currentUser.role === 'head-office') {
                ['btnExportJadwal','btnExportTugas','btnExportPreparation','btnExportChecklist','btnExportReject','btnExportFeedback'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.style.display = '';
                });
            }

            // Hide action columns for view only
            if (isViewOnly) {
                const style = document.createElement('style');
                style.textContent = '.action-column { display: none !important; }';
                document.head.appendChild(style);
            }
            
            // Pembatasan khusus untuk Staff Outlet
            if (currentUser && currentUser.role === 'outlet') {
                // Tombol yang harus disembunyikan untuk Staff Outlet
                const hideForOutlet = [
                    'btnExportJadwal', 'btnAddJadwal',      // Jadwal Kerja: hanya lihat, tidak bisa export/tambah
                    'btnExportTugas', 'btnAddTugas',        // Tugas Harian: hanya lihat, tidak bisa export/tambah
                    'btnExportPreparation', 'btnAddPrep',   // Preparation: hanya lihat, tidak bisa export/tambah
                    'btnExportChecklist',                   // Checklist: tidak bisa export
                    'btnExportReject',                      // Reject: tidak bisa export
                    'btnExportFeedback'                     // Feedback: tidak bisa export
                ];
                
                hideForOutlet.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.style.display = 'none';
                    }
                });
                
                // Sembunyikan kolom aksi pada jadwal kerja untuk staff outlet
                const style = document.createElement('style');
                style.id = 'outlet-restrictions';
                style.textContent = `
                    #module-jadwal-kerja .action-column { display: none !important; }
                    #module-tugas-harian button[onclick*="deleteTugas"] { display: none !important; }
                    #module-preparation .action-column { display: none !important; }
                `;
                document.head.appendChild(style);
            }

            // Pembatasan khusus untuk Area Manager: tidak bisa tambah data pada modul tertentu
            if (currentUser && currentUser.role === 'area-manager') {
                ['btnAddJadwal','btnAddTugas','btnAddPrep','btnAddReject'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.style.display = 'none';
                });
            }
        }

        // ==================== NAVIGATION ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function showModule(module) {
            currentModule = module;
            document.querySelectorAll('.module-section').forEach(s => s.classList.remove('active'));
            document.getElementById('module-' + module).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            event.target.closest('.sidebar-link')?.classList.add('active');
            
            if (window.innerWidth < 1024) toggleSidebar();
            
            // Pull ringan saat pindah modul jika sudah lebih 30 detik
            try {
                const last = Number(localStorage.getItem('lastCloudPullAt') || '0');
                if (isCloudConfigured() && Date.now() - last > 30000) {
                    pullDataFromCloud();
                }
            } catch (e) {}

            loadModuleData(module);
        }

        function loadModuleData(module) {
            switch(module) {
                case 'dashboard': loadDashboard(); break;
                case 'jadwal-kerja': loadJadwal(); updateSchedulePeriodLabel(); break;
                case 'tugas-harian': loadTugas(); break;
                case 'preparation': loadPreparation(); break;
                case 'checklist': loadChecklist(); break;
                case 'reject': loadReject(); break;
                case 'inventori': loadInventori(); break;
                case 'logbook': loadLogbook(); break;
                case 'feedback': loadFeedback(); break;
                case 'settings-checklist': loadChecklistSettings(); break;
                case 'settings-outlet': loadOutlets(); break;
                case 'settings-users': loadUsers(); break;
                case 'spreadsheet': loadSpreadsheetConfig(); break;
                case 'guidelines': /* static, no data loader needed */ break;
            }
        }
        
        function loadSpreadsheetConfig() {
            const config = JSON.parse(localStorage.getItem('spreadsheetConfig') || '{}');
            document.getElementById('webAppUrl').value = config.webAppUrl || '';
            document.getElementById('spreadsheetId').value = config.spreadsheetId || '';
            document.getElementById('apiKey').value = config.apiKey || '';
            
            // Show connection status
            const statusDiv = document.getElementById('connectionStatus');
            const statusIcon = document.getElementById('connStatusIcon');
            const statusText = document.getElementById('connStatusText');
            
            if (config.webAppUrl) {
                statusDiv.classList.remove('hidden');
                statusIcon.className = 'w-4 h-4 rounded-full bg-green-500';
                statusText.textContent = 'URL terkonfigurasi. Klik "Test & Sync" untuk memverifikasi.';
                statusText.className = 'text-sm text-green-600';
            } else {
                statusDiv.classList.remove('hidden');
                statusIcon.className = 'w-4 h-4 rounded-full bg-yellow-500';
                statusText.textContent = 'Belum dikonfigurasi. Masukkan Web App URL.';
                statusText.className = 'text-sm text-yellow-600';
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(id) {
            // Blok tambah data untuk Head Office (view only) dan Area Manager pada modul tertentu
            if (isViewOnly) {
                showToast('Mode View Only - Tidak dapat menambah data');
                return;
            }
            if (currentUser && currentUser.role === 'area-manager') {
                const blocked = ['modalJadwal','modalTugas','modalPreparation','modalReject'];
                if (blocked.includes(id)) {
                    showToast('Area Manager tidak dapat menambah data pada modul ini');
                    return;
                }
            }
            if (id === 'modalJadwal') {
                // Default tanggal ke periode berjalan (tgl 21) bila kosong
                const { start } = getSchedulePeriod();
                const input = document.getElementById('jadwalTanggal');
                if (input && !input.value) {
                    input.value = toYMD(start);
                }
            }
            if (id === 'modalTugas') {
                // Isi daftar assignee dari jadwal periode aktif (21 s.d. 20)
                populateAssigneeOptions();
            }
            if (id === 'modalPreparation') {
                // Isi daftar petugas dari Jadwal Kerja periode aktif (21 s.d. 20)
                populatePrepPetugasOptions();
            }
            if (id === 'modalInventori') {
                // Build options nama barang dan set default tanggal
                const sel = document.getElementById('invNama');
                if (sel) {
                    sel.innerHTML = optionsBarang();
                    onInvNamaChange();
                }
                const tMasuk = document.getElementById('invTglMasuk');
                if (tMasuk && !tMasuk.value) tMasuk.value = toYMD(new Date());
            }
            if (id === 'modalOutStock') {
                const sel = document.getElementById('outNama');
                if (sel) {
                    // Hanya tampilkan barang yang ada di inventori outlet aktif
                    const inv = JSON.parse(localStorage.getItem('inventori') || '[]')
                        .filter(i => i.outlet === currentOutlet && Number(i.jumlah) > 0);
                    const uniqueNames = [...new Set(inv.map(i => i.nama))].sort((a,b) => a.localeCompare(b, 'id'));
                    if (uniqueNames.length === 0) {
                        sel.innerHTML = '<option value="">(Tidak ada stok tersedia)</option>';
                    } else {
                        sel.innerHTML = uniqueNames.map(n => `<option value="${n}">${n}</option>`).join('');
                    }
                    onOutNamaChange();
                }
            }
            document.getElementById(id).classList.remove('hidden');
        }
        
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // ==================== DASHBOARD ====================
        function updateDashboardDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dashboardDate').textContent = new Date().toLocaleDateString('id-ID', options);
        }

        function loadDashboard() {
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            const today = new Date();
            const todayKeyStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const todayTugas = tugas.filter(t => t.tanggal === todayKeyStr && t.outlet === currentOutlet);
            const completedTugas = todayTugas.filter(t => t.selesai).length;
            document.getElementById('statTugas').textContent = `${completedTugas}/${todayTugas.length}`;
            document.getElementById('progressTugas').style.width = todayTugas.length ? (completedTugas/todayTugas.length*100)+'%' : '0%';

            // Checklist progress: OK counted, Not OK counted only if corrective action is filled
            const statusMap = JSON.parse(localStorage.getItem('checklistStatus') || '{}');
            const correctiveMap = JSON.parse(localStorage.getItem('checklistCorrective') || '{}');
            const checklistItems = JSON.parse(localStorage.getItem('checklistItems') || '[]');
            const baseKey = `${todayKeyStr}_${currentOutlet}`;
            const keys = [`${baseKey}_pra`, `${baseKey}_during`, `${baseKey}_after`];
            const totalChecklist = checklistItems.filter(i => i.waktu).length;
            let counted = 0;
            keys.forEach(k => {
                const obj = statusMap[k] || {};
                const corr = correctiveMap[k] || {};
                Object.entries(obj).forEach(([id, val]) => {
                    if (val === 'ok') counted++;
                    else if (val === 'not_ok') {
                        const tx = (corr[id] || '').trim();
                        if (tx) counted++;
                    }
                });
            });
            const checklistPercent = totalChecklist ? Math.round(counted/totalChecklist*100) : 0;
            document.getElementById('statChecklist').textContent = checklistPercent + '%';
            document.getElementById('progressChecklist').style.width = checklistPercent + '%';

            const reject = JSON.parse(localStorage.getItem('reject') || '[]');
            const todayReject = reject.filter(r => r.tanggal === todayKeyStr && r.outlet === currentOutlet);
            document.getElementById('statReject').textContent = todayReject.length;

            const feedback = JSON.parse(localStorage.getItem('feedback') || '[]');
            const outletFeedback = feedback.filter(f => f.outlet === currentOutlet);
            const avgRating = outletFeedback.length ? (outletFeedback.reduce((a,b) => a+b.rating, 0)/outletFeedback.length).toFixed(1) : '0.0';
            document.getElementById('statRating').textContent = avgRating;
            
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<i class="${i <= Math.round(avgRating) ? 'fas' : 'far'} fa-star"></i>`;
            }
            document.getElementById('starsRating').innerHTML = starsHtml;

            loadRecentActivities();
            loadExpiringItems();

            // Head Office / Area Manager / Admin extension
            if (currentUser && (['head-office','area-manager','admin'].includes(currentUser.role))) {
                loadDashboardHO();
            } else {
                const ho = document.getElementById('hoDashboard');
                if (ho) ho.classList.add('hidden');
            }
        }

        function loadRecentActivities() {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]')
                .filter(a => a.outlet === currentOutlet);
            const container = document.getElementById('recentActivities');
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>';
                return;
            }
            container.innerHTML = activities.slice(-5).reverse().map(a => `
                <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 ${a.type === 'tugas' ? 'bg-blue-100 text-blue-600' : a.type === 'checklist' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'} rounded-full flex items-center justify-center">
                        <i class="fas ${a.type === 'tugas' ? 'fa-tasks' : a.type === 'checklist' ? 'fa-check' : 'fa-clock'} text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">${a.message}</p>
                        <p class="text-xs text-gray-500">${a.time}</p>
                    </div>
                </div>
            `).join('');
        }

        function loadExpiringItems() {
            const inventori = JSON.parse(localStorage.getItem('inventori') || '[]');
            const now = new Date();
            const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
            const warningLocal = new Date(todayLocal.getTime() + 7 * 24 * 60 * 60 * 1000);
            const expiring = inventori.filter(i => {
                const expDate = parseLocalDate(i.tglExpired);
                return expDate && expDate <= warningLocal && expDate >= todayLocal && i.outlet === currentOutlet;
            });
            
            const container = document.getElementById('expiringItems');
            if (expiring.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada item mendekati expired</p>';
                return;
            }
            container.innerHTML = expiring.map(i => `
                <div class="flex items-center justify-between p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-800">${i.nama}</p>
                        <p class="text-sm text-gray-500">Batch: ${i.batch} | Qty: ${i.jumlah}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-yellow-600">Exp: ${formatDate(i.tglExpired)}</p>
                    </div>
                </div>
            `).join('');
        }

        // Head Office: Multi-Outlet summary, ranking, alerts
        function loadDashboardHO() {
            const hoWrapper = document.getElementById('hoDashboard');
            if (!hoWrapper) return;
            hoWrapper.classList.remove('hidden');

            const outletsAll = JSON.parse(localStorage.getItem('outlets') || '[]');
            const useIds = (selectedOutlets && selectedOutlets.length) ? selectedOutlets : (allowedOutlets || []);
            const outlets = outletsAll.filter(o => useIds.includes(o.id));

            // Scope label
            const scopeEl = document.getElementById('hoOutletScope');
            if (scopeEl) {
                if (outlets.length === 0) scopeEl.textContent = 'Tidak ada outlet dipilih';
                else if (outlets.length === 1) scopeEl.textContent = outlets[0].nama;
                else scopeEl.textContent = `${outlets.length} outlet dipilih`;
            }

            // Title label
            const titleEl = document.getElementById('hoTitle');
            if (titleEl) {
                if (currentUser.role === 'head-office') titleEl.textContent = 'Ringkasan Multi-Outlet (Head Office)';
                else if (currentUser.role === 'area-manager') titleEl.textContent = 'Ringkasan Multi-Outlet (Area Manager)';
                else if (currentUser.role === 'admin') titleEl.textContent = 'Ringkasan Multi-Outlet (Admin)';
                else titleEl.textContent = 'Ringkasan Multi-Outlet';
            }

            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            const feedback = JSON.parse(localStorage.getItem('feedback') || '[]');
            const reject = JSON.parse(localStorage.getItem('reject') || '[]');
            const inventori = JSON.parse(localStorage.getItem('inventori') || '[]');
            const checklistItems = JSON.parse(localStorage.getItem('checklistItems') || '[]').filter(i => i.waktu);
            const statusMap = JSON.parse(localStorage.getItem('checklistStatus') || '{}');
            const correctiveMap = JSON.parse(localStorage.getItem('checklistCorrective') || '{}');

            const today = new Date();
            const todayKeyStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const baseKeys = (outletId) => [`${todayKeyStr}_${outletId}_pra`, `${todayKeyStr}_${outletId}_during`, `${todayKeyStr}_${outletId}_after`];
            const totalChecklist = checklistItems.length;

            // KPI: Tugas Hari Ini
            const tugasToday = tugas.filter(t => useIds.includes(t.outlet) && t.tanggal === todayKeyStr);
            const tugasDone = tugasToday.filter(t => t.selesai).length;
            document.getElementById('hoStatTugas').textContent = `${tugasDone}/${tugasToday.length}`;
            document.getElementById('hoProgressTugas').style.width = tugasToday.length ? (tugasDone/tugasToday.length*100)+'%' : '0%';

            // KPI: Checklist Progress (OK + Not OK dgn CAPA)
            let counted = 0; let total = totalChecklist * (outlets.length || 1);
            outlets.forEach(o => {
                baseKeys(o.id).forEach(k => {
                    const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                    Object.entries(obj).forEach(([id, val]) => {
                        if (val === 'ok') counted++;
                        else if (val === 'not_ok') {
                            const tx = (corr[id] || '').trim();
                            if (tx) counted++;
                        }
                    });
                });
            });
            const checklistPercent = total ? Math.round(counted/total*100) : 0;
            document.getElementById('hoStatChecklist').textContent = checklistPercent + '%';
            document.getElementById('hoProgressChecklist').style.width = checklistPercent + '%';

            // KPI: Outlets Melapor (punya aktivitas hari ini)
            const reportingSet = new Set();
            outlets.forEach(o => {
                const hasTugas = tugasToday.some(t => t.outlet === o.id);
                const hasReject = reject.some(r => r.outlet === o.id && r.tanggal === todayKeyStr);
                const hasChecklist = baseKeys(o.id).some(k => Object.keys(statusMap[k]||{}).length > 0);
                const hasFeedback = feedback.some(f => f.outlet === o.id && f.tanggal === todayKeyStr);
                if (hasTugas || hasReject || hasChecklist || hasFeedback) reportingSet.add(o.id);
            });
            const cov = Math.round((reportingSet.size / (outlets.length || 1)) * 100);
            const covRing = document.getElementById('hoCoverageRing');
            if (covRing) covRing.style.background = `conic-gradient(#10b981 ${cov}%, #e5e7eb 0)`;
            const covNum = document.getElementById('hoOutletsReporting');
            const covTot = document.getElementById('hoOutletsTotal');
            if (covNum) covNum.textContent = String(reportingSet.size);
            if (covTot) covTot.textContent = String(outlets.length);

            // KPI: Pending CAPA & Feedback negatif hari ini
            let capaPending = 0; let negFb = 0;
            outlets.forEach(o => {
                baseKeys(o.id).forEach(k => {
                    const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                    Object.entries(obj).forEach(([id, val]) => {
                        if (val === 'not_ok' && !(corr[id]||'').trim()) capaPending++;
                    });
                });
                feedback.forEach(f => {
                    if (f.outlet === o.id && f.tanggal === todayKeyStr) {
                        if ((f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas') negFb++;
                    }
                });
            });
            const capaEl = document.getElementById('hoCapaPending');
            if (capaEl) capaEl.textContent = String(capaPending);
            const negFbEl = document.getElementById('hoNegFeedback');
            if (negFbEl) negFbEl.textContent = String(negFb);

            // Ranking Outlet (60% checklist, 30% rating, -10*reject)
            const outletScores = outlets.map(o => {
                let cCount = 0;
                baseKeys(o.id).forEach(k => {
                    const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                    Object.entries(obj).forEach(([id, val]) => {
                        if (val === 'ok') cCount++;
                        else if (val === 'not_ok') { const tx = (corr[id]||'').trim(); if (tx) cCount++; }
                    });
                });
                const cPct = totalChecklist ? (cCount/totalChecklist*100) : 0;
                const fb = feedback.filter(f => f.outlet === o.id);
                const rAvg = fb.length ? (fb.reduce((a,b)=>a+b.rating,0)/fb.length) : 0;
                const rj = reject.filter(r => r.outlet === o.id && r.tanggal === todayKeyStr).length;
                const score = (0.6*cPct) + (0.3*rAvg*20) - (10*rj);
                return { id: o.id, nama: o.nama, cPct: Math.round(cPct), rAvg: rAvg.toFixed(1), rj, score };
            }).sort((a,b) => b.score - a.score);

            const rankBody = document.getElementById('hoRankingBody');
            rankBody.innerHTML = outletScores.slice(0, 10).map(r => `
                <tr>
                    <td class="px-4 py-2 text-sm text-gray-900">${r.nama}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${r.cPct}%</td>
                    <td class="px-4 py-2 text-sm text-red-600">${r.rj}</td>
                    <td class="px-4 py-2 text-sm text-yellow-600">${r.rAvg}</td>
                </tr>
            `).join('');

            // Alerts
            const alerts = [];
            outlets.forEach(o => {
                let cCount = 0;
                baseKeys(o.id).forEach(k => {
                    const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                    Object.entries(obj).forEach(([id, val]) => {
                        if (val === 'ok') cCount++;
                        else if (val === 'not_ok') { const tx = (corr[id]||'').trim(); if (tx) cCount++; }
                    });
                });
                if (cCount === 0 && totalChecklist > 0) alerts.push({ type:'checklist', msg:`Checklist hari ini belum diisi di ${o.nama}` });
            });
            const nowLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 12,0,0,0);
            inventori.forEach(i => {
                const exp = parseLocalDate(i.tglExpired);
                if (exp && exp < nowLocal && useIds.includes(i.outlet)) alerts.push({ type: 'expired', msg:`Stok EXP: ${i.nama} (Outlet: ${(outlets.find(o=>o.id===i.outlet)||{}).nama || i.outlet})`});
            });
            feedback.forEach(f => {
                const neg = (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas';
                if (neg && f.tanggal === todayKeyStr && useIds.includes(f.outlet)) {
                    alerts.push({ type:'feedback', msg:`Feedback negatif di ${(outlets.find(o=>o.id===f.outlet)||{}).nama || f.outlet}` });
                }
            });
            const alertWrap = document.getElementById('hoAlertsList');
            alertWrap.innerHTML = alerts.length ? alerts.slice(0, 12).map(a => {
                const icon = a.type==='checklist' ? 'fa-clipboard-check text-orange-500' : a.type==='expired' ? 'fa-exclamation-triangle text-red-500' : 'fa-comment-dots text-pink-500';
                const bg = a.type==='checklist' ? 'bg-orange-50 border-orange-200' : a.type==='expired' ? 'bg-red-50 border-red-200' : 'bg-pink-50 border-pink-200';
                return `<div class="p-3 border ${bg} rounded-lg text-sm flex items-start gap-2"><i class="fas ${icon} mt-0.5"></i><span class="text-gray-700">${a.msg}</span></div>`;
            }).join('') : '<p class="text-gray-500 text-center py-4">Tidak ada alert</p>';

            // Coverage table per outlet
            const covBody = document.getElementById('hoCoverageBody');
            if (covBody) {
                covBody.innerHTML = outlets.map(o => {
                    // checklist percent per outlet
                    let cCount = 0;
                    baseKeys(o.id).forEach(k => {
                        const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                        Object.entries(obj).forEach(([id, val]) => {
                            if (val === 'ok') cCount++;
                            else if (val === 'not_ok') { const tx = (corr[id]||'').trim(); if (tx) cCount++; }
                        });
                    });
                    const cPct = totalChecklist ? Math.round(cCount/totalChecklist*100) : 0;
                    const tDone = tugasToday.filter(t => t.outlet === o.id && t.selesai).length;
                    const tTotal = tugasToday.filter(t => t.outlet === o.id).length;
                    const rj = reject.filter(r => r.outlet === o.id && r.tanggal === todayKeyStr).length;
                    const fb = feedback.filter(f => f.outlet === o.id);
                    const rAvg = fb.length ? (fb.reduce((a,b)=>a+b.rating,0)/fb.length).toFixed(1) : '-';
                    const status = cPct >= 80 && rj === 0 ? 'Sehat' : (cPct >= 50 ? 'Perlu Perhatian' : 'Kritis');
                    const statusClass = status === 'Sehat' ? 'bg-green-100 text-green-700' : status === 'Perlu Perhatian' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700';
                    return `<tr>
                        <td class="px-4 py-2 text-sm text-gray-900">${o.nama}</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${cPct}%</td>
                        <td class="px-4 py-2 text-sm text-gray-700">${tDone}/${tTotal}</td>
                        <td class="px-4 py-2 text-sm text-red-600">${rj}</td>
                        <td class="px-4 py-2 text-sm text-yellow-600">${rAvg}</td>
                        <td class="px-4 py-2 text-xs"><span class="px-2 py-1 rounded ${statusClass}">${status}</span></td>
                    </tr>`;
                }).join('');
            }

            // Aktivitas lintas outlet (20 terbaru)
            try {
                const outletsAll2 = JSON.parse(localStorage.getItem('outlets') || '[]');
                const actsAll = (JSON.parse(localStorage.getItem('activities')||'[]')||[])
                    .filter(a => useIds.includes(a.outlet))
                    .slice(-200)
                    .reverse();
                const list = document.getElementById('hoActivitiesList');
                if (list) {
                    if (!actsAll.length) {
                        list.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>';
                    } else {
                        const outletName = (id)=> (outletsAll2.find(o=>o.id===id)||{}).nama || id;
                        list.innerHTML = actsAll.slice(0,20).map(a => {
                            const icon = a.type==='tugas' ? 'fa-tasks text-blue-500' : a.type==='checklist' ? 'fa-check-circle text-green-500' : a.type==='reject' ? 'fa-times-circle text-red-500' : 'fa-clock text-gray-400';
                            return `<div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-sm">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between gap-3">
                                        <p class="text-sm font-medium text-gray-800 truncate">${a.message || '-'} </p>
                                        <span class="text-xs text-gray-500 whitespace-nowrap">${a.time || ''}</span>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-500 flex items-center gap-2">
                                        <span class="px-2 py-0.5 bg-blue-50 text-blue-700 rounded">${outletName(a.outlet)}</span>
                                        <span>${a.user || ''}</span>
                                    </div>
                                </div>
                            </div>`;
                        }).join('');
                    }
                }
            } catch (e) { /* ignore */ }

            // Export PDF summary (attached on window for button access)
            window.exportHoSummaryPDF = function() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
                    const title = titleEl ? titleEl.textContent : 'Ringkasan Multi-Outlet';
                    doc.setFontSize(14); doc.text(title, 40, 40);
                    const scopeText = scopeEl ? scopeEl.textContent : '';
                    doc.setFontSize(10); doc.text(`Cakupan: ${scopeText} | Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 40, 58);

                    // KPI table
                    const kpiRows = [[
                        document.getElementById('hoStatTugas')?.textContent || '-',
                        document.getElementById('hoStatChecklist')?.textContent || '-',
                        `${document.getElementById('hoOutletsReporting')?.textContent || '0'}/${document.getElementById('hoOutletsTotal')?.textContent || '0'}`,
                        document.getElementById('hoCapaPending')?.textContent || '0',
                        document.getElementById('hoNegFeedback')?.textContent || '0'
                    ]];
                    doc.autoTable({ startY: 74, head: [['Tugas Selesai', 'Checklist', 'Outlets Melapor', 'Pending CAPA', 'FB Negatif']], body: kpiRows, styles: { fontSize: 9 }, headStyles: { fillColor: [79,70,229] }});

                    // Ranking table
                    const rankBodyHtml = document.getElementById('hoRankingBody');
                    if (rankBodyHtml) {
                        const rows = Array.from(rankBodyHtml.querySelectorAll('tr')).map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
                        doc.autoTable({ startY: doc.lastAutoTable.finalY + 16, head: [['Outlet','Checklist','Reject (Hari ini)','Rating']], body: rows.slice(0,15), styles:{ fontSize: 8 }, headStyles:{ fillColor:[16,185,129] } });
                    }

                    // Coverage table
                    const covHtml = document.getElementById('hoCoverageBody');
                    if (covHtml) {
                        const rows = Array.from(covHtml.querySelectorAll('tr')).map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
                        doc.autoTable({ startY: doc.lastAutoTable.finalY + 16, head: [['Outlet','Checklist','Tugas (Selesai)','Reject (Hari ini)','Rating','Status']], body: rows.slice(0, 20), styles:{ fontSize: 8 }, headStyles:{ fillColor:[59,130,246] } });
                    }

                    doc.save(`Ringkasan_Multi_Outlet_${toYMD(new Date())}.pdf`);
                } catch (e) { console.error('Export HO summary failed:', e); }
            }
        }

        // ==================== JADWAL KERJA ====================
        function getSchedulePeriod(offset = schedulePeriodOffset) {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            let day = now.getDate();

            // Tentukan anchor periode berdasarkan tanggal berjalan
            // Periode berjalan dimulai pada 21 bulan ini bila hari >=21, selain itu 21 bulan lalu
            let startMonth = month;
            let startYear = year;
            if (day < 21) {
                startMonth -= 1;
                if (startMonth < 0) { startMonth = 11; startYear -= 1; }
            }
            // Geser sesuai offset (tiap offset = 1 periode = 1 bulan)
            startMonth += offset;
            while (startMonth < 0) { startMonth += 12; startYear -= 1; }
            while (startMonth > 11) { startMonth -= 12; startYear += 1; }

            const start = new Date(startYear, startMonth, 21);
            // end = tgl 20 bulan berikutnya
            let endMonth = startMonth + 1;
            let endYear = startYear;
            if (endMonth > 11) { endMonth = 0; endYear += 1; }
            const end = new Date(endYear, endMonth, 20, 23, 59, 59, 999);
            return { start, end };
        }

        function updateSchedulePeriodLabel() {
            const label = document.getElementById('labelSchedulePeriod');
            const select = document.getElementById('periodSelect');
            if (!label) return;
            const { start, end } = getSchedulePeriod();
            const fmt = (d) => d.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            label.textContent = `${fmt(start)} s.d. ${fmt(end)}`;

            // Build/select period dropdown options (last 12, current, next 12)
            if (select) {
                const buildKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                const currentAnchor = getSchedulePeriod(0).start; // start of current period
                const options = [];
                for (let i = -12; i <= 12; i++) {
                    const p = getSchedulePeriod(i);
                    options.push({
                        key: buildKey(p.start),
                        label: `${p.start.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })} (21 s.d. 20)` ,
                        offset: i
                    });
                }
                const currentKey = buildKey(start);
                // Only rebuild if different size or missing current key
                if (select.options.length !== options.length || !Array.from(select.options).some(o => o.value === currentKey)) {
                    select.innerHTML = options.map(o => `<option value="${o.offset}">${o.label}</option>`).join('');
                }
                // Set selected option to current offset
                select.value = String(schedulePeriodOffset);
            }
        }

        function changeSchedulePeriod(delta) {
            schedulePeriodOffset += delta;
            updateSchedulePeriodLabel();
            loadJadwal();
        }

        function onPeriodSelectChange() {
            const select = document.getElementById('periodSelect');
            if (!select) return;
            const newOffset = parseInt(select.value, 10) || 0;
            schedulePeriodOffset = newOffset;
            updateSchedulePeriodLabel();
            loadJadwal();
        }

        function loadJadwal() {
            const all = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const shift = (document.getElementById('shiftFilter')?.value || '').trim();
            const { start, end } = getSchedulePeriod();

            // Filter outlet + periode 21-20 + optional shift (use local date parsing)
            const jadwal = all.filter(j => {
                if (j.outlet !== currentOutlet || !j.tanggal) return false;
                const dt = parseLocalDate(j.tanggal);
                return dt >= start && dt <= end && (!shift || j.shift === shift);
            });

            // Simpan mapping index global untuk aksi hapus yang akurat
            const tbody = document.getElementById('jadwalTable');
            if (!window.__jadwalIndexMap) window.__jadwalIndexMap = [];
            window.__jadwalIndexMap = jadwal.map(j => all.findIndex(x => x === j));

            if (jadwal.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Belum ada jadwal pada periode ini</td></tr>';
                return;
            }
            tbody.innerHTML = jadwal.map((j, idx) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${j.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${formatDate(j.tanggal)}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${j.shift === 'pagi' ? 'bg-yellow-100 text-yellow-700' : j.shift === 'siang' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">${j.shift.charAt(0).toUpperCase() + j.shift.slice(1)}</span></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${j.status === 'hadir' ? 'bg-green-100 text-green-700' : j.status === 'izin' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'}">${j.status || 'Terjadwal'}</span></td>
                    <td class="px-6 py-4 action-column"><button onclick="deleteJadwal(${idx}, true)" class="text-red-600 hover:text-red-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function saveJadwal() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah jadwal');
                return;
            }
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const newItem = {
                id: genId('jadwal'),
                outlet: currentOutlet,
                nama: document.getElementById('jadwalNama').value,
                tanggal: document.getElementById('jadwalTanggal').value,
                shift: document.getElementById('jadwalShift').value,
                status: 'terjadwal'
            };
            jadwal.push(newItem);
            localStorage.setItem('jadwal', JSON.stringify(jadwal));
            // Push single row immediately to cloud to avoid waiting bulk sync
            createSingleToCloud('jadwal', newItem);
            scheduleCloudSync();
            closeModal('modalJadwal');
            updateSchedulePeriodLabel();
            loadJadwal();
            addActivity('jadwal', 'Jadwal baru ditambahkan');
            showToast('Jadwal berhasil disimpan!');
            clearForm(['jadwalNama', 'jadwalTanggal']);
        }

        function deleteJadwal(idx, useMap = false) {
            if (isViewOnly) return;
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            let deleteIndex = idx;
            if (useMap && Array.isArray(window.__jadwalIndexMap)) {
                deleteIndex = window.__jadwalIndexMap[idx];
            }
            if (deleteIndex > -1) {
                jadwal.splice(deleteIndex, 1);
                localStorage.setItem('jadwal', JSON.stringify(jadwal));
                loadJadwal();
            }
        }

        async function exportJadwalPDF() {
            const all = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);
            const shift = (document.getElementById('shiftFilter')?.value || '').trim();
            const { start, end } = getSchedulePeriod();
            const data = all.filter(j => {
                if (j.outlet !== currentOutlet || !j.tanggal) return false;
                const dt = parseLocalDate(j.tanggal);
                return dt >= start && dt <= end && (!shift || j.shift === shift);
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            // Header
            doc.setFontSize(14);
            doc.text(`Jadwal Kerja - ${outlet ? outlet.nama : 'Outlet'}`, 40, 40);
            const periodText = `${start.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} s.d. ${end.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`;
            doc.setFontSize(10);
            doc.text(`Periode: ${periodText}${shift ? ` | Shift: ${shift}` : ''}`, 40, 58);

            // Table
            const rows = data.sort((a,b) => parseLocalDate(a.tanggal) - parseLocalDate(b.tanggal)).map(j => [
                j.nama,
                parseLocalDate(j.tanggal).toLocaleDateString('id-ID'),
                j.shift.charAt(0).toUpperCase() + j.shift.slice(1),
                (j.status || 'Terjadwal').toUpperCase()
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Nama Staff', 'Tanggal', 'Shift', 'Status']],
                body: rows.length ? rows : [['-', '-', '-', '-']],
                styles: { fontSize: 9 },
                headStyles: { fillColor: [30, 58, 138] },
            });

            doc.save(`Jadwal_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(start)}_${toYMD(end)}.pdf`);
        }

        // ===== Export PDF: Tugas Harian =====
        async function exportTugasPDF() {
            const tugas = (JSON.parse(localStorage.getItem('tugas') || '[]') || []).filter(t => t.outlet === currentOutlet);
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            doc.setFontSize(14);
            doc.text(`Tugas Harian - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 40, 58);

            const rows = tugas.map(t => [
                formatDate(t.tanggal || toYMD(new Date())),
                t.judul || '-',
                (t.deskripsi || '').replace(/\s+/g,' ').trim(),
                (t.prioritas || '-').toUpperCase(),
                t.assign || '-',
                t.selesai ? 'SELESAI' : 'BELUM'
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Tugas', 'Deskripsi', 'Prioritas', 'Ditugaskan kepada', 'Status']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-', '-']],
                styles: { fontSize: 9, cellWidth: 'wrap' },
                headStyles: { fillColor: [37, 99, 235] },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 120 },
                    2: { cellWidth: 180 },
                    3: { cellWidth: 70 },
                    4: { cellWidth: 120 },
                    5: { cellWidth: 60 }
                }
            });

            doc.save(`Tugas_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(new Date())}.pdf`);
        }

        // ===== Export PDF: Preparation =====
        async function exportPreparationPDF() {
            const prep = (JSON.parse(localStorage.getItem('preparation') || '[]') || []).filter(p => p.outlet === currentOutlet);
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            doc.setFontSize(14);
            doc.text(`Preparation Bahan Baku - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 40, 58);

            const rows = prep.map(p => [
                formatDate(p.tanggal || toYMD(new Date())),
                p.nama || '-',
                p.jumlah || '-',
                p.petugas || p.pic || '-',
                p.selesai ? 'SELESAI' : 'PROSES'
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Bahan Baku', 'Jumlah', 'Petugas', 'Status']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-']],
                styles: { fontSize: 9 },
                headStyles: { fillColor: [5, 150, 105] },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 160 },
                    2: { cellWidth: 80 },
                    3: { cellWidth: 140 },
                    4: { cellWidth: 80 }
                }
            });

            doc.save(`Preparation_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(new Date())}.pdf`);
        }

        // ==================== TUGAS HARIAN ====================
        function loadTugas() {
            const all = JSON.parse(localStorage.getItem('tugas') || '[]');
            const tugas = all.filter(t => t.outlet === currentOutlet);
            const container = document.getElementById('tugasContainer');
            if (tugas.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-gray-500">Belum ada tugas</div>';
                return;
            }
            // Buat peta index global agar toggle/hapus akurat walau data difilter
            window.__tugasIndexMap = tugas.map(item => all.findIndex(x => x === item));
            const cannotToggle = isViewOnly || (currentUser && currentUser.role === 'outlet');
            container.innerHTML = tugas.map((t, idx) => {
                const gi = window.__tugasIndexMap[idx];
                return `
                <div class="bg-white rounded-xl p-4 shadow-sm flex items-start gap-4">
                    <input type="checkbox" ${t.selesai ? 'checked' : ''} ${cannotToggle ? 'disabled' : ''} onchange="toggleTugas(${gi})" title="${cannotToggle ? 'Anda tidak dapat checklist tugas harian' : ''}" class="w-5 h-5 mt-1 rounded border-gray-300 text-blue-600 ${cannotToggle ? 'pointer-events-none opacity-60' : ''}">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h4 class="font-medium ${t.selesai ? 'line-through text-gray-400' : 'text-gray-800'}">${t.judul}</h4>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full ${t.prioritas === 'tinggi' ? 'bg-red-100 text-red-700' : t.prioritas === 'sedang' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${t.prioritas}</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${t.deskripsi}</p>
                        <p class="text-xs text-gray-400 mt-2"><i class="fas fa-user mr-1"></i>${t.assign}</p>
                    </div>
                    <button onclick="deleteTugas(${gi})" class="text-red-500 hover:text-red-700 ${isViewOnly ? 'hidden' : ''}"><i class="fas fa-trash"></i></button>
                </div>`;
            }).join('');
        }

        function saveTugas() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah tugas');
                return;
            }
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            const judulVal = document.getElementById('tugasJudul').value;
            const assignVal = document.getElementById('tugasAssign').value;
            const newItem = {
                id: genId('tugas'),
                outlet: currentOutlet,
                judul: judulVal,
                deskripsi: document.getElementById('tugasDeskripsi').value,
                prioritas: document.getElementById('tugasPrioritas').value,
                assign: assignVal,
                tanggal: toYMD(new Date()),
                selesai: false
            };
            tugas.push(newItem);
            localStorage.setItem('tugas', JSON.stringify(tugas));
            // Push single row to cloud immediately (anti-CORS GET)
            createSingleToCloud('tugas', newItem);
            scheduleCloudSync();
            closeModal('modalTugas');
            loadTugas();
            addActivity('tugas', 'Tugas baru: ' + judulVal + (assignVal ? '  ' + assignVal : ''));
            showToast('Tugas berhasil ditambahkan!');
            clearForm(['tugasDeskripsi']);
        }

        function toggleTugas(idx) {
            // Staff Outlet dan Head Office (view only) tidak boleh checklist tugas harian
            if (isViewOnly || (currentUser && currentUser.role === 'outlet')) {
                showToast('Anda tidak diizinkan melakukan checklist tugas harian.');
                // Re-render untuk memastikan UI tetap konsisten
                loadTugas();
                return;
            }
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            tugas[idx].selesai = !tugas[idx].selesai;
            localStorage.setItem('tugas', JSON.stringify(tugas));

            // Sinkronkan perubahan ke Cloud agar kolom 'selesai' di Spreadsheet ikut terupdate
            try { scheduleCloudSync(800); } catch (e) { /* ignore */ }

            loadTugas();
            loadDashboard();
        }

        function deleteTugas(idx) {
            if (isViewOnly) return;
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            tugas.splice(idx, 1);
            localStorage.setItem('tugas', JSON.stringify(tugas));
            loadTugas();
        }

        // ==================== PREPARATION ====================
        function loadPreparation() {
            const all = JSON.parse(localStorage.getItem('preparation') || '[]');
            const prep = all.filter(p => p.outlet === currentOutlet);
            const tbody = document.getElementById('preparationTable');
            if (prep.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Belum ada data preparation</td></tr>';
                return;
            }
            // Peta index global agar aksi tepat walau data difilter
            window.__prepIndexMap = prep.map(item => all.findIndex(x => x === item));
            tbody.innerHTML = prep.map((p, idx) => {
                const gi = window.__prepIndexMap[idx];
                return `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${p.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${p.jumlah}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${p.petugas || p.pic || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${p.selesai ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${p.selesai ? 'Selesai' : 'Proses'}</span></td>
                    <td class="px-6 py-4 flex gap-2 action-column">
                        <button onclick="togglePreparation(${gi})" class="text-green-600 hover:text-green-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-check"></i></button>
                        <button onclick="deletePreparation(${gi})" class="text-red-600 hover:text-red-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        function savePreparation() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah preparation');
                return;
            }
            const prep = JSON.parse(localStorage.getItem('preparation') || '[]');
            const newItem = {
                id: genId('preparation'),
                outlet: currentOutlet,
                nama: document.getElementById('prepNama').value,
                jumlah: document.getElementById('prepJumlah').value,
                petugas: document.getElementById('prepPetugas').value,
                selesai: false,
                tanggal: toYMD(new Date())
            };
            prep.push(newItem);
            localStorage.setItem('preparation', JSON.stringify(prep));
            // Push single row to cloud immediately
            createSingleToCloud('preparation', newItem);
            scheduleCloudSync();
            closeModal('modalPreparation');
            loadPreparation();
            showToast('Preparation berhasil ditambahkan!');
            clearForm(['prepJumlah', 'prepPetugas']);
        }

        function togglePreparation(idx) {
            if (isViewOnly) return;
            const prep = JSON.parse(localStorage.getItem('preparation') || '[]');
            prep[idx].selesai = !prep[idx].selesai;
            localStorage.setItem('preparation', JSON.stringify(prep));
            loadPreparation();
        }

        function deletePreparation(idx) {
            if (isViewOnly) return;
            const prep = JSON.parse(localStorage.getItem('preparation') || '[]');
            prep.splice(idx, 1);
            localStorage.setItem('preparation', JSON.stringify(prep));
            loadPreparation();
        }

        // ==================== CHECKLIST ====================
        function loadChecklist() {
            const select = document.getElementById('checklistShift');
            const waktu = select.value; // pra | during | after
            const labelWaktu = waktu === 'pra' ? 'Pra Opening' : waktu === 'during' ? 'During' : 'After Closing';

            // Ambil daftar master lalu filter KETAT hanya berdasarkan properti waktu yang valid
            const itemsRaw = JSON.parse(localStorage.getItem('checklistItems') || '[]')
                .filter(i => i && i.waktu && (i.waktu === waktu));

            // Deduplikasi berdasarkan nama (case-insensitive) agar tidak dobel saat hasil pull/merge
            const byName = new Map();
            itemsRaw.forEach(i => {
                const key = (i.nama || '').toString().toLowerCase().trim();
                if (!byName.has(key)) byName.set(key, i);
            });
            const items = Array.from(byName.values());

            const today = toYMD(new Date());
            const todayKey = `${today}_${currentOutlet}_${waktu}`;

            const statusMap = JSON.parse(localStorage.getItem('checklistStatus') || '{}');
            const correctiveMap = JSON.parse(localStorage.getItem('checklistCorrective') || '{}');
            const todayStatus = statusMap[todayKey] || {}; // id -> 'ok' | 'not_ok'
            const todayCorrective = correctiveMap[todayKey] || {}; // id -> text

            // Gunakan total tetap agar denominator tidak berubah-ubah saat auto-pull
            const fixedTotals = { pra: 77, during: 77, after: 17 };
            const total = fixedTotals[waktu] != null ? fixedTotals[waktu] : items.length;

            // Hitung statistik dari item yang tampil (OK/Tidak OK/Pending CAPA)
            let ok = 0, notOk = 0, pending = 0;
            items.forEach(i => {
                const st = todayStatus[i.id];
                if (st === 'ok') ok++;
                else if (st === 'not_ok') {
                    notOk++;
                    const cap = (todayCorrective[i.id] || '').trim();
                    if (!cap) pending++;
                }
            });
            const completed = ok + (notOk - pending);
            const percent = total ? Math.round((completed / total) * 100) : 0;

            // Update header panel
            const shiftTimeEl = document.getElementById('clsShiftTime');
            const progBar = document.getElementById('clsProgressBar');
            const progLabel = document.getElementById('clsProgressLabel');
            const statTotal = document.getElementById('clsStatTotal');
            const statOk = document.getElementById('clsStatOk');
            const statNotOk = document.getElementById('clsStatNotOk');
            const statPending = document.getElementById('clsStatPending');
            if (shiftTimeEl) shiftTimeEl.textContent = labelWaktu;
            if (progBar) progBar.style.width = percent + '%';
            if (progLabel) progLabel.textContent = percent + '%';
            if (statTotal) statTotal.textContent = total;
            if (statOk) statOk.textContent = ok;
            if (statNotOk) statNotOk.textContent = notOk;
            if (statPending) statPending.textContent = pending;

            // Render daftar dalam kategori collapsible
            const container = document.getElementById('checklistContainer');
            const categories = [...new Set(items.map(i => i.kategori))];
            container.innerHTML = categories.map(cat => {
                const icon = cat === 'kebersihan' ? 'fa-broom' : cat === 'peralatan' ? 'fa-tools' : cat === 'keamanan' ? 'fa-shield-alt' : 'fa-cog';
                const catItems = items.filter(i => i.kategori === cat);
                return `
                <details class="bg-white rounded-xl shadow-sm group" open>
                    <summary class="cursor-pointer list-none select-none">
                        <div class="flex items-center justify-between px-4 py-3 bg-gray-50 rounded-t-xl">
                            <div class="flex items-center gap-2">
                                <i class="fas ${icon} text-blue-500"></i>
                                <h3 class="font-semibold text-gray-800 capitalize">${cat}</h3>
                            </div>
                            <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                        </div>
                    </summary>
                    <div class="divide-y">
                        ${catItems.map(i => {
                            const s = todayStatus[String(i.id)] || '';
                            const isNotOk = s === 'not_ok';
                            const corr = todayCorrective[String(i.id)] || '';
                            return `
                            <div class="p-4 ${isNotOk ? 'bg-red-50' : ''}">
                                <p class="${s ? (s === 'ok' ? 'text-gray-700' : 'text-red-700') : 'text-gray-700'}">${i.nama}</p>
                                <div class="mt-3 ${isViewOnly ? 'pointer-events-none opacity-60' : ''}">
                                    <label class="block text-xs text-gray-500 mb-1">Status</label>
                                    <select class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-300" ${isViewOnly ? 'disabled' : ''} onchange="onChecklistSelectChange('${i.id}', this.value)">
                                        <option value="" ${s ? '' : 'selected'}>Pilih status</option>
                                        <option value="ok" ${s==='ok' ? 'selected' : ''}>OK</option>
                                        <option value="not_ok" ${s==='not_ok' ? 'selected' : ''}>Tidak OK</option>
                                    </select>
                                </div>
                                ${isNotOk ? `
                                <div class="mt-3">
                                    <label class="block text-xs font-medium text-red-700 mb-1">Tindakan Perbaikan <span class="text-red-500">*</span></label>
                                    <textarea id="corr-${i.id}" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-300" placeholder="Jelaskan tindakan perbaikan..." onblur="saveCorrectiveAction(${i.id}, this.value)">${corr}</textarea>
                                    <p class="text-xs text-red-500 mt-1" id="corrHint-${i.id}" style="${(corr||'').trim() ? 'display:none' : ''}">Wajib diisi ketika pilih Tidak OK</p>
                                </div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </details>`;
            }).join('');
        }

        function setChecklistStatus(id, status) {
            if (isViewOnly) return;
            // Pastikan id adalah string agar konsisten sebagai key object
            id = String(id);
            const waktu = document.getElementById('checklistShift').value;
            const today = toYMD(new Date());
            const todayKey = `${today}_${currentOutlet}_${waktu}`;

            const statusMap = JSON.parse(localStorage.getItem('checklistStatus') || '{}');
            if (!statusMap[todayKey]) statusMap[todayKey] = {};
            if (!status) {
                // Hapus status jika kembali ke 'Pilih status'
                delete statusMap[todayKey][id];
            } else {
                statusMap[todayKey][id] = status;
            }
            localStorage.setItem('checklistStatus', JSON.stringify(statusMap));

            // Push status ke cloud sebagai satu baris (key=dataMap)
            try {
                createSingleToCloud('checklistStatus', { id: todayKey, key: todayKey, data: statusMap[todayKey] });
            } catch (e) { /* ignore push error */ }

            // Jika set ke OK, hapus corrective agar tidak tersimpan
            if (status === 'ok') {
                const correctiveMap = JSON.parse(localStorage.getItem('checklistCorrective') || '{}');
                if (correctiveMap[todayKey] && correctiveMap[todayKey][id]) {
                    delete correctiveMap[todayKey][id];
                    localStorage.setItem('checklistCorrective', JSON.stringify(correctiveMap));
                    try { createSingleToCloud('checklistCorrective', { id: todayKey, key: todayKey, data: correctiveMap[todayKey] || {} }); } catch (e) {}
                }
            }
            if (status) {
                addActivity('checklist', `Checklist (${waktu}) item diset: ${status === 'ok' ? 'OK' : 'Tidak OK'}`);
            }
            loadDashboard();
            loadChecklist();

            // Focus corrective textarea when selecting Not OK
            if (status === 'not_ok') {
                setTimeout(() => {
                    const ta = document.getElementById(`corr-${id}`);
                    if (ta) ta.focus();
                }, 0);
            }
        }

        function onChecklistSelectChange(id, value) {
            // value: '', 'ok', 'not_ok'
            setChecklistStatus(String(id), value || '');
        }

        function saveCorrectiveAction(id, text) {
            if (isViewOnly) return;
            id = String(id);
            const waktu = document.getElementById('checklistShift').value;
            const today = toYMD(new Date());
            const todayKey = `${today}_${currentOutlet}_${waktu}`;
            const correctiveMap = JSON.parse(localStorage.getItem('checklistCorrective') || '{}');
            if (!correctiveMap[todayKey]) correctiveMap[todayKey] = {};
            correctiveMap[todayKey][id] = (text || '').trim();
            localStorage.setItem('checklistCorrective', JSON.stringify(correctiveMap));
            // Push corrective map as single row keyed by todayKey
            try { createSingleToCloud('checklistCorrective', { id: todayKey, key: todayKey, data: correctiveMap[todayKey] }); } catch (e) {}
            const hint = document.getElementById(`corrHint-${id}`);
            if (hint) hint.style.display = (text || '').trim() ? 'none' : 'block';
        }

        // ==================== REJECT ====================
        function loadReject() {
            const all = JSON.parse(localStorage.getItem('reject') || '[]');
            const dateFilter = (document.getElementById('rejectDateFilter')?.value || '').trim();
            const catFilter = (document.getElementById('rejectCategoryFilter')?.value || '').trim();
            const reject = all.filter(r => r.outlet === currentOutlet)
                .filter(r => !dateFilter || r.tanggal === dateFilter)
                .filter(r => !catFilter || r.kategori === catFilter);
            const tbody = document.getElementById('rejectTable');
            if (reject.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data reject</td></tr>';
                return;
            }
            tbody.innerHTML = reject.map(r => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-500">${formatDate(r.tanggal)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${r.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.jumlah}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">${r.kategori}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.alasan}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.pic}</td>
                </tr>
            `).join('');
        }

        function saveReject() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah catatan reject');
                return;
            }
            const reject = JSON.parse(localStorage.getItem('reject') || '[]');
            const newItem = {
                id: genId('reject'),
                outlet: currentOutlet,
                tanggal: toYMD(new Date()),
                nama: document.getElementById('rejectNama').value,
                jumlah: document.getElementById('rejectJumlah').value,
                kategori: document.getElementById('rejectKategori').value,
                alasan: document.getElementById('rejectAlasan').value,
                pic: currentUser.nama
            };
            reject.push(newItem);
            localStorage.setItem('reject', JSON.stringify(reject));
            // Push single row immediately
            createSingleToCloud('reject', newItem);
            scheduleCloudSync();
            closeModal('modalReject');
            loadReject();
            loadDashboard();
            showToast('Data reject berhasil dicatat!');
            clearForm(['rejectJumlah', 'rejectAlasan']);
        }

        async function exportRejectPDF() {
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);
            const all = JSON.parse(localStorage.getItem('reject') || '[]');
            const dateFilter = (document.getElementById('rejectDateFilter')?.value || '').trim();
            const catFilter = (document.getElementById('rejectCategoryFilter')?.value || '').trim();
            const data = all.filter(r => r.outlet === currentOutlet)
                .filter(r => !dateFilter || r.tanggal === dateFilter)
                .filter(r => !catFilter || r.kategori === catFilter);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            doc.setFontSize(14);
            doc.text(`Catatan Barang Reject - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            const sub = `Tanggal: ${dateFilter || 'Semua'} | Kategori: ${catFilter || 'Semua'}`;
            doc.text(sub, 40, 58);

            const rows = data.map(r => [
                formatDate(r.tanggal),
                r.nama,
                r.jumlah,
                r.kategori,
                r.alasan,
                r.pic
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Nama Barang', 'Jumlah', 'Kategori', 'Alasan', 'PIC']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-', '-']],
                styles: { fontSize: 9 },
                headStyles: { fillColor: [220, 38, 38] }
            });

            const fileDate = dateFilter || toYMD(new Date());
            doc.save(`Reject_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${fileDate}${catFilter ? '_' + catFilter : ''}.pdf`);
        }

        // ==================== INVENTORI ====================
        const barangMaster = [
            { nama: 'Ayam Buncis', satuan: 'Kg' },
            { nama: 'Ayam Kuning', satuan: 'Pcs' },
            { nama: 'Ayam Kuning Negri', satuan: 'Pcs' },
            { nama: 'Ayam Marinade', satuan: 'Kg' },
            { nama: 'Bawang Goreng', satuan: 'Kg' },
            { nama: 'Biang Bumbu Otak-Otak', satuan: 'Kg' },
            { nama: 'Biang Bumbu Siomay', satuan: 'Kg' },
            { nama: 'Biang Sambal', satuan: 'Kg' },
            { nama: 'Biang Sayur Asem', satuan: 'Kg' },
            { nama: 'Biang Soto Ayam', satuan: 'Kg' },
            { nama: 'Boneless Marinade', satuan: 'Kg' },
            { nama: 'Boneless Tim', satuan: 'Kg' },
            { nama: 'Bumbu Asinan', satuan: 'Prs' },
            { nama: 'Bumbu Kaldu Rasa ( B )', satuan: 'Prs' },
            { nama: 'Bumbu Mie Ayam', satuan: 'Kg' },
            { nama: 'Bumbu Mie Jawa', satuan: 'Kg' },
            { nama: 'Bumbu Nasi Goreng', satuan: 'Kg' },
            { nama: 'Bumbu Tahu', satuan: 'Prs' },
            { nama: 'Buntut Nasi Goreng', satuan: 'Prs' },
            { nama: 'Buntut Sop', satuan: 'Prs' },
            { nama: 'Durian', satuan: 'Prs' },
            { nama: 'Ebi Matang', satuan: 'Kg' },
            { nama: 'Gula Rempah', satuan: 'Prs' },
            { nama: 'Iga Sop', satuan: 'Prs' },
            { nama: 'Kacang Goreng', satuan: 'Kg' },
            { nama: 'Kecap Mie Ayam', satuan: 'Kg' },
            { nama: 'Kecap Oplos', satuan: 'Kg' },
            { nama: 'Kecap Oplos ( B )', satuan: 'Kg' },
            { nama: 'Kelapa Kopyor', satuan: 'Prs' },
            { nama: 'Kerongkong Ayam', satuan: 'Kg' },
            { nama: 'Kuah Cah', satuan: 'Kg' },
            { nama: 'Kuah Cap Cay', satuan: 'Prs' },
            { nama: 'Kuah Pempek', satuan: 'Kg' },
            { nama: 'Minyak Mie Ayam', satuan: 'Kg' },
            { nama: 'Otak-Otak Bakar', satuan: 'Pcs' },
            { nama: 'PKS', satuan: 'Pcs' },
            { nama: 'Pempek Keju', satuan: 'Pcs' },
            { nama: 'Pempek Lenjeran', satuan: 'Pcs' },
            { nama: 'Pletok Set', satuan: 'Set' },
            { nama: 'Risoles', satuan: 'Pcs' },
            { nama: 'Sambal Hijau', satuan: 'Kg' },
            { nama: 'Saos Kungpao', satuan: 'kg' },
            { nama: 'Saos Telor Asin', satuan: 'Kg' },
            { nama: 'Sapi Marinade', satuan: 'Kg' },
            { nama: 'Siomay', satuan: 'Pcs' },
            { nama: 'SKT', satuan: 'Pcs' },
            { nama: 'SMU', satuan: 'Pcs' },
            { nama: 'Sirsak', satuan: 'Prs' },
            { nama: 'Soto Betawi', satuan: 'Prs' },
            { nama: 'Stroberi', satuan: 'Prs' },
            { nama: 'Tepung Premix', satuan: 'Kg' },
            { nama: 'Terasi Matang', satuan: 'Grm' },
            { nama: 'Tongseng Ayam', satuan: 'Prs' },
            { nama: 'Tongseng Sop', satuan: 'Prs' },
            { nama: 'Kentang', satuan: 'kg' },
            { nama: 'Singkong', satuan: 'Kg' },
            { nama: 'Mix Berries', satuan: 'Kg' }
        ];

        function optionsBarang() {
            return barangMaster.map(b => `<option value="${b.nama}">${b.nama}</option>`).join('');
        }
        function satuanOf(nama) {
            const f = barangMaster.find(b => b.nama === nama);
            return f ? f.satuan : '';
        }
        function onInvNamaChange() {
            const nama = document.getElementById('invNama').value;
            document.getElementById('invSatuanLabel').textContent = satuanOf(nama) ? `(${satuanOf(nama)})` : '';
        }
        function onOutNamaChange() {
            const nama = document.getElementById('outNama').value;
            document.getElementById('outSatuanLabel').textContent = satuanOf(nama) ? `(${satuanOf(nama)})` : '';
            
            // Tampilkan info batch yang tersedia untuk barang ini (urutan FEFO)
            const batchInfo = document.getElementById('outBatchInfo');
            const batchTable = document.getElementById('outBatchTable');
            const totalLabel = document.getElementById('outTotalTersedia');
            const preview = document.getElementById('outPreview');
            
            if (!nama) {
                batchInfo.classList.add('hidden');
                preview.classList.add('hidden');
                totalLabel.textContent = '0';
                return;
            }
            
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]')
                .filter(i => i.outlet === currentOutlet && i.nama === nama && Number(i.jumlah) > 0)
                .sort((a, b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired)); // FEFO
            
            if (inv.length === 0) {
                batchInfo.classList.add('hidden');
                preview.classList.add('hidden');
                totalLabel.textContent = '0';
                return;
            }
            
            batchInfo.classList.remove('hidden');
            const total = inv.reduce((sum, i) => sum + Number(i.jumlah || 0), 0);
            totalLabel.textContent = `${total} ${satuanOf(nama)}`;
            
            batchTable.innerHTML = inv.map((item, idx) => {
                const now = new Date();
                const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
                const expDate = parseLocalDate(item.tglExpired);
                const isExpired = expDate && expDate < todayLocal;
                const warningLocal = new Date(todayLocal.getTime() + 7 * 24 * 60 * 60 * 1000);
                const isWarning = expDate && expDate <= warningLocal && !isExpired;
                
                let rowClass = '';
                if (isExpired) rowClass = 'bg-red-100 text-red-700';
                else if (isWarning) rowClass = 'bg-yellow-100 text-yellow-700';
                else if (idx === 0) rowClass = 'bg-green-100 text-green-700';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-2 py-1 font-medium">${idx === 0 ? '<i class="fas fa-arrow-right mr-1"></i>1 (Prioritas)' : idx + 1}</td>
                        <td class="px-2 py-1">${formatDate(item.tglProduksi)}</td>
                        <td class="px-2 py-1">${formatDate(item.tglExpired)}${isExpired ? ' <span class="text-red-600 font-bold">(EXPIRED!)</span>' : ''}</td>
                        <td class="px-2 py-1 text-right font-medium">${item.jumlah}</td>
                    </tr>
                `;
            }).join('');
            
            // Reset preview dan input jumlah
            preview.classList.add('hidden');
            document.getElementById('outJumlah').value = '';
        }
        
        function previewOutStock() {
            const nama = document.getElementById('outNama').value;
            const qty = Number(document.getElementById('outJumlah').value || 0);
            const preview = document.getElementById('outPreview');
            const previewContent = document.getElementById('outPreviewContent');
            
            if (!nama || qty <= 0) {
                preview.classList.add('hidden');
                return;
            }
            
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]')
                .filter(i => i.outlet === currentOutlet && i.nama === nama && Number(i.jumlah) > 0)
                .sort((a, b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired)); // FEFO
            
            if (inv.length === 0) {
                preview.classList.add('hidden');
                return;
            }
            
            let remaining = qty;
            const usage = [];
            
            for (const item of inv) {
                if (remaining <= 0) break;
                const take = Math.min(Number(item.jumlah || 0), remaining);
                if (take > 0) {
                    usage.push({
                        tglProduksi: item.tglProduksi,
                        tglExpired: item.tglExpired,
                        batch: item.batch,
                        take: take,
                        sisa: Number(item.jumlah) - take
                    });
                    remaining -= take;
                }
            }
            
            if (usage.length === 0) {
                preview.classList.add('hidden');
                return;
            }
            
            preview.classList.remove('hidden');
            
            let html = '<div class="space-y-2">';
            usage.forEach((u, idx) => {
                html += `
                    <div class="flex items-center justify-between p-2 bg-white rounded border ${idx === 0 ? 'border-green-400' : 'border-gray-200'}">
                        <div>
                            <p class="font-medium text-gray-800">
                                <i class="fas fa-box text-green-500 mr-1"></i>
                                Batch: ${u.batch || '-'}
                            </p>
                            <p class="text-xs text-gray-500">
                                Produksi: ${formatDate(u.tglProduksi)} | Exp: ${formatDate(u.tglExpired)}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-red-600">-${u.take}</p>
                            <p class="text-xs text-gray-500">Sisa: ${u.sisa}</p>
                        </div>
                    </div>
                `;
            });
            
            if (remaining > 0) {
                html += `
                    <div class="p-2 bg-red-100 border border-red-300 rounded text-red-700 text-sm">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Stok tidak cukup! Kekurangan: <strong>${remaining} ${satuanOf(nama)}</strong>
                    </div>
                `;
            } else {
                const totalTake = usage.reduce((sum, u) => sum + u.take, 0);
                html += `
                    <div class="p-2 bg-blue-100 border border-blue-300 rounded text-blue-700 text-sm">
                        <i class="fas fa-check-circle mr-1"></i>
                        Total keluar: <strong>${totalTake} ${satuanOf(nama)}</strong> dari ${usage.length} batch
                    </div>
                `;
            }
            html += '</div>';
            
            previewContent.innerHTML = html;
        }

        function renderInventorySummaries(inv) {
            // Rekap Saldo per (nama, tglProduksi)
            const saldoMap = new Map();
            inv.forEach(i => {
                const key = `${i.nama}__${i.tglProduksi || '-'}`;
                const prev = saldoMap.get(key) || 0;
                saldoMap.set(key, prev + Number(i.jumlah || 0));
            });
            const saldoRows = Array.from(saldoMap.entries())
                .map(([key, qty]) => {
                    const [nama, tglProd] = key.split('__');
                    return { nama, tglProduksi: tglProd, qty };
                })
                .sort((a,b) => a.nama.localeCompare(b.nama,'id') || (parseLocalDate(a.tglProduksi) - parseLocalDate(b.tglProduksi)));
            const saldoBody = document.getElementById('invSaldoBody');
            if (saldoBody) {
                saldoBody.innerHTML = saldoRows.length ? saldoRows.map(r => `
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">${r.nama}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${formatDate(r.tglProduksi)}</td>
                        <td class="px-6 py-3 text-sm text-gray-700">${r.qty}</td>
                    </tr>
                `).join('') : '<tr><td colspan="3" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
            }

            // Rekap Jumlah per nama
            const jumlahMap = new Map();
            inv.forEach(i => {
                const prev = jumlahMap.get(i.nama) || 0;
                jumlahMap.set(i.nama, prev + Number(i.jumlah || 0));
            });
            const jumlahRows = Array.from(jumlahMap.entries())
                .map(([nama, qty]) => ({ nama, qty }))
                .sort((a,b) => a.nama.localeCompare(b.nama,'id'));
            const jumlahBody = document.getElementById('invJumlahBody');
            if (jumlahBody) {
                jumlahBody.innerHTML = jumlahRows.length ? jumlahRows.map(r => `
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">${r.nama}</td>
                        <td class="px-6 py-3 text-sm text-gray-700">${r.qty}</td>
                    </tr>
                `).join('') : '<tr><td colspan="2" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
            }
        }

        function loadOutStockHistory() {
            const tbody = document.getElementById('outStockTable');
            if (!tbody) return;
            const logs = (JSON.parse(localStorage.getItem('outStockLogs') || '[]') || []).filter(l => l.outlet === currentOutlet);
            if (!logs.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
                return;
            }
            const rows = logs.slice().reverse().map(l => `
                <tr>
                    <td class="px-6 py-3 text-sm text-gray-500">${formatDate(l.tanggal)}</td>
                    <td class="px-6 py-3 text-sm text-gray-900">${l.nama}</td>
                    <td class="px-6 py-3 text-sm text-gray-700">${l.jumlah}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${l.satuan || ''}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${l.pic || '-'}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${l.ket || '-'}</td>
                </tr>
            `).join('');
            tbody.innerHTML = rows;
        }

        function loadInventori() {
            const allInv = JSON.parse(localStorage.getItem('inventori') || '[]').filter(i => i.outlet === currentOutlet);
            const filterNama = (document.getElementById('invFilterNama')?.value || '').trim();
            
            // Populate filter dropdown dengan nama barang unik
            const filterSelect = document.getElementById('invFilterNama');
            if (filterSelect) {
                const uniqueNames = [...new Set(allInv.map(i => i.nama))].sort((a,b) => a.localeCompare(b, 'id'));
                const currentVal = filterSelect.value;
                filterSelect.innerHTML = '<option value="">Semua Barang</option>' + uniqueNames.map(n => `<option value="${n}" ${n === currentVal ? 'selected' : ''}>${n}</option>`).join('');
            }
            
            // Apply filter
            const inv = filterNama ? allInv.filter(i => i.nama === filterNama) : allInv;
            
            const now = new Date();
            const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
            const warningLocal = new Date(todayLocal.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            // Hitung status dari seluruh inventori (bukan yang difilter)
            let aman = 0, warning = 0, expired = 0;
            allInv.forEach(i => {
                const expDate = parseLocalDate(i.tglExpired);
                if (!expDate) return;
                if (expDate < todayLocal) expired++;
                else if (expDate <= warningLocal) warning++;
                else aman++;
            });
            
            document.getElementById('stockAman').textContent = aman;
            document.getElementById('stockWarning').textContent = warning;
            document.getElementById('stockExpired').textContent = expired;
            
            const tbody = document.getElementById('inventoriTable');
            if (inv.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500">Belum ada data inventori' + (filterNama ? ' untuk filter ini' : '') + '</td></tr>';
                // Tetap render ringkasan kosong dan riwayat out stock
                renderInventorySummaries(allInv);
                loadOutStockHistory();
                return;
            }
            
            inv.sort((a, b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired));
            
            // Bangun mapping index global untuk aksi hapus yang akurat
            const globalIndexMap = inv.map(item => {
                const allData = JSON.parse(localStorage.getItem('inventori') || '[]');
                return allData.findIndex(x => x.outlet === item.outlet && x.nama === item.nama && x.batch === item.batch && x.tglMasuk === item.tglMasuk && x.tglExpired === item.tglExpired);
            });
            
            tbody.innerHTML = inv.map((i, idx) => {
                const expDate = parseLocalDate(i.tglExpired);
                let status = 'Aman', statusClass = 'bg-green-100 text-green-700';
                if (expDate < todayLocal) { status = 'Expired'; statusClass = 'bg-red-100 text-red-700'; }
                else if (expDate <= warningLocal) { status = 'Warning'; statusClass = 'bg-yellow-100 text-yellow-700'; }
                return `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${i.nama}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.satuan || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.batch}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.jumlah}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatDate(i.tglProduksi)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatDate(i.tglMasuk)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatDate(i.tglExpired)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${status}</span></td>
                        <td class="px-6 py-4 action-column"><button onclick="deleteInventori(${globalIndexMap[idx]})" class="text-red-600 hover:text-red-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            }).join('');

            // Render ringkasan saldo & jumlah (dari seluruh data, bukan yang difilter)
            renderInventorySummaries(allInv);
            // Render riwayat out stock
            loadOutStockHistory();
        }

        function saveInventori() {
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]');
            const nama = document.getElementById('invNama').value;
            const newItem = {
                id: genId('inventori'),
                outlet: currentOutlet,
                nama: nama,
                satuan: satuanOf(nama),
                batch: document.getElementById('invBatch').value,
                jumlah: Number(document.getElementById('invJumlah').value || 0),
                tglProduksi: document.getElementById('invTglProduksi').value || '',
                tglMasuk: document.getElementById('invTglMasuk').value,
                tglExpired: document.getElementById('invTglExpired').value
            };
            inv.push(newItem);
            localStorage.setItem('inventori', JSON.stringify(inv));
            // Push single row immediately
            createSingleToCloud('inventori', newItem);
            scheduleCloudSync();
            closeModal('modalInventori');
            loadInventori();
            loadDashboard();
            showToast('In Stock berhasil ditambahkan!');
            clearForm(['invBatch', 'invJumlah', 'invTglProduksi', 'invTglMasuk', 'invTglExpired']);
        }

        function saveOutStock() {
            if (isViewOnly) { showToast('Mode View Only'); return; }
            const nama = document.getElementById('outNama').value;
            let qty = Number(document.getElementById('outJumlah').value || 0);
            if (!nama || qty <= 0) { showToast('Isi nama dan jumlah yang benar'); return; }
            let inv = JSON.parse(localStorage.getItem('inventori') || '[]');
            const list = inv.filter(i => i.outlet === currentOutlet && i.nama === nama).sort((a,b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired));
            let remaining = qty;
            for (const item of list) {
                if (remaining <= 0) break;
                const take = Math.min(Number(item.jumlah || 0), remaining);
                item.jumlah = Number(item.jumlah || 0) - take;
                remaining -= take;
            }
            // Hapus batch yang jumlahnya 0
            inv = inv.filter(i => !(i.outlet === currentOutlet && i.nama === nama && Number(i.jumlah) === 0));
            localStorage.setItem('inventori', JSON.stringify(inv));

            // Catat riwayat Out Stock
            const outLogs = JSON.parse(localStorage.getItem('outStockLogs') || '[]');
            const newLog = {
                id: genId('outlog'),
                outlet: currentOutlet,
                tanggal: toYMD(new Date()),
                nama: nama,
                jumlah: qty,
                satuan: satuanOf(nama),
                pic: currentUser?.nama || '-',
                ket: 'FEFO'
            };
            outLogs.push(newLog);
            localStorage.setItem('outStockLogs', JSON.stringify(outLogs));
            // Push single outStock log immediately
            createSingleToCloud('outStockLogs', newLog);
            scheduleCloudSync();

            closeModal('modalOutStock');
            loadInventori();
            loadDashboard();
            showToast('Out Stock berhasil diproses!');
            clearForm(['outJumlah']);
        }

        function deleteInventori(idx) {
            if (isViewOnly) return;
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]');
            inv.splice(idx, 1);
            localStorage.setItem('inventori', JSON.stringify(inv));
            loadInventori();
        }

        // ==================== UTIL: ASSIGNEE FROM JADWAL ====================
        function populateAssigneeOptions() {
            const select = document.getElementById('tugasAssign');
            if (!select) return;
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const { start, end } = getSchedulePeriod();
            // Ambil nama unik dari jadwal outlet & periode aktif
            const namesSet = new Set(
                jadwal
                    .filter(j => j.outlet === currentOutlet && j.tanggal)
                    .filter(j => {
                        const dt = parseLocalDate(j.tanggal);
                        return dt >= start && dt <= end;
                    })
                    .map(j => (j.nama || '').trim())
                    .filter(n => n)
            );
            const names = Array.from(namesSet).sort((a,b) => a.localeCompare(b, 'id'));
            select.innerHTML = names.length
                ? names.map(n => `<option value="${n}">${n}</option>`).join('')
                : '<option value="">(Belum ada nama pada Jadwal Kerja)</option>';
        }

        function populatePrepPetugasOptions() {
            const select = document.getElementById('prepPetugas');
            if (!select) return;
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const { start, end } = getSchedulePeriod();
            const namesSet = new Set(
                jadwal
                    .filter(j => j.outlet === currentOutlet && j.tanggal)
                    .filter(j => {
                        const dt = parseLocalDate(j.tanggal);
                        return dt >= start && dt <= end;
                    })
                    .map(j => (j.nama || '').trim())
                    .filter(n => n)
            );
            const names = Array.from(namesSet).sort((a,b) => a.localeCompare(b, 'id'));
            select.innerHTML = names.length
                ? names.map(n => `<option value="${n}">${n}</option>`).join('')
                : '<option value="">(Belum ada nama pada Jadwal Kerja)</option>';
        }

        // ==================== LOGBOOK ====================
        function loadLogbook() {
            const logs = JSON.parse(localStorage.getItem('logbook') || '[]').filter(l => l.outlet === currentOutlet);
            const container = document.getElementById('logbookContainer');
            if (logs.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-gray-500">Belum ada catatan log book</div>';
                return;
            }
            container.innerHTML = logs.reverse().map(l => `
                <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 ${l.kategori === 'urgent' ? 'border-red-500' : l.kategori === 'penting' ? 'border-yellow-500' : 'border-blue-500'}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${l.shift === 'pagi' ? 'bg-yellow-100 text-yellow-700' : l.shift === 'siang' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">Shift ${l.shift}</span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${l.kategori === 'urgent' ? 'bg-red-100 text-red-700' : l.kategori === 'penting' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}">${l.kategori}</span>
                        </div>
                        <span class="text-xs text-gray-500">${formatDate(l.tanggal)} ${l.waktu}</span>
                    </div>
                    <p class="text-gray-800">${l.catatan}</p>
                    <p class="text-xs text-gray-500 mt-2"><i class="fas fa-user mr-1"></i>${l.penulis}</p>
                </div>
            `).join('');
        }

        function saveLogbook() {
            const logs = JSON.parse(localStorage.getItem('logbook') || '[]');
            const newItem = {
                id: genId('log'),
                outlet: currentOutlet,
                tanggal: new Date().toISOString().split('T')[0],
                waktu: new Date().toTimeString().slice(0,5),
                shift: document.getElementById('logShift').value,
                kategori: document.getElementById('logKategori').value,
                catatan: document.getElementById('logCatatan').value,
                penulis: currentUser.nama
            };
            logs.push(newItem);
            localStorage.setItem('logbook', JSON.stringify(logs));
            // Push single row immediately
            createSingleToCloud('logbook', newItem);
            closeModal('modalLogbook');
            loadLogbook();
            showToast('Log berhasil disimpan!');
            clearForm(['logCatatan']);
        }

        // ==================== FEEDBACK ====================
        function loadFeedback() {
            const allFb = JSON.parse(localStorage.getItem('feedback') || '[]').filter(f => f.outlet === currentOutlet);
            
            // Get filter values
            const filterTanggal = (document.getElementById('fbFilterTanggal')?.value || '').trim();
            const filterSumber = (document.getElementById('fbFilterSumber')?.value || '').trim();
            const filterKategori = (document.getElementById('fbFilterKategori')?.value || '').trim();
            const filterRating = (document.getElementById('fbFilterRating')?.value || '').trim();
            
            // Calculate statistics from all data (before filter)
            const total = allFb.length;
            // Positive: rating >= 4 atau status puas (bintang 4-5 atau puas)
            const positive = allFb.filter(f => f.rating >= 4 || f.kepuasan === 'puas').length;
            // Negative: rating <= 3 atau status tidak_puas (bintang 1-3 atau tidak puas)
            const negative = allFb.filter(f => (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas').length;
            // Avg rating hanya untuk yang punya rating bintang
            const withRating = allFb.filter(f => f.rating && f.rating > 0);
            const avg = withRating.length ? (withRating.reduce((a,b) => a+b.rating, 0)/withRating.length).toFixed(1) : '0.0';
            
            document.getElementById('avgRating').textContent = avg;
            document.getElementById('totalPositive').textContent = positive;
            document.getElementById('totalNegative').textContent = negative;
            document.getElementById('totalFeedback').textContent = total;
            
            // Apply filters
            let fb = allFb;
            if (filterTanggal) {
                fb = fb.filter(f => f.tanggal === filterTanggal);
            }
            if (filterSumber) {
                fb = fb.filter(f => f.sumber === filterSumber);
            }
            if (filterKategori) {
                fb = fb.filter(f => f.kategori === filterKategori);
            }
            if (filterRating === 'positif') {
                fb = fb.filter(f => f.rating >= 4 || f.kepuasan === 'puas');
            } else if (filterRating === 'negatif') {
                fb = fb.filter(f => (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas');
            }
            
            const tbody = document.getElementById('feedbackTableBody');
            if (fb.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada feedback' + (filterTanggal || filterSumber || filterKategori || filterRating ? ' untuk filter ini' : '') + '</td></tr>';
                return;
            }
            
            const sumberLabel = { google: 'Google Review', wa: 'WA Customer Care', instagram: 'Instagram', onsite: 'On Site' };
            const kategoriLabel = { pelayanan: 'Pelayanan', produk: 'Produk', sikap: 'Sikap Karyawan', lingkungan: 'Lingkungan' };
            
            tbody.innerHTML = fb.slice().reverse().map(f => {
                // Determine if positive or negative
                const isPositive = f.rating >= 4 || f.kepuasan === 'puas';
                const isNegative = (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas';
                
                // Render rating: bintang atau puas/tidak puas
                let ratingHtml = '';
                if (f.sumber === 'google' && f.rating) {
                    const starColor = f.rating >= 4 ? 'text-yellow-400' : 'text-red-400';
                    ratingHtml = `<div class="flex ${starColor}">${'<i class="fas fa-star"></i>'.repeat(f.rating)}${'<i class="far fa-star text-gray-300"></i>'.repeat(5-f.rating)}</div>`;
                } else if (f.kepuasan) {
                    ratingHtml = f.kepuasan === 'puas' 
                        ? '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700"><i class="fas fa-smile mr-1"></i>Puas</span>'
                        : '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700"><i class="fas fa-frown mr-1"></i>Tidak Puas</span>';
                }
                
                // Row background color based on rating
                const rowClass = isNegative ? 'bg-red-50' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3 text-sm text-gray-500">${formatDate(f.tanggal)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${f.nama || '-'}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">${sumberLabel[f.sumber] || f.sumber || '-'}</span></td>
                        <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-700">${kategoriLabel[f.kategori] || f.kategori || '-'}</span></td>
                        <td class="px-4 py-3">${ratingHtml}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 max-w-xs">${f.komentar || '-'}</td>
                        <td class="px-4 py-3 text-sm ${f.capa ? 'text-red-700' : 'text-gray-400'}">${f.capa || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Export Feedback PDF
        async function exportFeedbackPDF() {
            const allFb = JSON.parse(localStorage.getItem('feedback') || '[]').filter(f => f.outlet === currentOutlet);
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);
            
            // Get filter values
            const filterTanggal = (document.getElementById('fbFilterTanggal')?.value || '').trim();
            const filterSumber = (document.getElementById('fbFilterSumber')?.value || '').trim();
            const filterKategori = (document.getElementById('fbFilterKategori')?.value || '').trim();
            const filterRating = (document.getElementById('fbFilterRating')?.value || '').trim();
            
            // Apply filters
            let fb = allFb;
            if (filterTanggal) fb = fb.filter(f => f.tanggal === filterTanggal);
            if (filterSumber) fb = fb.filter(f => f.sumber === filterSumber);
            if (filterKategori) fb = fb.filter(f => f.kategori === filterKategori);
            if (filterRating === 'positif') fb = fb.filter(f => f.rating >= 4 || f.kepuasan === 'puas');
            else if (filterRating === 'negatif') fb = fb.filter(f => (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas');
            
            const sumberLabel = { google: 'Google Review', wa: 'WA Customer Care', instagram: 'Instagram', onsite: 'On Site' };
            const kategoriLabel = { pelayanan: 'Pelayanan', produk: 'Produk', sikap: 'Sikap Karyawan', lingkungan: 'Lingkungan' };
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            
            doc.setFontSize(14);
            doc.text(`Customer Feedback - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            const filterText = [
                filterTanggal ? `Tanggal: ${formatDate(filterTanggal)}` : '',
                filterSumber ? `Sumber: ${sumberLabel[filterSumber]}` : '',
                filterKategori ? `Kategori: ${kategoriLabel[filterKategori]}` : '',
                filterRating ? `Rating: ${filterRating === 'positif' ? 'Positif' : 'Negatif'}` : ''
            ].filter(x => x).join(' | ') || 'Semua Data';
            doc.text(`Filter: ${filterText}`, 40, 58);
            
            const rows = fb.slice().reverse().map(f => {
                let ratingText = '';
                if (f.sumber === 'google' && f.rating) {
                    ratingText = ''.repeat(f.rating) + ''.repeat(5 - f.rating);
                } else if (f.kepuasan) {
                    ratingText = f.kepuasan === 'puas' ? 'Puas' : 'Tidak Puas';
                }
                return [
                    formatDate(f.tanggal),
                    f.nama || '-',
                    sumberLabel[f.sumber] || f.sumber || '-',
                    kategoriLabel[f.kategori] || f.kategori || '-',
                    ratingText,
                    (f.komentar || '-').substring(0, 50) + (f.komentar && f.komentar.length > 50 ? '...' : ''),
                    (f.capa || '-').substring(0, 40) + (f.capa && f.capa.length > 40 ? '...' : '')
                ];
            });
            
            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Customer', 'Sumber', 'Kategori', 'Rating', 'Komentar', 'CAPA']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-', '-', '-']],
                styles: { fontSize: 8 },
                headStyles: { fillColor: [59, 130, 246] },
                columnStyles: {
                    5: { cellWidth: 150 },
                    6: { cellWidth: 120 }
                }
            });
            
            doc.save(`Feedback_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(new Date())}.pdf`);
        }

        function onFbSumberChange() {
            const sumber = document.getElementById('fbSumber').value;
            const starsContainer = document.getElementById('ratingStarsContainer');
            const puasContainer = document.getElementById('ratingPuasContainer');
            const capaContainer = document.getElementById('fbCapaContainer');
            
            if (sumber === 'google') {
                starsContainer.classList.remove('hidden');
                puasContainer.classList.add('hidden');
            } else {
                starsContainer.classList.add('hidden');
                puasContainer.classList.remove('hidden');
                // Reset radio
                document.querySelectorAll('input[name="fbPuas"]').forEach(r => r.checked = false);
            }
            
            // Reset CAPA
            capaContainer.classList.add('hidden');
            document.getElementById('fbCapa').value = '';
            
            // Reset rating
            setRating(0);
        }

        function setRating(rating) {
            selectedRating = rating;
            document.getElementById('fbRating').value = rating;
            const stars = document.querySelectorAll('#ratingStars button');
            stars.forEach((s, i) => {
                s.classList.toggle('text-yellow-400', i < rating);
                s.classList.toggle('text-gray-300', i >= rating);
            });
            
            // Show CAPA if rating 1-3
            const capaContainer = document.getElementById('fbCapaContainer');
            if (rating >= 1 && rating <= 3) {
                capaContainer.classList.remove('hidden');
            } else {
                capaContainer.classList.add('hidden');
            }
        }

        function onPuasChange() {
            const selected = document.querySelector('input[name="fbPuas"]:checked');
            const capaContainer = document.getElementById('fbCapaContainer');
            
            if (selected && selected.value === 'tidak_puas') {
                capaContainer.classList.remove('hidden');
            } else {
                capaContainer.classList.add('hidden');
            }
        }

        function saveFeedback() {
            const sumber = document.getElementById('fbSumber').value;
            const nama = document.getElementById('fbNama').value;
            const kategori = document.getElementById('fbKategori').value;
            const komentar = document.getElementById('fbKomentar').value;
            const capa = document.getElementById('fbCapa').value.trim();
            
            let rating = 0;
            let kepuasan = '';
            let isNegative = false;
            
            if (sumber === 'google') {
                rating = parseInt(document.getElementById('fbRating').value) || 0;
                if (rating === 0) {
                    showToast('Silakan pilih rating bintang');
                    return;
                }
                // Bintang 1-3 = negatif, bintang 4-5 = positif
                isNegative = rating <= 3;
            } else {
                const puasSelected = document.querySelector('input[name="fbPuas"]:checked');
                if (!puasSelected) {
                    showToast('Silakan pilih Puas atau Tidak Puas');
                    return;
                }
                kepuasan = puasSelected.value;
                isNegative = kepuasan === 'tidak_puas';
                // Convert to rating for statistics (puas = 5, tidak puas = 1)
                rating = kepuasan === 'puas' ? 5 : 1;
            }
            
            // Validate CAPA for negative feedback (bintang 1-3 atau tidak puas)
            if (isNegative && !capa) {
                showToast('CAPA wajib diisi untuk feedback negatif (1-3 atau Tidak Puas)');
                document.getElementById('fbCapa').focus();
                return;
            }
            
            const fb = JSON.parse(localStorage.getItem('feedback') || '[]');
            const newItem = {
                id: genId('fb'),
                outlet: currentOutlet,
                tanggal: toYMD(new Date()),
                nama: nama,
                sumber: sumber,
                kategori: kategori,
                rating: rating,
                kepuasan: kepuasan,
                komentar: komentar,
                capa: isNegative ? capa : ''
            };
            fb.push(newItem);
            localStorage.setItem('feedback', JSON.stringify(fb));
            // Push single row immediately
            createSingleToCloud('feedback', newItem);
            closeModal('modalFeedback');
            resetFeedbackForm();
            loadFeedback();
            loadDashboard();
            showToast('Feedback berhasil disimpan!');
        }

        function resetFeedbackForm() {
            setRating(0);
            document.getElementById('fbNama').value = '';
            document.getElementById('fbSumber').value = 'google';
            document.getElementById('fbKategori').value = 'pelayanan';
            document.getElementById('fbKomentar').value = '';
            document.getElementById('fbCapa').value = '';
            document.querySelectorAll('input[name="fbPuas"]').forEach(r => r.checked = false);
            document.getElementById('ratingStarsContainer').classList.remove('hidden');
            document.getElementById('ratingPuasContainer').classList.add('hidden');
            document.getElementById('fbCapaContainer').classList.add('hidden');
        }

        // ==================== SETTINGS: CHECKLIST ====================
        function loadChecklistSettings() {
            const items = JSON.parse(localStorage.getItem('checklistItems') || '[]');
            const tbody = document.getElementById('checklistSettingTable');
            tbody.innerHTML = items.map((i, idx) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900 capitalize">${i.kategori}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${i.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${(i.waktu || (Array.isArray(i.shift) ? i.shift.join(',') : '')).replace('pra','Pra Opening').replace('during','During').replace('after','After Closing')}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">${i.status}</span></td>
                    <td class="px-6 py-4 action-column"><button onclick="deleteChecklistItem(${idx})" class="text-red-600 hover:text-red-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function saveChecklistSetting() {
            const items = JSON.parse(localStorage.getItem('checklistItems') || '[]');
            items.push({
                id: Date.now(),
                kategori: document.getElementById('clsKategori').value,
                nama: document.getElementById('clsNama').value,
                waktu: document.getElementById('clsWaktu').value,
                status: 'aktif'
            });
            localStorage.setItem('checklistItems', JSON.stringify(items));
            closeModal('modalChecklistSetting');
            loadChecklistSettings();
            showToast('Item checklist berhasil ditambahkan!');
            clearForm(['clsNama']);
        }

        function deleteChecklistItem(idx) {
            if (isViewOnly) return;
            const items = JSON.parse(localStorage.getItem('checklistItems') || '[]');
            items.splice(idx, 1);
            localStorage.setItem('checklistItems', JSON.stringify(items));
            loadChecklistSettings();
        }

        function resetChecklistMaster() {
            try {
                const existing = JSON.parse(localStorage.getItem('checklistItems') || '[]');
                const afterItems = existing.filter(i => i && i.waktu === 'after');
                const custom = existing.filter(i => !i.waktu);
                const praDuringList = [
                    "Muka bersih tidak berminyak dan merias wajah sesuai standar",
                    "Kulit tidak kering dan tidak bersisik memakai body lotion",
                    "Kuku pendek dan tidak menggunakan cat kuku",
                    "Bulu atau rambut hidung tidak menjorok keluar lubang hidung",
                    "Tidak ada bau yang tidak sedap dari badan, mulut, telinga atau bagian tubuh lainnya termasuk parfume yang aromanya menyengat",
                    "Mengenakan baju dan celana sesuai standar bentuk, warna bahan yang ditetapkan dalam kondisi bersih dan rapi",
                    "Memakai sepatu pantofel warna hitam dengan maksimal tinggi 3 cm dalam kondisi bersih dan mengkilap (bersemir)",
                    "Memakai ikat pinggang warna hitam polos terbuat dari kulit bukan kain atau sintetis dengan kepala gesper yang sederhana",
                    "Memakai kaos singlet warna putih",
                    "Tidak memakai gelang, anting, kalung, jam tangan atau aksesoris lainnya",
                    "Tidak ada tato di bagian tubuh yang terbuka",
                    "Pakai name tag sesuai standar yang ditetapkan",
                    "Memakai masker hitam dan kelengkapan kerja sesuai jabatannya",
                    "Rambut rapi dengan maksimal panjang 5 cm, tidak kusam/kering, rapi menggunakan minyak rambut yang tidak berbau menyengat",
                    "Tidak memelihara kumis, jenggot dan jambang dipotong sejajar ekor mata",
                    "Hijab dalam keadaan rapi, terutama pada bagian leher harus kelihatan bentuk leher dengan bantuan jepit/bros tanpa manik dan warna sesuai warna hijab",
                    "Dilarang menggunakan jarum pentul",
                    "Memakai dalaman hijab berwarna hitam polos",
                    "Rambut panjang harus memakai hairnet dan poni tidak menjuntai ke depan menutupi dahi",
                    "Order Barang sudah dicek kacab, diinput dan dikirim ke bagian gudang",
                    "Labeling pada pada barang datang, hasil prepare dan atau hasil produksi sudah dilakukan",
                    "Rekap Pemakaian sudah dikerjakan dan dikirim ke bagian akuntansi",
                    "Pencatatan produksi cabang, produksi pusat sudah dikerjakan dan diverifikasi",
                    "Laporan Piutang (Bagi cabang yang ada transaksi piutang) sudah dikerjakan dan atau dikirim ke bagian akuntansi",
                    "Kesiapan Kelengkapan, Kebersihan, serta Kecukupan Sumber Daya (Area Dinning, Juicer, Kasir, Dapur)",
                    "Sendok, garpu, pisau roti dan sumpit tersedia dalam kondisi cukup",
                    "Tissue meja, saos, kecap, sambal dalam kondisi terisi cukup dan tidak belepotan",
                    "Nampan, buku menu, slip order dan alat tulis tersedia dalam kondisi bersih dan cukup ",
                    "Kain Lap Meja (waiter, juicer, kasir dan dapur) dalam kondisi bersih dan tidak ada bau tidak sedap",
                    "Kain Lap Sendok, gelas dan piring dalam kondisi bersih dan tidak ada bau tidak sedap",
                    "Hand sanitizer pada posisi pintu masuk & kasir",
                    "Disinfektan tersedia dalam kondisi cukup",
                    "Semua meja, kursi, sofa, kursi anak  dalam kondisi bersih dan tertata rapi",
                    "Semua pegangan pintu, pegangan anak tangga, pembatas antrian dalam kondisi bersih",
                    "Wastafel dalam kondisi bersih, tersedia hand soap, tissue, tempat sampah, cermin",
                    "Tempat Sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                    "Pad counter dalam kondisi bersih dan barang-barang tertata rapi",
                    "Semua Dinding (dining, juicer, kasir, dapur, gudang) dalam kondisi bersih",
                    "Semua lantai (dinning, kasir, juicer, dapur, gudang) dan gotter dalam kondisi bersih",
                    "Kaca (jendela, interior) dalam kondisi bersih tidak buram",
                    "Diffuser AC / AC dalam kondisi bersih dan dingin",
                    "TV display, Audio player dalam kondisi normal dan bersih",
                    "Interior (gambar dinding, lampu gantung, furniture) dalam kondisi bersih",
                    "Service Extension dalam kondisi rapi dan bersih",
                    "Lampu (dining, box menu, Logo) dalam kondisi menyala normal dan bersih",
                    "Tanaman Hias tidak ada yang layu daunnya",
                    "Sarana Promosi (x banner, tripod banner, standing menu, baliho) dalam kondisi layak dan bersih",
                    "Peralatan proses juicer (Blender, Juicer, extractor, sendok ukur, pisau, talenan, saringan juice, teh, scoop es krim, tea maker, mesin serut es, mesin cup sealer, es maker, timbangan) dalam kondisi berfungsi normal dan bersih",
                    "Alat saji (Plate coupe 7.5, 8, 9, 10,5. Saucer 4,25. Bowl 4.5, 6, Bowl omega 7, square plate besar, kecil, piring snack, piring lauk, mangkok kuring/ramen, saucer, sendok, gelas juice, gelas teh, cangkir kopi, lunch box, box gurame, paper bowl set 650, 800, 1000, cup oval, cup 400, 500, sedotan) dalam kondisi cukup dan bersih",
                    "Meja kerja di semua area dalam kondisi bersih dan penataan barang-barang rapi",
                    "Alegro dalam kondisi berfungsi normal, bersih dan penataan buah rapi",
                    "Freezer, under freezer, chiller, under chiller, salad case (gasket, kaca, rak, kipas, handle, body) juicer dan dapur dalam kondisi berfungsi normal, bersih, bunga es tidak tebal dan penataan bahan baku rapi",
                    "Chiller, salad case juicer dan dapur dalam kondisi normal dan bersih",
                    "Tempat prepare di area juicer dan dapur (food pan, kitchen set, termos nasi, keranjang, toples, box risol, box thawing) dalam kondisi tertutup dan dalam kondisi bersih",
                    "Tempat penyimpanan bahan baku & produk (rak susun, rak tempel dan lemari penyimpanan termasuk laci-laci) dalam kondisi bersih dan barang-barang tersusun rapi",
                    "Sink, grease trap, grease induk dan gutter dalam kondisi bersih",
                    "Langit-langit semua area dalam kondisi baik dan bersih",
                    "Tempat sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                    "Dinding semua area dalam kondisi bersih",
                    "Mesin POS, alat pembayaran (EDC BCA, Mandiri, BRI, Gobiz, Grabfood, Handphone, HT dalam kondisi normal dan bersih",
                    "Setor omset maksimal jam 14.00 dan laporan setor omzet ke bagian keuangan",
                    "Kelengkapan peralatan kasir (kalkulator, money detector, stepless, isolatif) dalam kondisi cukup",
                    "Uang receh tersedia cukup (20rb, 10rb, 5rb, 2rb, 1rb, 500, 200, 100)",
                    "Peralatan proses cook (steamer nasi, rice cooker, gas cooker, steamer, magic com, microwave, toaster, panci, wajan, sodet, saringan mie, saringan minyak, jepitan makanan, deep fryer, teflon, cetakan nasi, kompor high, kompor low, pisau, talenan, parutan keju, timbangan) dalam kondisi layak pakai, bersih dan bebas dari kontaminasi antar alat, maupun dari  dari hal-hal lainnya",
                    "Hood dan exhaust dalam kondisi bersih dan berfungsi normal",
                    "Mesin cuci piring dan mesin pembuat es dalam kondisi bersih dan berfungsi normal",
                    "Semua area bebas dari hama(tikus, kecoa, lalat, semut)",
                    "Fasilitas toilet di dalam cabang",
                    "Handle pintu dan kunci pintu berfungsi normal dan bersih",
                    "Aroma toilet harum atau tidak berbau tidak sedap",
                    "Lantai dan dinding dalam kondisi bersih dan kering",
                    "Lampu penerangan tidak ada yang mati dan fan exhaust dengan kondisi bersih dan berfungsi normal",
                    "Kloset dalam kondisi baik,bersih dan kering",
                    "Shower kloset berfungsi normal dan bersih",
                    "Wastafel dalam kondisi normal dan bersih serta tersedia hand soap dan tissue",
                    "Urinoir dalam kondisi bersih, berfungsi normal dan tidak beraroma tidak sedap",
                    "Tempat Sampah dalam kondisi bersih tidak ada bau tidak sedap"
                ];
                const baseItems = [];
                let idCounter = Date.now();
                praDuringList.forEach(n => baseItems.push({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'pra', status: 'aktif' }));
                praDuringList.forEach(n => baseItems.push({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'during', status: 'aktif' }));
                const newItems = [...baseItems, ...afterItems, ...custom];
                localStorage.setItem('checklistItems', JSON.stringify(newItems));
                localStorage.setItem('checklistV2', '1');

                // Sync only checklistItems to Cloud (GET anti-CORS with fallback)
                const baseUrl = getApiUrl();
                if (baseUrl) {
                    (async () => {
                        try {
                            const dataStr = JSON.stringify(newItems);
                            const encoded = encodeURIComponent(dataStr);
                            if (encoded.length > 1400) {
                                await getJSON(`${baseUrl}?action=sync&sheet=checklistItems&data=%5B%5D`);
                                for (let i = 0; i < newItems.length; i++) {
                                    await getJSON(`${baseUrl}?action=create&sheet=checklistItems&data=${encodeURIComponent(JSON.stringify(newItems[i]))}`);
                                }
                            } else {
                                await getJSON(`${baseUrl}?action=sync&sheet=checklistItems&data=${encoded}`);
                            }
                            console.log(' Master checklist tersinkron ke cloud:', newItems.length);
                            if (currentModule === 'settings-checklist') loadChecklistSettings();
                            showToast('Master checklist berhasil direset & disinkronkan');
                        } catch (e) {
                            console.warn(' Gagal sync master checklist:', e);
                            if (currentModule === 'settings-checklist') loadChecklistSettings();
                            showToast('Master checklist direset (local), sync gagal');
                        }
                    })();
                } else {
                    if (currentModule === 'settings-checklist') loadChecklistSettings();
                    showToast('Master checklist direset (local).');
                }
            } catch (e) {
                console.error(e);
                showToast('Gagal reset master checklist');
            }
        }

        // ==================== SETTINGS: OUTLET ====================
        function loadOutlets() {
            // Run dedupe to ensure no duplicates are shown
            try { dedupeOutlets(); } catch(e) {}
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const container = document.getElementById('outletContainer');
            
            // Filter outlets based on role
            let filteredOutlets = outlets;
            if (currentUser.role !== 'admin' && currentUser.role !== 'head-office') {
                filteredOutlets = outlets.filter(o => allowedOutlets.includes(o.id));
            }
            
            container.innerHTML = filteredOutlets.map((o, idx) => `
                <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-store text-blue-600 text-xl"></i>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${o.status === 'aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${o.status}</span>
                    </div>
                    <p class="text-xs text-gray-400 mb-1">${o.kode || '-'}</p>
                    <h3 class="font-bold text-gray-800">${o.nama}</h3>
                    <p class="text-sm text-gray-500 mt-1">${o.alamat}</p>
                    <p class="text-sm text-gray-500"><i class="fas fa-phone mr-1"></i>${o.telp}</p>
                    <p class="text-sm text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${o.area}</p>
                    ${currentUser.role === 'admin' ? `
                    <div class="mt-4 flex gap-2">
                        <button onclick="deleteOutlet('${o.id}')" class="text-red-600 hover:text-red-800 text-sm"><i class="fas fa-trash mr-1"></i>Hapus</button>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function saveOutlet() {
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const namaBaru = (document.getElementById('outletNama').value || '').trim();
            // Prevent duplicate by normalized name
            const normalize = (s) => (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
            const exists = outlets.some(o => normalize(o.nama) === normalize(namaBaru));
            if (exists) {
                showToast('Nama outlet sudah ada. Gunakan nama lain.');
                return;
            }
            const newId = 'outlet-' + Date.now();
            outlets.push({
                id: newId,
                kode: document.getElementById('outletKode').value,
                nama: namaBaru,
                alamat: document.getElementById('outletAlamat').value,
                telp: document.getElementById('outletTelp').value,
                area: document.getElementById('outletArea').value,
                status: 'aktif'
            });
            localStorage.setItem('outlets', JSON.stringify(outlets));
            // Run dedupe after add just in case
            try { dedupeOutlets(); } catch(e) {}
            closeModal('modalOutlet');
            loadOutlets();
            populateOutletSelector();
            showToast('Outlet berhasil ditambahkan!');
            clearForm(['outletKode', 'outletNama', 'outletAlamat', 'outletTelp', 'outletArea']);
        }

        function deleteOutlet(id) {
            if (currentUser.role !== 'admin') return;
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const idx = outlets.findIndex(o => o.id === id);
            if (idx > -1) {
                outlets.splice(idx, 1);
                localStorage.setItem('outlets', JSON.stringify(outlets));
                loadOutlets();
                populateOutletSelector();
            }
        }

        // ==================== SETTINGS: USERS ====================
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const tbody = document.getElementById('userTable');
            
            if (!Array.isArray(users) || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada user</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map((u, idx) => {
                const kode = (u && u.kode) ? u.kode : '-';
                const nama = (u && u.nama) ? u.nama : '-';
                const role = (u && u.role) ? getRoleName(u.role) : '-';
                const status = (u && u.status) ? u.status : 'aktif';
                let outletNames = 'Semua Outlet';
                if (u && u.outlets !== 'all' && Array.isArray(u.outlets)) {
                    outletNames = u.outlets.map(oid => {
                        const o = outlets.find(x => x.id === oid);
                        return o ? o.nama : (oid || '-');
                    }).join(', ');
                } else if (u && u.outlets !== 'all') {
                    const o = outlets.find(x => x.id === u.outlets);
                    outletNames = o ? o.nama : (u.outlets || '-');
                }
                
                return `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900 font-mono">${kode}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${nama}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">${role}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${outletNames}">${outletNames}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">${status}</span></td>
                    <td class="px-6 py-4 action-column"><button onclick="deleteUser(${idx})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td>
                </tr>
            `}).join('');
        }

        function onUserRoleChange() {
            const role = document.getElementById('userRoleSelect').value;
            const outletDiv = document.getElementById('outletAssignmentDiv');
            const checkboxes = document.getElementById('outletCheckboxes');
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            
            if (role === 'admin' || role === 'head-office') {
                outletDiv.classList.add('hidden');
            } else {
                outletDiv.classList.remove('hidden');
                checkboxes.innerHTML = outlets.map(o => `
                    <label class="flex items-center gap-2">
                        <input type="checkbox" value="${o.id}" class="outlet-checkbox rounded border-gray-300">
                        <span class="text-sm">${o.nama}</span>
                    </label>
                `).join('');
            }
        }

        function saveUser() {
            const role = document.getElementById('userRoleSelect').value;
            let outlets;
            
            if (role === 'admin' || role === 'head-office') {
                outlets = 'all';
            } else {
                const checked = document.querySelectorAll('.outlet-checkbox:checked');
                outlets = Array.from(checked).map(c => c.value);
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            users.push({
                kode: document.getElementById('userKode').value,
                nama: document.getElementById('userNama').value,
                role: role,
                outlets: outlets,
                status: 'aktif'
            });
            localStorage.setItem('users', JSON.stringify(users));
            closeModal('modalUser');
            loadUsers();
            showToast('User berhasil ditambahkan!');
            clearForm(['userKode', 'userNama']);
        }

        function deleteUser(idx) {
            if (currentUser.role !== 'admin') return;
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            users.splice(idx, 1);
            localStorage.setItem('users', JSON.stringify(users));
            loadUsers();
        }

        // ==================== SPREADSHEET ====================
        function saveSpreadsheetConfig() {
            const config = {
                spreadsheetId: document.getElementById('spreadsheetId').value,
                apiKey: document.getElementById('apiKey').value,
                webAppUrl: document.getElementById('webAppUrl').value.trim()
            };
            if (!config.webAppUrl) {
                showToast('Web App URL wajib diisi!');
                return;
            }
            localStorage.setItem('spreadsheetConfig', JSON.stringify(config));
            showToast('Konfigurasi berhasil disimpan!');
        }

        // Helper API (GET-only to avoid CORS)
        function getApiUrl() {
            const cfg = JSON.parse(localStorage.getItem('spreadsheetConfig') || '{}');
            return (cfg.webAppUrl || '').replace(/\/$/, '');
        }
        function enc(obj) { return encodeURIComponent(JSON.stringify(obj || {})); }
        async function getJSON(url) {
            try {
                const res = await fetch(url, { method: 'GET' });
                return await res.json();
            } catch (e) {
                return { success: false, error: e.message };
            }
        }
        // JSONP helper (anti-CORS read)
        function jsonp(url, callbackName = '') {
            return new Promise((resolve) => {
                const cb = callbackName || `cb_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                const script = document.createElement('script');
                const cleanup = () => {
                    try { delete window[cb]; } catch(e) {}
                    if (script && script.parentNode) script.parentNode.removeChild(script);
                };
                window[cb] = (payload) => { cleanup(); resolve(payload || { success:false, data:null, error:'Empty JSONP payload' }); };
                const sep = url.includes('?') ? '&' : '?';
                script.src = `${url}${sep}callback=${cb}`;
                script.onerror = () => { cleanup(); resolve({ success:false, data:null, error:'JSONP load error' }); };
                document.body.appendChild(script);
            });
        }
        function isCloudConfigured() {
            try { const url = getApiUrl(); return !!url; } catch(e){ return false; }
        }
        function showCloudAlert() {
            const el = document.getElementById('cloudAlert');
            if (el) el.classList.remove('hidden');
        }
        function hideCloudAlert() {
            const el = document.getElementById('cloudAlert');
            if (el) el.classList.add('hidden');
        }

        // Debounced auto-sync trigger + Single-row cloud create (anti-CORS)
        let __syncTimer = null;
        async function createSingleToCloud(sheetName, item) {
            const baseUrl = getApiUrl();
            if (!baseUrl || !item) return;
            try {
                const obj = { ...item };
                if (!obj.id) obj.id = `${sheetName}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
                // GET anti-CORS create
                await getJSON(`${baseUrl}?action=create&sheet=${encodeURIComponent(sheetName)}&data=${encodeURIComponent(JSON.stringify(obj))}`);
                console.log(` Created 1 row to cloud [${sheetName}]`);
            } catch (e) {
                console.warn(' Create cloud failed', sheetName, e);
            }
        }
        function scheduleCloudSync(delay = 2000) {
            clearTimeout(__syncTimer);
            __syncTimer = setTimeout(() => initialSyncToCloud(), delay);
        }
        window.addEventListener('online', () => scheduleCloudSync(500));

        async function testConnection() {
            const baseUrl = getApiUrl();
            if (!baseUrl) { showToast('Masukkan Web App URL terlebih dahulu!'); return; }
            showToast('Menguji koneksi...');
            const result = await getJSON(`${baseUrl}?action=ping`);
            if (result.success && result.data === 'pong') {
                showToast(' Koneksi berhasil! Memulai sinkronisasi...');
                setTimeout(() => initialSyncToCloud(), 600);
            } else {
                showToast(' Koneksi gagal: ' + (result.error || 'Unknown error'));
            }
        }
        
        async function initialSyncToCloud() {
            const baseUrl = getApiUrl();
            if (!baseUrl) return;
            showToast(' Mengunggah data ke cloud...');

            const sheets = [
                { name: 'users', key: 'users' },
                { name: 'outlets', key: 'outlets' },
                { name: 'jadwal', key: 'jadwal' },
                { name: 'tugas', key: 'tugas' },
                { name: 'preparation', key: 'preparation' },
                { name: 'checklistItems', key: 'checklistItems' },
                { name: 'checklistStatus', key: 'checklistStatus' },
                { name: 'checklistCorrective', key: 'checklistCorrective' },
                { name: 'reject', key: 'reject' },
                { name: 'inventori', key: 'inventori' },
                { name: 'outStockLogs', key: 'outStockLogs' },
                { name: 'logbook', key: 'logbook' },
                { name: 'feedback', key: 'feedback' },
                { name: 'activities', key: 'activities' }
            ];

            let successCount = 0;
            let errorCount = 0;

            for (const sheet of sheets) {
                try {
                    const localData = JSON.parse(localStorage.getItem(sheet.key) || '[]');
                    const dataWithIds = localData.map((item, idx) => {
                        if (item && typeof item === 'object' && !item.id) item.id = `${sheet.key}-${Date.now()}-${idx}`;
                        return item;
                    });
                    const dataStr = JSON.stringify(dataWithIds);
                    const encoded = encodeURIComponent(dataStr);

                    // Fallback strategy for long URLs
                    if (encoded.length > 1400) {
                        // Clear first
                        const clearRes = await getJSON(`${baseUrl}?action=sync&sheet=${encodeURIComponent(sheet.name)}&data=%5B%5D`);
                        if (!clearRes.success) { errorCount++; console.error('Clear failed', sheet.name, clearRes.error); continue; }
                        // Create one by one
                        for (let i = 0; i < dataWithIds.length; i++) {
                            const item = dataWithIds[i];
                            const cr = await getJSON(`${baseUrl}?action=create&sheet=${encodeURIComponent(sheet.name)}&data=${encodeURIComponent(JSON.stringify(item))}`);
                            if (!cr.success) { errorCount++; console.error(`Create failed on ${sheet.name} idx ${i+1}`, cr.error); }
                        }
                        successCount++;
                        console.log(` Synced ${sheet.name} (fallback create): ${dataWithIds.length}`);
                    } else {
                        // Single sync
                        const res = await getJSON(`${baseUrl}?action=sync&sheet=${encodeURIComponent(sheet.name)}&data=${encoded}`);
                        if (res.success) { successCount++; console.log(` Synced ${sheet.name}: ${dataWithIds.length}`); }
                        else { errorCount++; console.error(` Failed to sync ${sheet.name}:`, res.error); }
                    }
                } catch (err) {
                    errorCount++;
                    console.error(` Error syncing ${sheet.name}:`, err);
                }
            }

            if (errorCount === 0) {
                showToast(` Sinkronisasi selesai! ${successCount} sheet berhasil diupload`);
            } else {
                showToast(` Sinkronisasi: ${successCount} berhasil, ${errorCount} gagal`);
            }
        }
        
        async function pullDataFromCloud() {
            const baseUrl = getApiUrl();
            if (!baseUrl) { showToast('Konfigurasi Web App URL belum diisi!'); showCloudAlert(); return; }

            // Helper: GViz reader (fallback tanpa CORS) dari Spreadsheet ID
            async function readViaGviz(sheetName) {
                try {
                    const cfg = JSON.parse(localStorage.getItem('spreadsheetConfig') || '{}');
                    const sid = cfg.spreadsheetId || DEFAULT_SPREADSHEET_ID;
                    if (!sid) return null;
                    const url = `https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                    const resp = await fetch(url, { method: 'GET', cache: 'no-store' });
                    const text = await resp.text();
                    const start = text.indexOf('{');
                    const end = text.lastIndexOf('}');
                    if (start === -1 || end === -1) return null;
                    const json = JSON.parse(text.slice(start, end + 1));
                    if (!json || !json.table) return null;
                    const cols = (json.table.cols || []).map((c, i) => c && (c.label || c.id) ? (c.label || c.id) : `c${i}`);
                    const rows = (json.table.rows || []).map(r => {
                        const obj = {};
                        (r.c || []).forEach((cell, i) => {
                            obj[cols[i]] = cell && Object.prototype.hasOwnProperty.call(cell, 'v') ? (cell.v === null ? '' : cell.v) : '';
                        });
                        return obj;
                    });
                    return rows;
                } catch (e) {
                    console.warn('GViz fallback error:', e);
                    return null;
                }
            }

            // silent pull: jangan tampilkan toast agar tidak mengganggu UI
            const sheets = [
                { name: 'users', key: 'users' },
                { name: 'outlets', key: 'outlets' },
                { name: 'jadwal', key: 'jadwal' },
                { name: 'tugas', key: 'tugas' },
                { name: 'preparation', key: 'preparation' },
                { name: 'checklistItems', key: 'checklistItems' },
                { name: 'checklistStatus', key: 'checklistStatus' },
                { name: 'checklistCorrective', key: 'checklistCorrective' },
                { name: 'reject', key: 'reject' },
                { name: 'inventori', key: 'inventori' },
                { name: 'outStockLogs', key: 'outStockLogs' },
                { name: 'logbook', key: 'logbook' },
                { name: 'feedback', key: 'feedback' },
                { name: 'activities', key: 'activities' }
            ];

            let successCount = 0;
            for (const sheet of sheets) {
                try {
                    let dataArr = null;

                    // 1) JSONP (readp)  cara utama anti-CORS
                    const res = await jsonp(`${baseUrl}?action=readp&sheet=${encodeURIComponent(sheet.name)}`);
                    if (res && res.success && Array.isArray(res.data)) {
                        dataArr = res.data;
                    }

                    // 2) Fallback GViz (publish/view only) bila JSONP gagal atau kosong
                    if (!Array.isArray(dataArr)) {
                        const gRows = await readViaGviz(sheet.name);
                        if (Array.isArray(gRows)) {
                            dataArr = gRows;
                        }
                    }

                    if (Array.isArray(dataArr)) {
                        // Safe-save strategy: avoid wiping local when cloud returns empty/partial
                        let prev = [];
                        try { prev = JSON.parse(localStorage.getItem(sheet.key) || '[]'); } catch (e) { prev = []; }
                        let saveArr = dataArr;

                        // 1) If cloud returns empty but we have local data, keep local (skip overwrite)
                        if ((dataArr.length === 0) && Array.isArray(prev) && prev.length > 0) {
                            console.warn(` Skip overwrite ${sheet.name}: remote empty, keep local ${prev.length}`);
                        } else {
                            // 2) If both sides have id and cloud has fewer items, merge by id to avoid data loss
                            const hasIdNew = dataArr.length && typeof dataArr[0] === 'object' && dataArr[0] && ('id' in dataArr[0]);
                            const hasIdPrev = prev.length && typeof prev[0] === 'object' && prev[0] && ('id' in prev[0]);
                            if (hasIdNew && hasIdPrev && prev.length > dataArr.length) {
                                const map = new Map();
                                dataArr.forEach(it => { if (it && it.id != null) map.set(it.id, it); });
                                prev.forEach(it => { if (it && it.id != null && !map.has(it.id)) map.set(it.id, it); });
                                saveArr = Array.from(map.values());
                                console.log(` Merged ${sheet.name}: cloud ${dataArr.length} + kept ${saveArr.length - dataArr.length} = ${saveArr.length}`);
                            }

                            localStorage.setItem(sheet.key, JSON.stringify(saveArr));
                            successCount++;
                            console.log(` Pulled ${sheet.name}: ${saveArr.length} items`);
                        }
                    } else {
                        console.warn(` Gagal menarik sheet ${sheet.name} (data kosong atau error)`);
                    }

                    // Throttle untuk menghindari rate limit Apps Script / GViz
                    await new Promise(r => setTimeout(r, 200));
                } catch (err) {
                    console.error(` Error pulling ${sheet.name}:`, err);
                }
            }

            // Setelah pull: merge ulang master (users/outlets dlsb) agar tidak hilang jika data cloud masih sedikit
            try {
                mergeUserDatabase();
                // Dedupe outlets again after cloud pull (in case cloud had duplicates)
                try { dedupeOutlets(); } catch(e) {}
            } catch (e) { console.warn('Merge user database after cloud pull failed:', e); }

            // Simpan timestamp pull terakhir
            try { localStorage.setItem('lastCloudPullAt', String(Date.now())); } catch (e) {}
            hideCloudAlert();

            // Refresh session & selector (ids from cloud mungkin berubah)
            try {
                if (currentUser) {
                    setupUserSession();
                    populateOutletSelector();
                }
            } catch (e) { console.warn('Session refresh after cloud pull failed:', e); }

            // Hindari double render saat auto-pull yang sering; debounce render
            clearTimeout(window.__afterPullRenderTimer);
            window.__afterPullRenderTimer = setTimeout(() => {
                // jangan tampilkan toast sukses agar UI bersih
                // console.log digunakan sebagai log non-intrusif
                console.log(` Data dari cloud berhasil diunduh! (${successCount} sheet)`);
                const activeModule = document.querySelector('.module-section.active');
                if (activeModule) {
                    const moduleId = activeModule.id.replace('module-', '');
                    loadModuleData(moduleId);
                }
            }, 200);
            
        }

        // Auto-pull lintas-perangkat: saat login, saat tab aktif, saat online, dan tiap 3 menit
        function autoCloudStart() {
            // Tarik sekali saat start (sebelum render modul berat)
            pullDataFromCloud();
            // Saat kembali online
            window.addEventListener('online', () => {
                console.log(' Online kembali - menarik data dari cloud');
                pullDataFromCloud();
            });
            // Saat tab menjadi aktif
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    const last = Number(localStorage.getItem('lastCloudPullAt') || '0');
                    // Pull ringan jika sudah > 15 detik sejak pull terakhir
                    if (Date.now() - last > 15000) {
                        console.log(' Tab aktif - refresh data dari cloud');
                        pullDataFromCloud();
                    }
                }
            });
            // Tarik berkala tiap 30 detik agar lintas perangkat lebih segar
            if (window.__autoCloudTimer) clearInterval(window.__autoCloudTimer);
            window.__autoCloudTimer = setInterval(() => {
                console.log(' Auto refresh cloud data (30s)');
                pullDataFromCloud();
            }, 30000);
        }

        // ==================== EXPORT CHECKLIST PDF ====================
        function exportChecklistPDF() {
            try {
                const waktu = document.getElementById('checklistShift').value; // pra|during|after
                const labelWaktu = waktu === 'pra' ? 'Pra Opening' : waktu === 'during' ? 'During' : 'After Closing';
                const items = (JSON.parse(localStorage.getItem('checklistItems') || '[]') || []).filter(i => i.waktu === waktu);
                const today = toYMD(new Date());
                const todayKey = `${today}_${currentOutlet}_${waktu}`;
                const statusMapAll = JSON.parse(localStorage.getItem('checklistStatus') || '{}') || {};
                const correctiveMapAll = JSON.parse(localStorage.getItem('checklistCorrective') || '{}') || {};
                const statusMap = statusMapAll[todayKey] || {};
                const correctiveMap = correctiveMapAll[todayKey] || {};
                const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
                const outlet = outlets.find(o => o.id === currentOutlet);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

                // Page header & footer styling
                const pageWidth = doc.internal.pageSize.getWidth();
                const marginX = 40;
                const headerY = 28;
                const footerY = doc.internal.pageSize.getHeight() - 30;

                doc.setProperties({ title: `Checklist Operasional - ${outlet ? outlet.nama : ''}` });

                const drawHeaderFooter = (data) => {
                    // Header bar
                    doc.setFillColor(30, 58, 138); // indigo-900
                    doc.rect(0, 0, pageWidth, 60, 'F');
                    // Title
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(13);
                    doc.text('Portal Cabang', marginX, headerY);
                    doc.setFontSize(11);
                    const sub = `Checklist Operasional  ${labelWaktu}`;
                    doc.text(sub, marginX, headerY + 16);

                    // Meta (right)
                    const metaRight = [
                        `Outlet: ${outlet ? outlet.nama : '-'}`,
                        `Tanggal: ${new Date().toLocaleDateString('id-ID')}`,
                        `Disusun oleh: ${currentUser?.nama || '-'}`
                    ];
                    doc.setFontSize(9);
                    let yMeta = headerY - 6;
                    metaRight.forEach((line, idx) => {
                        doc.text(line, pageWidth - marginX, yMeta + idx * 12, { align: 'right' });
                    });

                    // Footer page number
                    doc.setDrawColor(229, 231, 235);
                    doc.setFillColor(249, 250, 251);
                    doc.setTextColor(107, 114, 128);
                    doc.setFontSize(8);
                    doc.text(`Halaman ${doc.internal.getNumberOfPages()}`, pageWidth - marginX, footerY, { align: 'right' });
                };

                // Build table rows
                const rows = items.map(i => {
                    const st = statusMap[i.id] || '';
                    const corr = (correctiveMap[i.id] || '').trim();
                    const stLabel = st === 'ok' ? 'OK' : (st === 'not_ok' ? 'Tidak OK' : '-');
                    const corrText = st === 'not_ok' ? (corr || '-') : '-';
                    return [i.kategori || '-', i.nama || '-', stLabel, corrText];
                });

                // Compute progress for small badge (optional)
                let total = items.length, ok = 0, notOk = 0, pending = 0;
                items.forEach(i => {
                    const st = statusMap[i.id];
                    if (st === 'ok') ok++;
                    else if (st === 'not_ok') {
                        notOk++;
                        const cap = (correctiveMap[i.id] || '').trim();
                        if (!cap) pending++;
                    }
                });
                const completed = ok + (notOk - pending);
                const percent = total ? Math.round((completed / total) * 100) : 0;

                // Body top info band (under header)
                doc.addPage(); // ensure didDrawPage executes for first page too by forcing hook via autoTable
                doc.deletePage(doc.internal.getNumberOfPages());

                doc.autoTable({
                    startY: 80,
                    head: [['Kategori', 'Item Checklist', 'Status', 'Tindakan Perbaikan (CAPA)']],
                    body: rows.length ? rows : [['-', '-', '-', '-']],
                    styles: { fontSize: 9, cellPadding: 6, valign: 'top' },
                    headStyles: { fillColor: [30, 58, 138], textColor: 255, fontStyle: 'bold' },
                    columnStyles: {
                        0: { cellWidth: 110 },
                        1: { cellWidth: 250 },
                        2: { cellWidth: 80, halign: 'center' },
                        3: { cellWidth: 140 }
                    },
                    alternateRowStyles: { fillColor: [250, 250, 250] },
                    didDrawPage: (data) => {
                        drawHeaderFooter(data);
                        // Small progress chip under header
                        const chipY = 60;
                        doc.setFillColor(236, 253, 245); // green-50
                        doc.setDrawColor(16, 185, 129); // green-500
                        doc.roundedRect(marginX, chipY, 96, 20, 4, 4, 'FD');
                        doc.setTextColor(5, 150, 105); // green-600
                        doc.setFontSize(9);
                        doc.text(`Progress: ${percent}%`, marginX + 8, chipY + 13);
                        // Shift chip
                        const shiftText = `Waktu: ${labelWaktu}`;
                        const chip2X = marginX + 110;
                        doc.setFillColor(239, 246, 255); // blue-50
                        doc.setDrawColor(59, 130, 246);  // blue-500
                        doc.roundedRect(chip2X, chipY, 120, 20, 4, 4, 'FD');
                        doc.setTextColor(37, 99, 235); // blue-600
                        doc.text(shiftText, chip2X + 8, chipY + 13);
                        // Outlet chip
                        const chip3X = chip2X + 130;
                        doc.setFillColor(238, 242, 255); // indigo-50
                        doc.setDrawColor(99, 102, 241);  // indigo-500
                        const outletText = `Outlet: ${(outlet ? outlet.nama : '-')}`;
                        const w = doc.getTextWidth(outletText) + 20;
                        doc.roundedRect(chip3X, chipY, Math.max(120, w), 20, 4, 4, 'FD');
                        doc.setTextColor(79, 70, 229); // indigo-600
                        doc.text(outletText, chip3X + 8, chipY + 13);
                    },
                    didParseCell: (hookData) => {
                        // Center align status cell text
                        if (hookData.section === 'body' && hookData.column.index === 2) {
                            hookData.cell.styles.halign = 'center';
                            const v = (hookData.cell.raw || '').toString().toLowerCase();
                            if (v.includes('tidak')) {
                                hookData.cell.styles.textColor = [220, 38, 38]; // red-600
                                hookData.cell.styles.fontStyle = 'bold';
                            } else if (v.includes('ok')) {
                                hookData.cell.styles.textColor = [5, 150, 105]; // green-600
                                hookData.cell.styles.fontStyle = 'bold';
                            }
                        }
                    }
                });

                // Signature block
                const endY = doc.lastAutoTable.finalY + 24;
                const sigTop = Math.min(endY, doc.internal.pageSize.getHeight() - 160);
                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81);
                doc.text('Catatan:', marginX, sigTop);
                doc.setDrawColor(209, 213, 219);
                doc.rect(marginX, sigTop + 6, pageWidth - marginX * 2, 40);

                const sigY = sigTop + 60;
                const colW = (pageWidth - marginX * 2) / 2;
                doc.text('Diperiksa oleh (Kepala Cabang):', marginX, sigY);
                doc.line(marginX, sigY + 4, marginX + colW - 20, sigY + 4);
                doc.text('Disetujui oleh (HO/AM):', marginX + colW, sigY);
                doc.line(marginX + colW, sigY + 4, pageWidth - marginX, sigY + 4);

                const filename = `Checklist_${(outlet ? outlet.nama.replace(/\s+/g, '_') : 'Outlet')}_${today}_${waktu}.pdf`;
                doc.save(filename);
            } catch (e) {
                console.error('Export Checklist PDF failed:', e);
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        // Parse 'YYYY-MM-DD' as a local date to avoid timezone shifts
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return new Date(dateStr);
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            const d = parseInt(parts[2], 10);
            // Use noon to avoid any DST or timezone boundary issues
            return new Date(y, (m || 1) - 1, d || 1, 12, 0, 0, 0);
        }
        // Build local 'YYYY-MM-DD' from Date object
        function toYMD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            const d = parseLocalDate(dateStr);
            return d ? d.toLocaleDateString('id-ID', options) : '-';
        }

        function addActivity(type, message) {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]');
            activities.push({
                type,
                message,
                time: new Date().toLocaleString('id-ID'),
                outlet: currentOutlet,
                user: currentUser.nama
            });
            localStorage.setItem('activities', JSON.stringify(activities.slice(-100)));
        }

        function clearForm(fields) {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }
        // Generate stable id for new records so cloud/local stay consistent across devices
        function genId(prefix) {
            return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
        }

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(`
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => clients.claim());
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
            `)).catch(() => {});
        }

        // ==================== DIAGNOSTIC TOOLS ====================
        async function diagnoseCloud() {
            const baseUrl = getApiUrl();
            const cfg = JSON.parse(localStorage.getItem('spreadsheetConfig') || '{}');
            const sid = cfg.spreadsheetId || DEFAULT_SPREADSHEET_ID;
            console.group(' Diagnosa Cloud');
            if (!baseUrl) {
                console.warn(' Web App URL belum diisi');
                showToast(' Web App URL belum diisi. Buka Koneksi Spreadsheet.');
                showCloudAlert();
                console.groupEnd();
                return;
            }

            // 1) Ping test
            try {
                const ping = await getJSON(`${baseUrl}?action=ping`);
                if (ping && ping.success && ping.data === 'pong') {
                    console.log(' Ping Web App OK');
                } else {
                    console.warn(' Ping gagal:', ping && ping.error);
                }
            } catch (e) { console.warn(' Ping error:', e); }

            // 2) JSONP readp test (anti-CORS)
            try {
                const res = await (function jsonpStrict(url, timeoutMs = 10000) {
                    return new Promise((resolve) => {
                        const cb = `cb_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                        const script = document.createElement('script');
                        const timer = setTimeout(() => {
                            cleanup();
                            resolve({ success: false, data: null, error: 'JSONP timeout' });
                        }, timeoutMs);
                        function cleanup() {
                            try { delete window[cb]; } catch(e) {}
                            if (script && script.parentNode) script.parentNode.removeChild(script);
                            clearTimeout(timer);
                        }
                        window[cb] = (payload) => { cleanup(); resolve(payload || { success:false, data:null, error:'Empty JSONP payload' }); };
                        const sep = url.includes('?') ? '&' : '?';
                        script.src = `${url}${sep}callback=${cb}`;
                        script.onerror = () => { cleanup(); resolve({ success:false, data:null, error:'JSONP load error' }); };
                        document.body.appendChild(script);
                    });
                })(`${baseUrl}?action=readp&sheet=users`);
                if (res && res.success && Array.isArray(res.data)) {
                    console.log(` JSONP readp users OK (${res.data.length} baris)`);
                } else {
                    console.warn(' JSONP readp users gagal. Pastikan Code.gs mendukung action=readp (JSONP).');
                }
            } catch(e){ console.warn(' JSONP error:', e); }

            // 3) GViz fallback test (Spreadsheet harus dapat diakses publik atau publish to web)
            try {
                if (!sid) {
                    console.warn(' Spreadsheet ID belum diisi, lewati GViz');
                } else {
                    const url = `https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:json&sheet=users`;
                    const resp = await fetch(url, { cache: 'no-store' });
                    const text = await resp.text();
                    const start = text.indexOf('{');
                    const end = text.lastIndexOf('}');
                    if (start !== -1 && end !== -1) {
                        console.log(' GViz akses Spreadsheet OK');
                    } else {
                        console.warn(' GViz gagal parse. Pastikan Spreadsheet dibuka aksesnya (Anyone with link - Viewer) atau Publish to the web.');
                    }
                }
            } catch (e) {
                console.warn(' GViz error:', e);
            }
            console.groupEnd();
            showToast(' Diagnosa selesai. Lihat Console untuk detail.');
        }

        // ====== CUSTOM PATCH: After Closing Master + Time Gating (WIB) ======
        (function(){
            // Helper: get hour/minute in Asia/Jakarta (WIB)
            function getJakartaHM() {
                try {
                    const parts = new Intl.DateTimeFormat('en-US', { timeZone: 'Asia/Jakarta', hour12: false, hour: '2-digit', minute: '2-digit' }).formatToParts(new Date());
                    const h = parseInt(parts.find(p=>p.type==='hour')?.value || '0', 10);
                    const m = parseInt(parts.find(p=>p.type==='minute')?.value || '0', 10);
                    return { h, m };
                } catch (e) {
                    const now = new Date();
                    return { h: now.getHours(), m: now.getMinutes() };
                }
            }
            // WIB window: 21:00 - 00:00 (inclusive at 00:00)
            function isWithinAfterClosingWIB() {
                const { h } = getJakartaHM();
                return (h >= 21 && h <= 23) || h === 0; // 21:00-23:59 and 00:00
            }
            // Enforce UI: hide/disable After option outside window; auto-switch if needed
            function updateChecklistShiftOptionsVisibility() {
                try {
                    const sel = document.getElementById('checklistShift');
                    if (!sel) return;
                    const optAfter = Array.from(sel.options).find(o => (o.value||'') === 'after');
                    if (!optAfter) return;
                    const allowed = isWithinAfterClosingWIB();
                    optAfter.disabled = !allowed;
                    optAfter.hidden = !allowed;
                    if (!allowed && sel.value === 'after') {
                        sel.value = 'pra';
                    }
                } catch (e) { /* noop */ }
            }
            // Force update After Closing master list with the exact items from request
            function forceUpdateAfterClosingMasterWithNewList() {
                try {
                    const afterList = [
                        "Permintaan barang ke gudang sudah di lakukan dan diverifikasi oleh kacab atau staff penggantinya",
                        "Labeling pada pada barang datang sudah dilakukan",
                        "Stock Opname sudah dilakukan dan diinput kedalam form rekapan pemakaian",
                        "Bahan baku sisa sudah masuk pendingin (bahan baku food & juice)",
                        "Semua peralatan saji dan kerja dalam kondisi bersih (dapur, juicer, kasir, dinning)",
                        "Grase Trap dan Gotter dalam kondisi bersih (dapur & juicer)",
                        "Semua area dalam kondisi bersih meliputi semua dinding, semua kolong meja kerja, pendingin, meja makan dan bangku dan atau sofa dalam kondisi bersih",
                        "Semua area bebas hama (tikus, kecoa, semut, lalat)",
                        "Tea maker, Microwave, Toaster, Magic com, Mesin cup sealer, Mesin ice cube, Mesin cuci piring dalam kondisi off",
                        "Exaust Pan, Kompor gas, kompor listrik  dalam kondisi off",
                        "Valve Gas central, Valve kran air dalam kondisi off",
                        "Lampu penerangan dan lampu  hias area dinning, dapur, juicer, kasir serta lampu logo dalam kondisi off",
                        "Komputer admin, POS, Semua printer, Monitor checker, UPS dalam kondisi off",
                        "Uang Omzet, Kas Kecil, Modal sudah masuk ke brangkas dan kodenya diputar acak",
                        "Kipas Angin / AC, TV display, Audio player dalam kondisi off",
                        "Tidak ada sampah yang tertinggal di dalam cabang",
                        "Semua pintu dan jendela dalam kondisi terkunci"
                    ];
                    let items = [];
                    try { items = JSON.parse(localStorage.getItem('checklistItems') || '[]'); } catch(e){ items = []; }
                    // Remove existing 'after' items
                    const others = items.filter(i => i && i.waktu !== 'after');
                    // Build new after items with fresh ids
                    let idCounter = Date.now();
                    const newAfter = afterList.map(n => ({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'after', status: 'aktif' }));
                    const merged = [...others, ...newAfter];
                    localStorage.setItem('checklistItems', JSON.stringify(merged));
                    // Optional: also push to cloud only the checklistItems (best-effort)
                    try {
                        const baseUrl = (JSON.parse(localStorage.getItem('spreadsheetConfig')||'{}').webAppUrl || '').replace(/\/$/, '');
                        if (baseUrl) {
                            const dataStr = JSON.stringify(merged);
                            const enc = encodeURIComponent(dataStr);
                            // If too long, clear then create per item
                            if (enc.length > 1400) {
                                fetch(`${baseUrl}?action=sync&sheet=checklistItems&data=%5B%5D`).catch(()=>{});
                                newAfter.forEach(row => fetch(`${baseUrl}?action=create&sheet=checklistItems&data=${encodeURIComponent(JSON.stringify(row))}`).catch(()=>{}));
                            } else {
                                fetch(`${baseUrl}?action=sync&sheet=checklistItems&data=${enc}`).catch(()=>{});
                            }
                        }
                    } catch(e) {/* silent */}
                } catch (e) { /* noop */ }
            }

            // Hook loadChecklist to enforce time gating before executing original logic
            const __orig_loadChecklist = window.loadChecklist;
            if (typeof __orig_loadChecklist === 'function') {
                window.loadChecklist = function() {
                    updateChecklistShiftOptionsVisibility();
                    const sel = document.getElementById('checklistShift');
                    if (sel && sel.value === 'after' && !isWithinAfterClosingWIB()) {
                        sel.value = 'pra';
                    }
                    return __orig_loadChecklist.apply(this, arguments);
                };
            }
            // Hook showModule to refresh gating when opening checklist module
            const __orig_showModule = window.showModule;
            if (typeof __orig_showModule === 'function') {
                window.showModule = function(module) {
                    const r = __orig_showModule.apply(this, arguments);
                    if (module === 'checklist') {
                        updateChecklistShiftOptionsVisibility();
                    }
                    return r;
                };
            }

            // Expose helpers in window (optional for debug)
            window.__pc_isWithinAfterClosingWIB = isWithinAfterClosingWIB;
            window.__pc_updateAfterClosingMaster = forceUpdateAfterClosingMasterWithNewList;

            // Run once on load to ensure After Closing list is in sync
            try { forceUpdateAfterClosingMasterWithNewList(); } catch (e) {}
        })();

        // === PATCH: Pra Opening Master + Time Gating (WIB 03:00-10:00) ===
        (function(){
            // Daftar Pra Opening persis sesuai instruksi
            const PRA_OPENING_LIST = [
                "Muka bersih tidak berminyak dan merias wajah sesuai standar",
                "Kulit tidak kering dan tidak bersisik memakai body lotion",
                "Kuku pendek dan tidak menggunakan cat kuku",
                "Bulu atau rambut hidung tidak menjorok keluar lubang hidung",
                "Tidak ada bau yang tidak sedap dari badan, mulut, telinga atau bagian tubuh lainnya termasuk parfume yang aromanya menyengat",
                "Mengenakan baju dan celana sesuai standar bentuk, warna bahan yang ditetapkan dalam kondisi bersih dan rapi",
                "Memakai sepatu pantofel warna hitam dengan maksimal tinggi 3 cm dalam kondisi bersih dan mengkilap (bersemir)",
                "Memakai ikat pinggang warna hitam polos terbuat dari kulit bukan kain atau sintetis dengan kepala gesper yang sederhana",
                "Memakai kaos singlet warna putih",
                "Tidak memakai gelang, anting, kalung, jam tangan atau aksesoris lainnya",
                "Tidak ada tato di bagian tubuh yang terbuka",
                "Pakai name tag sesuai standar yang ditetapkan",
                "Memakai masker hitam dan kelengkapan kerja sesuai jabatannya",
                "Rambut rapi dengan maksimal panjang 5 cm, tidak kusam/kering, rapi menggunakan minyak rambut yang tidak berbau menyengat",
                "Tidak memelihara kumis, jenggot dan jambang dipotong sejajar ekor mata",
                "Hijab dalam keadaan rapi, terutama pada bagian leher harus kelihatan bentuk leher dengan bantuan jepit/bros tanpa manik dan warna sesuai warna hijab",
                "Dilarang menggunakan jarum pentul",
                "Memakai dalaman hijab berwarna hitam polos",
                "Rambut panjang harus memakai hairnet dan poni tidak menjuntai ke depan menutupi dahi",
                "Order Barang sudah dicek kacab, diinput dan dikirim ke bagian gudang",
                "Labeling pada pada barang datang, hasil prepare dan atau hasil produksi sudah dilakukan",
                "Rekap Pemakaian sudah dikerjakan dan dikirim ke bagian akuntansi",
                "Pencatatan produksi cabang, produksi pusat sudah dikerjakan dan diverifikasi",
                "Laporan Piutang (Bagi cabang yang ada transaksi piutang) sudah dikerjakan dan atau dikirim ke bagian akuntansi",
                "Kesiapan Kelengkapan, Kebersihan, serta Kecukupan Sumber Daya (Area Dinning, Juicer, Kasir, Dapur)",
                "Sendok, garpu, pisau roti dan sumpit tersedia dalam kondisi cukup",
                "Tissue meja, saos, kecap, sambal dalam kondisi terisi cukup dan tidak belepotan",
                "Nampan, buku menu, slip order dan alat tulis tersedia dalam kondisi bersih dan cukup",
                "Kain Lap Meja (waiter, juicer, kasir dan dapur) dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Kain Lap Sendok, gelas dan piring dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Hand sanitizer pada posisi pintu masuk & kasir",
                "Disinfektan tersedia dalam kondisi cukup",
                "Semua meja, kursi, sofa, kursi anak  dalam kondisi bersih dan tertata rapi",
                "Semua pegangan pintu, pegangan anak tangga, pembatas antrian dalam kondisi bersih",
                "Wastafel dalam kondisi bersih, tersedia hand soap, tissue, tempat sampah, cermin",
                "Tempat Sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Pad counter dalam kondisi bersih dan barang-barang tertata rapi",
                "Semua Dinding (dining, juicer, kasir, dapur, gudang) dalam kondisi bersih",
                "Semua lantai (dining, kasir, juicer, dapur, gudang) dan gotter dalam kondisi bersih",
                "Kaca (jendela, interior) dalam kondisi bersih tidak buram",
                "Diffuser AC / AC dalam kondisi bersih dan dingin",
                "TV display, Audio player dalam kondisi normal dan bersih",
                "Interior (gambar dinding, lampu gantung, furniture) dalam kondisi bersih",
                "Service Extension dalam kondisi rapi dan bersih",
                "Lampu (dining, box menu, Logo) dalam kondisi menyala normal dan bersih",
                "Tanaman Hias tidak ada yang layu daunnya",
                "Sarana Promosi (x banner, tripod banner, standing menu, baliho) dalam kondisi layak dan bersih",
                "Peralatan proses juicer (Blender, Juicer, extractor, sendok ukur, pisau, talenan, saringan juice, teh, scoop es krim, tea maker, mesin serut es, mesin cup sealer, es maker, timbangan) dalam kondisi berfungsi normal dan bersih",
                "Alat saji (Plate coupe 7.5, 8, 9, 10,5. Saucer 4,25. Bowl 4.5, 6, Bowl omega 7, square plate besar, kecil, piring snack, piring lauk, mangkok kuring/ramen, saucer, sendok, gelas juice, gelas teh, cangkir kopi, lunch box, box gurame, paper bowl set 650, 800, 1000, cup oval, cup 400, 500, sedotan) dalam kondisi cukup dan bersih",
                "Meja kerja di semua area dalam kondisi bersih dan penataan barang-barang rapi",
                "Alegro dalam kondisi berfungsi normal, bersih dan penataan buah rapi",
                "Freezer, under freezer, chiller, under chiller, salad case (gasket, kaca, rak, kipas, handle, body) juicer dan dapur dalam kondisi berfungsi normal, bersih, bunga es tidak tebal dan penataan bahan baku rapi",
                "Chiller, salad case juicer dan dapur dalam kondisi normal dan bersih",
                "Tempat prepare di area juicer dan dapur (food pan, kitchen set, termos nasi, keranjang, toples, box risol, box thawing) dalam kondisi tertutup dan dalam kondisi bersih",
                "Tempat penyimpanan bahan baku & produk (rak susun, rak tempel dan lemari penyimpanan termasuk laci-laci) dalam kondisi bersih dan barang-barang tersusun rapi",
                "Sink, grease trap, grease induk dan gutter dalam kondisi bersih",
                "Langit-langit semua area dalam kondisi baik dan bersih",
                "Tempat sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap",
                "Dinding semua area dalam kondisi bersih",
                "Mesin POS, alat pembayaran (EDC BCA, Mandiri, BRI, Gobiz, Grabfood, Handphone, HT dalam kondisi normal dan bersih",
                "Setor omset maksimal jam 14.00 dan laporan setor omzet ke bagian keuangan",
                "Kelengkapan peralatan kasir (kalkulator, money detector, stepless, isolatif) dalam kondisi cukup",
                "Uang receh tersedia cukup (20rb, 10rb, 5rb, 2rb, 1rb, 500, 200, 100)",
                "Peralatan proses cook (steamer nasi, rice cooker, gas cooker, steamer, magic com, microwave, toaster, panci, wajan, sodet, saringan mie, saringan minyak, jepitan makanan, deep fryer, teflon, cetakan nasi, kompor high, kompor low, pisau, talenan, parutan keju, timbangan) dalam kondisi layak pakai, bersih dan bebas dari kontaminasi antar alat, maupun dari  dari hal-hal lainnya",
                "Hood dan exhaust dalam kondisi bersih dan berfungsi normal",
                "Mesin cuci piring dan mesin pembuat es dalam kondisi bersih dan berfungsi normal",
                "Semua area bebas dari hama(tikus, kecoa, lalat, semut)",
                "Fasilitas toilet di dalam cabang",
                "Handle pintu dan kunci pintu berfungsi normal dan bersih",
                "Aroma toilet harum atau tidak berbau tidak sedap",
                "Lantai dan dinding dalam kondisi bersih dan kering",
                "Lampu penerangan tidak ada yang mati dan fan exhaust dengan kondisi bersih dan berfungsi normal",
                "Kloset dalam kondisi baik,bersih dan kering",
                "Shower kloset berfungsi normal dan bersih",
                "Wastafel dalam kondisi normal dan bersih serta tersedia hand soap dan tissue",
                "Urinoir dalam kondisi bersih, berfungsi normal dan tidak beraroma tidak sedap",
                "Tempat Sampah dalam kondisi bersih tidak ada bau tidak sedap"
            ];

            function getJakartaHM() {
                try {
                    const parts = new Intl.DateTimeFormat('en-US', { timeZone: 'Asia/Jakarta', hour12: false, hour: '2-digit', minute: '2-digit' }).formatToParts(new Date());
                    const h = parseInt(parts.find(p=>p.type==='hour')?.value || '0', 10);
                    const m = parseInt(parts.find(p=>p.type==='minute')?.value || '0', 10);
                    return { h, m };
                } catch (e) {
                    const now = new Date();
                    return { h: now.getHours(), m: now.getMinutes() };
                }
            }
            function isWithinPraOpeningWIB(){
                const { h } = getJakartaHM();
                return (h >= 3 && h < 10); // 03:00 - 09:59 WIB
            }

            function forceUpdatePraOpeningMasterWithNewList(){
                try {
                    let items = [];
                    try { items = JSON.parse(localStorage.getItem('checklistItems') || '[]'); } catch(e){ items = []; }
                    // Remove existing 'pra' items
                    const others = items.filter(i => i && i.waktu !== 'pra');
                    // Build new pra with fresh ids
                    let idCounter = Date.now();
                    const newPra = PRA_OPENING_LIST.map(n => ({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'pra', status: 'aktif' }));
                    const merged = [...others, ...newPra];
                    localStorage.setItem('checklistItems', JSON.stringify(merged));
                    // Best-effort sync to cloud (only checklistItems)
                    try {
                        const baseUrl = (JSON.parse(localStorage.getItem('spreadsheetConfig')||'{}').webAppUrl || '').replace(/\/$/, '');
                        if (baseUrl) {
                            const dataStr = JSON.stringify(merged);
                            const encData = encodeURIComponent(dataStr);
                            const syncEmpty = () => fetch(`${baseUrl}?action=sync&sheet=checklistItems&data=%5B%5D`).catch(()=>{});
                            if (encData.length > 1400) {
                                syncEmpty().then(()=>{
                                    newPra.forEach(row => fetch(`${baseUrl}?action=create&sheet=checklistItems&data=${encodeURIComponent(JSON.stringify(row))}`).catch(()=>{}));
                                });
                            } else {
                                fetch(`${baseUrl}?action=sync&sheet=checklistItems&data=${encData}`).catch(()=>{});
                            }
                        }
                    } catch(e){}
                } catch(e){}
            }

            // Patch loadChecklist to enforce time gating for Pra Opening
            const __orig_loadChecklist_pra = window.loadChecklist;
            if (typeof __orig_loadChecklist_pra === 'function') {
                window.loadChecklist = function(){
                    try {
                        const sel = document.getElementById('checklistShift');
                        if (sel) {
                            const optPra = Array.from(sel.options).find(o => (o.value||'') === 'pra');
                            const allowPra = isWithinPraOpeningWIB();
                            if (optPra) {
                                optPra.disabled = !allowPra;
                                optPra.hidden = !allowPra;
                            }
                            if (sel.value === 'pra' && !allowPra) {
                                // Pindah ke during jika tersedia, jika tidak ke after, jika tidak tetap pra (fallback)
                                if (Array.from(sel.options).some(o=>o.value==='during')) sel.value = 'during';
                                else if (Array.from(sel.options).some(o=>o.value==='after')) sel.value = 'after';
                            }
                        }
                    } catch(e){}
                    return __orig_loadChecklist_pra.apply(this, arguments);
                };
            }

            // Jalankan update master Pra Opening sekali saat load
            try { forceUpdatePraOpeningMasterWithNewList(); } catch(e){}
        })();

        // ====== PATCH: During Master + Time Gating (WIB 15:00-18:00) ======
        (function(){
            const DURING_LIST = [
                'Muka bersih tidak berminyak dan merias wajah sesuai standar',
                'Kulit tidak kering dan tidak bersisik memakai body lotion',
                'Kuku pendek dan tidak menggunakan cat kuku',
                'Bulu atau rambut hidung tidak menjorok keluar lubang hidung',
                'Tidak ada bau yang tidak sedap dari badan, mulut, telinga atau bagian tubuh lainnya termasuk parfume yang aromanya menyengat',
                'Mengenakan baju dan celana sesuai standar bentuk, warna bahan yang ditetapkan dalam kondisi bersih dan rapi',
                'Memakai sepatu pantofel warna hitam dengan maksimal tinggi 3 cm dalam kondisi bersih dan mengkilap (bersemir)',
                'Memakai ikat pinggang warna hitam polos terbuat dari kulit bukan kain atau sintetis dengan kepala gesper yang sederhana',
                'Memakai kaos singlet warna putih',
                'Tidak memakai gelang, anting, kalung, jam tangan atau aksesoris lainnya',
                'Tidak ada tato di bagian tubuh yang terbuka',
                'Pakai name tag sesuai standar yang ditetapkan',
                'Memakai masker hitam dan kelengkapan kerja sesuai jabatannya',
                'Rambut rapi dengan maksimal panjang 5 cm, tidak kusam/kering, rapi menggunakan minyak rambut yang tidak berbau menyengat',
                'Tidak memelihara kumis, jenggot dan jambang dipotong sejajar ekor mata',
                'Hijab dalam keadaan rapi, terutama pada bagian leher harus kelihatan bentuk leher dengan bantuan jepit/bros tanpa manik dan warna sesuai warna hijab',
                'Dilarang menggunakan jarum pentul',
                'Memakai dalaman hijab berwarna hitam polos',
                'Rambut panjang harus memakai hairnet dan poni tidak menjuntai ke depan menutupi dahi',
                'Order Barang sudah dicek kacab, diinput dan dikirim ke bagian gudang',
                'Labeling pada pada barang datang, hasil prepare dan atau hasil produksi sudah dilakukan',
                'Rekap Pemakaian sudah dikerjakan dan dikirim ke bagian akuntansi',
                'Pencatatan produksi cabang, produksi pusat sudah dikerjakan dan diverifikasi',
                'Laporan Piutang (Bagi cabang yang ada transaksi piutang) sudah dikerjakan dan atau dikirim ke bagian akuntansi',
                'Kesiapan Kelengkapan, Kebersihan, serta Kecukupan Sumber Daya (Area Dinning, Juicer, Kasir, Dapur)',
                'Sendok, garpu, pisau roti dan sumpit tersedia dalam kondisi cukup',
                'Tissue meja, saos, kecap, sambal dalam kondisi terisi cukup dan tidak belepotan',
                'Nampan, buku menu, slip order dan alat tulis tersedia dalam kondisi bersih dan cukup',
                'Kain Lap Meja (waiter, juicer, kasir dan dapur) dalam kondisi bersih dan tidak ada bau tidak sedap',
                'Kain Lap Sendok, gelas dan piring dalam kondisi bersih dan tidak ada bau tidak sedap',
                'Hand sanitizer pada posisi pintu masuk & kasir',
                'Disinfektan tersedia dalam kondisi cukup',
                'Semua meja, kursi, sofa, kursi anak  dalam kondisi bersih dan tertata rapi',
                'Semua pegangan pintu, pegangan anak tangga, pembatas antrian dalam kondisi bersih',
                'Wastafel dalam kondisi bersih, tersedia hand soap, tissue, tempat sampah, cermin',
                'Tempat Sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap',
                'Pad counter dalam kondisi bersih dan barang-barang tertata rapi',
                'Semua Dinding (dining, juicer, kasir, dapur, gudang) dalam kondisi bersih',
                'Semua lantai (dining, kasir, juicer, dapur, gudang) dan gotter dalam kondisi bersih',
                'Kaca (jendela, interior) dalam kondisi bersih tidak buram',
                'Diffuser AC / AC dalam kondisi bersih dan dingin',
                'TV display, Audio player dalam kondisi normal dan bersih',
                'Interior (gambar dinding, lampu gantung, furniture) dalam kondisi bersih',
                'Service Extension dalam kondisi rapi dan bersih',
                'Lampu (dining, box menu, Logo) dalam kondisi menyala normal dan bersih',
                'Tanaman Hias tidak ada yang layu daunnya',
                'Sarana Promosi (x banner, tripod banner, standing menu, baliho) dalam kondisi layak dan bersih',
                'Peralatan proses juicer (Blender, Juicer, extractor, sendok ukur, pisau, talenan, saringan juice, teh, scoop es krim, tea maker, mesin serut es, mesin cup sealer, es maker, timbangan) dalam kondisi berfungsi normal dan bersih',
                'Alat saji (Plate coupe 7.5, 8, 9, 10,5. Saucer 4,25. Bowl 4.5, 6, Bowl omega 7, square plate besar, kecil, piring snack, piring lauk, mangkok kuring/ramen, saucer, sendok, gelas juice, gelas teh, cangkir kopi, lunch box, box gurame, paper bowl set 650, 800, 1000, cup oval, cup 400, 500, sedotan) dalam kondisi cukup dan bersih',
                'Meja kerja di semua area dalam kondisi bersih dan penataan barang-barang rapi',
                'Alegro dalam kondisi berfungsi normal, bersih dan penataan buah rapi',
                'Freezer, under freezer, chiller, under chiller, salad case (gasket, kaca, rak, kipas, handle, body) juicer dan dapur dalam kondisi berfungsi normal, bersih, bunga es tidak tebal dan penataan bahan baku rapi',
                'Chiller, salad case juicer dan dapur dalam kondisi normal dan bersih',
                'Tempat prepare di area juicer dan dapur (food pan, kitchen set, termos nasi, keranjang, toples, box risol, box thawing) dalam kondisi tertutup dan dalam kondisi bersih',
                'Tempat penyimpanan bahan baku & produk (rak susun, rak tempel dan lemari penyimpanan termasuk laci-laci) dalam kondisi bersih dan barang-barang tersusun rapi',
                'Sink, grease trap, grease induk dan gutter dalam kondisi bersih',
                'Langit-langit semua area dalam kondisi baik dan bersih',
                'Tempat sampah semua area dalam kondisi bersih dan tidak ada bau tidak sedap',
                'Dinding semua area dalam kondisi bersih',
                'Mesin POS, alat pembayaran (EDC BCA, Mandiri, BRI, Gobiz, Grabfood, Handphone, HT dalam kondisi normal dan bersih',
                'Setor omset maksimal jam 14.00 dan laporan setor omzet ke bagian keuangan',
                'Kelengkapan peralatan kasir (kalkulator, money detector, stepless, isolatif) dalam kondisi cukup',
                'Uang receh tersedia cukup (20rb, 10rb, 5rb, 2rb, 1rb, 500, 200, 100)',
                'Peralatan proses cook (steamer nasi, rice cooker, gas cooker, steamer, magic com, microwave, toaster, panci, wajan, sodet, saringan mie, saringan minyak, jepitan makanan, deep fryer, teflon, cetakan nasi, kompor high, kompor low, pisau, talenan, parutan keju, timbangan) dalam kondisi layak pakai, bersih dan bebas dari kontaminasi antar alat, maupun dari  dari hal-hal lainnya',
                'Hood dan exhaust dalam kondisi bersih dan berfungsi normal',
                'Mesin cuci piring dan mesin pembuat es dalam kondisi bersih dan berfungsi normal',
                'Semua area bebas dari hama(tikus, kecoa, lalat, semut)',
                'Fasilitas toilet di dalam cabang',
                'Handle pintu dan kunci pintu berfungsi normal dan bersih',
                'Aroma toilet harum atau tidak berbau tidak sedap',
                'Lantai dan dinding dalam kondisi bersih dan kering',
                'Lampu penerangan tidak ada yang mati dan fan exhaust dengan kondisi bersih dan berfungsi normal',
                'Kloset dalam kondisi baik,bersih dan kering',
                'Shower kloset berfungsi normal dan bersih',
                'Wastafel dalam kondisi normal dan bersih serta tersedia hand soap dan tissue',
                'Urinoir dalam kondisi bersih, berfungsi normal dan tidak beraroma tidak sedap',
                'Tempat Sampah dalam kondisi bersih tidak ada bau tidak sedap'
            ];

            function getJakartaHM() {
                try {
                    const parts = new Intl.DateTimeFormat('en-US', { timeZone: 'Asia/Jakarta', hour12: false, hour: '2-digit', minute: '2-digit' }).formatToParts(new Date());
                    const h = parseInt(parts.find(p=>p.type==='hour')?.value || '0', 10);
                    const m = parseInt(parts.find(p=>p.type==='minute')?.value || '0', 10);
                    return { h, m };
                } catch (e) {
                    const now = new Date();
                    return { h: now.getHours(), m: now.getMinutes() };
                }
            }
            function isWithinDuringWIB(){
                const { h } = getJakartaHM();
                return (h >= 15 && h < 18); // 15:00 - 17:59 WIB
            }
            function forceUpdateDuringMasterWithNewList(){
                try {
                    let items = [];
                    try { items = JSON.parse(localStorage.getItem('checklistItems') || '[]'); } catch(e){ items = []; }
                    const others = items.filter(i => i && i.waktu !== 'during');
                    let idCounter = Date.now();
                    const newDuring = DURING_LIST.map(n => ({ id: idCounter++, kategori: 'operasional', nama: n, waktu: 'during', status: 'aktif' }));
                    const merged = [...others, ...newDuring];
                    localStorage.setItem('checklistItems', JSON.stringify(merged));
                    // Best-effort sync to cloud (only checklistItems)
                    try {
                        const baseUrl = (JSON.parse(localStorage.getItem('spreadsheetConfig')||'{}').webAppUrl || '').replace(/\/$/, '');
                        if (baseUrl) {
                            const dataStr = JSON.stringify(merged);
                            const encData = encodeURIComponent(dataStr);
                            if (encData.length > 1400) {
                                getJSON(`${baseUrl}?action=sync&sheet=checklistItems&data=%5B%5D`).then(()=>{
                                    newDuring.forEach(row => getJSON(`${baseUrl}?action=create&sheet=checklistItems&data=${encodeURIComponent(JSON.stringify(row))}`));
                                });
                            } else {
                                getJSON(`${baseUrl}?action=sync&sheet=checklistItems&data=${encData}`);
                            }
                        }
                    } catch(e){}
                } catch(e){}
            }
            // Patch loadChecklist to enforce time gating for During
            const __orig_loadChecklist_during = window.loadChecklist;
            if (typeof __orig_loadChecklist_during === 'function') {
                window.loadChecklist = function(){
                    try {
                        const sel = document.getElementById('checklistShift');
                        if (sel) {
                            const optDuring = Array.from(sel.options).find(o => (o.value||'') === 'during');
                            const allow = isWithinDuringWIB();
                            if (optDuring) { optDuring.disabled = !allow; optDuring.hidden = !allow; }
                            if (!allow && sel.value === 'during') {
                                if (Array.from(sel.options).some(o=>o.value==='pra')) sel.value = 'pra';
                                else if (Array.from(sel.options).some(o=>o.value==='after')) sel.value = 'after';
                            }
                        }
                    } catch(e){}
                    return __orig_loadChecklist_during.apply(this, arguments);
                };
            }
            // Refresh gating when entering checklist module
            const __orig_showModule_during = window.showModule;
            if (typeof __orig_showModule_during === 'function') {
                window.showModule = function(module){
                    const r = __orig_showModule_during.apply(this, arguments);
                    if (module === 'checklist') {
                        try {
                            const sel = document.getElementById('checklistShift');
                            if (sel) {
                                const optDuring = Array.from(sel.options).find(o => (o.value||'') === 'during');
                                const allow = isWithinDuringWIB();
                                if (optDuring) { optDuring.disabled = !allow; optDuring.hidden = !allow; }
                                if (!allow && sel.value === 'during') {
                                    if (Array.from(sel.options).some(o=>o.value==='pra')) sel.value = 'pra';
                                    else if (Array.from(sel.options).some(o=>o.value==='after')) sel.value = 'after';
                                }
                            }
                        } catch(e){}
                    }
                    return r;
                };
            }
            // Run once to ensure During list is updated
            try { forceUpdateDuringMasterWithNewList(); } catch(e){}
        })();

        // Initialize
        // Admin override for Checklist time gating: allow all shifts anytime
        (function(){
            function isAdmin(){ try { return currentUser && currentUser.role === 'admin'; } catch(e){ return false; } }
            function enableAllChecklistOptions(){
                if (!isAdmin()) return;
                try {
                    const sel = document.getElementById('checklistShift');
                    if (!sel) return;
                    ['pra','during','after'].forEach(v => {
                        const opt = Array.from(sel.options || []).find(o => (o.value||'') === v);
                        if (opt){ opt.disabled = false; opt.hidden = false; }
                    });
                } catch(e){}
            }
            // Patch loadChecklist to always re-enable options for Admin
            const __orig_loadChecklist = window.loadChecklist;
            if (typeof __orig_loadChecklist === 'function'){
                window.loadChecklist = function(){
                    enableAllChecklistOptions();
                    return __orig_loadChecklist.apply(this, arguments);
                };
            }
            // Patch showModule to re-enable when entering checklist module
            const __orig_showModule = window.showModule;
            if (typeof __orig_showModule === 'function'){
                window.showModule = function(module){
                    const r = __orig_showModule.apply(this, arguments);
                    if (module === 'checklist') enableAllChecklistOptions();
                    return r;
                };
            }
            // If time-gating helpers are exposed, bypass them for admin
            if (typeof window.__pc_isWithinAfterClosingWIB === 'function'){
                const _oldAfter = window.__pc_isWithinAfterClosingWIB;
                window.__pc_isWithinAfterClosingWIB = function(){ return isAdmin() ? true : _oldAfter(); };
            }
            if (typeof window.__pc_isWithinDuringWIB === 'function'){
                const _oldDuring = window.__pc_isWithinDuringWIB;
                window.__pc_isWithinDuringWIB = function(){ return isAdmin() ? true : _oldDuring(); };
            }
            if (typeof window.__pc_isWithinPraOpeningWIB === 'function'){
                const _oldPra = window.__pc_isWithinPraOpeningWIB;
                window.__pc_isWithinPraOpeningWIB = function(){ return isAdmin() ? true : _oldPra(); };
            }
        })();

        // ==================== PATCH: Robust Outlet Dedupe + Checklist Status Handlers ====================
        (function(){
            // Normalize name aggressively
            function normName(s){
                return (s||'').toString()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                    .toLowerCase().replace(/[^a-z0-9\s]/g,' ')
                    .replace(/\s+/g,' ').trim();
            }
            function fixSessionOutletRefs(idMap){
                try{
                    if (!idMap || !Object.keys(idMap).length) return;
                    if (Array.isArray(selectedOutlets)) selectedOutlets = Array.from(new Set(selectedOutlets.map(id=>idMap[id]||id)));
                    if (Array.isArray(allowedOutlets)) allowedOutlets = Array.from(new Set(allowedOutlets.map(id=>idMap[id]||id)));
                    if (currentOutlet) currentOutlet = idMap[currentOutlet] || currentOutlet;
                    try{ const cu = JSON.parse(localStorage.getItem('currentUser')||'null'); if(cu){ localStorage.setItem('currentUser', JSON.stringify({ ...cu, outlets: cu.outlets==='all'? 'all' : Array.isArray(cu.outlets) ? cu.outlets.map(id=>idMap[id]||id) : (idMap[cu.outlets]||cu.outlets) })); currentUser = JSON.parse(localStorage.getItem('currentUser')); } }catch(e){}
                }catch(e){}
            }
            function writeFixedOutlets(newOutlets){ try{ localStorage.setItem('outlets', JSON.stringify(newOutlets)); }catch(e){} }

            window.__fixDedupeOutlets = function(){
                try{
                    let outlets = [];
                    try{ outlets = JSON.parse(localStorage.getItem('outlets')||'[]'); }catch(e){ outlets=[]; }
                    if (!Array.isArray(outlets) || outlets.length<=1) return false;

                    const keepIndexByName = new Map();
                    const idMap = {}; // oldId -> keptId
                    outlets.forEach((o,idx)=>{
                        const key = normName(o && o.nama);
                        if (!key) return;
                        if (!keepIndexByName.has(key)){
                            keepIndexByName.set(key, idx);
                        }else{
                            const keepIdx = keepIndexByName.get(key);
                            const keep = outlets[keepIdx];
                            const drop = o;
                            if (keep && drop && keep.id && drop.id && keep.id!==drop.id){
                                idMap[drop.id] = keep.id;
                            }
                        }
                    });
                    const dupIds = Object.keys(idMap);
                    if (!dupIds.length) return false;

                    // Fix users references
                    let users = [];
                    try{ users = JSON.parse(localStorage.getItem('users')||'[]'); }catch(e){ users=[]; }
                    if (Array.isArray(users) && users.length){
                        users.forEach(u=>{
                            if (!u) return;
                            if (u.outlets==='all') return;
                            if (Array.isArray(u.outlets)){
                                u.outlets = Array.from(new Set(u.outlets.map(id=>idMap[id]||id)));
                            }else if (u.outlets){
                                u.outlets = idMap[u.outlets] || u.outlets;
                            }
                        });
                        try{ localStorage.setItem('users', JSON.stringify(users)); }catch(e){}
                    }

                    // Fix session refs
                    fixSessionOutletRefs(idMap);

                    // Remove duplicates
                    const fixed = outlets.filter(o=> !idMap[o.id]);
                    writeFixedOutlets(fixed);

                    // Refresh UI selectors if available
                    try{ if (typeof populateOutletSelector==='function') populateOutletSelector(); }catch(e){}
                    // If currently in settings-outlet, reload
                    try{
                        const active = document.querySelector('.module-section.active');
                        if (active && active.id==='module-settings-outlet' && typeof loadOutlets==='function') loadOutlets();
                    }catch(e){}
                    console.log(` Dedupe outlets: removed ${outlets.length-fixed.length} duplicates`);
                    return true;
                }catch(e){ console.warn('Dedupe outlets patch failed:', e); return false; }
            };

            // Patch pullDataFromCloud to run dedupe afterwards
            if (typeof window.pullDataFromCloud==='function'){
                const _oldPull = window.pullDataFromCloud;
                window.pullDataFromCloud = async function(){
                    const r = await _oldPull.apply(this, arguments);
                    try{ window.__fixDedupeOutlets(); }catch(e){}
                    return r;
                };
            }
            // Run once after init to clean any local duplicates
            setTimeout(()=>{ try{ window.__fixDedupeOutlets(); }catch(e){} }, 1200);

            // Robust checklist handlers (force id as string)
            const _oldSet = window.setChecklistStatus;
            window.setChecklistStatus = function(id, status){
                try{
                    id = String(id);
                    if (typeof _oldSet === 'function') return _oldSet.call(this, id, status);
                }catch(e){}
                // Fallback minimal handler if original missing
                try{
                    const waktu = document.getElementById('checklistShift').value;
                    const today = (function(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; })(new Date());
                    const key = `${today}_${currentOutlet}_${waktu}`;
                    const map = JSON.parse(localStorage.getItem('checklistStatus')||'{}');
                    map[key] = map[key] || {};
                    if (!status) delete map[key][id]; else map[key][id]=status;
                    localStorage.setItem('checklistStatus', JSON.stringify(map));
                    try{ createSingleToCloud && createSingleToCloud('checklistStatus', { id:key, key, data: map[key] }); }catch(e){}
                }catch(e){ console.warn('Fallback setChecklistStatus failed', e); }
            };
            window.onChecklistSelectChange = function(id, value){ try{ window.setChecklistStatus(String(id), value||''); }catch(e){ console.warn(e); } };
            const _oldSaveCorr = window.saveCorrectiveAction;
            window.saveCorrectiveAction = function(id, text){ try{ return _oldSaveCorr.call(this, String(id), text); }catch(e){
                try{ id=String(id); const waktu=document.getElementById('checklistShift').value; const today=(function(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; })(new Date()); const key=`${today}_${currentOutlet}_${waktu}`; const corr=JSON.parse(localStorage.getItem('checklistCorrective')||'{}'); corr[key]=corr[key]||{}; corr[key][id]=(text||'').trim(); localStorage.setItem('checklistCorrective', JSON.stringify(corr)); try{ createSingleToCloud && createSingleToCloud('checklistCorrective', { id:key, key, data:corr[key] }); }catch(_){} }catch(_e){ console.warn('Fallback saveCorrectiveAction failed', _e); } };
        })();

        // === Robust Login Override v2: tolerant, role-agnostic by code, auto-merge, defensive against corrupted storage ===
        (function(){
            function normRole(r){ return (r||'').toString().trim().toLowerCase().replace(/[\s_]+/g,'-'); }
            function normCode(c){ return (c||'').toString().trim().toLowerCase(); }
            function safeParseLS(key, fallback){ try{ const v = localStorage.getItem(key); if(!v) return fallback; const p = JSON.parse(v); return p==null? fallback : p; }catch(e){ console.warn('LS parse fail for', key, e); return fallback; } }
            function setLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){ console.warn('LS set fail', key, e); } }

            function flattenBuiltinUsers(){
                const arr = [];
                try{ const db = window.userDatabase||{}; Object.keys(db).forEach(role=>{ (db[role]||[]).forEach(u=>{ if(u&&u.kode){ arr.push({ kode:String(u.kode), nama:u.nama||'User', role:role, outlets:u.outlets|| (role==='admin'||role==='head-office' ? 'all' : []), status:'aktif' }); } }); }); }catch(e){}
                return arr;
            }
            function buildIndexByCode(){
                const map = new Map();
                const localUsers = safeParseLS('users',[]);
                localUsers.forEach(u=>{ if(u&&u.kode){ map.set(normCode(u.kode), u); } });
                const builtin = flattenBuiltinUsers();
                builtin.forEach(u=>{ const k = normCode(u.kode); if(!map.has(k)) map.set(k, u); });
                return map;
            }

            window.login = function(){
                const roleSel = document.getElementById('loginRole');
                const codeEl  = document.getElementById('loginCode');
                const errorDiv = document.getElementById('loginError');
                const errorText = document.getElementById('errorText');
                function showErr(msg){ if(errorDiv){ errorDiv.classList.remove('hidden'); errorText.textContent = msg; } console.warn('Login warn:', msg); }
                function hideErr(){ if(errorDiv){ errorDiv.classList.add('hidden'); } }

                const selRoleRaw = (roleSel?.value||'');
                const codeRaw = (codeEl?.value||'');
                const selRole = normRole(selRoleRaw);
                const codeNorm = normCode(codeRaw);
                if (!selRole) return showErr('Silakan pilih role terlebih dahulu');
                if (!codeNorm) return showErr('Silakan masukkan kode akses');

                hideErr();

                // Pastikan master user dimerge terlebih dahulu
                try{ window.mergeUserDatabase && window.mergeUserDatabase(); }catch(e){ console.warn('mergeUserDatabase error', e); }

                // Bangun index gabungan (local + builtin)
                const idx = buildIndexByCode();
                let user = idx.get(codeNorm) || null;

                // Jika belum ketemu, coba pull ringan dari cloud (users saja), lalu rebuild index
                if (!user) {
                    try {
                        if (typeof window.pullDataFromCloud==='function') {
                            // tarik hanya users via JSONP ringan bila tersedia
                            // namun tidak blok UI; kita lanjut tanpa await
                            window.pullDataFromCloud();
                        }
                    } catch(e){}
                    // rebuild index setelah (mungkin) merge user lagi
                    try{ window.mergeUserDatabase && window.mergeUserDatabase(); }catch(e){}
                    const idx2 = buildIndexByCode();
                    user = idx2.get(codeNorm) || null;
                }

                if (!user){
                    return showErr('Kode akses tidak ditemukan. Hubungi Admin.');
                }

                // Jika role yang dipilih berbeda dengan role di data user, tetap pakai role dari data user agar konsisten
                const effRole = normRole(user.role||selRoleRaw);
                if (!effRole) return showErr('Role pengguna tidak valid');

                if (String(user.status||'aktif').toLowerCase()!=='aktif'){
                    return showErr('Akun dinonaktifkan. Hubungi Admin.');
                }

                // Siapkan outlets
                let outlets = user.outlets;
                if (!outlets) {
                    if (effRole==='admin' || effRole==='head-office') outlets='all';
                    else outlets = [];
                }

                const current = { kode: String(user.kode), nama: user.nama||'User', role: effRole, outlets: outlets };
                setLS('currentUser', current);

                try { window.setupUserSession && window.setupUserSession(); } catch(e){ console.error('setupUserSession error', e); }
                try { window.showMainApp && window.showMainApp(); } catch(e){ console.error('showMainApp error', e); }
            };
        })();

        init();

        // ==== Robust Login Override v3: kode akses case-insensitive, merge bawaan, tidak bergantung cloud ====
        (function(){
            function normCode(c){ return (c||'').toString().trim().toLowerCase(); }
            function showErr(msg){
                try{
                    const eDiv = document.getElementById('loginError');
                    const eTxt = document.getElementById('errorText');
                    if (eDiv && eTxt){ eDiv.classList.remove('hidden'); eTxt.textContent = msg; }
                }catch(e){}
            }
            function getUsersLS(){ try{ const v = JSON.parse(localStorage.getItem('users')||'[]'); return Array.isArray(v)? v : []; }catch(e){ return []; } }
            function setUsersLS(arr){ try{ localStorage.setItem('users', JSON.stringify(arr||[])); }catch(e){} }
            function buildBuiltinIndex(){
                const idx = new Map();
                try{
                    const db = window.userDatabase || {};
                    Object.keys(db).forEach(role => {
                        (db[role]||[]).forEach(u => {
                            if (!u || !u.kode) return;
                            const key = normCode(u.kode);
                            if (!idx.has(key)) idx.set(key, { kode:String(u.kode), nama:u.nama||'User', role, outlets:u.outlets|| (role==='admin'||role==='head-office' ? 'all' : []), status:'aktif' });
                        });
                    });
                }catch(e){}
                return idx;
            }
            window.login = function(){
                try{
                    // Ambil input
                    const roleSelRaw = (document.getElementById('loginRole')?.value||'').toString().trim().toLowerCase();
                    const codeRaw = (document.getElementById('loginCode')?.value||'').toString();
                    const codeKey = normCode(codeRaw);
                    if (!roleSelRaw){ showErr('Silakan pilih role terlebih dahulu'); return; }
                    if (!codeKey){ showErr('Silakan masukkan kode akses'); return; }

                    // Pastikan master user dimerge dan outlet dibersihkan
                    try{ window.mergeUserDatabase && window.mergeUserDatabase(); }catch(e){}
                    try{ window.dedupeOutlets && window.dedupeOutlets(); }catch(e){}

                    // Bangun index gabungan: local + builtin
                    let users = getUsersLS();
                    const localIdx = new Map();
                    users.forEach(u => { if(u&&u.kode){ localIdx.set(normCode(u.kode), u); } });
                    const builtinIdx = buildBuiltinIndex();

                    // Cari user berdasarkan kode di local dulu, lalu builtin
                    let user = localIdx.get(codeKey) || builtinIdx.get(codeKey) || null;

                    // Jika ketemu di builtin tapi belum ada di local, tambahkan ke local agar persist
                    if (user && !localIdx.get(codeKey)){
                        users.push({ kode:user.kode, nama:user.nama, role:user.role, outlets:user.outlets, status:user.status||'aktif' });
                        setUsersLS(users);
                    }

                    if (!user){
                        showErr('Kode akses tidak ditemukan. Hubungi Admin.');
                        return;
                    }
                    if ((user.status||'aktif').toString().toLowerCase() !== 'aktif'){
                        showErr('Akun dinonaktifkan. Hubungi Admin.');
                        return;
                    }

                    // Siapkan allowed outlets
                    let outletsAll = [];
                    try{ outletsAll = JSON.parse(localStorage.getItem('outlets')||'[]'); }catch(e){ outletsAll=[]; }
                    const allIds = Array.isArray(outletsAll)? outletsAll.map(o=>o.id).filter(Boolean) : [];
                    let allowed = [];
                    if (user.outlets==='all' || user.role==='admin' || user.role==='head-office'){
                        allowed = allIds.slice();
                    } else if (Array.isArray(user.outlets)){
                        allowed = user.outlets.filter(id => allIds.includes(id));
                    } else if (user.outlets){
                        allowed = allIds.includes(user.outlets)? [user.outlets] : [];
                    }
                    if (allowed.length===0 && allIds.length){ allowed = allIds.slice(); }

                    // Tetapkan currentUser (role mengikuti data user agar konsisten)
                    const cu = { kode: user.kode, nama: user.nama||'User', role: (user.role||roleSelRaw), outlets: (user.outlets!==undefined? user.outlets : (['admin','head-office'].includes(user.role)? 'all' : allowed)) };
                    try{ localStorage.setItem('currentUser', JSON.stringify(cu)); }catch(e){}
                    window.currentUser = cu;

                    // Lanjutkan sesi
                    try{ window.setupUserSession && window.setupUserSession(); }catch(e){}
                    try{ window.showMainApp && window.showMainApp(); }catch(e){}
                }catch(err){
                    console.warn('Login fatal error:', err);
                    showErr('Terjadi kesalahan saat login. Muat ulang lalu coba lagi.');
                }
            };
        })();
        // === FINAL OVERRIDE: Ultra-robust login (code-only, case-insensitive, role-agnostic) ===
        (function(){
            function safeParse(key, fallback){
                try{ const v = localStorage.getItem(key); if(!v) return fallback; const p = JSON.parse(v); return (p==null? fallback : p); }catch(e){ return fallback; }
            }
            function setLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
            function flattenBuiltin(){
                const arr=[]; try{ const db = window.userDatabase||{}; Object.keys(db).forEach(role=>{ (db[role]||[]).forEach(u=>{ if(u&&u.kode){ arr.push({ kode:String(u.kode), nama:u.nama||'User', role, outlets:(u.outlets!=null? u.outlets : (role==='admin'||role==='head-office' ? 'all' : [])), status:'aktif' }); } }); }); }catch(e){}
                return arr;
            }
            function buildIndex(){
                const idx = new Map();
                const ls = safeParse('users',[]);
                ls.forEach(u=>{ if(u&&u.kode){ idx.set(String(u.kode).toLowerCase().trim(), u); } });
                const builtin = flattenBuiltin();
                builtin.forEach(u=>{ const k=String(u.kode).toLowerCase().trim(); if(!idx.has(k)) idx.set(k, u); });
                return { idx, ls };
            }
            window.login = function(){
                try{
                    const roleSel = (document.getElementById('loginRole')?.value||'').toString().trim().toLowerCase();
                    const codeRaw = (document.getElementById('loginCode')?.value||'').toString().trim();
                    const codeKey = codeRaw.toLowerCase();
                    const errDiv = document.getElementById('loginError');
                    const errTxt = document.getElementById('errorText');
                    function showErr(msg){ if(errDiv&&errTxt){ errDiv.classList.remove('hidden'); errTxt.textContent = msg; } console.warn('[LOGIN]', msg); }
                    function hideErr(){ if(errDiv){ errDiv.classList.add('hidden'); } }
                    if(!roleSel) return showErr('Silakan pilih role terlebih dahulu');
                    if(!codeKey) return showErr('Silakan masukkan kode akses');
                    hideErr();

                    // 1) Pastikan master user dimuat/merge terlebih dulu
                    try{ window.mergeUserDatabase && window.mergeUserDatabase(); }catch(e){ console.warn('mergeUserDatabase error', e); }

                    // 2) Bangun index gabungan (local + builtin)
                    let { idx, ls } = buildIndex();
                    let user = idx.get(codeKey) || null;

                    // 3) Jika belum ketemu, coba pull ringan (non-blocking), lalu re-merge & rebuild index
                    if(!user){
                        try{ if(typeof window.pullDataFromCloud==='function'){ window.pullDataFromCloud(); } }catch(e){}
                        try{ window.mergeUserDatabase && window.mergeUserDatabase(); }catch(e){}
                        const rebuilt = buildIndex(); idx = rebuilt.idx; ls = rebuilt.ls; user = idx.get(codeKey) || null;
                    }

                    // 4) Jika ketemu hanya di builtin, persist ke local agar sesi berikutnya langsung ada
                    if(user && (!ls || !Array.isArray(ls) || !ls.find(u=> (u&&u.kode)&& String(u.kode).toLowerCase().trim()===codeKey))){
                        const newUsers = Array.isArray(ls)? ls.slice() : [];
                        newUsers.push({ kode:user.kode, nama:user.nama, role:user.role, outlets:user.outlets, status:user.status||'aktif' });
                        setLS('users', newUsers);
                    }

                    if(!user){ return showErr('Kode akses tidak ditemukan. Hubungi Admin.'); }
                    if(String(user.status||'aktif').toLowerCase()!=='aktif'){ return showErr('Akun dinonaktifkan. Hubungi Admin.'); }

                    // 5) Siapkan allowed outlets
                    let outletsAll = []; try{ outletsAll = JSON.parse(localStorage.getItem('outlets')||'[]'); }catch(e){ outletsAll = []; }
                    const allIds = Array.isArray(outletsAll)? outletsAll.map(o=>o.id).filter(Boolean) : [];
                    let outletsField = user.outlets;
                    if(outletsField==='all' || user.role==='admin' || user.role==='head-office'){
                        outletsField = allIds.length? allIds.slice() : 'all';
                    } else if(Array.isArray(outletsField)){
                        outletsField = outletsField.filter(id=> allIds.includes(id));
                        if(!outletsField.length && allIds.length){ outletsField = [allIds[0]]; }
                    } else if(typeof outletsField==='string' && outletsField){
                        outletsField = allIds.includes(outletsField)? outletsField : (allIds[0]||outletsField);
                    } else {
                        outletsField = allIds.length? [allIds[0]] : [];
                    }

                    const effectiveRole = (user.role || roleSel);
                    const current = { kode: user.kode, nama: user.nama||'User', role: effectiveRole, outlets: outletsField };
                    setLS('currentUser', current);
                    try{ window.currentUser = current; }catch(e){}

                    // 6) Siapkan sesi & tampilkan app
                    try{ window.setupUserSession && window.setupUserSession(); }catch(e){ console.error('setupUserSession error', e); }
                    try{ window.showMainApp && window.showMainApp(); }catch(e){ console.error('showMainApp error', e); }
                }catch(err){
                    console.error('Fatal login error:', err);
                    const errDiv = document.getElementById('loginError');
                    const errTxt = document.getElementById('errorText');
                    if(errDiv&&errTxt){ errDiv.classList.remove('hidden'); errTxt.textContent = 'Terjadi kesalahan saat login. Muat ulang lalu coba lagi.'; }
                }
            };
        })();


        // ===== FINAL OVERRIDE: Robust login (code-only, case-insensitive, role-agnostic) =====
        (function(){
            window.login = function(){
                try{
                    const roleSel = (document.getElementById('loginRole')?.value||'').toString().trim().toLowerCase();
                    const codeRaw = (document.getElementById('loginCode')?.value||'').toString().trim();
                    const codeKey = codeRaw.toLowerCase();
                    const errDiv = document.getElementById('loginError');
                    const errTxt = document.getElementById('errorText');
                    function showErr(msg){ if(errDiv&&errTxt){ errDiv.classList.remove('hidden'); errTxt.textContent = msg; } }
                    function hideErr(){ if(errDiv){ errDiv.classList.add('hidden'); } }

                    if (!codeKey){ showErr('Silakan masukkan kode akses'); return; }
                    hideErr();

                    // Merge database bawaan terlebih dahulu agar tidak tergantung cloud
                    try { window.mergeUserDatabase && window.mergeUserDatabase(); } catch(e) { console.warn('mergeUserDatabase error', e); }

                    // Ambil users dari local
                    function getUsersLS(){ try{ const v = JSON.parse(localStorage.getItem('users')||'[]'); return Array.isArray(v)? v : []; } catch(e){ return []; } }
                    let users = getUsersLS();

                    // Bangun index gabungan: local + builtin userDatabase
                    const idx = new Map();
                    users.forEach(u=>{ if(u&&u.kode){ idx.set(String(u.kode).toLowerCase().trim(), u); } });
                    try {
                        const db = window.userDatabase || {};
                        Object.keys(db).forEach(role => {
                            (db[role]||[]).forEach(u => {
                                if (!u || !u.kode) return;
                                const k = String(u.kode).toLowerCase().trim();
                                if (!idx.has(k)) idx.set(k, { kode:String(u.kode), nama:u.nama||'User', role:role, outlets:(u.outlets!=null?u.outlets:(role==='admin'||role==='head-office'?'all':[])), status:'aktif' });
                            });
                        });
                    } catch(e) { console.warn('build builtin index failed', e); }

                    let user = idx.get(codeKey) || null;
                    if (!user){ showErr('Kode akses tidak ditemukan. Hubungi Admin.'); return; }
                    if (String(user.status||'aktif').toLowerCase() !== 'aktif'){ showErr('Akun dinonaktifkan. Hubungi Admin.'); return; }

                    // Pastikan user ada di localStorage agar sesi berikutnya stabil
                    if (!users.find(u => String(u.kode).toLowerCase().trim() === codeKey)){
                        users.push({ kode:user.kode, nama:user.nama, role:user.role, outlets:user.outlets, status:user.status||'aktif' });
                        try { localStorage.setItem('users', JSON.stringify(users)); } catch(e) {}
                    }

                    // Susun allowed outlets aman
                    let outletsAll = []; try { outletsAll = JSON.parse(localStorage.getItem('outlets')||'[]'); } catch(e){ outletsAll=[]; }
                    const allIds = Array.isArray(outletsAll) ? outletsAll.map(o=>o.id).filter(Boolean) : [];
                    let outletsField = user.outlets;
                    if (outletsField==='all' || user.role==='admin' || user.role==='head-office'){
                        outletsField = allIds.length ? allIds.slice() : 'all';
                    } else if (Array.isArray(outletsField)){
                        outletsField = outletsField.filter(id => allIds.includes(id));
                        if (!outletsField.length && allIds.length){ outletsField = [allIds[0]]; }
                    } else if (typeof outletsField==='string' && outletsField){
                        outletsField = allIds.includes(outletsField) ? outletsField : (allIds[0]||outletsField);
                    } else {
                        outletsField = allIds.length ? [allIds[0]] : [];
                    }

                    const current = { kode: user.kode, nama: user.nama||'User', role: user.role, outlets: outletsField };
                    try { localStorage.setItem('currentUser', JSON.stringify(current)); } catch(e) {}
                    window.currentUser = current;

                    try { window.setupUserSession && window.setupUserSession(); } catch(e){ console.error('setupUserSession error', e); }
                    try { window.showMainApp && window.showMainApp(); } catch(e){ console.error('showMainApp error', e); }
                } catch(err){
                    const errDiv = document.getElementById('loginError');
                    const errTxt = document.getElementById('errorText');
                    if (errDiv && errTxt){ errDiv.classList.remove('hidden'); errTxt.textContent = 'Terjadi kesalahan saat login. Muat ulang lalu coba lagi.'; }
                    console.error('Fatal login error:', err);
                }
            };
        })();

    </script>
<script>
// === ULTRA ROBUST LOGIN OVERRIDE v5 ===
(function(){
  console.info('[LOGIN] ultra override v5 loaded');
  window.login = async function(){
    const errDiv = document.getElementById('loginError');
    const errTxt = document.getElementById('errorText');
    function showErr(msg){ if(errDiv&&errTxt){ errDiv.classList.remove('hidden'); errTxt.textContent = msg; } }
    function hideErr(){ if(errDiv){ errDiv.classList.add('hidden'); } }
    try{
      const codeRaw = (document.getElementById('loginCode')?.value||'').trim();
      if(!codeRaw){ showErr('Silakan masukkan kode akses'); return; }
      hideErr();
      const codeKey = codeRaw.toLowerCase();

      // 1) Pastikan master user ter-merge lebih dulu
      try{ if(typeof mergeUserDatabase==='function') mergeUserDatabase(); }catch(e){ console.warn('[LOGIN] mergeUserDatabase error', e); }

      // 2) Bangun index user gabungan: local + builtin
      function getUsersLS(){ try{ const a = JSON.parse(localStorage.getItem('users')||'[]'); return Array.isArray(a)? a:[]; }catch(e){ return []; } }
      const builtin = (function(){
        const coll=[]; try{ const db = window.userDatabase||{}; Object.keys(db).forEach(r=>{ (db[r]||[]).forEach(u=>{ if(u&&u.kode){ coll.push({ kode:String(u.kode), nama:u.nama||'User', role:r, outlets:u.outlets!=null? u.outlets : (r==='admin'||r==='head-office'?'all':[]), status:'aktif' }); } }); }); }catch(e){}
        return coll;
      })();
      let users = getUsersLS();
      const idx = new Map();
      users.forEach(u=>{ if(u&&u.kode){ idx.set(String(u.kode).toLowerCase(), u); } });
      builtin.forEach(u=>{ const k = String(u.kode).toLowerCase(); if(!idx.has(k)) idx.set(k, u); });

      let user = idx.get(codeKey) || null;

      // 3) Jika belum ketemu, coba pull ringan dari cloud lalu rebuild index
      if(!user && typeof pullDataFromCloud==='function'){
        try{
          await pullDataFromCloud();
          users = getUsersLS();
          const idx2 = new Map();
          users.forEach(u=>{ if(u&&u.kode){ idx2.set(String(u.kode).toLowerCase(), u); } });
          builtin.forEach(u=>{ const k = String(u.kode).toLowerCase(); if(!idx2.has(k)) idx2.set(k, u); });
          user = idx2.get(codeKey) || null;
        }catch(e){ console.warn('[LOGIN] pullDataFromCloud error', e); }
      }

      if(!user){ showErr('Kode akses tidak ditemukan. Hubungi Admin.'); return; }
      if(String(user.status||'aktif').toLowerCase()!=='aktif'){ showErr('Akun dinonaktifkan. Hubungi Admin.'); return; }

      // 4) Pastikan user tercatat di localStorage.users
      if(!users.find(u=> String(u.kode).toLowerCase()===codeKey)){
        users.push({ kode:user.kode, nama:user.nama, role:user.role, outlets:user.outlets, status:user.status||'aktif' });
        try{ localStorage.setItem('users', JSON.stringify(users)); }catch(e){ console.warn('[LOGIN] save users failed', e); }
      }

      // 5) Susun allowed outlets aman
      let outletsAll=[]; try{ outletsAll = JSON.parse(localStorage.getItem('outlets')||'[]'); }catch(e){ outletsAll=[]; }
      const allIds = Array.isArray(outletsAll)? outletsAll.map(o=>o.id).filter(Boolean):[];
      let outletsField = user.outlets;
      if(outletsField==='all' || user.role==='admin' || user.role==='head-office'){
        outletsField = allIds.length? allIds.slice(): 'all';
      }else if(Array.isArray(outletsField)){
        outletsField = outletsField.filter(id=> allIds.includes(id));
        if(!outletsField.length && allIds.length) outletsField=[allIds[0]];
      }else if(typeof outletsField==='string' && outletsField){
        outletsField = allIds.includes(outletsField)? outletsField : (allIds[0]||outletsField);
      }else{
        outletsField = allIds.length? [allIds[0]] : [];
      }

      const current = { kode:user.kode, nama:user.nama||'User', role:user.role, outlets:outletsField };
      try{ localStorage.setItem('currentUser', JSON.stringify(current)); }catch(e){}
      window.currentUser = current;

      // 6) Siapkan sesi & tampilkan app
      try{ if(typeof setupUserSession==='function') setupUserSession(); }catch(e){ console.warn('setupUserSession error', e); }
      try{ if(typeof showMainApp==='function') showMainApp(); }catch(e){ console.warn('showMainApp error', e); }
      console.info('[LOGIN] success as', current.role, current.nama);
    }catch(err){
      console.error('Fatal login error:', err);
      showErr('Terjadi kesalahan saat login. Muat ulang lalu coba lagi.');
    }
  };
})();
</script>
</body>
</html>
