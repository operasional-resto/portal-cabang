<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Cabang - Sistem Pengendalian Operasional Multi Outlet</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Portal Cabang - Pengendalian Operasional&quot;,
        &quot;short_name&quot;: &quot;Portal Cabang&quot;,
        &quot;start_url&quot;: &quot;./&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;%231e3a8a&quot;,
        &quot;theme_color&quot;: &quot;%231e3a8a&quot;,
        &quot;scope&quot;: &quot;./&quot;
    }">
    <meta name="theme-color" content="#1e3a8a">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: 16px; }
        html { font-size: 16px; }
        body { font-size: 1rem; }
        .text-sm { font-size: 0.95rem; }
        .text-xs { font-size: 0.85rem; }
        .sidebar-link.active { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .module-section { display: none; }
        .module-section.active { display: block; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-only { pointer-events: none; opacity: 0.7; }
        .btn-disabled { pointer-events: none; opacity: 0.5; }

        /* Remove all borders inside module sections */
        .module-section .border,
        .module-section .border-b,
        .module-section .border-t,
        .module-section .border-l,
        .module-section .border-r,
        .module-section .border-x,
        .module-section .border-y,
        .module-section .border-white\/10,
        .module-section .border-gray-100,
        .module-section .border-gray-200,
        .module-section .border-gray-300,
        .module-section .border-red-200,
        .module-section .border-yellow-200,
        .module-section .border-green-200,
        .module-section .border-blue-200 { border-width: 0 !important; }

        .module-section .border-b { border-bottom-width: 0 !important; }
        .module-section .border-t { border-top-width: 0 !important; }
        .module-section .border-l { border-left-width: 0 !important; }
        .module-section .border-r { border-right-width: 0 !important; }

        /* Remove divide lines in lists/tables */
        .module-section .divide-y > :not([hidden]) ~ :not([hidden]) { border-top-width: 0 !important; }
        .module-section .divide-x > :not([hidden]) ~ :not([hidden]) { border-left-width: 0 !important; }

        /* Tables: remove borders */
        .module-section table,
        .module-section th,
        .module-section td { border: none !important; }
    </style>
    <style>
        /* Remove borders on Outlet Selector Bar */
        #outletSelectorBar { border-width: 0 !important; border: none !important; }
        #outletSelectorBar .border,
        #outletSelectorBar .border-b,
        #outletSelectorBar .border-t,
        #outletSelectorBar .border-l,
        #outletSelectorBar .border-r,
        #outletSelectorBar .border-x,
        #outletSelectorBar .border-y { border-width: 0 !important; }
        #outletSelectorBar select { border: none !important; box-shadow: none !important; }

        /* Hide access badge (top-right) */
        #accessBadge { display: none !important; }
        /* Hide access mode label under Portal Cabang (sidebar) */
        #accessModeLabel { display: none !important; }
        /* Hide subtitle under Portal Cabang in login modal */
        #loginModal .text-center > p { display: none !important; }

        /* Narrow outlet filter and improve mobile fit */
        #outletSelectorBar .flex.items-center.gap-3 { gap: 0.5rem; }
        #outletSelectorBar span { font-size: 0.85rem; }
        #activeOutletSelect {
            max-width: 60vw;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            font-size: 0.9rem;
            padding: 0.35rem 0.6rem;
        }
        @media (max-width: 640px) {
            #activeOutletSelect { max-width: 56vw; font-size: 0.85rem; }
            #outletSelectorBar span { font-size: 0.8rem; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-indigo-900 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-store text-white text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Portal Cabang</h1>
                <p class="text-gray-500">Sistem Pengendalian Operasional</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Role <span class="text-red-500">*</span></label>
                    <select id="loginRole" onchange="onRoleChange()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- Pilih Role --</option>
                        <option value="admin">Admin</option>
                        <option value="head-office">Head Office</option>
                        <option value="area-manager">Area Manager</option>
                        <option value="kepala-cabang">Kepala Cabang</option>
                        <option value="outlet">Staff Outlet</option>
                    </select>
                </div>
                <div id="roleDescription" class="hidden p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-700" id="roleDescText"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kode Akses <span class="text-red-500">*</span></label>
                    <input type="password" id="loginCode" placeholder="Masukkan kode akses Anda" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1" id="codeHint"></p>
                </div>
                <div id="loginError" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600"><i class="fas fa-exclamation-circle mr-1"></i><span id="errorText"></span></p>
                </div>
                <button onclick="login()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-indigo-700 transition-all">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                </button>
            </div>
            // Checklist migration removed (checklist module deprecated)

            <!-- Dashboard -->
            <section id="module-dashboard" class="module-section active p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <p class="text-gray-500" id="dashboardDate"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tugas Selesai</p>
                                <p class="text-3xl font-bold text-gray-800" id="statTugas">0/0</p>
                            </div>
                            <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-tasks text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 rounded-full" id="progressTugas" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Checklist Hari Ini</p>
                                <p class="text-3xl font-bold text-gray-800" id="statChecklist">0%</p>
                            </div>
                            <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clipboard-check text-green-600 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-green-500 rounded-full" id="progressChecklist" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Barang Reject</p>
                                <p class="text-3xl font-bold text-red-600" id="statReject">0</p>
                            </div>
                            <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                            </div>
                        </div>
                        <p class="mt-4 text-sm text-gray-500">Hari ini</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Rating Feedback</p>
                                <p class="text-3xl font-bold text-yellow-600" id="statRating">0.0</p>
                            </div>
                            <div class="w-14 h-14 bg-yellow-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-star text-yellow-600 text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex text-yellow-400" id="starsRating">
                            <i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-clock text-blue-500 mr-2"></i>Aktivitas Terkini</h3>
                        <div class="space-y-4" id="recentActivities">
                            <p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-exclamation-triangle text-orange-500 mr-2"></i>Item Mendekati Expired</h3>
                        <div class="space-y-3" id="expiringItems">
                            <p class="text-gray-500 text-center py-4">Tidak ada item mendekati expired</p>
                        </div>
                    </div>
                </div>

                <!-- Head Office Dashboard Extensions -->
                <div id="hoDashboard" class="mt-8 hidden">
                    <div class="mb-4">
                        <h3 class="font-bold text-gray-800"><i class="fas fa-globe-asia text-indigo-500 mr-2"></i><span id="hoTitle">Ringkasan Multi-Outlet</span></h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Tugas Selesai</p>
                                    <p class="text-3xl font-bold text-gray-800" id="hoStatTugas">0/0</p>
                                </div>
                                <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-tasks text-blue-600 text-2xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 rounded-full" id="hoProgressTugas" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Checklist Hari Ini</p>
                                    <p class="text-3xl font-bold text-gray-800" id="hoStatChecklist">0%</p>
                                </div>
                                <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-clipboard-check text-green-600 text-2xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-green-500 rounded-full" id="hoProgressChecklist" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Barang Reject</p>
                                    <p class="text-3xl font-bold text-red-600" id="hoStatReject">0</p>
                                </div>
                                <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                                </div>
                            </div>
                            <p class="mt-4 text-sm text-gray-500">Hari ini (semua outlet)</p>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Rating Feedback</p>
                                    <p class="text-3xl font-bold text-yellow-600" id="hoStatRating">0.0</p>
                                </div>
                                <div class="w-14 h-14 bg-yellow-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-star text-yellow-600 text-2xl"></i>
                                </div>
                            </div>
                            <div class="mt-4 flex text-yellow-400" id="hoStarsRating">
                                <i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Ranking Outlet</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Outlet</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Checklist</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Reject (Hari ini)</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hoRankingBody" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm">
                            <h3 class="font-bold text-gray-800 mb-4"><i class="fas fa-bell text-red-500 mr-2"></i>Panel Alert</h3>
                            <div id="hoAlertsList" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Tidak ada alert</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Jadwal Kerja -->
            <section id="module-jadwal-kerja" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Jadwal Kerja</h2>
                    <div class="flex gap-2">
                        <button id="btnExportJadwal" onclick="exportJadwalPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                        <button id="btnAddJadwal" onclick="openModal('modalJadwal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Jadwal
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex items-center justify-between gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-2 border rounded-lg" onclick="changeSchedulePeriod(-1)"><i class="fas fa-chevron-left"></i></button>
                            <div class="text-sm">
                                <div class="font-semibold text-gray-700">Periode</div>
                                <div id="labelSchedulePeriod" class="text-gray-500">21 ... 20 ...</div>
                            </div>
                            <button class="px-3 py-2 border rounded-lg" onclick="changeSchedulePeriod(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Pilih Periode:</label>
                                <select id="periodSelect" class="px-4 py-2 border rounded-lg" onchange="onPeriodSelectChange()"></select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Filter Shift:</label>
                                <select id="shiftFilter" class="px-4 py-2 border rounded-lg" onchange="loadJadwal()">
                                    <option value="">Semua Shift</option>
                                    <option value="pagi">Pagi (06:00-14:00)</option>
                                    <option value="siang">Siang (14:00-22:00)</option>
                                    <option value="malam">Malam (22:00-06:00)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Staff</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shift</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="jadwalTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Tugas Harian -->
            <section id="module-tugas-harian" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Tugas Harian</h2>
                    <div class="flex gap-2">
                        <button id="btnExportTugas" onclick="exportTugasPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddTugas" onclick="openModal('modalTugas')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Tugas
                        </button>
                    </div>
                </div>
                <div class="grid gap-4" id="tugasContainer"></div>
            </section>

            <!-- Preparation Bahan Baku -->
            <section id="module-preparation" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Preparation Bahan Baku</h2>
                    <div class="flex gap-2">
                        <button id="btnExportPreparation" onclick="exportPreparationPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddPrep" onclick="openModal('modalPreparation')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Preparation
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bahan Baku</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Petugas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="preparationTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Checklist Operasional removed (replaced by Google Forms). -->

            <!-- Catatan Barang Reject -->
            <section id="module-reject" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Catatan Barang Reject</h2>
                    <div class="flex gap-2">
                        <button id="btnExportReject" onclick="exportRejectPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddReject" onclick="openModal('modalReject')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Catat Reject
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex gap-4 flex-wrap">
                        <input type="date" id="rejectDateFilter" class="px-4 py-2 border rounded-lg" onchange="loadReject()">
                        <select id="rejectCategoryFilter" class="px-4 py-2 border rounded-lg" onchange="loadReject()">
                            <option value="">Semua Kategori</option>
                            <option value="expired">Expired</option>
                            <option value="rusak">Rusak/Cacat</option>
                            <option value="kontaminasi">Kontaminasi</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Alasan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">PIC</th>
                                </tr>
                            </thead>
                            <tbody id="rejectTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventori FIFO/FEFO -->
            <section id="module-inventori" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Inventori (FIFO/FEFO)</h2>
                    <div class="flex gap-2">
                        <button id="btnAddInv" onclick="openModal('modalInventori')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-sign-in-alt mr-2"></i>In Stock
                        </button>
                        <button id="btnOutStock" onclick="openModal('modalOutStock')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all">
                            <i class="fas fa-sign-out-alt mr-2"></i>Out Stock
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 w-full max-w-full min-w-0">
                        <p class="text-green-600 text-sm font-medium">Stock Aman</p>
                        <p class="text-2xl font-bold text-green-700" id="stockAman">0</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 w-full max-w-full min-w-0">
                        <p class="text-yellow-600 text-sm font-medium">Mendekati Expired</p>
                        <p class="text-2xl font-bold text-yellow-700" id="stockWarning">0</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-xl p-4 w-full max-w-full min-w-0">
                        <p class="text-red-600 text-sm font-medium">Expired</p>
                        <p class="text-2xl font-bold text-red-700" id="stockExpired">0</p>
                    </div>
                </div>
                <!-- Rekap Saldo & Jumlah -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="font-bold text-gray-800"><i class="fas fa-layer-group text-blue-500 mr-2"></i>Rekap Saldo per Tgl Produksi</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Produksi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="invSaldoBody" class="divide-y divide-gray-200">
                                    <tr><td colspan="3" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 border-b">
                            <h3 class="font-bold text-gray-800"><i class="fas fa-box-open text-emerald-500 mr-2"></i>Rekap Jumlah per Nama Barang</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="invJumlahBody" class="divide-y divide-gray-200">
                                    <tr><td colspan="2" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b">
                        <div class="flex items-center gap-4 flex-wrap">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Filter Nama Barang:</label>
                                <select id="invFilterNama" class="px-4 py-2 border rounded-lg" onchange="loadInventori()">
                                    <option value="">Semua Barang</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Satuan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Batch</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Produksi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Masuk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Expired</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="inventoriTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Riwayat Out Stock -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden mt-6">
                    <div class="p-4 border-b">
                        <h3 class="font-bold text-gray-800"><i class="fas fa-history text-red-500 mr-2"></i>Riwayat Out Stock</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Barang</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Satuan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">PIC</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody id="outStockTable" class="divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Log Book -->
            <section id="module-logbook" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Log Book (Komunikasi Antar Shift)</h2>
                    <button id="btnAddLog" onclick="openModal('modalLogbook')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                        <i class="fas fa-plus mr-2"></i>Tulis Log
                    </button>
                </div>
                <div class="space-y-4" id="logbookContainer"></div>
            </section>

            <!-- Customer Feedback -->
            <section id="module-feedback" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Customer Feedback</h2>
                    <div class="flex gap-2">
                        <button id="btnExportFeedback" onclick="exportFeedbackPDF()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-all">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                        <button id="btnAddFeedback" onclick="openModal('modalFeedback')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-2"></i>Tambah Feedback
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-yellow-500" id="avgRating">0.0</p>
                        <p class="text-gray-500 text-sm">Rating Rata-rata</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-green-500" id="totalPositive">0</p>
                        <p class="text-gray-500 text-sm">Feedback Positif (★4-5/Puas)</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-red-500" id="totalNegative">0</p>
                        <p class="text-gray-500 text-sm">Feedback Negatif (★1-3/Tidak Puas)</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <p class="text-3xl font-bold text-blue-500" id="totalFeedback">0</p>
                        <p class="text-gray-500 text-sm">Total Feedback</p>
                    </div>
                </div>
                <!-- Filter Feedback -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-gray-500">Tanggal:</label>
                            <input type="date" id="fbFilterTanggal" class="px-3 py-2 border rounded-lg text-sm" onchange="loadFeedback()">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sumber</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Komentar</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">CAPA</th>
                                </tr>
                            </thead>
                            <tbody id="feedbackTableBody" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Pengaturan Checklist removed (Google Forms used instead) -->

            <!-- Pengaturan Outlet -->
            <section id="module-settings-outlet" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Pengaturan Outlet</h2>
                    <button id="btnAddOutlet" onclick="openModal('modalOutlet')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                        <i class="fas fa-plus mr-2"></i>Tambah Outlet
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="outletContainer"></div>
            </section>

            <!-- Manajemen User -->
            <section id="module-settings-users" class="module-section p-4 lg:p-8 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Manajemen User</h2>
                    <button id="btnAddUser" onclick="openModal('modalUser')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                        <i class="fas fa-plus mr-2"></i>Tambah User
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kode Akses</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Outlet</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase action-column">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Koneksi Spreadsheet -->
            <section id="module-spreadsheet" class="module-section p-4 lg:p-8 fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Koneksi Google Spreadsheet</h2>
                    <p class="text-gray-500">Konfigurasi koneksi ke database Spreadsheet</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Spreadsheet ID</label>
                            <input type="text" id="spreadsheetId" placeholder="Masukkan Spreadsheet ID" class="w-full px-4 py-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                            <input type="password" id="apiKey" placeholder="Masukkan API Key" class="w-full px-4 py-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Web App URL (Google Apps Script)</label>
                            <input type="text" id="webAppUrl" placeholder="https://script.google.com/..." class="w-full px-4 py-3 border rounded-lg">
                        </div>
                        <div class="flex gap-4">
                            <button onclick="saveSpreadsheetConfig()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-save mr-2"></i>Simpan Konfigurasi
                            </button>
                            <button onclick="testConnection()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                                <i class="fas fa-plug mr-2"></i>Test Koneksi
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Panduan Integrasi</h4>
                        <ol class="text-sm text-blue-700 space-y-1 list-decimal ml-4">
                            <li>Buat Google Spreadsheet baru dengan sheet: Jadwal, Tugas, Checklist, Inventori, LogBook, Feedback, Reject</li>
                            <li>Buat Google Apps Script dan deploy sebagai Web App</li>
                            <li>Copy Spreadsheet ID dan Web App URL ke form di atas</li>
                            <li>Test koneksi untuk memastikan berhasil</li>
                        </ol>
                    </div>
                </div>
            </section>

            <!-- Panduan Akses -->
            <section id="module-guidelines" class="module-section p-4 lg:p-8 fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panduan Akses Head Office</h2>
                    <p class="text-gray-500">Rekomendasi cakupan akses agar efektif memantau seluruh outlet</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 space-y-6">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Tujuan Peran</h3>
                        <p class="text-sm text-gray-600">Head Office berfokus pada pemantauan, analitik, dan audit mutu. Tidak melakukan input operasional harian.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Akses yang Disarankan</h3>
                        <ul class="list-disc ml-5 text-sm text-gray-700 space-y-1">
                            <li>Dashboard: akses penuh untuk melihat metrik seluruh outlet dan per outlet.</li>
                            <li>Jadwal Kerja: lihat saja, termasuk filter periode dan outlet.</li>
                            <li>Tugas Harian: lihat saja, progres dan detail tugas per outlet.</li>
                            <li>Preparation Bahan Baku: lihat saja, untuk audit kepatuhan.</li>
                            <li>Checklist Operasional: lihat saja status OK/Tidak OK beserta CAPA.</li>
                            <li>Catatan Barang Reject: lihat saja, ekspor laporan untuk audit.</li>
                            <li>Inventori (FIFO/FEFO): lihat saja, termasuk stok, rekap saldo/jumlah, riwayat out stock.</li>
                            <li>Log Book: lihat saja, arsip komunikasi antar shift.</li>
                            <li>Customer Feedback: lihat saja seluruh catatan dan statistik.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Fitur Analitik Tambahan (Opsional)</h3>
                        <ul class="list-disc ml-5 text-sm text-gray-700 space-y-1">
                            <li>Filter lintas outlet dan periode untuk membandingkan performa.</li>
                            <li>Ekspor PDF/Spreadsheet untuk seluruh modul.</li>
                            <li>Notifikasi atau highlight outlier (mis. reject tinggi, checklist pending CAPA).</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-2">Batasan</h3>
                        <ul class="list-disc ml-5 text-sm text-gray-700 space-y-1">
                            <li>Tidak dapat menambah/mengubah/menghapus data operasional.</li>
                            <li>Tidak dapat mengubah pengaturan master (Checklist, Outlet, User).</li>
                        </ul>
                    </div>
                </div>
            </section>        </main>
    </div>

    <!-- Modals -->
    <!-- Modal Jadwal -->
    <div id="modalJadwal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Jadwal Kerja</h3>
                <button onclick="closeModal('modalJadwal')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Staff</label>
                    <input type="text" id="jadwalNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                    <input type="date" id="jadwalTanggal" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                    <select id="jadwalShift" class="w-full px-4 py-2 border rounded-lg">
                        <option value="pagi">Pagi</option>
                        <option value="middle">Middle</option>
                        <option value="siang">Siang</option>
                        <option value="malam">Malam</option>
                        <option value="full">FT</option>
                    </select>
                </div>
                <button onclick="saveJadwal()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Tugas -->
    <div id="modalTugas" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Tugas</h3>
                <button onclick="closeModal('modalTugas')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tugas</label>
                    <select id="tugasJudul" class="w-full px-4 py-2 border rounded-lg">
                        <option>Buang Sampah</option>
                        <option>Greastrap</option>
                        <option>Dishwasher</option>
                        <option>Stock Opname</option>
                        <option>Room Service/Penanganan TO</option>
                        <option>Checker</option>
                        <option>Order Barang</option>
                        <option>Terima Barang</option>
                        <option>Masakan "A"</option>
                        <option>Masakan "B"</option>
                        <option>Masakan "C"</option>
                        <option>Kasir</option>
                        <option>Juicer</option>
                        <option>Greeter</option>
                        <option>Runner</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <textarea id="tugasDeskripsi" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prioritas</label>
                    <select id="tugasPrioritas" class="w-full px-4 py-2 border rounded-lg">
                        <option value="tinggi">Tinggi</option>
                        <option value="sedang">Sedang</option>
                        <option value="rendah">Rendah</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ditugaskan kepada</label>
                    <select id="tugasAssign" class="w-full px-4 py-2 border rounded-lg"></select>
                    <p class="text-xs text-gray-500 mt-1">Nama diambil dari Jadwal Kerja periode aktif (21 s.d. 20).</p>
                </div>
                <button onclick="saveTugas()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Preparation -->
    <div id="modalPreparation" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Preparation</h3>
                <button onclick="closeModal('modalPreparation')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Bahan Baku</label>
                    <select id="prepNama" class="w-full px-4 py-2 border rounded-lg">
                        <option>Kukus Siomay</option>
                        <option>Kukus SMU</option>
                        <option>Kukus SKT</option>
                        <option>Rebus Telur</option>
                        <option>Rebus Kentang</option>
                        <option>Rebus Kol</option>
                        <option>Rebus Pare</option>
                        <option>Kukus Tahu</option>
                        <option>Masak Bumbu Siomay</option>
                        <option>Masak Bumbu Otak-otak</option>
                        <option>Masak Sambal</option>
                        <option>Masak Nasi Pera</option>
                        <option>Masak Nasi Putih</option>
                        <option>Buat Sambal Terasi</option>
                        <option>Buat Sambal Mercon</option>
                        <option>Masak Telur Ceplok</option>
                        <option>Goreng Emping</option>
                        <option>Goreng Kerupuk</option>
                        <option>Buat Kuah Siram</option>
                        <option>Thawing Buntut Sop</option>
                        <option>Thawing Tongseng Sop</option>
                        <option>Thawing Tongseng Ayam</option>
                        <option>Thawing Soto Betawi</option>
                        <option>Kukus PKS</option>
                        <option>Kukus Lenjeran</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label>
                    <input type="text" id="prepJumlah" class="w-full px-4 py-2 border rounded-lg" placeholder="contoh: 5 kg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Petugas</label>
                    <select id="prepPetugas" class="w-full px-4 py-2 border rounded-lg"></select>
                    <p class="text-xs text-gray-500 mt-1">Nama diambil dari Jadwal Kerja periode aktif (21 s.d. 20).</p>
                </div>
                <button onclick="savePreparation()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Reject -->
    <div id="modalReject" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Catat Barang Reject</h3>
                <button onclick="closeModal('modalReject')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <select id="rejectNama" class="w-full px-4 py-2 border rounded-lg">
                        <option>Ayam marinade</option>
                        <option>Boneless marinade</option>
                        <option>Daun bawang</option>
                        <option>Seldri</option>
                        <option>Wortel</option>
                        <option>CMB</option>
                        <option>CRH</option>
                        <option>Telur</option>
                        <option>Kentang</option>
                        <option>Kol</option>
                        <option>Pare</option>
                        <option>Bokcoy</option>
                        <option>Apple</option>
                        <option>Alpukat</option>
                        <option>Nanas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label>
                    <input type="text" id="rejectJumlah" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="rejectKategori" class="w-full px-4 py-2 border rounded-lg">
                        <option value="expired">Expired</option>
                        <option value="rusak">Rusak/Cacat</option>
                        <option value="kontaminasi">Kontaminasi</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Alasan</label>
                    <textarea id="rejectAlasan" rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <button onclick="saveReject()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Inventori (In Stock) -->
    <div id="modalInventori" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">In Stock</h3>
                <button onclick="closeModal('modalInventori')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Masuk</label>
                    <input type="date" id="invTglMasuk" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <select id="invNama" class="w-full px-4 py-2 border rounded-lg" onchange="onInvNamaChange()"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Batch Number</label>
                    <input type="text" id="invBatch" class="w-full px-4 py-2 border rounded-lg" placeholder="Contoh: PRD-202601-01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Produksi</label>
                    <input type="date" id="invTglProduksi" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Expired</label>
                    <input type="date" id="invTglExpired" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah <span id="invSatuanLabel" class="text-gray-400"></span></label>
                    <input type="number" id="invJumlah" class="w-full px-4 py-2 border rounded-lg" placeholder="0">
                </div>
                <button onclick="saveInventori()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Out Stock -->
    <div id="modalOutStock" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Out Stock (FEFO)</h3>
                <button onclick="closeModal('modalOutStock')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Barang</label>
                    <select id="outNama" class="w-full px-4 py-2 border rounded-lg" onchange="onOutNamaChange()"></select>
                </div>
                <!-- Info Batch Tersedia -->
                <div id="outBatchInfo" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-layer-group text-blue-500 mr-1"></i>Batch Tersedia (Urutan FEFO)
                    </label>
                    <div class="bg-gray-50 rounded-lg border max-h-40 overflow-y-auto">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 py-1 text-left">Urutan</th>
                                    <th class="px-2 py-1 text-left">Tgl Produksi</th>
                                    <th class="px-2 py-1 text-left">Tgl Expired</th>
                                    <th class="px-2 py-1 text-right">Stok</th>
                                </tr>
                            </thead>
                            <tbody id="outBatchTable"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-blue-600 mt-1"><i class="fas fa-info-circle mr-1"></i>Batch dengan tanggal expired paling awal akan dikeluarkan terlebih dahulu.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah yang Dikeluarkan <span id="outSatuanLabel" class="text-gray-400"></span></label>
                    <input type="number" id="outJumlah" class="w-full px-4 py-2 border rounded-lg" placeholder="0" oninput="previewOutStock()">
                    <p class="text-xs text-gray-500 mt-1">Total tersedia: <span id="outTotalTersedia" class="font-semibold">0</span></p>
                </div>
                <!-- Preview Penggunaan Batch -->
                <div id="outPreview" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-eye text-green-500 mr-1"></i>Preview Batch yang Akan Terpakai
                    </label>
                    <div id="outPreviewContent" class="bg-green-50 border border-green-200 rounded-lg p-3 text-sm"></div>
                </div>
                <button onclick="saveOutStock()" class="w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700">
                    <i class="fas fa-sign-out-alt mr-2"></i>Keluarkan Stock
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Logbook -->
    <div id="modalLogbook" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tulis Log Book</h3>
                <button onclick="closeModal('modalLogbook')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                    <select id="logShift" class="w-full px-4 py-2 border rounded-lg">
                        <option value="pagi">Pagi</option>
                        <option value="siang">Siang</option>
                        <option value="malam">Malam</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="logKategori" class="w-full px-4 py-2 border rounded-lg">
                        <option value="info">Informasi</option>
                        <option value="penting">Penting</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label>
                    <textarea id="logCatatan" rows="4" class="w-full px-4 py-2 border rounded-lg" placeholder="Tulis catatan untuk shift berikutnya..."></textarea>
                </div>
                <button onclick="saveLogbook()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Feedback -->
    <div id="modalFeedback" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Feedback</h3>
                <button onclick="closeModal('modalFeedback')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Customer</label>
                    <input type="text" id="fbNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sumber Feedback</label>
                    <select id="fbSumber" class="w-full px-4 py-2 border rounded-lg" onchange="onFbSumberChange()">
                        <option value="google">Google Review</option>
                        <option value="wa">WA Customer Care</option>
                        <option value="instagram">Instagram</option>
                        <option value="onsite">On Site</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="fbKategori" class="w-full px-4 py-2 border rounded-lg">
                        <option value="pelayanan">Pelayanan</option>
                        <option value="produk">Produk</option>
                        <option value="sikap">Sikap Karyawan</option>
                        <option value="lingkungan">Lingkungan</option>
                    </select>
                </div>
                <!-- Rating Bintang (Google Review) -->
                <div id="ratingStarsContainer">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating Bintang</label>
                    <div class="flex gap-2" id="ratingStars">
                        <button type="button" onclick="setRating(1)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(2)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(3)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(4)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                        <button type="button" onclick="setRating(5)" class="text-3xl text-gray-300 hover:text-yellow-400"><i class="fas fa-star"></i></button>
                    </div>
                    <input type="hidden" id="fbRating" value="0">
                </div>
                <!-- Rating Puas/Tidak Puas (selain Google Review) -->
                <div id="ratingPuasContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tingkat Kepuasan</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="fbPuas" value="puas" onchange="onPuasChange()" class="w-5 h-5 text-green-600">
                            <span class="text-green-600 font-medium"><i class="fas fa-smile mr-1"></i>Puas</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="fbPuas" value="tidak_puas" onchange="onPuasChange()" class="w-5 h-5 text-red-600">
                            <span class="text-red-600 font-medium"><i class="fas fa-frown mr-1"></i>Tidak Puas</span>
                        </label>
                    </div>
                </div>
                <!-- Kolom CAPA (muncul jika rating negatif) -->
                <div id="fbCapaContainer" class="hidden">
                    <label class="block text-sm font-medium text-red-700 mb-1">CAPA (Corrective and Preventive Action) <span class="text-red-500">*</span></label>
                    <textarea id="fbCapa" rows="3" class="w-full px-4 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-300" placeholder="Jelaskan tindakan perbaikan dan pencegahan..."></textarea>
                    <p class="text-xs text-red-500 mt-1" id="fbCapaHint">Wajib diisi untuk rating negatif</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Komentar</label>
                    <textarea id="fbKomentar" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <button onclick="saveFeedback()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Checklist Setting removed -->

    <!-- Modal Outlet -->
    <div id="modalOutlet" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah Outlet</h3>
                <button onclick="closeModal('modalOutlet')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kode Outlet</label>
                    <input type="text" id="outletKode" class="w-full px-4 py-2 border rounded-lg" placeholder="contoh: OT001">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Outlet</label>
                    <input type="text" id="outletNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                    <textarea id="outletAlamat" rows="2" class="w-full px-4 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telepon</label>
                    <input type="text" id="outletTelp" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Area</label>
                    <input type="text" id="outletArea" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <button onclick="saveOutlet()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal User -->
    <div id="modalUser" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tambah User</h3>
                <button onclick="closeModal('modalUser')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kode Akses</label>
                    <input type="text" id="userKode" class="w-full px-4 py-2 border rounded-lg" placeholder="Kode unik untuk login">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="userNama" class="w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="userRoleSelect" class="w-full px-4 py-2 border rounded-lg" onchange="onUserRoleChange()">
                        <option value="admin">Admin</option>
                        <option value="head-office">Head Office</option>
                        <option value="area-manager">Area Manager</option>
                        <option value="kepala-cabang">Kepala Cabang</option>
                        <option value="outlet">Staff Outlet</option>
                    </select>
                </div>
                <div id="outletAssignmentDiv">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Outlet yang Ditangani</label>
                    <div id="outletCheckboxes" class="max-h-40 overflow-y-auto border rounded-lg p-3 space-y-2"></div>
                </div>
                <button onclick="saveUser()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 fade-in">
        <i class="fas fa-check-circle mr-2"></i><span id="toastMessage">Berhasil disimpan!</span>
    </div>

    <script>
        // ==================== USER DATABASE ====================
        const userDatabase = {
            'admin': [
                { kode: '2015115650mr', nama: 'Marianto', outlets: 'all' }
            ],
            'head-office': [
                { kode: '1998090117', nama: 'Puguh Setyo Wicasono', outlets: 'all' },
                { kode: '1994050021', nama: 'Wiwin Wiyono', outlets: 'all' },
                { kode: '1988110003', nama: 'Suyono', outlets: 'all' },
                { kode: '1988100004', nama: 'Grace Santoso', outlets: 'all' },
                { kode: '1988100005', nama: 'Stephanus Robion Pranatio', outlets: 'all' },
                { kode: '1988100006', nama: 'Rosalia Pranatio', outlets: 'all' }
            ],
            'area-manager': [
                { kode: '2015115657', nama: 'Afifur Rahman', outlets: ['outlet-1', 'outlet-2', 'outlet-3'] },
                { kode: '2015115662', nama: 'Sunarto', outlets: ['outlet-4', 'outlet-5', 'outlet-6'] },
                { kode: '2018037573', nama: 'I Made Swastika', outlets: ['outlet-7', 'outlet-8'] },
                { kode: '2018127754', nama: 'Moh. Imam Ma\'ruf Nahi Mungkar', outlets: ['outlet-9', 'outlet-10'] },
                { kode: '1997080076', nama: 'Ferdiyanto', outlets: ['outlet-11', 'outlet-12'] }
            ],
            'kepala-cabang': [],
            'outlet': []
        };

        // Role descriptions
        const roleDescriptions = {
            'admin': 'Semua outlet - Akses penuh ke seluruh sistem',
            'head-office': 'View Only semua outlet - Dapat melihat data tanpa mengubah',
            'area-manager': 'Outlet yang dibawahi - Mengelola beberapa outlet',
            'kepala-cabang': 'Outlet yang dibawahi - Mengelola satu outlet',
            'outlet': 'View + Input terbatas - Hanya outlet tempat bertugas'
        };

        // ==================== STATE MANAGEMENT ====================
        let currentUser = null;
        let currentOutlet = null; // legacy single outlet
        let selectedOutlets = null; // array of selected outlet ids for Admin/HO/AM
        let allowedOutlets = [];
        let isViewOnly = false;
        let currentModule = 'dashboard';
        let selectedRating = 0;
        let schedulePeriodOffset = 0; // 0 = periode berjalan, -1 periode sebelumnya, 1 periode berikutnya


        // Role Permissions
        const rolePermissions = {
            'admin': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'reject', 'inventori', 'logbook', 'feedback', 'settings-outlet', 'settings-users', 'spreadsheet', 'guidelines'],
            'head-office': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'reject', 'inventori', 'logbook', 'feedback'],
            'area-manager': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'reject', 'inventori', 'logbook', 'feedback'],
            'kepala-cabang': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'reject', 'inventori', 'logbook', 'feedback'],
            'outlet': ['dashboard', 'jadwal-kerja', 'tugas-harian', 'preparation', 'reject', 'inventori', 'logbook', 'feedback']
        };

        // ==================== INITIALIZATION ====================
        function cleanupDefaultOutlets() {
            try {
                let outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
                const before = outlets.length;
                const norm = (s) => (s || '').toString().toLowerCase().trim();
                const toRemoveSet = new Set([
                    'outlet sudirman',
                    'outlet kemang',
                    'outlet depok',
                    'outlet bali kuta',
                    'outlet bali seminyak',
                    'outlet kelapa gading',
                    'outlet surabaya tunjungan',
                    'outlet surabaya gubeng',
                    'outlet bandung dago',
                    'outlet bandung raya',
                    'outlet thamrin',
                    'outlet bekasi'
                ]);
                outlets = outlets.filter(o => {
                    const name = norm(o.nama);
                    if (toRemoveSet.has(name)) return false;
                    // Tangani kemungkinan salah ketik: "Bandung Raya" yang dimaksud "Bandung Braga"
                    if (name.startsWith('outlet bandung ') && (name.includes('braga') || name.includes('raya'))) return false;
                    return true;
                });
                if (outlets.length !== before) {
                    localStorage.setItem('outlets', JSON.stringify(outlets));
                }
            } catch (e) { /* ignore */ }
        }
        // Checklist migration removed (checklist module deprecated)
        function init() {
            // Pastikan data dasar terbuat lalu lakukan merge & cleanup sebelum menampilkan app
            initDefaultData();
            mergeUserDatabase();
            cleanupDefaultOutlets();

            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                setupUserSession();
                showMainApp();
            }
            // Load prefill mapping if any (no-op; prefill UI removed)
        }

        function initDefaultData() {
            if (!localStorage.getItem('outlets')) {
                localStorage.setItem('outlets', JSON.stringify([
                    { id: 'outlet-1', kode: 'OT001', nama: 'Outlet Sudirman', alamat: 'Jl. Sudirman No. 123', telp: '021-1234567', area: 'Jakarta Pusat', status: 'aktif' },
                    { id: 'outlet-2', kode: 'OT002', nama: 'Outlet Thamrin', alamat: 'Jl. Thamrin No. 456', telp: '021-2345678', area: 'Jakarta Pusat', status: 'aktif' },
                    { id: 'outlet-3', kode: 'OT003', nama: 'Outlet Kemang', alamat: 'Jl. Kemang Raya No. 789', telp: '021-3456789', area: 'Jakarta Selatan', status: 'aktif' },
                    { id: 'outlet-4', kode: 'OT004', nama: 'Outlet Kelapa Gading', alamat: 'Jl. Kelapa Gading No. 101', telp: '021-4567890', area: 'Jakarta Utara', status: 'aktif' },
                    { id: 'outlet-5', kode: 'OT005', nama: 'Outlet Bekasi', alamat: 'Jl. Ahmad Yani No. 202', telp: '021-5678901', area: 'Bekasi', status: 'aktif' },
                    { id: 'outlet-6', kode: 'OT006', nama: 'Outlet Depok', alamat: 'Jl. Margonda No. 303', telp: '021-6789012', area: 'Depok', status: 'aktif' },
                    { id: 'outlet-7', kode: 'OT007', nama: 'Outlet Bali Kuta', alamat: 'Jl. Kuta Beach No. 1', telp: '0361-123456', area: 'Bali', status: 'aktif' },
                    { id: 'outlet-8', kode: 'OT008', nama: 'Outlet Bali Seminyak', alamat: 'Jl. Seminyak No. 2', telp: '0361-234567', area: 'Bali', status: 'aktif' },
                    { id: 'outlet-9', kode: 'OT009', nama: 'Outlet Surabaya Tunjungan', alamat: 'Jl. Tunjungan No. 10', telp: '031-123456', area: 'Surabaya', status: 'aktif' },
                    { id: 'outlet-10', kode: 'OT010', nama: 'Outlet Surabaya Gubeng', alamat: 'Jl. Gubeng No. 20', telp: '031-234567', area: 'Surabaya', status: 'aktif' },
                    { id: 'outlet-11', kode: 'OT011', nama: 'Outlet Bandung Dago', alamat: 'Jl. Dago No. 100', telp: '022-123456', area: 'Bandung', status: 'aktif' },
                    { id: 'outlet-12', kode: 'OT012', nama: 'Outlet Bandung Braga', alamat: 'Jl. Braga No. 50', telp: '022-234567', area: 'Bandung', status: 'aktif' }
                ]));
            }
            if (!localStorage.getItem('checklistItems')) {
                localStorage.setItem('checklistItems', JSON.stringify([]));
            }
            // Checklist schema migration removed
        }

        function mergeUserDatabase() {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            let outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            let needsUserSave = false;
            let needsOutletSave = false;

            // 1) Merge predefined users (Admin, Head Office, Area Manager, dll)
            Object.keys(userDatabase).forEach(role => {
                userDatabase[role].forEach(u => {
                    const existing = users.find(existing => existing.kode === u.kode);
                    if (!existing) {
                        users.push({
                            kode: u.kode,
                            nama: u.nama,
                            role: role,
                            outlets: u.outlets,
                            status: 'aktif'
                        });
                        needsUserSave = true;
                    } else {
                        // Update nama, role, dan outlets jika berubah agar sinkron dengan data terbaru
                        let updated = false;
                        if (existing.nama !== u.nama) { existing.nama = u.nama; updated = true; }
                        if (existing.role !== role) { existing.role = role; updated = true; }
                        if (existing.outlets !== u.outlets) { existing.outlets = u.outlets; updated = true; }
                        if (updated) needsUserSave = true;
                    }
                });
            });

            // 2) Tambah daftar Staff Outlet dari data yang diberikan
            const staffOutletList = [
                { nama: 'MM RS Mayapada Tangerang', kode: '065' },
                { nama: 'MM RS JEC Kedoya', kode: '024' },
                { nama: 'MM RS Carolus Sumarecon', kode: '046' },
                { nama: 'MM RS EMC Alam Sutera', kode: '033' },
                { nama: 'MM Bandara Soetta T 1B Keberangkatan', kode: '035' },
                { nama: 'MM Bandara Soetta T 2E Keberangkatan', kode: '073' },
                { nama: 'MM Bandara Soetta T 2F Keberangkatan', kode: '059' },
                { nama: 'MM Bandara Soetta T 3Int Kedatangan', kode: '044' },
                { nama: 'MM Villagio Sumarecon karawang', kode: '028' },
                { nama: 'MM RS Siloam Cikarang', kode: '038' },
                { nama: 'MM Green Terrace Taman Mini', kode: '022' },
                { nama: 'MM RS EMC Sentul', kode: 'sentul' },
                { nama: 'MM RS Mayapada Nusantara', kode: '055' },
                { nama: 'MM HO Fatmawati', kode: '201' },
                { nama: 'MM Plaza Bintaro', kode: '015' },
                { nama: 'MM RS Mayapada Kuningan', kode: '071' },
                { nama: 'MM RS Premier Bintaro', kode: '013' },
                { nama: 'MM Cikajang', kode: '062' },
                { nama: 'MM Hypesquare Taman Yasmin', kode: 'yasmin' },
                { nama: 'MM RSUPFatmawati', kode: '040' },
                { nama: 'MM RS Mayapada Cakung', kode: 'cakung' },
                { nama: 'MM Bandara Soetta T 1A Keberangkatan', kode: '069' },
                { nama: 'MM Bandara Soetta T 1C Keberangkatan', kode: 'mm1c' },
                { nama: 'PK Bandara Soetta T 1C Keberangkatan', kode: 'pk1c' },
                { nama: 'MM Bandara Soetta T 3 G 14 Keberangkatan', kode: 't3g14' },
                { nama: 'MM Bandara Soetta T 3 G 3 Kedatangan', kode: '074' },
                { nama: 'MM Melawai', kode: '001' },
                { nama: 'MM RS Hermina Kemayoran', kode: '031' },
                { nama: 'MM RS Pusat Pertamina', kode: '054' },
                { nama: 'MM EKA Hospital MT. Haryono', kode: 'eka' },
                { nama: 'MM Mal Puri Indah', kode: '014' },
                { nama: 'MM RS Pantai Indah Kapuk', kode: '008' },
                { nama: 'MM RSPAD Gatot Subroto', kode: '068' },
                { nama: 'MM RS EMC Pekayon', kode: 'pekayon' },
                { nama: 'MM PandanSari', kode: '018' },
                { nama: 'MM RS Mayapada Jaksel', kode: '010' },
                { nama: 'PK RS Mayapada Jaksel', kode: '007' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Kedatangan', kode: '009' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Keberangkatan', kode: 'hasanudin' },
                { nama: 'MM Bandara Juanda Surabaya', kode: '034' },
                { nama: 'MM Grand City Surabaya', kode: '003' },
                { nama: 'MM RS Husada Utama Surabaya', kode: '026' },
                { nama: 'MM RS Mayapada Surabaya', kode: '067' },
                { nama: 'MM RS Mitra Keluarga Waru', kode: '004' },
                { nama: 'MM RS Mitra Keluarga Sidoarjo', kode: 'sidoarjo' },
                { nama: 'MM RS Mitra Keluarga Darmo Satelit', kode: 'darmo' },
                { nama: 'MM Mal Sumarecon Bandung', kode: '025' },
                { nama: 'MM Paris Van Java', kode: '043' },
                { nama: 'MM Paskal 23 Square', kode: '056' },
                { nama: 'MM RS Mayapada Bandung', kode: '072' },
                { nama: 'MM RSUP dr.Hasan Sadikin Bandung', kode: '052' },
                { nama: 'MM Manado Town Square', kode: '048' },
                { nama: 'MM Mega Mas Manado', kode: '051' },
                { nama: 'MM Living World Bali', kode: '042' },
                { nama: 'PK Living World Bali', kode: '057' },
                { nama: 'MM Gatot Subroto Bali', kode: '053' },
                { nama: 'MM RSUP Prof. dr. I.G.N.G. Ngoerah', kode: '064' },
                { nama: 'MM RS Kasih Ibu', kode: '005' },
                { nama: 'MM Lippo Sunset Plaza', kode: '017' },
                { nama: 'MM Icon Bali', kode: '037' },
                { nama: 'PK Icon Bali', kode: '049' },
                { nama: 'MM Lippo Mal Kuta', kode: '047' },
                { nama: 'MM Plaza Renon Bali', kode: '061' },
                { nama: 'MM Mal Bali Galeria', kode: '029' },
                { nama: 'PK Mal Bali Galeria', kode: '020' },
                { nama: 'MM Beachwalk', kode: '063' },
                { nama: 'PK Beachwalk', kode: '070' },
                { nama: 'MM Teuku Umar', kode: '058' },
                { nama: 'MM Pepito Jimbaran Bali', kode: '041' }
            ];

            // Helper untuk membuat ID outlet konsisten & unik
            const slugify = (str) => str
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const codeSlug = (str) => (str || '').toLowerCase().replace(/[^a-z0-9]+/g, '');

            staffOutletList.forEach(entry => {
                const name = entry.nama.trim();
                const code = entry.kode.trim();

                // Cari outlet berdasarkan nama (case-insensitive)
                let outletObj = outlets.find(o => (o.nama || '').toLowerCase() === name.toLowerCase());
                if (!outletObj) {
                    const id = `outlet-${slugify(name)}-${codeSlug(code)}`.slice(0, 64);
                    outletObj = {
                        id,
                        kode: code.toUpperCase(),
                        nama: name,
                        alamat: '-',
                        telp: '-',
                        area: '-',
                        status: 'aktif'
                    };
                    outlets.push(outletObj);
                    needsOutletSave = true;
                }

                // Sinkronisasi user Staff Outlet berdasarkan nama (update kode/outlet bila perlu)
                const existingByName = users.find(u => u.role === 'outlet' && (u.nama || '').toLowerCase() === name.toLowerCase());
                if (existingByName) {
                    // Perbarui kode akses dan outlet assignment jika berbeda
                    if (existingByName.kode !== code) { existingByName.kode = code; needsUserSave = true; }
                    if (existingByName.outlets !== outletObj.id) { existingByName.outlets = outletObj.id; needsUserSave = true; }
                }

                // Tambah user Staff Outlet jika belum ada (berdasarkan kode)
                if (!users.find(u => u.kode === code)) {
                    users.push({
                        kode: code,
                        nama: name,
                        role: 'outlet',
                        outlets: outletObj.id,
                        status: 'aktif'
                    });
                    needsUserSave = true;
                }
            });

            // 2b) Tambah daftar Kepala Cabang dari data yang diberikan
            const kepalaCabangList = [
                { nama: 'MM RS Mayapada Tangerang', kode: '065a' },
                { nama: 'MM RS JEC Kedoya', kode: '024a' },
                { nama: 'MM RS Carolus Sumarecon', kode: '046a' },
                { nama: 'MM RS EMC Alam Sutera', kode: '033a' },
                { nama: 'MM Bandara Soetta T 1B Keberangkatan', kode: '035a' },
                { nama: 'MM Bandara Soetta T 2E Keberangkatan', kode: '073a' },
                { nama: 'MM Bandara Soetta T 2F Keberangkatan', kode: '059a' },
                { nama: 'MM Bandara Soetta T 3Int Kedatangan', kode: '044a' },
                { nama: 'MM Villagio Sumarecon karawang', kode: '028a' },
                { nama: 'MM RS Siloam Cikarang', kode: '038a' },
                { nama: 'MM Green Terrace Taman Mini', kode: '022a' },
                { nama: 'MM RS EMC Sentul', kode: '@sentul' },
                { nama: 'MM RS Mayapada Nusantara', kode: '055a' },
                { nama: 'MM HO Fatmawati', kode: '201a' },
                { nama: 'MM Plaza Bintaro', kode: '015a' },
                { nama: 'MM RS Mayapada Kuningan', kode: '071a' },
                { nama: 'MM RS Premier Bintaro', kode: '013a' },
                { nama: 'MM Cikajang', kode: '062a' },
                { nama: 'MM Hypesquare Taman Yasmin', kode: '@yasmin' },
                { nama: 'MM RSUPFatmawati', kode: '040a' },
                { nama: 'MM RS Mayapada Cakung', kode: '@cakung' },
                { nama: 'MM Bandara Soetta T 1A Keberangkatan', kode: '069a' },
                { nama: 'MM Bandara Soetta T 1C Keberangkatan', kode: '@mm1c' },
                { nama: 'PK Bandara Soetta T 1C Keberangkatan', kode: '@pk1c' },
                { nama: 'MM Bandara Soetta T 3 G 14 Keberangkatan', kode: '@t3g14' },
                { nama: 'MM Bandara Soetta T 3 G 3 Kedatangan', kode: '074a' },
                { nama: 'MM Melawai', kode: '001a' },
                { nama: 'MM RS Hermina Kemayoran', kode: '031a' },
                { nama: 'MM RS Pusat Pertamina', kode: '054a' },
                { nama: 'MM EKA Hospital MT. Haryono', kode: '@eka' },
                { nama: 'MM Mal Puri Indah', kode: '014a' },
                { nama: 'MM RS Pantai Indah Kapuk', kode: '008a' },
                { nama: 'MM RSPAD Gatot Subroto', kode: '068a' },
                { nama: 'MM RS EMC Pekayon', kode: '@pekayon' },
                { nama: 'MM PandanSari', kode: '018a' },
                { nama: 'MM RS Mayapada Jaksel', kode: '010a' },
                { nama: 'PK RS Mayapada Jaksel', kode: '007a' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Kedatangan', kode: '009a' },
                { nama: 'MM Bandar Udara Sultan Hasanudin Keberangkatan', kode: '@hasanudin' },
                { nama: 'MM Bandara Juanda Surabaya', kode: '034a' },
                { nama: 'MM Grand City Surabaya', kode: '003a' },
                { nama: 'MM RS Husada Utama Surabaya', kode: '026a' },
                { nama: 'MM RS Mayapada Surabaya', kode: '067a' },
                { nama: 'MM RS Mitra Keluarga Waru', kode: '004a' },
                { nama: 'MM RS Mitra Keluarga Sidoarjo', kode: '@sidoarjo' },
                { nama: 'MM RS Mitra Keluarga Darmo Satelit', kode: '@darmo' },
                { nama: 'MM Mal Sumarecon Bandung', kode: '025a' },
                { nama: 'MM Paris Van Java', kode: '043a' },
                { nama: 'MM Paskal 23 Square', kode: '056a' },
                { nama: 'MM RS Mayapada Bandung', kode: '072a' },
                { nama: 'MM RSUP dr.Hasan Sadikin Bandung', kode: '052a' },
                { nama: 'MM Manado Town Square', kode: '048a' },
                { nama: 'MM Mega Mas Manado', kode: '051a' },
                { nama: 'MM Living World Bali', kode: '042a' },
                { nama: 'PK Living World Bali', kode: '057a' },
                { nama: 'MM Gatot Subroto Bali', kode: '053a' },
                { nama: 'MM RSUP Prof. dr. I.G.N.G. Ngoerah', kode: '064a' },
                { nama: 'MM RS Kasih Ibu', kode: '005a' },
                { nama: 'MM Lippo Sunset Plaza', kode: '017a' },
                { nama: 'MM Icon Bali', kode: '037a' },
                { nama: 'PK Icon Bali', kode: '049a' },
                { nama: 'MM Lippo Mal Kuta', kode: '047a' },
                { nama: 'MM Plaza Renon Bali', kode: '061a' },
                { nama: 'MM Mal Bali Galeria', kode: '029a' },
                { nama: 'PK Mal Bali Galeria', kode: '020a' },
                { nama: 'MM Beachwalk', kode: '063a' },
                { nama: 'PK Beachwalk', kode: '070a' },
                { nama: 'MM Teuku Umar', kode: '058a' },
                { nama: 'MM Pepito Jimbaran Bali', kode: '041a' }
            ];

            kepalaCabangList.forEach(entry => {
                const name = entry.nama.trim();
                const code = entry.kode.trim();

                // Cari outlet berdasarkan nama (case-insensitive)
                let outletObj = outlets.find(o => (o.nama || '').toLowerCase() === name.toLowerCase());
                if (!outletObj) {
                    // Buat outlet baru jika belum ada
                    const id = `outlet-${slugify(name)}-${codeSlug(code)}`.slice(0, 64);
                    outletObj = {
                        id,
                        kode: code.toUpperCase(),
                        nama: name,
                        alamat: '-',
                        telp: '-',
                        area: '-',
                        status: 'aktif'
                    };
                    outlets.push(outletObj);
                    needsOutletSave = true;
                }

                // Sinkronisasi user Kepala Cabang berdasarkan kode
                const existingByCode = users.find(u => u.kode === code);
                if (existingByCode) {
                    // Update role dan outlet jika diperlukan
                    if (existingByCode.role !== 'kepala-cabang') { existingByCode.role = 'kepala-cabang'; needsUserSave = true; }
                    if (existingByCode.outlets !== outletObj.id) { existingByCode.outlets = outletObj.id; needsUserSave = true; }
                    if (existingByCode.nama !== name) { existingByCode.nama = name; needsUserSave = true; }
                } else {
                    // Tambah user Kepala Cabang baru
                    users.push({
                        kode: code,
                        nama: name,
                        role: 'kepala-cabang',
                        outlets: outletObj.id,
                        status: 'aktif'
                    });
                    needsUserSave = true;
                }
            });

            // 3) Tambah/Update Area Manager berdasarkan mapping nama outlet -> kode AM dan nama AM
            const normalizeName = (s) => (s || '').toString().toLowerCase().replace(/\s+/g, ' ').trim();
            const outletNameIndex = {};
            outlets.forEach(o => { outletNameIndex[normalizeName(o.nama)] = o.id; });

            function findOutletIdByNameFuzzy(name) {
                if (!name) return null;
                let n = normalizeName(name);
                // perbaiki variasi umum
                n = n.replace(/^mm mm\s+/, 'mm ');
                let id = outletNameIndex[n];
                if (!id) {
                    // coba tambahkan/hilangkan prefix 'mm '
                    const withMM = n.startsWith('mm ') ? n : ('mm ' + n);
                    const withoutMM = n.replace(/^mm\s+/, '');
                    id = outletNameIndex[withMM] || outletNameIndex[withoutMM];
                }
                if (!id) {
                    // coba cocokkan dengan includes dua arah
                    const hit = outlets.find(o => {
                        const on = normalizeName(o.nama);
                        return on.includes(n) || n.includes(on);
                    });
                    if (hit) id = hit.id;
                }
                if (!id) {
                    // jika tetap tidak ditemukan, buat outlet baru agar assignment tidak gagal
                    const newId = `outlet-${slugify(name)}-${Math.random().toString(36).slice(2,8)}`.slice(0,64);
                    const outletObj = { id: newId, kode: '-', nama: name.trim(), alamat: '-', telp: '-', area: '-', status: 'aktif' };
                    outlets.push(outletObj);
                    outletNameIndex[normalizeName(name)] = newId;
                    needsOutletSave = true;
                    id = newId;
                }
                return id;
            }

            const areaManagerAssignments = [
                { kode: '1995120041', nama: 'Hartadi', outletsByName: [
                    'MM RS Mayapada Tangerang','MM RS JEC Kedoya','MM RS Carolus Sumarecon','MM RS EMC Alam Sutera','MM Bandara Soetta T 1B Keberangkatan','MM Bandara Soetta T 2E Keberangkatan','MM Bandara Soetta T 2F Keberangkatan','MM Bandara Soetta T 3Int Kedatangan','MM Villagio Sumarecon Karawang','MM RS Siloam Cikarang','MM Green Terrace Taman Mini','MM RS EMC Sentul','MM RS Mayapada Nusantara','MM HO Fatmawati','MM Plaza Bintaro','MM RS Mayapada Kuningan','MM RS Premier Bintaro','MM Cikajang','MM Hypesquare Taman Yasmin','MM RSUPFatmawati','MM RS Mayapada Cakung','MM Bandara Soetta T 1A Keberangkatan','MM Bandara Soetta T 1C Keberangkatan','PK Bandara Soetta T 1C Keberangkatan','MM Bandara Soetta T 3 G 14 Keberangkatan','MM Bandara Soetta T 3 G 3 Kedatangan','MM Melawai','MM RS Hermina Kemayoran','MM RS Pusat Pertamina','MM EKA Hospital MT. Haryono','MM Mal Puri Indah','MM RS Pantai Indah Kapuk','MM RSPAD Gatot Subroto','MM RS EMC Pekayon','MM Pandansari','MM RS Mayapada Jaksel','PK RS Mayapada Jaksel','MM Bandar Udara Sultan Hasanudin Kedatangan','MM Bandar Udara Sultan Hasanudin Keberangkatan','MM Bandara Juanda Surabaya','MM Grand City Surabaya','MM RS Husada Utama Surabaya','MM RS Mayapada Surabaya','MM RS Mitra Keluarga Waru','MM RS Mitra Keluarga Sidoarjo','MM RS Mitra Keluarga Darmo Satelit','MM Mal Sumarecon Bandung','MM Paris Van Java','MM Paskal 23 Square','MM RS Mayapada Bandung','MM RSUP dr.Hasan Sadikin Bandung','MM Living World Bali','PK Living World Bali','MM Gatot Subroto Bali','MM RSUP Prof. dr. I.G.N.G. Ngoerah','MM RS Kasih Ibu','MM Lippo Sunset Plaza','MM Icon Bali','PK Icon Bali','MM Lippo Mal Kuta','MM Plaza Renon Bali','MM Mal Bali Galeria','PK Mal Bali Galeria','MM Beachwalk','PK Beachwalk','MM Teuku Umar','MM Pepito Jimbaran Bali','MM Mega Mas Manado','Manado Town Square'
                ]},
                { kode: '1992080011', nama: 'Darwanto', outletsByName: [
                    'MM Bandara Soetta T 1B Keberangkatan','MM Bandara Soetta T 2E Keberangkatan','MM Bandara Soetta T 2F Keberangkatan','MM Bandara Soetta T 3Int Kedatangan'
                ]},
                { kode: '2009081950', nama: 'Suprianto', outletsByName: [
                    'MM Villagio Sumarecon Karawang','MM RS Siloam Cikarang','MM Green Terrace Taman Mini','MM RS EMC Sentul','MM RS Mayapada Nusantara'
                ]},
                { kode: '2016126353', nama: 'Deni Hormansyah', outletsByName: [
                    'MM HO Fatmawati','MM Plaza Bintaro','MM RS Mayapada Kuningan','MM RS Premier Bintaro'
                ]},
                { kode: '2015115648', nama: 'Budi Hari Santoso', outletsByName: [
                    'MM Cikajang','MM Hypesquare Taman Yasmin','MM RSUPFatmawati','MM RS Mayapada Cakung'
                ]},
                { kode: '2022050099', nama: 'Pujianto', outletsByName: [
                    'MM Bandara Soetta T 1A Keberangkatan','MM Bandara Soetta T 1C Keberangkatan','PK Bandara Soetta T 1C Keberangkatan','MM Bandara Soetta T 3 G 14 Keberangkatan','MM Bandara Soetta T 3 G 3 Kedatangan'
                ]},
                { kode: '2000110212', nama: 'Badrudin', outletsByName: [
                    'MM Melawai','MM RS Hermina Kemayoran','MM RS Pusat Pertamina','MM EKA Hospital MT. Haryono'
                ]},
                { kode: '2017036469', nama: 'Tri Prasetio', outletsByName: [
                    'MM Mal Puri Indah','MM RS Pantai Indah Kapuk','MM RSPAD Gatot Subroto','MM RS EMC Pekayon'
                ]},
                { kode: '2017126957', nama: 'Ahmad Fauzi', outletsByName: [
                    'MM Pandansari','MM RS Mayapada Jaksel','PK RS Mayapada Jaksel','MM Bandar Udara Sultan Hasanudin Kedatangan','MM Bandar Udara Sultan Hasanudin Keberangkatan'
                ]},
                { kode: '2016086072', nama: 'Khoirrudin', outletsByName: [
                    'MM Bandara Juanda Surabaya','MM Grand City Surabaya','MM RS Husada Utama Surabaya','MM RS Mayapada Surabaya','MM RS Mitra Keluarga Waru','MM RS Mitra Keluarga Sidoarjo','MM RS Mitra Keluarga Darmo Satelit'
                ]},
                { kode: '1999080142', nama: 'Dadan Dani', outletsByName: [
                    'MM Mal Sumarecon Bandung','MM Paris Van Java','MM Paskal 23 Square','MM RS Mayapada Bandung','MM RSUP dr.Hasan Sadikin Bandung'
                ]},
                { kode: '1997080076', nama: 'Ferdiyanto', outletsByName: [
                    'MM Living World Bali','PK Living World Bali','MM Gatot Subroto Bali','MM RSUP Prof. dr. I.G.N.G. Ngoerah','MM RS Kasih Ibu','MM Lippo Sunset Plaza','MM Icon Bali','PK Icon Bali','MM Lippo Mal Kuta','MM Plaza Renon Bali','MM Mal Bali Galeria','PK Mal Bali Galeria','MM Beachwalk','PK Beachwalk','MM Teuku Umar','MM Pepito Jimbaran Bali','MM Mega Mas Manado','Manado Town Square'
                ]},
                { kode: '2015115657', nama: 'Afifur Rahman', outletsByName: [
                    'MM Living World Bali','PK Living World Bali','MM Gatot Subroto Bali','MM RSUP Prof. dr. I.G.N.G. Ngoerah'
                ]},
                { kode: '2015115662', nama: 'Sunarto', outletsByName: [
                    'MM RS Kasih Ibu','MM Lippo Sunset Plaza','MM Icon Bali','PK Icon Bali'
                ]},
                { kode: '2018127754', nama: "Moh. Imam Ma'ruf Nahi Mungkar", outletsByName: [
                    'MM Lippo Mal Kuta','MM Plaza Renon Bali','MM Mal Bali Galeria','PK Mal Bali Galeria'
                ]},
                { kode: '2018037573', nama: 'I Made Swastika', outletsByName: [
                    'MM Beachwalk','PK Beachwalk','MM Teuku Umar','MM Pepito Jimbaran Bali'
                ]}
            ];

            areaManagerAssignments.forEach(am => {
                const ids = Array.from(new Set(am.outletsByName.map(findOutletIdByNameFuzzy).filter(Boolean)));
                const existing = users.find(u => u.kode === am.kode);
                if (existing) {
                    if (existing.role !== 'area-manager') { existing.role = 'area-manager'; }
                    if (existing.nama !== am.nama) { existing.nama = am.nama; }
                    existing.outlets = ids;
                    needsUserSave = true;
                } else {
                    users.push({ kode: am.kode, nama: am.nama, role: 'area-manager', outlets: ids, status: 'aktif' });
                    needsUserSave = true;
                }
            });

            if (needsOutletSave) {
                localStorage.setItem('outlets', JSON.stringify(outlets));
            }
            if (needsUserSave) {
                localStorage.setItem('users', JSON.stringify(users));
                // Sinkronkan currentUser jika ada perubahan pada data user
                try {
                    const cu = JSON.parse(localStorage.getItem('currentUser') || 'null');
                    if (cu) {
                        const upd = users.find(u => u.kode === cu.kode);
                        if (upd) {
                            const newCurrent = { kode: upd.kode, nama: upd.nama, role: upd.role, outlets: upd.outlets };
                            localStorage.setItem('currentUser', JSON.stringify(newCurrent));
                            currentUser = newCurrent;
                        }
                    }
                } catch (e) { /* ignore */ }
            }
        }

        // ==================== LOGIN FUNCTIONS ====================
        function onRoleChange() {
            const role = document.getElementById('loginRole').value;
            const descDiv = document.getElementById('roleDescription');
            const descText = document.getElementById('roleDescText');
            const codeHint = document.getElementById('codeHint');
            
            if (role) {
                descDiv.classList.remove('hidden');
                descText.textContent = roleDescriptions[role];
                codeHint.textContent = 'Masukkan kode akses untuk role ' + getRoleName(role);
            } else {
                descDiv.classList.add('hidden');
                codeHint.textContent = '';
            }
            
            document.getElementById('loginError').classList.add('hidden');
        }

        function login() {
            const role = document.getElementById('loginRole').value;
            const codeRaw = document.getElementById('loginCode').value || '';
            const code = codeRaw.trim();
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');

            if (!role) {
                errorDiv.classList.remove('hidden');
                errorText.textContent = 'Silakan pilih role terlebih dahulu';
                return;
            }

            if (!code) {
                errorDiv.classList.remove('hidden');
                errorText.textContent = 'Silakan masukkan kode akses';
                return;
            }

            // Try to find user in localStorage users first
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            const norm = s => (s || '').toString().trim().toLowerCase();
            let user = users.find(u => norm(u.kode) === norm(code) && u.role === role);

            // Fallback: check predefined userDatabase for the role
            if (!user) {
                const dbList = userDatabase[role] || [];
                const found = dbList.find(u => norm(u.kode) === norm(code));
                if (found) {
                    user = { kode: found.kode, nama: found.nama, role: role, outlets: found.outlets, status: 'aktif' };
                    users.push(user);
                    try { localStorage.setItem('users', JSON.stringify(users)); } catch (e) {}
                }
            }

            // Fallback 2: if still not found, try to find by kode only (in case role changed)
            if (!user) {
                user = users.find(u => norm(u.kode) === norm(code));
                if (user) {
                    // If role mismatch, but user exists, allow login but update role to selected one
                    if (user.role !== role) {
                        user.role = role;
                        try { localStorage.setItem('users', JSON.stringify(users)); } catch (e) {}
                    }
                }
            }

            if (!user) {
                errorDiv.classList.remove('hidden');
                errorText.textContent = 'Kode akses tidak valid untuk role ' + getRoleName(role);
                return;
            }

            // Set current user
            currentUser = {
                kode: user.kode,
                nama: user.nama,
                role: user.role,
                outlets: user.outlets
            };

            try { localStorage.setItem('currentUser', JSON.stringify(currentUser)); } catch (e) {}
            setupUserSession();
            showMainApp();
        }

        function setupUserSession() {
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');

            // Determine allowed outlets based on role
            if (currentUser.role === 'admin' || currentUser.role === 'head-office' || currentUser.outlets === 'all') {
                allowedOutlets = outlets.map(o => o.id);
            } else if (Array.isArray(currentUser.outlets)) {
                allowedOutlets = currentUser.outlets;
            } else {
                allowedOutlets = [currentUser.outlets];
            }

            // Set view only mode for head-office
            isViewOnly = (currentUser.role === 'head-office');

            // Legacy single outlet fallback
            currentOutlet = allowedOutlets[0];

            // Restore multi-selection for Admin/HO/AM from localStorage (persist per user)
            const isMultiRole = ['admin','head-office','area-manager'].includes(currentUser.role);
            if (isMultiRole) {
                const key = `selectedOutlets.${currentUser.role}.${currentUser.kode}`;
                const saved = JSON.parse(localStorage.getItem(key) || 'null');
                // Use intersection of saved with allowedOutlets, fallback to all allowed
                if (Array.isArray(saved) && saved.length) {
                    const setAllowed = new Set(allowedOutlets);
                    const filtered = saved.filter(id => setAllowed.has(id));
                    selectedOutlets = filtered.length ? filtered : [...allowedOutlets];
                } else {
                    selectedOutlets = [...allowedOutlets];
                }
                // Ensure currentOutlet is within selectedOutlets
                if (!selectedOutlets.includes(currentOutlet)) currentOutlet = selectedOutlets[0] || currentOutlet;
            } else {
                selectedOutlets = null;
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            allowedOutlets = [];
            isViewOnly = false;
            location.reload();
        }

        // ==================== MAIN APP ====================
        function showMainApp() {
            const loginModalEl = document.getElementById('loginModal');
            if (loginModalEl) loginModalEl.classList.add('hidden');

            const mainAppEl = document.getElementById('mainApp');
            if (!mainAppEl) {
                console.warn('showMainApp: #mainApp element not found — skipping UI activation');
                return;
            }
            mainAppEl.classList.remove('hidden');

            const userNameEl = document.getElementById('userName');
            if (userNameEl) userNameEl.textContent = currentUser.nama;

            const userRoleEl = document.getElementById('userRole');
            if (userRoleEl) userRoleEl.textContent = getRoleName(currentUser.role);

            // Set access mode label (use roleDescriptions for detailed text)
            const accessLabel = document.getElementById('accessModeLabel');
            if (accessLabel) accessLabel.textContent = roleDescriptions[currentUser.role] || 'Mode Akses';

            // Set access badge
            const accessBadge = document.getElementById('accessBadge');
            if (accessBadge) {
                if (isViewOnly) {
                    accessBadge.textContent = 'VIEW ONLY';
                    accessBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700';
                } else {
                    accessBadge.textContent = 'DAPAT MENGUBAH';
                    accessBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
                }
            }

            populateOutletSelector();
            applyRolePermissions();
            applyViewOnlyMode();
            loadDashboard();
            updateDashboardDate();
        }

        function populateOutletSelector() {
            const select = document.getElementById('activeOutletSelect');
            const multiWrap = document.getElementById('multiOutletSelector');
            const multiBtn = document.getElementById('multiOutletBtn');
            const optionsBox = document.getElementById('multiOutletOptions');
            const outletsRaw = JSON.parse(localStorage.getItem('outlets') || '[]');
            // Dedupe outlets by normalized name to avoid duplicate display entries
            const normalize = s => (s || '').toString().trim().toLowerCase();
            const nameMap = new Map();
            outletsRaw.forEach(o => {
                const key = normalize(o.nama) || o.id;
                if (!nameMap.has(key)) nameMap.set(key, o);
            });
            const outlets = Array.from(nameMap.values());

            const isMultiRole = ['admin','head-office','area-manager'].includes(currentUser.role);
            if (isMultiRole) {
                // Show multi selector, hide single select
                if (multiWrap) multiWrap.classList.remove('hidden');
                if (select) select.classList.add('hidden');

                // Build options (checkboxes)
                if (optionsBox) {
                    const list = outlets.filter(o => allowedOutlets.includes(o.id));
                    optionsBox.innerHTML = list.map(o => {
                        const checked = !selectedOutlets || selectedOutlets.includes(o.id) ? 'checked' : '';
                        return `<label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50">
                            <input type="checkbox" class="outlet-check" value="${o.id}" ${checked}>
                            <span class="text-sm text-gray-700 truncate">${o.nama}</span>
                        </label>`;
                    }).join('');
                }

                // Update button label summary
                if (multiBtn) {
                    const list = outlets.filter(o => allowedOutlets.includes(o.id));
                    const mapName = (id)=> (list.find(x=>x.id===id)||{}).nama || id;
                    const sel = (selectedOutlets && selectedOutlets.length) ? selectedOutlets : allowedOutlets;
                    let label = 'Semua Outlet';
                    if (sel.length === 1) label = mapName(sel[0]);
                    else if (sel.length > 1 && sel.length < list.length) label = `${sel.length} Outlet dipilih`;
                    else if (sel.length === list.length) label = 'Semua Outlet';
                    multiBtn.textContent = label;
                }
            } else {
                // Show single select
                if (multiWrap) multiWrap.classList.add('hidden');
                if (select) {
                    select.classList.remove('hidden');
                    select.innerHTML = '';
                    outlets.filter(o => allowedOutlets.includes(o.id)).forEach(o => {
                        const option = document.createElement('option');
                        option.value = o.id;
                        option.textContent = o.nama;
                        if (o.id === currentOutlet) option.selected = true;
                        select.appendChild(option);
                    });
                }
            }
        }

        function changeActiveOutlet() {
            currentOutlet = document.getElementById('activeOutletSelect').value;
            // Reload current module
            const activeModule = document.querySelector('.module-section.active');
            if (activeModule) {
                const moduleId = activeModule.id.replace('module-', '');
                loadModuleData(moduleId);
            }
        }

        function toggleMultiOutletPanel() {
            const panel = document.getElementById('multiOutletPanel');
            if (!panel) return;
            panel.classList.toggle('hidden');

            // Attach/detach outside click to close
            const handler = (e) => {
                if (!panel.classList.contains('hidden')) {
                    const btn = document.getElementById('multiOutletBtn');
                    if (!panel.contains(e.target) && !btn.contains(e.target)) {
                        panel.classList.add('hidden');
                        document.removeEventListener('click', handler);
                    }
                }
            };
            if (!panel.classList.contains('hidden')) {
                setTimeout(() => document.addEventListener('click', handler), 0);
            }
        }

        function selectAllOutlets() {
            const checks = document.querySelectorAll('#multiOutletOptions .outlet-check');
            checks.forEach(c => c.checked = true);
        }

        function deselectAllOutlets() {
            const checks = document.querySelectorAll('#multiOutletOptions .outlet-check');
            checks.forEach(c => c.checked = false);
        }

        function applySelectedOutlets() {
            const checks = document.querySelectorAll('#multiOutletOptions .outlet-check');
            const sel = Array.from(checks).filter(c => c.checked).map(c => c.value);
            selectedOutlets = sel.length ? sel : [...allowedOutlets];

            // Persist selection per user
            try {
                const key = `selectedOutlets.${currentUser.role}.${currentUser.kode}`;
                localStorage.setItem(key, JSON.stringify(selectedOutlets));
            } catch (e) {}

            // Ensure legacy currentOutlet stays within selection for single-outlet modules
            if (selectedOutlets && selectedOutlets.length) {
                if (!selectedOutlets.includes(currentOutlet)) {
                    currentOutlet = selectedOutlets[0];
                }
            }
            // Update summary label
            populateOutletSelector();
            toggleMultiOutletPanel();
            // Reload current module
            const activeModule = document.querySelector('.module-section.active');
            if (activeModule) {
                const moduleId = activeModule.id.replace('module-', '');
                loadModuleData(moduleId);
            }
        }

        function getRoleName(role) {
            const names = {
                'admin': 'Administrator',
                'head-office': 'Head Office',
                'area-manager': 'Area Manager',
                'kepala-cabang': 'Kepala Cabang',
                'outlet': 'Staff Outlet'
            };
            return names[role] || role;
        }

        function applyRolePermissions() {
            const permissions = rolePermissions[currentUser.role] || [];
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const onclick = link.getAttribute('onclick');
                if (onclick) {
                    const match = onclick.match(/'([^']+)'/);
                    if (match) {
                        const module = match[1];
                        if (!permissions.includes(module)) {
                            link.style.display = 'none';
                        }
                    }
                }
            });
            
            // Sembunyikan seluruh menu Pengaturan untuk role non-admin
            if (currentUser.role !== 'admin') {
                document.getElementById('settingsMenu').style.display = 'none';
            }
        }

        function applyViewOnlyMode() {
            const addButtons = [
                'btnAddJadwal', 'btnAddTugas', 'btnAddPrep', 'btnAddReject',
                'btnAddInv', 'btnOutStock', 'btnAddLog', 'btnAddFeedback',
                'btnAddOutlet', 'btnAddUser'
            ];
            
            addButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    if (isViewOnly) {
                        btn.classList.add('btn-disabled');
                        btn.onclick = null;
                    }
                }
            });

            // Head Office: pastikan tombol Export PDF tetap terlihat (monitoring butuh export)
            if (currentUser && currentUser.role === 'head-office') {
                ['btnExportJadwal','btnExportTugas','btnExportPreparation','btnExportReject','btnExportFeedback'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.style.display = '';
                });
            }

            // Hide action columns for view only
            if (isViewOnly) {
                const style = document.createElement('style');
                style.textContent = '.action-column { display: none !important; }';
                document.head.appendChild(style);
            }
            
            // Pembatasan khusus untuk Staff Outlet
            if (currentUser && currentUser.role === 'outlet') {
                // Tombol yang harus disembunyikan untuk Staff Outlet
                const hideForOutlet = [
                    'btnExportJadwal', 'btnAddJadwal',      // Jadwal Kerja: hanya lihat, tidak bisa export/tambah
                    'btnExportTugas', 'btnAddTugas',        // Tugas Harian: hanya lihat, tidak bisa export/tambah
                    'btnExportPreparation', 'btnAddPrep',   // Preparation: hanya lihat, tidak bisa export/tambah
                    // checklist removed
                    'btnExportReject',                      // Reject: tidak bisa export
                    'btnExportFeedback'                     // Feedback: tidak bisa export
                ];
                
                hideForOutlet.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.style.display = 'none';
                    }
                });
                
                // Sembunyikan kolom aksi pada jadwal kerja untuk staff outlet
                const style = document.createElement('style');
                style.id = 'outlet-restrictions';
                style.textContent = `
                    #module-jadwal-kerja .action-column { display: none !important; }
                    #module-tugas-harian button[onclick*="deleteTugas"] { display: none !important; }
                    #module-preparation .action-column { display: none !important; }
                `;
                document.head.appendChild(style);
            }

            // Pembatasan khusus untuk Area Manager: tidak bisa tambah data pada modul tertentu
            if (currentUser && currentUser.role === 'area-manager') {
                ['btnAddJadwal','btnAddTugas','btnAddPrep','btnAddReject'].forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.style.display = 'none';
                });
            }
        }

        // ==================== NAVIGATION ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function showModule(module) {
            currentModule = module;
            document.querySelectorAll('.module-section').forEach(s => s.classList.remove('active'));
            document.getElementById('module-' + module).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            event.target.closest('.sidebar-link')?.classList.add('active');
            
            if (window.innerWidth < 1024) toggleSidebar();
            
            loadModuleData(module);
        }

        function loadModuleData(module) {
            switch(module) {
                case 'dashboard': loadDashboard(); break;
                case 'jadwal-kerja': loadJadwal(); updateSchedulePeriodLabel(); break;
                case 'tugas-harian': loadTugas(); break;
                case 'preparation': loadPreparation(); break;
                // checklist feature replaced by external Google Forms (removed)
                case 'reject': loadReject(); break;
                case 'inventori': loadInventori(); break;
                case 'logbook': loadLogbook(); break;
                case 'feedback': loadFeedback(); break;
                // settings-checklist removed (prefill/settings moved/disabled)
                case 'settings-outlet': loadOutlets(); break;
                case 'settings-users': loadUsers(); break;
                case 'guidelines': /* static, no data loader needed */ break;
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(id) {
            // Blok tambah data untuk Head Office (view only) dan Area Manager pada modul tertentu
            if (isViewOnly) {
                showToast('Mode View Only - Tidak dapat menambah data');
                return;
            }
            if (currentUser && currentUser.role === 'area-manager') {
                const blocked = ['modalJadwal','modalTugas','modalPreparation','modalReject'];
                if (blocked.includes(id)) {
                    showToast('Area Manager tidak dapat menambah data pada modul ini');
                    return;
                }
            }
            if (id === 'modalJadwal') {
                // Default tanggal ke periode berjalan (tgl 21) bila kosong
                const { start } = getSchedulePeriod();
                const input = document.getElementById('jadwalTanggal');
                if (input && !input.value) {
                    input.value = toYMD(start);
                }
            }
            if (id === 'modalTugas') {
                // Isi daftar assignee dari jadwal periode aktif (21 s.d. 20)
                populateAssigneeOptions();
            }
            if (id === 'modalPreparation') {
                // Isi daftar petugas dari Jadwal Kerja periode aktif (21 s.d. 20)
                populatePrepPetugasOptions();
            }
            if (id === 'modalInventori') {
                // Build options nama barang dan set default tanggal
                const sel = document.getElementById('invNama');
                if (sel) {
                    sel.innerHTML = optionsBarang();
                    onInvNamaChange();
                }
                const tMasuk = document.getElementById('invTglMasuk');
                if (tMasuk && !tMasuk.value) tMasuk.value = toYMD(new Date());
            }
            if (id === 'modalOutStock') {
                const sel = document.getElementById('outNama');
                if (sel) {
                    // Hanya tampilkan barang yang ada di inventori outlet aktif
                    const inv = JSON.parse(localStorage.getItem('inventori') || '[]')
                        .filter(i => i.outlet === currentOutlet && Number(i.jumlah) > 0);
                    const uniqueNames = [...new Set(inv.map(i => i.nama))].sort((a,b) => a.localeCompare(b, 'id'));
                    if (uniqueNames.length === 0) {
                        sel.innerHTML = '<option value="">(Tidak ada stok tersedia)</option>';
                    } else {
                        sel.innerHTML = uniqueNames.map(n => `<option value="${n}">${n}</option>`).join('');
                    }
                    onOutNamaChange();
                }
            }
            document.getElementById(id).classList.remove('hidden');
        }
        
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // ==================== DASHBOARD ====================
        function updateDashboardDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dashboardDate').textContent = new Date().toLocaleDateString('id-ID', options);
        }

        function loadDashboard() {
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            const today = new Date();
            const todayKeyStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const todayTugas = tugas.filter(t => t.tanggal === todayKeyStr && t.outlet === currentOutlet);
            const completedTugas = todayTugas.filter(t => t.selesai).length;
            document.getElementById('statTugas').textContent = `${completedTugas}/${todayTugas.length}`;
            document.getElementById('progressTugas').style.width = todayTugas.length ? (completedTugas/todayTugas.length*100)+'%' : '0%';

            // Checklist progress: OK counted, Not OK counted only if corrective action is filled
            const statusMap = JSON.parse(localStorage.getItem('checklistStatus') || '{}');
            const correctiveMap = JSON.parse(localStorage.getItem('checklistCorrective') || '{}');
            const checklistItems = JSON.parse(localStorage.getItem('checklistItems') || '[]');
            const baseKey = `${todayKeyStr}_${currentOutlet}`;
            const keys = [`${baseKey}_pra`, `${baseKey}_during`, `${baseKey}_after`];
            const totalChecklist = checklistItems.filter(i => i.waktu).length;
            let counted = 0;
            keys.forEach(k => {
                const obj = statusMap[k] || {};
                const corr = correctiveMap[k] || {};
                Object.entries(obj).forEach(([id, val]) => {
                    if (val === 'ok') counted++;
                    else if (val === 'not_ok') {
                        const tx = (corr[id] || '').trim();
                        if (tx) counted++;
                    }
                });
            });
            const checklistPercent = totalChecklist ? Math.round(counted/totalChecklist*100) : 0;
            document.getElementById('statChecklist').textContent = checklistPercent + '%';
            document.getElementById('progressChecklist').style.width = checklistPercent + '%';

            const reject = JSON.parse(localStorage.getItem('reject') || '[]');
            const todayReject = reject.filter(r => r.tanggal === todayKeyStr && r.outlet === currentOutlet);
            document.getElementById('statReject').textContent = todayReject.length;

            const feedback = JSON.parse(localStorage.getItem('feedback') || '[]');
            const outletFeedback = feedback.filter(f => f.outlet === currentOutlet);
            const avgRating = outletFeedback.length ? (outletFeedback.reduce((a,b) => a+b.rating, 0)/outletFeedback.length).toFixed(1) : '0.0';
            document.getElementById('statRating').textContent = avgRating;
            
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                starsHtml += `<i class="${i <= Math.round(avgRating) ? 'fas' : 'far'} fa-star"></i>`;
            }
            document.getElementById('starsRating').innerHTML = starsHtml;

            loadRecentActivities();
            loadExpiringItems();

            // Head Office / Area Manager extension
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                loadDashboardHO();
            } else {
                const ho = document.getElementById('hoDashboard');
                if (ho) ho.classList.add('hidden');
            }
        }

        function loadRecentActivities() {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]')
                .filter(a => a.outlet === currentOutlet);
            const container = document.getElementById('recentActivities');
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada aktivitas</p>';
                return;
            }
            container.innerHTML = activities.slice(-5).reverse().map(a => `
                <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 ${a.type === 'tugas' ? 'bg-blue-100 text-blue-600' : a.type === 'checklist' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'} rounded-full flex items-center justify-center">
                        <i class="fas ${a.type === 'tugas' ? 'fa-tasks' : a.type === 'checklist' ? 'fa-check' : 'fa-clock'} text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">${a.message}</p>
                        <p class="text-xs text-gray-500">${a.time}</p>
                    </div>
                </div>
            `).join('');
        }

        function loadExpiringItems() {
            const inventori = JSON.parse(localStorage.getItem('inventori') || '[]');
            const now = new Date();
            const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
            const warningLocal = new Date(todayLocal.getTime() + 7 * 24 * 60 * 60 * 1000);
            const expiring = inventori.filter(i => {
                const expDate = parseLocalDate(i.tglExpired);
                return expDate && expDate <= warningLocal && expDate >= todayLocal && i.outlet === currentOutlet;
            });
            
            const container = document.getElementById('expiringItems');
            if (expiring.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada item mendekati expired</p>';
                return;
            }
            container.innerHTML = expiring.map(i => `
                <div class="flex items-center justify-between p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-800">${i.nama}</p>
                        <p class="text-sm text-gray-500">Batch: ${i.batch} | Qty: ${i.jumlah}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-yellow-600">Exp: ${formatDate(i.tglExpired)}</p>
                    </div>
                </div>
            `).join('');
        }

        // Head Office: Multi-Outlet summary, ranking, alerts
        function loadDashboardHO() {
            const hoWrapper = document.getElementById('hoDashboard');
            if (!hoWrapper) return;
            hoWrapper.classList.remove('hidden');

            const outletsAll = JSON.parse(localStorage.getItem('outlets') || '[]');
            // Limit to selectedOutlets (Admin/HO/AM). If none selected, use allowedOutlets
            const useIds = (selectedOutlets && selectedOutlets.length) ? selectedOutlets : (allowedOutlets || []);
            const outlets = outletsAll.filter(o => useIds.includes(o.id));

            // Update title label
            const titleEl = document.getElementById('hoTitle');
            if (titleEl) {
                if (currentUser.role === 'head-office') titleEl.textContent = 'Ringkasan Multi-Outlet (Head Office)';
                else if (currentUser.role === 'area-manager') titleEl.textContent = 'Ringkasan Multi-Outlet (Area Manager)';
                else titleEl.textContent = 'Ringkasan Multi-Outlet';
            }
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            const feedback = JSON.parse(localStorage.getItem('feedback') || '[]');
            const reject = JSON.parse(localStorage.getItem('reject') || '[]');
            const inventori = JSON.parse(localStorage.getItem('inventori') || '[]');
            const checklistItems = JSON.parse(localStorage.getItem('checklistItems') || '[]').filter(i => i.waktu);
            const statusMap = JSON.parse(localStorage.getItem('checklistStatus') || '{}');
            const correctiveMap = JSON.parse(localStorage.getItem('checklistCorrective') || '{}');

            const today = new Date();
            const todayKeyStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const baseKeys = (outletId) => [`${todayKeyStr}_${outletId}_pra`, `${todayKeyStr}_${outletId}_during`, `${todayKeyStr}_${outletId}_after`];
            const totalChecklist = checklistItems.length;

            // Aggregate tugas (hari ini)
            const tugasToday = tugas.filter(t => t.tanggal === todayKeyStr);
            const tugasDone = tugasToday.filter(t => t.selesai).length;
            document.getElementById('hoStatTugas').textContent = `${tugasDone}/${tugasToday.length}`;
            document.getElementById('hoProgressTugas').style.width = tugasToday.length ? (tugasDone/tugasToday.length*100)+'%' : '0%';

            // Aggregate checklist progress (count OK + not_ok with CAPA)
            let counted = 0; let total = totalChecklist * (outlets.length || 1);
            outlets.forEach(o => {
                baseKeys(o.id).forEach(k => {
                    const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                    Object.entries(obj).forEach(([id, val]) => {
                        if (val === 'ok') counted++;
                        else if (val === 'not_ok') {
                            const tx = (corr[id] || '').trim();
                            if (tx) counted++;
                        }
                    });
                });
            });
            const checklistPercent = total ? Math.round(counted/total*100) : 0;
            document.getElementById('hoStatChecklist').textContent = checklistPercent + '%';
            document.getElementById('hoProgressChecklist').style.width = checklistPercent + '%';

            // Aggregate reject (hari ini)
            const rejectToday = reject.filter(r => r.tanggal === todayKeyStr).length;
            document.getElementById('hoStatReject').textContent = rejectToday;

            // Avg rating seluruh outlet
            const avgRating = feedback.length ? (feedback.reduce((a,b) => a+b.rating, 0)/feedback.length).toFixed(1) : '0.0';
            document.getElementById('hoStatRating').textContent = avgRating;
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) starsHtml += `<i class="${i <= Math.round(avgRating) ? 'fas' : 'far'} fa-star"></i>`;
            document.getElementById('hoStarsRating').innerHTML = starsHtml;

            // Ranking Outlet (berdasar skor gabungan: checklist% 60%, rating 30%, reject -10 per item)
            const outletScores = outlets.map(o => {
                // checklist percent per outlet
                let cCount = 0;
                baseKeys(o.id).forEach(k => {
                    const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                    Object.entries(obj).forEach(([id, val]) => {
                        if (val === 'ok') cCount++;
                        else if (val === 'not_ok') { const tx = (corr[id]||'').trim(); if (tx) cCount++; }
                    });
                });
                const cPct = totalChecklist ? (cCount/totalChecklist*100) : 0;
                // rating per outlet
                const fb = feedback.filter(f => f.outlet === o.id);
                const rAvg = fb.length ? (fb.reduce((a,b)=>a+b.rating,0)/fb.length) : 0;
                // reject today per outlet
                const rj = reject.filter(r => r.outlet === o.id && r.tanggal === todayKeyStr).length;
                const score = (0.6*cPct) + (0.3*rAvg*20) - (10*rj);
                return { id: o.id, nama: o.nama, cPct: Math.round(cPct), rAvg: rAvg.toFixed(1), rj, score };
            }).sort((a,b) => b.score - a.score);

            const rankBody = document.getElementById('hoRankingBody');
            rankBody.innerHTML = outletScores.slice(0, 10).map(r => `
                <tr>
                    <td class="px-4 py-2 text-sm text-gray-900">${r.nama}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${r.cPct}%</td>
                    <td class="px-4 py-2 text-sm text-red-600">${r.rj}</td>
                    <td class="px-4 py-2 text-sm text-yellow-600">${r.rAvg}</td>
                </tr>
            `).join('');

            // Alerts: checklist 0% (belum diisi), stok expired, feedback negatif hari ini
            const alerts = [];
            // checklist 0%
            outlets.forEach(o => {
                let cCount = 0;
                baseKeys(o.id).forEach(k => {
                    const obj = statusMap[k] || {}; const corr = correctiveMap[k] || {};
                    Object.entries(obj).forEach(([id, val]) => {
                        if (val === 'ok') cCount++;
                        else if (val === 'not_ok') { const tx = (corr[id]||'').trim(); if (tx) cCount++; }
                    });
                });
                if (cCount === 0 && totalChecklist > 0) alerts.push({ type:'checklist', msg:`Checklist hari ini belum diisi di ${o.nama}` });
            });
            // stok expired
            const nowLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 12,0,0,0);
            inventori.forEach(i => {
                const exp = parseLocalDate(i.tglExpired);
                if (exp && exp < nowLocal) alerts.push({ type: 'expired', msg:`Stok EXP: ${i.nama} (Outlet: ${ (outlets.find(o=>o.id===i.outlet)||{}).nama || i.outlet })`});
            });
            // feedback negatif hari ini
            feedback.forEach(f => {
                const neg = (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas';
                if (neg && f.tanggal === todayKeyStr) {
                    alerts.push({ type:'feedback', msg:`Feedback negatif di ${(outlets.find(o=>o.id===f.outlet)||{}).nama || f.outlet}` });
                }
            });

            const alertWrap = document.getElementById('hoAlertsList');
            alertWrap.innerHTML = alerts.length ? alerts.slice(0, 10).map(a => {
                const icon = a.type==='checklist' ? 'fa-clipboard-check text-orange-500' : a.type==='expired' ? 'fa-exclamation-triangle text-red-500' : 'fa-comment-dots text-pink-500';
                const bg = a.type==='checklist' ? 'bg-orange-50 border-orange-200' : a.type==='expired' ? 'bg-red-50 border-red-200' : 'bg-pink-50 border-pink-200';
                return `<div class="p-3 border ${bg} rounded-lg text-sm flex items-start gap-2">
                    <i class="fas ${icon} mt-0.5"></i>
                    <span class="text-gray-700">${a.msg}</span>
                </div>`;
            }).join('') : '<p class="text-gray-500 text-center py-4">Tidak ada alert</p>';
        }

        // ==================== JADWAL KERJA ====================
        function getSchedulePeriod(offset = schedulePeriodOffset) {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            let day = now.getDate();

            // Tentukan anchor periode berdasarkan tanggal berjalan
            // Periode berjalan dimulai pada 21 bulan ini bila hari >=21, selain itu 21 bulan lalu
            let startMonth = month;
            let startYear = year;
            if (day < 21) {
                startMonth -= 1;
                if (startMonth < 0) { startMonth = 11; startYear -= 1; }
            }
            // Geser sesuai offset (tiap offset = 1 periode = 1 bulan)
            startMonth += offset;
            while (startMonth < 0) { startMonth += 12; startYear -= 1; }
            while (startMonth > 11) { startMonth -= 12; startYear += 1; }

            const start = new Date(startYear, startMonth, 21);
            // end = tgl 20 bulan berikutnya
            let endMonth = startMonth + 1;
            let endYear = startYear;
            if (endMonth > 11) { endMonth = 0; endYear += 1; }
            const end = new Date(endYear, endMonth, 20, 23, 59, 59, 999);
            return { start, end };
        }

        function updateSchedulePeriodLabel() {
            const label = document.getElementById('labelSchedulePeriod');
            const select = document.getElementById('periodSelect');
            if (!label) return;
            const { start, end } = getSchedulePeriod();
            const fmt = (d) => d.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            label.textContent = `${fmt(start)} s.d. ${fmt(end)}`;

            // Build/select period dropdown options (last 12, current, next 12)
            if (select) {
                const buildKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                const currentAnchor = getSchedulePeriod(0).start; // start of current period
                const options = [];
                for (let i = -12; i <= 12; i++) {
                    const p = getSchedulePeriod(i);
                    options.push({
                        key: buildKey(p.start),
                        label: `${p.start.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })} (21 s.d. 20)` ,
                        offset: i
                    });
                }
                const currentKey = buildKey(start);
                // Only rebuild if different size or missing current key
                if (select.options.length !== options.length || !Array.from(select.options).some(o => o.value === currentKey)) {
                    select.innerHTML = options.map(o => `<option value="${o.offset}">${o.label}</option>`).join('');
                }
                // Set selected option to current offset
                select.value = String(schedulePeriodOffset);
            }
        }

        function changeSchedulePeriod(delta) {
            schedulePeriodOffset += delta;
            updateSchedulePeriodLabel();
            loadJadwal();
        }

        function onPeriodSelectChange() {
            const select = document.getElementById('periodSelect');
            if (!select) return;
            const newOffset = parseInt(select.value, 10) || 0;
            schedulePeriodOffset = newOffset;
            updateSchedulePeriodLabel();
            loadJadwal();
        }

        function loadJadwal() {
            const all = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const shift = (document.getElementById('shiftFilter')?.value || '').trim();
            const { start, end } = getSchedulePeriod();

            // Filter outlet + periode 21-20 + optional shift (use local date parsing)
            const jadwal = all.filter(j => {
                if (j.outlet !== currentOutlet || !j.tanggal) return false;
                const dt = parseLocalDate(j.tanggal);
                return dt >= start && dt <= end && (!shift || j.shift === shift);
            });

            // Simpan mapping index global untuk aksi hapus yang akurat
            const tbody = document.getElementById('jadwalTable');
            if (!window.__jadwalIndexMap) window.__jadwalIndexMap = [];
            window.__jadwalIndexMap = jadwal.map(j => all.findIndex(x => x === j));

            if (jadwal.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Belum ada jadwal pada periode ini</td></tr>';
                return;
            }
            tbody.innerHTML = jadwal.map((j, idx) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${j.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${formatDate(j.tanggal)}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${j.shift === 'pagi' ? 'bg-yellow-100 text-yellow-700' : j.shift === 'siang' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">${j.shift.charAt(0).toUpperCase() + j.shift.slice(1)}</span></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${j.status === 'hadir' ? 'bg-green-100 text-green-700' : j.status === 'izin' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'}">${j.status || 'Terjadwal'}</span></td>
                    <td class="px-6 py-4 action-column"><button onclick="deleteJadwal(${idx}, true)" class="text-red-600 hover:text-red-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function saveJadwal() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah jadwal');
                return;
            }
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            jadwal.push({
                outlet: currentOutlet,
                nama: document.getElementById('jadwalNama').value,
                tanggal: document.getElementById('jadwalTanggal').value,
                shift: document.getElementById('jadwalShift').value,
                status: 'terjadwal'
            });
            localStorage.setItem('jadwal', JSON.stringify(jadwal));
            closeModal('modalJadwal');
            updateSchedulePeriodLabel();
            loadJadwal();
            addActivity('jadwal', 'Jadwal baru ditambahkan');
            showToast('Jadwal berhasil disimpan!');
            clearForm(['jadwalNama', 'jadwalTanggal']);
        }

        function deleteJadwal(idx, useMap = false) {
            if (isViewOnly) return;
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            let deleteIndex = idx;
            if (useMap && Array.isArray(window.__jadwalIndexMap)) {
                deleteIndex = window.__jadwalIndexMap[idx];
            }
            if (deleteIndex > -1) {
                jadwal.splice(deleteIndex, 1);
                localStorage.setItem('jadwal', JSON.stringify(jadwal));
                loadJadwal();
            }
        }

        async function exportJadwalPDF() {
            const all = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);
            const shift = (document.getElementById('shiftFilter')?.value || '').trim();
            const { start, end } = getSchedulePeriod();
            const data = all.filter(j => {
                if (j.outlet !== currentOutlet || !j.tanggal) return false;
                const dt = parseLocalDate(j.tanggal);
                return dt >= start && dt <= end && (!shift || j.shift === shift);
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            // Header
            doc.setFontSize(14);
            doc.text(`Jadwal Kerja - ${outlet ? outlet.nama : 'Outlet'}`, 40, 40);
            const periodText = `${start.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} s.d. ${end.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`;
            doc.setFontSize(10);
            doc.text(`Periode: ${periodText}${shift ? ` | Shift: ${shift}` : ''}`, 40, 58);

            // Table
            const rows = data.sort((a,b) => parseLocalDate(a.tanggal) - parseLocalDate(b.tanggal)).map(j => [
                j.nama,
                parseLocalDate(j.tanggal).toLocaleDateString('id-ID'),
                j.shift.charAt(0).toUpperCase() + j.shift.slice(1),
                (j.status || 'Terjadwal').toUpperCase()
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Nama Staff', 'Tanggal', 'Shift', 'Status']],
                body: rows.length ? rows : [['-', '-', '-', '-']],
                styles: { fontSize: 9 },
                headStyles: { fillColor: [30, 58, 138] },
            });

            doc.save(`Jadwal_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(start)}_${toYMD(end)}.pdf`);
        }

        // ===== Export PDF: Tugas Harian =====
        async function exportTugasPDF() {
            const tugas = (JSON.parse(localStorage.getItem('tugas') || '[]') || []).filter(t => t.outlet === currentOutlet);
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            doc.setFontSize(14);
            doc.text(`Tugas Harian - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 40, 58);

            const rows = tugas.map(t => [
                formatDate(t.tanggal || toYMD(new Date())),
                t.judul || '-',
                (t.deskripsi || '').replace(/\s+/g,' ').trim(),
                (t.prioritas || '-').toUpperCase(),
                t.assign || '-',
                t.selesai ? 'SELESAI' : 'BELUM'
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Tugas', 'Deskripsi', 'Prioritas', 'Ditugaskan kepada', 'Status']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-', '-']],
                styles: { fontSize: 9, cellWidth: 'wrap' },
                headStyles: { fillColor: [37, 99, 235] },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 120 },
                    2: { cellWidth: 180 },
                    3: { cellWidth: 70 },
                    4: { cellWidth: 120 },
                    5: { cellWidth: 60 }
                }
            });

            doc.save(`Tugas_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(new Date())}.pdf`);
        }

        // ===== Export PDF: Preparation =====
        async function exportPreparationPDF() {
            const prep = (JSON.parse(localStorage.getItem('preparation') || '[]') || []).filter(p => p.outlet === currentOutlet);
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            doc.setFontSize(14);
            doc.text(`Preparation Bahan Baku - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 40, 58);

            const rows = prep.map(p => [
                formatDate(p.tanggal || toYMD(new Date())),
                p.nama || '-',
                p.jumlah || '-',
                p.petugas || p.pic || '-',
                p.selesai ? 'SELESAI' : 'PROSES'
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Bahan Baku', 'Jumlah', 'Petugas', 'Status']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-']],
                styles: { fontSize: 9 },
                headStyles: { fillColor: [5, 150, 105] },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 160 },
                    2: { cellWidth: 80 },
                    3: { cellWidth: 140 },
                    4: { cellWidth: 80 }
                }
            });

            doc.save(`Preparation_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(new Date())}.pdf`);
        }

        // ==================== TUGAS HARIAN ====================
        function loadTugas() {
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]').filter(t => t.outlet === currentOutlet);
            const container = document.getElementById('tugasContainer');
            if (tugas.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-gray-500">Belum ada tugas</div>';
                return;
            }
            const cannotToggle = isViewOnly || (currentUser && currentUser.role === 'outlet');
            container.innerHTML = tugas.map((t, idx) => `
                <div class="bg-white rounded-xl p-4 shadow-sm flex items-start gap-4">
                    <input type="checkbox" ${t.selesai ? 'checked' : ''} ${cannotToggle ? 'disabled' : ''} onchange="toggleTugas(${idx})" title="${cannotToggle ? 'Anda tidak dapat checklist tugas harian' : ''}" class="w-5 h-5 mt-1 rounded border-gray-300 text-blue-600 ${cannotToggle ? 'pointer-events-none opacity-60' : ''}">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h4 class="font-medium ${t.selesai ? 'line-through text-gray-400' : 'text-gray-800'}">${t.judul}</h4>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full ${t.prioritas === 'tinggi' ? 'bg-red-100 text-red-700' : t.prioritas === 'sedang' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${t.prioritas}</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${t.deskripsi}</p>
                        <p class="text-xs text-gray-400 mt-2"><i class="fas fa-user mr-1"></i>${t.assign}</p>
                    </div>
                    <button onclick="deleteTugas(${idx})" class="text-red-500 hover:text-red-700 ${isViewOnly ? 'hidden' : ''}"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function saveTugas() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah tugas');
                return;
            }
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            const judulVal = document.getElementById('tugasJudul').value;
            const assignVal = document.getElementById('tugasAssign').value;
            tugas.push({
                outlet: currentOutlet,
                judul: judulVal,
                deskripsi: document.getElementById('tugasDeskripsi').value,
                prioritas: document.getElementById('tugasPrioritas').value,
                assign: assignVal,
                tanggal: toYMD(new Date()),
                selesai: false
            });
            localStorage.setItem('tugas', JSON.stringify(tugas));
            closeModal('modalTugas');
            loadTugas();
            addActivity('tugas', 'Tugas baru: ' + judulVal + (assignVal ? ' → ' + assignVal : ''));
            showToast('Tugas berhasil ditambahkan!');
            clearForm(['tugasDeskripsi']);
        }

        function toggleTugas(idx) {
            // Staff Outlet dan Head Office (view only) tidak boleh checklist tugas harian
            if (isViewOnly || (currentUser && currentUser.role === 'outlet')) {
                showToast('Anda tidak diizinkan melakukan checklist tugas harian.');
                // Re-render untuk memastikan UI tetap konsisten
                loadTugas();
                return;
            }
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            tugas[idx].selesai = !tugas[idx].selesai;
            localStorage.setItem('tugas', JSON.stringify(tugas));
            loadTugas();
            loadDashboard();
        }

        function deleteTugas(idx) {
            if (isViewOnly) return;
            const tugas = JSON.parse(localStorage.getItem('tugas') || '[]');
            tugas.splice(idx, 1);
            localStorage.setItem('tugas', JSON.stringify(tugas));
            loadTugas();
        }

        // ==================== PREPARATION ====================
        function loadPreparation() {
            const prep = JSON.parse(localStorage.getItem('preparation') || '[]').filter(p => p.outlet === currentOutlet);
            const tbody = document.getElementById('preparationTable');
            if (prep.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Belum ada data preparation</td></tr>';
                return;
            }
            tbody.innerHTML = prep.map((p, idx) => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900">${p.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${p.jumlah}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${p.petugas || p.pic || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${p.selesai ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${p.selesai ? 'Selesai' : 'Proses'}</span></td>
                    <td class="px-6 py-4 flex gap-2 action-column">
                        <button onclick="togglePreparation(${idx})" class="text-green-600 hover:text-green-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-check"></i></button>
                        <button onclick="deletePreparation(${idx})" class="text-red-600 hover:text-red-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function savePreparation() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah preparation');
                return;
            }
            const prep = JSON.parse(localStorage.getItem('preparation') || '[]');
            prep.push({
                outlet: currentOutlet,
                nama: document.getElementById('prepNama').value,
                jumlah: document.getElementById('prepJumlah').value,
                petugas: document.getElementById('prepPetugas').value,
                selesai: false,
                tanggal: toYMD(new Date())
            });
            localStorage.setItem('preparation', JSON.stringify(prep));
            closeModal('modalPreparation');
            loadPreparation();
            showToast('Preparation berhasil ditambahkan!');
            clearForm(['prepJumlah', 'prepPetugas']);
        }

        function togglePreparation(idx) {
            if (isViewOnly) return;
            const prep = JSON.parse(localStorage.getItem('preparation') || '[]');
            prep[idx].selesai = !prep[idx].selesai;
            localStorage.setItem('preparation', JSON.stringify(prep));
            loadPreparation();
        }

        function deletePreparation(idx) {
            if (isViewOnly) return;
            const prep = JSON.parse(localStorage.getItem('preparation') || '[]');
            prep.splice(idx, 1);
            localStorage.setItem('preparation', JSON.stringify(prep));
            loadPreparation();
        }

        // Checklist UI removed — related handlers deprecated

        // ==================== REJECT ====================
        function loadReject() {
            const all = JSON.parse(localStorage.getItem('reject') || '[]');
            const dateFilter = (document.getElementById('rejectDateFilter')?.value || '').trim();
            const catFilter = (document.getElementById('rejectCategoryFilter')?.value || '').trim();
            const reject = all.filter(r => r.outlet === currentOutlet)
                .filter(r => !dateFilter || r.tanggal === dateFilter)
                .filter(r => !catFilter || r.kategori === catFilter);
            const tbody = document.getElementById('rejectTable');
            if (reject.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data reject</td></tr>';
                return;
            }
            tbody.innerHTML = reject.map(r => `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-500">${formatDate(r.tanggal)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${r.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.jumlah}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">${r.kategori}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.alasan}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${r.pic}</td>
                </tr>
            `).join('');
        }

        function saveReject() {
            if (currentUser && (currentUser.role === 'head-office' || currentUser.role === 'area-manager')) {
                showToast('Anda tidak diizinkan menambah catatan reject');
                return;
            }
            const reject = JSON.parse(localStorage.getItem('reject') || '[]');
            reject.push({
                outlet: currentOutlet,
                tanggal: toYMD(new Date()),
                nama: document.getElementById('rejectNama').value,
                jumlah: document.getElementById('rejectJumlah').value,
                kategori: document.getElementById('rejectKategori').value,
                alasan: document.getElementById('rejectAlasan').value,
                pic: currentUser.nama
            });
            localStorage.setItem('reject', JSON.stringify(reject));
            closeModal('modalReject');
            loadReject();
            loadDashboard();
            showToast('Data reject berhasil dicatat!');
            clearForm(['rejectJumlah', 'rejectAlasan']);
        }

        async function exportRejectPDF() {
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);
            const all = JSON.parse(localStorage.getItem('reject') || '[]');
            const dateFilter = (document.getElementById('rejectDateFilter')?.value || '').trim();
            const catFilter = (document.getElementById('rejectCategoryFilter')?.value || '').trim();
            const data = all.filter(r => r.outlet === currentOutlet)
                .filter(r => !dateFilter || r.tanggal === dateFilter)
                .filter(r => !catFilter || r.kategori === catFilter);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            doc.setFontSize(14);
            doc.text(`Catatan Barang Reject - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            const sub = `Tanggal: ${dateFilter || 'Semua'} | Kategori: ${catFilter || 'Semua'}`;
            doc.text(sub, 40, 58);

            const rows = data.map(r => [
                formatDate(r.tanggal),
                r.nama,
                r.jumlah,
                r.kategori,
                r.alasan,
                r.pic
            ]);

            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Nama Barang', 'Jumlah', 'Kategori', 'Alasan', 'PIC']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-', '-']],
                styles: { fontSize: 9 },
                headStyles: { fillColor: [220, 38, 38] }
            });

            const fileDate = dateFilter || toYMD(new Date());
            doc.save(`Reject_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${fileDate}${catFilter ? '_' + catFilter : ''}.pdf`);
        }

        // ==================== INVENTORI ====================
        const barangMaster = [
            { nama: 'Ayam Buncis', satuan: 'Kg' },
            { nama: 'Ayam Kuning', satuan: 'Pcs' },
            { nama: 'Ayam Kuning Negri', satuan: 'Pcs' },
            { nama: 'Ayam Marinade', satuan: 'Kg' },
            { nama: 'Bawang Goreng', satuan: 'Kg' },
            { nama: 'Biang Bumbu Otak-Otak', satuan: 'Kg' },
            { nama: 'Biang Bumbu Siomay', satuan: 'Kg' },
            { nama: 'Biang Sambal', satuan: 'Kg' },
            { nama: 'Biang Sayur Asem', satuan: 'Kg' },
            { nama: 'Biang Soto Ayam', satuan: 'Kg' },
            { nama: 'Boneless Marinade', satuan: 'Kg' },
            { nama: 'Boneless Tim', satuan: 'Kg' },
            { nama: 'Bumbu Asinan', satuan: 'Prs' },
            { nama: 'Bumbu Kaldu Rasa ( B )', satuan: 'Prs' },
            { nama: 'Bumbu Mie Ayam', satuan: 'Kg' },
            { nama: 'Bumbu Mie Jawa', satuan: 'Kg' },
            { nama: 'Bumbu Nasi Goreng', satuan: 'Kg' },
            { nama: 'Bumbu Tahu', satuan: 'Prs' },
            { nama: 'Buntut Nasi Goreng', satuan: 'Prs' },
            { nama: 'Buntut Sop', satuan: 'Prs' },
            { nama: 'Durian', satuan: 'Prs' },
            { nama: 'Ebi Matang', satuan: 'Kg' },
            { nama: 'Gula Rempah', satuan: 'Prs' },
            { nama: 'Iga Sop', satuan: 'Prs' },
            { nama: 'Kacang Goreng', satuan: 'Kg' },
            { nama: 'Kecap Mie Ayam', satuan: 'Kg' },
            { nama: 'Kecap Oplos', satuan: 'Kg' },
            { nama: 'Kecap Oplos ( B )', satuan: 'Kg' },
            { nama: 'Kelapa Kopyor', satuan: 'Prs' },
            { nama: 'Kerongkong Ayam', satuan: 'Kg' },
            { nama: 'Kuah Cah', satuan: 'Kg' },
            { nama: 'Kuah Cap Cay', satuan: 'Prs' },
            { nama: 'Kuah Pempek', satuan: 'Kg' },
            { nama: 'Minyak Mie Ayam', satuan: 'Kg' },
            { nama: 'Otak-Otak Bakar', satuan: 'Pcs' },
            { nama: 'PKS', satuan: 'Pcs' },
            { nama: 'Pempek Keju', satuan: 'Pcs' },
            { nama: 'Pempek Lenjeran', satuan: 'Pcs' },
            { nama: 'Pletok Set', satuan: 'Set' },
            { nama: 'Risoles', satuan: 'Pcs' },
            { nama: 'Sambal Hijau', satuan: 'Kg' },
            { nama: 'Saos Kungpao', satuan: 'kg' },
            { nama: 'Saos Telor Asin', satuan: 'Kg' },
            { nama: 'Sapi Marinade', satuan: 'Kg' },
            { nama: 'Siomay', satuan: 'Pcs' },
            { nama: 'SKT', satuan: 'Pcs' },
            { nama: 'SMU', satuan: 'Pcs' },
            { nama: 'Sirsak', satuan: 'Prs' },
            { nama: 'Soto Betawi', satuan: 'Prs' },
            { nama: 'Stroberi', satuan: 'Prs' },
            { nama: 'Tepung Premix', satuan: 'Kg' },
            { nama: 'Terasi Matang', satuan: 'Grm' },
            { nama: 'Tongseng Ayam', satuan: 'Prs' },
            { nama: 'Tongseng Sop', satuan: 'Prs' },
            { nama: 'Kentang', satuan: 'kg' },
            { nama: 'Singkong', satuan: 'Kg' },
            { nama: 'Mix Berries', satuan: 'Kg' }
        ];

        function optionsBarang() {
            return barangMaster.map(b => `<option value="${b.nama}">${b.nama}</option>`).join('');
        }
        function satuanOf(nama) {
            const f = barangMaster.find(b => b.nama === nama);
            return f ? f.satuan : '';
        }
        function onInvNamaChange() {
            const nama = document.getElementById('invNama').value;
            document.getElementById('invSatuanLabel').textContent = satuanOf(nama) ? `(${satuanOf(nama)})` : '';
        }
        function onOutNamaChange() {
            const nama = document.getElementById('outNama').value;
            document.getElementById('outSatuanLabel').textContent = satuanOf(nama) ? `(${satuanOf(nama)})` : '';
            
            // Tampilkan info batch yang tersedia untuk barang ini (urutan FEFO)
            const batchInfo = document.getElementById('outBatchInfo');
            const batchTable = document.getElementById('outBatchTable');
            const totalLabel = document.getElementById('outTotalTersedia');
            const preview = document.getElementById('outPreview');
            
            if (!nama) {
                batchInfo.classList.add('hidden');
                preview.classList.add('hidden');
                totalLabel.textContent = '0';
                return;
            }
            
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]')
                .filter(i => i.outlet === currentOutlet && i.nama === nama && Number(i.jumlah) > 0)
                .sort((a, b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired)); // FEFO
            
            if (inv.length === 0) {
                batchInfo.classList.add('hidden');
                preview.classList.add('hidden');
                totalLabel.textContent = '0';
                return;
            }
            
            batchInfo.classList.remove('hidden');
            const total = inv.reduce((sum, i) => sum + Number(i.jumlah || 0), 0);
            totalLabel.textContent = `${total} ${satuanOf(nama)}`;
            
            batchTable.innerHTML = inv.map((item, idx) => {
                const now = new Date();
                const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
                const expDate = parseLocalDate(item.tglExpired);
                const isExpired = expDate && expDate < todayLocal;
                const warningLocal = new Date(todayLocal.getTime() + 7 * 24 * 60 * 60 * 1000);
                const isWarning = expDate && expDate <= warningLocal && !isExpired;
                
                let rowClass = '';
                if (isExpired) rowClass = 'bg-red-100 text-red-700';
                else if (isWarning) rowClass = 'bg-yellow-100 text-yellow-700';
                else if (idx === 0) rowClass = 'bg-green-100 text-green-700';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-2 py-1 font-medium">${idx === 0 ? '<i class="fas fa-arrow-right mr-1"></i>1 (Prioritas)' : idx + 1}</td>
                        <td class="px-2 py-1">${formatDate(item.tglProduksi)}</td>
                        <td class="px-2 py-1">${formatDate(item.tglExpired)}${isExpired ? ' <span class="text-red-600 font-bold">(EXPIRED!)</span>' : ''}</td>
                        <td class="px-2 py-1 text-right font-medium">${item.jumlah}</td>
                    </tr>
                `;
            }).join('');
            
            // Reset preview dan input jumlah
            preview.classList.add('hidden');
            document.getElementById('outJumlah').value = '';
        }
        
        function previewOutStock() {
            const nama = document.getElementById('outNama').value;
            const qty = Number(document.getElementById('outJumlah').value || 0);
            const preview = document.getElementById('outPreview');
            const previewContent = document.getElementById('outPreviewContent');
            
            if (!nama || qty <= 0) {
                preview.classList.add('hidden');
                return;
            }
            
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]')
                .filter(i => i.outlet === currentOutlet && i.nama === nama && Number(i.jumlah) > 0)
                .sort((a, b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired)); // FEFO
            
            if (inv.length === 0) {
                preview.classList.add('hidden');
                return;
            }
            
            let remaining = qty;
            const usage = [];
            
            for (const item of inv) {
                if (remaining <= 0) break;
                const take = Math.min(Number(item.jumlah || 0), remaining);
                if (take > 0) {
                    usage.push({
                        tglProduksi: item.tglProduksi,
                        tglExpired: item.tglExpired,
                        batch: item.batch,
                        take: take,
                        sisa: Number(item.jumlah) - take
                    });
                    remaining -= take;
                }
            }
            
            if (usage.length === 0) {
                preview.classList.add('hidden');
                return;
            }
            
            preview.classList.remove('hidden');
            
            let html = '<div class="space-y-2">';
            usage.forEach((u, idx) => {
                html += `
                    <div class="flex items-center justify-between p-2 bg-white rounded border ${idx === 0 ? 'border-green-400' : 'border-gray-200'}">
                        <div>
                            <p class="font-medium text-gray-800">
                                <i class="fas fa-box text-green-500 mr-1"></i>
                                Batch: ${u.batch || '-'}
                            </p>
                            <p class="text-xs text-gray-500">
                                Produksi: ${formatDate(u.tglProduksi)} | Exp: ${formatDate(u.tglExpired)}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-red-600">-${u.take}</p>
                            <p class="text-xs text-gray-500">Sisa: ${u.sisa}</p>
                        </div>
                    </div>
                `;
            });
            
            if (remaining > 0) {
                html += `
                    <div class="p-2 bg-red-100 border border-red-300 rounded text-red-700 text-sm">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Stok tidak cukup! Kekurangan: <strong>${remaining} ${satuanOf(nama)}</strong>
                    </div>
                `;
            } else {
                const totalTake = usage.reduce((sum, u) => sum + u.take, 0);
                html += `
                    <div class="p-2 bg-blue-100 border border-blue-300 rounded text-blue-700 text-sm">
                        <i class="fas fa-check-circle mr-1"></i>
                        Total keluar: <strong>${totalTake} ${satuanOf(nama)}</strong> dari ${usage.length} batch
                    </div>
                `;
            }
            html += '</div>';
            
            previewContent.innerHTML = html;
        }

        function renderInventorySummaries(inv) {
            // Rekap Saldo per (nama, tglProduksi)
            const saldoMap = new Map();
            inv.forEach(i => {
                const key = `${i.nama}__${i.tglProduksi || '-'}`;
                const prev = saldoMap.get(key) || 0;
                saldoMap.set(key, prev + Number(i.jumlah || 0));
            });
            const saldoRows = Array.from(saldoMap.entries())
                .map(([key, qty]) => {
                    const [nama, tglProd] = key.split('__');
                    return { nama, tglProduksi: tglProd, qty };
                })
                .sort((a,b) => a.nama.localeCompare(b.nama,'id') || (parseLocalDate(a.tglProduksi) - parseLocalDate(b.tglProduksi)));
            const saldoBody = document.getElementById('invSaldoBody');
            if (saldoBody) {
                saldoBody.innerHTML = saldoRows.length ? saldoRows.map(r => `
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">${r.nama}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${formatDate(r.tglProduksi)}</td>
                        <td class="px-6 py-3 text-sm text-gray-700">${r.qty}</td>
                    </tr>
                `).join('') : '<tr><td colspan="3" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
            }

            // Rekap Jumlah per nama
            const jumlahMap = new Map();
            inv.forEach(i => {
                const prev = jumlahMap.get(i.nama) || 0;
                jumlahMap.set(i.nama, prev + Number(i.jumlah || 0));
            });
            const jumlahRows = Array.from(jumlahMap.entries())
                .map(([nama, qty]) => ({ nama, qty }))
                .sort((a,b) => a.nama.localeCompare(b.nama,'id'));
            const jumlahBody = document.getElementById('invJumlahBody');
            if (jumlahBody) {
                jumlahBody.innerHTML = jumlahRows.length ? jumlahRows.map(r => `
                    <tr>
                        <td class="px-6 py-3 text-sm text-gray-900">${r.nama}</td>
                        <td class="px-6 py-3 text-sm text-gray-700">${r.qty}</td>
                    </tr>
                `).join('') : '<tr><td colspan="2" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
            }
        }

        function loadOutStockHistory() {
            const tbody = document.getElementById('outStockTable');
            if (!tbody) return;
            const logs = (JSON.parse(localStorage.getItem('outStockLogs') || '[]') || []).filter(l => l.outlet === currentOutlet);
            if (!logs.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-6 text-center text-gray-500">Tidak ada data</td></tr>';
                return;
            }
            const rows = logs.slice().reverse().map(l => `
                <tr>
                    <td class="px-6 py-3 text-sm text-gray-500">${formatDate(l.tanggal)}</td>
                    <td class="px-6 py-3 text-sm text-gray-900">${l.nama}</td>
                    <td class="px-6 py-3 text-sm text-gray-700">${l.jumlah}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${l.satuan || ''}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${l.pic || '-'}</td>
                    <td class="px-6 py-3 text-sm text-gray-500">${l.ket || '-'}</td>
                </tr>
            `).join('');
            tbody.innerHTML = rows;
        }

        function loadInventori() {
            const allInv = JSON.parse(localStorage.getItem('inventori') || '[]').filter(i => i.outlet === currentOutlet);
            const filterNama = (document.getElementById('invFilterNama')?.value || '').trim();
            
            // Populate filter dropdown dengan nama barang unik
            const filterSelect = document.getElementById('invFilterNama');
            if (filterSelect) {
                const uniqueNames = [...new Set(allInv.map(i => i.nama))].sort((a,b) => a.localeCompare(b, 'id'));
                const currentVal = filterSelect.value;
                filterSelect.innerHTML = '<option value="">Semua Barang</option>' + uniqueNames.map(n => `<option value="${n}" ${n === currentVal ? 'selected' : ''}>${n}</option>`).join('');
            }
            
            // Apply filter
            const inv = filterNama ? allInv.filter(i => i.nama === filterNama) : allInv;
            
            const now = new Date();
            const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12, 0, 0, 0);
            const warningLocal = new Date(todayLocal.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            // Hitung status dari seluruh inventori (bukan yang difilter)
            let aman = 0, warning = 0, expired = 0;
            allInv.forEach(i => {
                const expDate = parseLocalDate(i.tglExpired);
                if (!expDate) return;
                if (expDate < todayLocal) expired++;
                else if (expDate <= warningLocal) warning++;
                else aman++;
            });
            
            document.getElementById('stockAman').textContent = aman;
            document.getElementById('stockWarning').textContent = warning;
            document.getElementById('stockExpired').textContent = expired;
            
            const tbody = document.getElementById('inventoriTable');
            if (inv.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500">Belum ada data inventori' + (filterNama ? ' untuk filter ini' : '') + '</td></tr>';
                // Tetap render ringkasan kosong dan riwayat out stock
                renderInventorySummaries(allInv);
                loadOutStockHistory();
                return;
            }
            
            inv.sort((a, b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired));
            
            // Bangun mapping index global untuk aksi hapus yang akurat
            const globalIndexMap = inv.map(item => {
                const allData = JSON.parse(localStorage.getItem('inventori') || '[]');
                return allData.findIndex(x => x.outlet === item.outlet && x.nama === item.nama && x.batch === item.batch && x.tglMasuk === item.tglMasuk && x.tglExpired === item.tglExpired);
            });
            
            tbody.innerHTML = inv.map((i, idx) => {
                const expDate = parseLocalDate(i.tglExpired);
                let status = 'Aman', statusClass = 'bg-green-100 text-green-700';
                if (expDate < todayLocal) { status = 'Expired'; statusClass = 'bg-red-100 text-red-700'; }
                else if (expDate <= warningLocal) { status = 'Warning'; statusClass = 'bg-yellow-100 text-yellow-700'; }
                return `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${i.nama}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.satuan || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.batch}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${i.jumlah}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatDate(i.tglProduksi)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatDate(i.tglMasuk)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${formatDate(i.tglExpired)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${status}</span></td>
                        <td class="px-6 py-4 action-column"><button onclick="deleteInventori(${globalIndexMap[idx]})" class="text-red-600 hover:text-red-800 ${isViewOnly ? 'btn-disabled' : ''}"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            }).join('');

            // Render ringkasan saldo & jumlah (dari seluruh data, bukan yang difilter)
            renderInventorySummaries(allInv);
            // Render riwayat out stock
            loadOutStockHistory();
        }

        function saveInventori() {
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]');
            const nama = document.getElementById('invNama').value;
            inv.push({
                outlet: currentOutlet,
                nama: nama,
                satuan: satuanOf(nama),
                batch: document.getElementById('invBatch').value,
                jumlah: Number(document.getElementById('invJumlah').value || 0),
                tglProduksi: document.getElementById('invTglProduksi').value || '',
                tglMasuk: document.getElementById('invTglMasuk').value,
                tglExpired: document.getElementById('invTglExpired').value
            });
            localStorage.setItem('inventori', JSON.stringify(inv));
            closeModal('modalInventori');
            loadInventori();
            loadDashboard();
            showToast('In Stock berhasil ditambahkan!');
            clearForm(['invBatch', 'invJumlah', 'invTglProduksi', 'invTglMasuk', 'invTglExpired']);
        }

        function saveOutStock() {
            if (isViewOnly) { showToast('Mode View Only'); return; }
            const nama = document.getElementById('outNama').value;
            let qty = Number(document.getElementById('outJumlah').value || 0);
            if (!nama || qty <= 0) { showToast('Isi nama dan jumlah yang benar'); return; }
            let inv = JSON.parse(localStorage.getItem('inventori') || '[]');
            const list = inv.filter(i => i.outlet === currentOutlet && i.nama === nama).sort((a,b) => parseLocalDate(a.tglExpired) - parseLocalDate(b.tglExpired));
            let remaining = qty;
            for (const item of list) {
                if (remaining <= 0) break;
                const take = Math.min(Number(item.jumlah || 0), remaining);
                item.jumlah = Number(item.jumlah || 0) - take;
                remaining -= take;
            }
            // Hapus batch yang jumlahnya 0
            inv = inv.filter(i => !(i.outlet === currentOutlet && i.nama === nama && Number(i.jumlah) === 0));
            localStorage.setItem('inventori', JSON.stringify(inv));

            // Catat riwayat Out Stock
            const outLogs = JSON.parse(localStorage.getItem('outStockLogs') || '[]');
            outLogs.push({
                outlet: currentOutlet,
                tanggal: toYMD(new Date()),
                nama: nama,
                jumlah: qty,
                satuan: satuanOf(nama),
                pic: currentUser?.nama || '-',
                ket: 'FEFO'
            });
            localStorage.setItem('outStockLogs', JSON.stringify(outLogs));

            closeModal('modalOutStock');
            loadInventori();
            loadDashboard();
            showToast('Out Stock berhasil diproses!');
            clearForm(['outJumlah']);
        }

        function deleteInventori(idx) {
            if (isViewOnly) return;
            const inv = JSON.parse(localStorage.getItem('inventori') || '[]');
            inv.splice(idx, 1);
            localStorage.setItem('inventori', JSON.stringify(inv));
            loadInventori();
        }

        // ==================== UTIL: ASSIGNEE FROM JADWAL ====================
        function populateAssigneeOptions() {
            const select = document.getElementById('tugasAssign');
            if (!select) return;
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const { start, end } = getSchedulePeriod();
            // Ambil nama unik dari jadwal outlet & periode aktif
            const namesSet = new Set(
                jadwal
                    .filter(j => j.outlet === currentOutlet && j.tanggal)
                    .filter(j => {
                        const dt = parseLocalDate(j.tanggal);
                        return dt >= start && dt <= end;
                    })
                    .map(j => (j.nama || '').trim())
                    .filter(n => n)
            );
            const names = Array.from(namesSet).sort((a,b) => a.localeCompare(b, 'id'));
            select.innerHTML = names.length
                ? names.map(n => `<option value="${n}">${n}</option>`).join('')
                : '<option value="">(Belum ada nama pada Jadwal Kerja)</option>';
        }

        function populatePrepPetugasOptions() {
            const select = document.getElementById('prepPetugas');
            if (!select) return;
            const jadwal = JSON.parse(localStorage.getItem('jadwal') || '[]');
            const { start, end } = getSchedulePeriod();
            const namesSet = new Set(
                jadwal
                    .filter(j => j.outlet === currentOutlet && j.tanggal)
                    .filter(j => {
                        const dt = parseLocalDate(j.tanggal);
                        return dt >= start && dt <= end;
                    })
                    .map(j => (j.nama || '').trim())
                    .filter(n => n)
            );
            const names = Array.from(namesSet).sort((a,b) => a.localeCompare(b, 'id'));
            select.innerHTML = names.length
                ? names.map(n => `<option value="${n}">${n}</option>`).join('')
                : '<option value="">(Belum ada nama pada Jadwal Kerja)</option>';
        }

        // ==================== LOGBOOK ====================
        function loadLogbook() {
            const logs = JSON.parse(localStorage.getItem('logbook') || '[]').filter(l => l.outlet === currentOutlet);
            const container = document.getElementById('logbookContainer');
            if (logs.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-gray-500">Belum ada catatan log book</div>';
                return;
            }
            container.innerHTML = logs.reverse().map(l => `
                <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 ${l.kategori === 'urgent' ? 'border-red-500' : l.kategori === 'penting' ? 'border-yellow-500' : 'border-blue-500'}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${l.shift === 'pagi' ? 'bg-yellow-100 text-yellow-700' : l.shift === 'siang' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">Shift ${l.shift}</span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${l.kategori === 'urgent' ? 'bg-red-100 text-red-700' : l.kategori === 'penting' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}">${l.kategori}</span>
                        </div>
                        <span class="text-xs text-gray-500">${formatDate(l.tanggal)} ${l.waktu}</span>
                    </div>
                    <p class="text-gray-800">${l.catatan}</p>
                    <p class="text-xs text-gray-500 mt-2"><i class="fas fa-user mr-1"></i>${l.penulis}</p>
                </div>
            `).join('');
        }

        function saveLogbook() {
            const logs = JSON.parse(localStorage.getItem('logbook') || '[]');
            logs.push({
                outlet: currentOutlet,
                tanggal: new Date().toISOString().split('T')[0],
                waktu: new Date().toTimeString().slice(0,5),
                shift: document.getElementById('logShift').value,
                kategori: document.getElementById('logKategori').value,
                catatan: document.getElementById('logCatatan').value,
                penulis: currentUser.nama
            });
            localStorage.setItem('logbook', JSON.stringify(logs));
            closeModal('modalLogbook');
            loadLogbook();
            showToast('Log berhasil disimpan!');
            clearForm(['logCatatan']);
        }

        // ==================== FEEDBACK ====================
        function loadFeedback() {
            const allFb = JSON.parse(localStorage.getItem('feedback') || '[]').filter(f => f.outlet === currentOutlet);
            
            // Get filter values
            const filterTanggal = (document.getElementById('fbFilterTanggal')?.value || '').trim();
            const filterSumber = (document.getElementById('fbFilterSumber')?.value || '').trim();
            const filterKategori = (document.getElementById('fbFilterKategori')?.value || '').trim();
            const filterRating = (document.getElementById('fbFilterRating')?.value || '').trim();
            
            // Calculate statistics from all data (before filter)
            const total = allFb.length;
            // Positive: rating >= 4 atau status puas (bintang 4-5 atau puas)
            const positive = allFb.filter(f => f.rating >= 4 || f.kepuasan === 'puas').length;
            // Negative: rating <= 3 atau status tidak_puas (bintang 1-3 atau tidak puas)
            const negative = allFb.filter(f => (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas').length;
            // Avg rating hanya untuk yang punya rating bintang
            const withRating = allFb.filter(f => f.rating && f.rating > 0);
            const avg = withRating.length ? (withRating.reduce((a,b) => a+b.rating, 0)/withRating.length).toFixed(1) : '0.0';
            
            document.getElementById('avgRating').textContent = avg;
            document.getElementById('totalPositive').textContent = positive;
            document.getElementById('totalNegative').textContent = negative;
            document.getElementById('totalFeedback').textContent = total;
            
            // Apply filters
            let fb = allFb;
            if (filterTanggal) {
                fb = fb.filter(f => f.tanggal === filterTanggal);
            }
            if (filterSumber) {
                fb = fb.filter(f => f.sumber === filterSumber);
            }
            if (filterKategori) {
                fb = fb.filter(f => f.kategori === filterKategori);
            }
            if (filterRating === 'positif') {
                fb = fb.filter(f => f.rating >= 4 || f.kepuasan === 'puas');
            } else if (filterRating === 'negatif') {
                fb = fb.filter(f => (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas');
            }
            
            const tbody = document.getElementById('feedbackTableBody');
            if (fb.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada feedback' + (filterTanggal || filterSumber || filterKategori || filterRating ? ' untuk filter ini' : '') + '</td></tr>';
                return;
            }
            
            const sumberLabel = { google: 'Google Review', wa: 'WA Customer Care', instagram: 'Instagram', onsite: 'On Site' };
            const kategoriLabel = { pelayanan: 'Pelayanan', produk: 'Produk', sikap: 'Sikap Karyawan', lingkungan: 'Lingkungan' };
            
            tbody.innerHTML = fb.slice().reverse().map(f => {
                // Determine if positive or negative
                const isPositive = f.rating >= 4 || f.kepuasan === 'puas';
                const isNegative = (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas';
                
                // Render rating: bintang atau puas/tidak puas
                let ratingHtml = '';
                if (f.sumber === 'google' && f.rating) {
                    const starColor = f.rating >= 4 ? 'text-yellow-400' : 'text-red-400';
                    ratingHtml = `<div class="flex ${starColor}">${'<i class="fas fa-star"></i>'.repeat(f.rating)}${'<i class="far fa-star text-gray-300"></i>'.repeat(5-f.rating)}</div>`;
                } else if (f.kepuasan) {
                    ratingHtml = f.kepuasan === 'puas' 
                        ? '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700"><i class="fas fa-smile mr-1"></i>Puas</span>'
                        : '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700"><i class="fas fa-frown mr-1"></i>Tidak Puas</span>';
                }
                
                // Row background color based on rating
                const rowClass = isNegative ? 'bg-red-50' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3 text-sm text-gray-500">${formatDate(f.tanggal)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${f.nama || '-'}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">${sumberLabel[f.sumber] || f.sumber || '-'}</span></td>
                        <td class="px-4 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-700">${kategoriLabel[f.kategori] || f.kategori || '-'}</span></td>
                        <td class="px-4 py-3">${ratingHtml}</td>
                        <td class="px-4 py-3 text-sm text-gray-600 max-w-xs">${f.komentar || '-'}</td>
                        <td class="px-4 py-3 text-sm ${f.capa ? 'text-red-700' : 'text-gray-400'}">${f.capa || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Export Feedback PDF
        async function exportFeedbackPDF() {
            const allFb = JSON.parse(localStorage.getItem('feedback') || '[]').filter(f => f.outlet === currentOutlet);
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const outlet = outlets.find(o => o.id === currentOutlet);
            
            // Get filter values
            const filterTanggal = (document.getElementById('fbFilterTanggal')?.value || '').trim();
            const filterSumber = (document.getElementById('fbFilterSumber')?.value || '').trim();
            const filterKategori = (document.getElementById('fbFilterKategori')?.value || '').trim();
            const filterRating = (document.getElementById('fbFilterRating')?.value || '').trim();
            
            // Apply filters
            let fb = allFb;
            if (filterTanggal) fb = fb.filter(f => f.tanggal === filterTanggal);
            if (filterSumber) fb = fb.filter(f => f.sumber === filterSumber);
            if (filterKategori) fb = fb.filter(f => f.kategori === filterKategori);
            if (filterRating === 'positif') fb = fb.filter(f => f.rating >= 4 || f.kepuasan === 'puas');
            else if (filterRating === 'negatif') fb = fb.filter(f => (f.rating && f.rating <= 3) || f.kepuasan === 'tidak_puas');
            
            const sumberLabel = { google: 'Google Review', wa: 'WA Customer Care', instagram: 'Instagram', onsite: 'On Site' };
            const kategoriLabel = { pelayanan: 'Pelayanan', produk: 'Produk', sikap: 'Sikap Karyawan', lingkungan: 'Lingkungan' };
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            
            doc.setFontSize(14);
            doc.text(`Customer Feedback - ${outlet ? outlet.nama : ''}`, 40, 40);
            doc.setFontSize(10);
            const filterText = [
                filterTanggal ? `Tanggal: ${formatDate(filterTanggal)}` : '',
                filterSumber ? `Sumber: ${sumberLabel[filterSumber]}` : '',
                filterKategori ? `Kategori: ${kategoriLabel[filterKategori]}` : '',
                filterRating ? `Rating: ${filterRating === 'positif' ? 'Positif' : 'Negatif'}` : ''
            ].filter(x => x).join(' | ') || 'Semua Data';
            doc.text(`Filter: ${filterText}`, 40, 58);
            
            const rows = fb.slice().reverse().map(f => {
                let ratingText = '';
                if (f.sumber === 'google' && f.rating) {
                    ratingText = '★'.repeat(f.rating) + '☆'.repeat(5 - f.rating);
                } else if (f.kepuasan) {
                    ratingText = f.kepuasan === 'puas' ? 'Puas' : 'Tidak Puas';
                }
                return [
                    formatDate(f.tanggal),
                    f.nama || '-',
                    sumberLabel[f.sumber] || f.sumber || '-',
                    kategoriLabel[f.kategori] || f.kategori || '-',
                    ratingText,
                    (f.komentar || '-').substring(0, 50) + (f.komentar && f.komentar.length > 50 ? '...' : ''),
                    (f.capa || '-').substring(0, 40) + (f.capa && f.capa.length > 40 ? '...' : '')
                ];
            });
            
            doc.autoTable({
                startY: 74,
                head: [['Tanggal', 'Customer', 'Sumber', 'Kategori', 'Rating', 'Komentar', 'CAPA']],
                body: rows.length ? rows : [['-', '-', '-', '-', '-', '-', '-']],
                styles: { fontSize: 8 },
                headStyles: { fillColor: [59, 130, 246] },
                columnStyles: {
                    5: { cellWidth: 150 },
                    6: { cellWidth: 120 }
                }
            });
            
            doc.save(`Feedback_${(outlet ? outlet.nama.replace(/\s+/g,'_') : 'Outlet')}_${toYMD(new Date())}.pdf`);
        }

        function onFbSumberChange() {
            const sumber = document.getElementById('fbSumber').value;
            const starsContainer = document.getElementById('ratingStarsContainer');
            const puasContainer = document.getElementById('ratingPuasContainer');
            const capaContainer = document.getElementById('fbCapaContainer');
            
            if (sumber === 'google') {
                starsContainer.classList.remove('hidden');
                puasContainer.classList.add('hidden');
            } else {
                starsContainer.classList.add('hidden');
                puasContainer.classList.remove('hidden');
                // Reset radio
                document.querySelectorAll('input[name="fbPuas"]').forEach(r => r.checked = false);
            }
            
            // Reset CAPA
            capaContainer.classList.add('hidden');
            document.getElementById('fbCapa').value = '';
            
            // Reset rating
            setRating(0);
        }

        function setRating(rating) {
            selectedRating = rating;
            document.getElementById('fbRating').value = rating;
            const stars = document.querySelectorAll('#ratingStars button');
            stars.forEach((s, i) => {
                s.classList.toggle('text-yellow-400', i < rating);
                s.classList.toggle('text-gray-300', i >= rating);
            });
            
            // Show CAPA if rating 1-3
            const capaContainer = document.getElementById('fbCapaContainer');
            if (rating >= 1 && rating <= 3) {
                capaContainer.classList.remove('hidden');
            } else {
                capaContainer.classList.add('hidden');
            }
        }

        function onPuasChange() {
            const selected = document.querySelector('input[name="fbPuas"]:checked');
            const capaContainer = document.getElementById('fbCapaContainer');
            
            if (selected && selected.value === 'tidak_puas') {
                capaContainer.classList.remove('hidden');
            } else {
                capaContainer.classList.add('hidden');
            }
        }

        function saveFeedback() {
            const sumber = document.getElementById('fbSumber').value;
            const nama = document.getElementById('fbNama').value;
            const kategori = document.getElementById('fbKategori').value;
            const komentar = document.getElementById('fbKomentar').value;
            const capa = document.getElementById('fbCapa').value.trim();
            
            let rating = 0;
            let kepuasan = '';
            let isNegative = false;
            
            if (sumber === 'google') {
                rating = parseInt(document.getElementById('fbRating').value) || 0;
                if (rating === 0) {
                    showToast('Silakan pilih rating bintang');
                    return;
                }
                // Bintang 1-3 = negatif, bintang 4-5 = positif
                isNegative = rating <= 3;
            } else {
                const puasSelected = document.querySelector('input[name="fbPuas"]:checked');
                if (!puasSelected) {
                    showToast('Silakan pilih Puas atau Tidak Puas');
                    return;
                }
                kepuasan = puasSelected.value;
                isNegative = kepuasan === 'tidak_puas';
                // Convert to rating for statistics (puas = 5, tidak puas = 1)
                rating = kepuasan === 'puas' ? 5 : 1;
            }
            
            // Validate CAPA for negative feedback (bintang 1-3 atau tidak puas)
            if (isNegative && !capa) {
                showToast('CAPA wajib diisi untuk feedback negatif (★1-3 atau Tidak Puas)');
                document.getElementById('fbCapa').focus();
                return;
            }
            
            const fb = JSON.parse(localStorage.getItem('feedback') || '[]');
            fb.push({
                outlet: currentOutlet,
                tanggal: toYMD(new Date()),
                nama: nama,
                sumber: sumber,
                kategori: kategori,
                rating: rating,
                kepuasan: kepuasan,
                komentar: komentar,
                capa: isNegative ? capa : ''
            });
            localStorage.setItem('feedback', JSON.stringify(fb));
            closeModal('modalFeedback');
            resetFeedbackForm();
            loadFeedback();
            loadDashboard();
            showToast('Feedback berhasil disimpan!');
        }

        function resetFeedbackForm() {
            setRating(0);
            document.getElementById('fbNama').value = '';
            document.getElementById('fbSumber').value = 'google';
            document.getElementById('fbKategori').value = 'pelayanan';
            document.getElementById('fbKomentar').value = '';
            document.getElementById('fbCapa').value = '';
            document.querySelectorAll('input[name="fbPuas"]').forEach(r => r.checked = false);
            document.getElementById('ratingStarsContainer').classList.remove('hidden');
            document.getElementById('ratingPuasContainer').classList.add('hidden');
            document.getElementById('fbCapaContainer').classList.add('hidden');
        }

        // Checklist settings removed — use Google Forms and central templates

        // ==================== SETTINGS: OUTLET ====================
        function loadOutlets() {
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const container = document.getElementById('outletContainer');
            
            // Filter outlets based on role
            let filteredOutlets = outlets;
            if (currentUser.role !== 'admin' && currentUser.role !== 'head-office') {
                filteredOutlets = outlets.filter(o => allowedOutlets.includes(o.id));
            }
            
            container.innerHTML = filteredOutlets.map((o, idx) => `
                <div class="bg-white rounded-xl p-6 shadow-sm card-hover transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-store text-blue-600 text-xl"></i>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${o.status === 'aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${o.status}</span>
                    </div>
                    <p class="text-xs text-gray-400 mb-1">${o.kode || '-'}</p>
                    <h3 class="font-bold text-gray-800">${o.nama}</h3>
                    <p class="text-sm text-gray-500 mt-1">${o.alamat}</p>
                    <p class="text-sm text-gray-500"><i class="fas fa-phone mr-1"></i>${o.telp}</p>
                    <p class="text-sm text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${o.area}</p>
                    ${currentUser.role === 'admin' ? `
                    <div class="mt-4 flex gap-2">
                        <button onclick="deleteOutlet('${o.id}')" class="text-red-600 hover:text-red-800 text-sm"><i class="fas fa-trash mr-1"></i>Hapus</button>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function saveOutlet() {
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const newId = 'outlet-' + Date.now();
            outlets.push({
                id: newId,
                kode: document.getElementById('outletKode').value,
                nama: document.getElementById('outletNama').value,
                alamat: document.getElementById('outletAlamat').value,
                telp: document.getElementById('outletTelp').value,
                area: document.getElementById('outletArea').value,
                status: 'aktif'
            });
            localStorage.setItem('outlets', JSON.stringify(outlets));
            closeModal('modalOutlet');
            loadOutlets();
            populateOutletSelector();
            showToast('Outlet berhasil ditambahkan!');
            clearForm(['outletKode', 'outletNama', 'outletAlamat', 'outletTelp', 'outletArea']);
        }

        function deleteOutlet(id) {
            if (currentUser.role !== 'admin') return;
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const idx = outlets.findIndex(o => o.id === id);
            if (idx > -1) {
                outlets.splice(idx, 1);
                localStorage.setItem('outlets', JSON.stringify(outlets));
                loadOutlets();
                populateOutletSelector();
            }
        }

        // ==================== SETTINGS: USERS ====================
        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            const tbody = document.getElementById('userTable');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada user</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map((u, idx) => {
                let outletNames = 'Semua Outlet';
                if (u.outlets !== 'all' && Array.isArray(u.outlets)) {
                    outletNames = u.outlets.map(oid => {
                        const o = outlets.find(x => x.id === oid);
                        return o ? o.nama : oid;
                    }).join(', ');
                } else if (u.outlets !== 'all') {
                    const o = outlets.find(x => x.id === u.outlets);
                    outletNames = o ? o.nama : u.outlets;
                }
                
                return `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900 font-mono">${u.kode}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${u.nama}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">${getRoleName(u.role)}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="${outletNames}">${outletNames}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">${u.status || 'aktif'}</span></td>
                    <td class="px-6 py-4 action-column"><button onclick="deleteUser(${idx})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td>
                </tr>
            `}).join('');
        }

        function onUserRoleChange() {
            const role = document.getElementById('userRoleSelect').value;
            const outletDiv = document.getElementById('outletAssignmentDiv');
            const checkboxes = document.getElementById('outletCheckboxes');
            const outlets = JSON.parse(localStorage.getItem('outlets') || '[]');
            
            if (role === 'admin' || role === 'head-office') {
                outletDiv.classList.add('hidden');
            } else {
                outletDiv.classList.remove('hidden');
                checkboxes.innerHTML = outlets.map(o => `
                    <label class="flex items-center gap-2">
                        <input type="checkbox" value="${o.id}" class="outlet-checkbox rounded border-gray-300">
                        <span class="text-sm">${o.nama}</span>
                    </label>
                `).join('');
            }
        }

        function saveUser() {
            const role = document.getElementById('userRoleSelect').value;
            let outlets;
            
            if (role === 'admin' || role === 'head-office') {
                outlets = 'all';
            } else {
                const checked = document.querySelectorAll('.outlet-checkbox:checked');
                outlets = Array.from(checked).map(c => c.value);
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            users.push({
                kode: document.getElementById('userKode').value,
                nama: document.getElementById('userNama').value,
                role: role,
                outlets: outlets,
                status: 'aktif'
            });
            localStorage.setItem('users', JSON.stringify(users));
            closeModal('modalUser');
            loadUsers();
            showToast('User berhasil ditambahkan!');
            clearForm(['userKode', 'userNama']);
        }

        function deleteUser(idx) {
            if (currentUser.role !== 'admin') return;
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            users.splice(idx, 1);
            localStorage.setItem('users', JSON.stringify(users));
            loadUsers();
        }

        // ==================== SPREADSHEET ====================
        function saveSpreadsheetConfig() {
            const config = {
                spreadsheetId: document.getElementById('spreadsheetId').value,
                apiKey: document.getElementById('apiKey').value,
                webAppUrl: document.getElementById('webAppUrl').value
            };
            localStorage.setItem('spreadsheetConfig', JSON.stringify(config));
            showToast('Konfigurasi berhasil disimpan!');
        }

        function testConnection() {
            const config = JSON.parse(localStorage.getItem('spreadsheetConfig') || '{}');
            if (!config.webAppUrl) {
                showToast('Masukkan Web App URL terlebih dahulu!');
                return;
            }
            showToast('Menguji koneksi...');
        }

        // Checklist export & template functions removed — exports use Google Forms / Apps Script now

        // ==================== HELPER FUNCTIONS ====================
        // Parse 'YYYY-MM-DD' as a local date to avoid timezone shifts
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return new Date(dateStr);
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            const d = parseInt(parts[2], 10);
            // Use noon to avoid any DST or timezone boundary issues
            return new Date(y, (m || 1) - 1, d || 1, 12, 0, 0, 0);
        }
        // Build local 'YYYY-MM-DD' from Date object
        function toYMD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            const d = parseLocalDate(dateStr);
            return d ? d.toLocaleDateString('id-ID', options) : '-';
        }

        function addActivity(type, message) {
            const activities = JSON.parse(localStorage.getItem('activities') || '[]');
            activities.push({
                type,
                message,
                time: new Date().toLocaleString('id-ID'),
                outlet: currentOutlet,
                user: currentUser.nama
            });
            localStorage.setItem('activities', JSON.stringify(activities.slice(-100)));
        }

        // Checklist submissions, prefill helpers and Drive-save helpers removed

        function clearForm(fields) {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(`
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => clients.claim());
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
            `)).catch(() => {});
        }

        // Initialize
        init();
    </script>
</body>
</html>
